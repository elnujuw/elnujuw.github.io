<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Junle&#39;s Blog</title>
  
  <subtitle>Have a Nice Day</subtitle>
  <link href="https://www.junle.org/atom.xml" rel="self"/>
  
  <link href="https://www.junle.org/"/>
  <updated>2024-03-25T05:47:00.963Z</updated>
  <id>https://www.junle.org/</id>
  
  <author>
    <name>Junle</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>如何在RuoYi-Vue项目中整合积木报表</title>
    <link href="https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8RuoYi-Vue%E9%A1%B9%E7%9B%AE%E4%B8%AD%E6%95%B4%E5%90%88%E7%A7%AF%E6%9C%A8%E6%8A%A5%E8%A1%A8/"/>
    <id>https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8RuoYi-Vue%E9%A1%B9%E7%9B%AE%E4%B8%AD%E6%95%B4%E5%90%88%E7%A7%AF%E6%9C%A8%E6%8A%A5%E8%A1%A8/</id>
    <published>2024-03-25T03:24:10.000Z</published>
    <updated>2024-03-25T05:47:00.963Z</updated>
    
    <content type="html"><![CDATA[<p>在本篇博客中，我们将介绍如何在RuoYi-Vue项目中整合积木报表来实现数据可视化和报表功能。</p><p>本示例以之前介绍的SQLServer版的RuoYi系统<a href="https://github.com/elnujuw/RuoYi-SQLServer">RuoYi-SQLServer</a>为例。</p><span id="more"></span><ol><li><p>参考<a href="http://report.jeecg.com/2302148">官方文档</a>完成1-7步；</p></li><li><p>前端代码创建API文件 <code>src/api/report/jimu.js</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&#x27;@/utils/request&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 报表设计器</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">design</span>(<span class="params">query</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;/report/jimu/design&#x27;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建页面 <code>src/views/report/jimu/design.vue</code>：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-loading</span>=<span class="string">&quot;loading&quot;</span> <span class="attr">:style</span>=<span class="string">&quot;&#x27;height:&#x27;+ height&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">:src</span>=<span class="string">&quot;src&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;no&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 100%;height: 100%&quot;</span> <span class="attr">scrolling</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> &#123; getToken &#125; <span class="keyword">from</span> <span class="string">&#x27;@/utils/auth&#x27;</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> &#123; design &#125; <span class="keyword">from</span> <span class="string">&#x27;@/api/report/jimu&#x27;</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&quot;Ureport&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">src</span>: <span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">height</span>: <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="property">clientHeight</span> - <span class="number">94.5</span> + <span class="string">&quot;px;&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">loading</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">      &#125;;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">created</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">design</span>().<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">src</span> = res + <span class="string">&quot;?token=Bearer &quot;</span> + <span class="title function_">getToken</span>();</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">    <span class="attr">mounted</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">loading</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">      &#125;, <span class="number">230</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> that = <span class="variable language_">this</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">window</span>.<span class="property">onresize</span> = <span class="keyword">function</span> <span class="title function_">temp</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        that.<span class="property">height</span> = <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="property">clientHeight</span> - <span class="number">94.5</span> + <span class="string">&quot;px;&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">      &#125;;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>添加Token校验</p><ol><li><p>修改后端配置文件<code>application.yml</code>，添加<code>reportUrl</code>：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ruoyi:</span></span><br><span class="line">  <span class="comment"># 积木报表访问地址</span></span><br><span class="line">  <span class="attr">reportUrl:</span> <span class="string">http://127.0.0.1:8080/</span></span><br></pre></td></tr></table></figure></li><li><p>创建文件：<code>ruoyi-framework\src\main\java\com\ruoyi\framework\jimu\JimuController.java</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/report/jimu&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JimuController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/design&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;report:jimu:design&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">design</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> environment.getProperty(<span class="string">&quot;ruoyi.reportUrl&quot;</span>) + <span class="string">&quot;jmreport/list&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/view&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;report:jimu:view&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">view</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> environment.getProperty(<span class="string">&quot;ruoyi.reportUrl&quot;</span>)+<span class="string">&quot;/jmreport/view&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建文件：<code>ruoyi-framework\src\main\java\com\ruoyi\framework\jimu\JimuReportTokenService.java</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JimuReportTokenService</span> <span class="keyword">implements</span> <span class="title class_">JmReportTokenServiceI</span>  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ISysUserService iSysUserService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> tokenService.getLoginUserFromToken(token);</span><br><span class="line">        <span class="keyword">return</span> loginUser.getUsername();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getRoles(String s) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    校验token</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">verifyToken</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(token !=<span class="literal">null</span> &amp;&amp; token.length()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//这个获得的token 是带前缀的，所以需要新加一个一个方法,处理token，再返回loginUser</span></span><br><span class="line">            <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> tokenService.getLoginUserFromToken(token);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotNull(loginUser))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getToken</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jmToken</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span> || token.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            token = jmToken;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (token != <span class="literal">null</span> &amp;&amp; token.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> token;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getToken</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JmReportTokenServiceI.<span class="built_in">super</span>.getToken();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getUserInfo</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>(<span class="number">5</span>);</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> tokenService.getLoginUserFromToken(token);</span><br><span class="line">        <span class="comment">//设置用户名</span></span><br><span class="line">        map.put(SYS_USER_CODE, loginUser.getUsername());</span><br><span class="line">        <span class="comment">//设置部门编码</span></span><br><span class="line">        map.put(SYS_ORG_CODE, loginUser.getDeptId());</span><br><span class="line">        <span class="comment">// 将所有信息存放至map 解析sql/api会根据map的键值解析</span></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> HttpHeaders <span class="title function_">customApiHeader</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">header</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        header.add(<span class="string">&quot;Authorization&quot;</span>, getToken());</span><br><span class="line">        header.add(<span class="string">&quot;X-Access-Token&quot;</span>, getToken());</span><br><span class="line">        <span class="keyword">return</span> header;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTenantId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JmReportTokenServiceI.<span class="built_in">super</span>.getTenantId();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>修改tokenService，添加方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 根据 token，获取用户信息</span></span><br><span class="line"><span class="comment">* Bearer + gettoken()</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> LoginUser <span class="title function_">getLoginUserFromToken</span><span class="params">(String token)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotEmpty(token))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//处理token</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(token) &amp;&amp; token.startsWith(Constants.TOKEN_PREFIX))</span><br><span class="line">        &#123;</span><br><span class="line">            token = token.replace(Constants.TOKEN_PREFIX, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> parseToken(token);</span><br><span class="line">            <span class="comment">// 解析对应的权限以及用户信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> (String) claims.get(Constants.LOGIN_USER_KEY);</span><br><span class="line">            <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> getTokenKey(uuid);</span><br><span class="line">            <span class="type">LoginUser</span> <span class="variable">user</span> <span class="operator">=</span> redisCache.getCacheObject(userKey);</span><br><span class="line">            <span class="keyword">return</span> user;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li><li><p>添加菜单</p><p><img src="/images/jimu_report_system.png" alt="报表系统菜单"></p><p><img src="/images/jimu_report_design.png" alt="报表设计器菜单"></p></li><li><p>效果</p><p><img src="/images/jimu_report_index.png" alt="报表设计器界面"></p></li><li></li></ol>]]></content>
    
    
    <summary type="html">在本篇博客中，我们将介绍如何在RuoYi-Vue项目中整合积木报表来实现数据可视化和报表功能</summary>
    
    
    
    
    <category term="Java" scheme="https://www.junle.org/tags/Java/"/>
    
    <category term="RuoYi" scheme="https://www.junle.org/tags/RuoYi/"/>
    
  </entry>
  
  <entry>
    <title>RuoYi系统如何与SQLServer数据库完美搭配</title>
    <link href="https://www.junle.org/RuoYi%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E4%B8%8ESQLServer%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%8C%E7%BE%8E%E6%90%AD%E9%85%8D/"/>
    <id>https://www.junle.org/RuoYi%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E4%B8%8ESQLServer%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%8C%E7%BE%8E%E6%90%AD%E9%85%8D/</id>
    <published>2024-03-22T07:56:01.000Z</published>
    <updated>2024-03-23T01:41:52.454Z</updated>
    
    <content type="html"><![CDATA[<p>最近在使用RuoYi系统开发ERP系统，由于需要使用SQLServer数据库来作为系统数据库所以有了今天的文章。</p><p>先给出完整代码，包含数据库脚本：<a href="https://github.com/elnujuw/RuoYi-SQLServer">https://github.com/elnujuw/RuoYi-SQLServer</a></p><p>本文使用的数据库版本是<strong>Microsoft SQL Server 2019</strong>，下面将介绍具体实现步骤：</p><span id="more"></span><ol><li><p>ruoyi-admin工程下的pom.xml文件添加SQLServer驱动依赖包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- SQLServer驱动包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.microsoft.sqlserver<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mssql-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>修改application-druid.yml配置文件</p><ol><li><p>修改driverClassName</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">driverClassName:</span> <span class="string">com.microsoft.sqlserver.jdbc.SQLServerDriver</span></span><br></pre></td></tr></table></figure></li><li><p>修改主数据源url</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">url:</span> <span class="string">jdbc:sqlserver://数据库ip:1433;SelectMethod=cursor;DatabaseName=数据库名称</span></span><br></pre></td></tr></table></figure></li><li><p>修改validationQuery</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置检测连接是否有效</span></span><br><span class="line"><span class="attr">validationQuery:</span> <span class="string">select</span> <span class="string">&#x27;x&#x27;</span></span><br></pre></td></tr></table></figure></li></ol></li><li><p>修改application-druid.yml配置文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PageHelper分页插件</span></span><br><span class="line"><span class="attr">pagehelper:</span></span><br><span class="line"><span class="attr">helperDialect:</span> <span class="string">sqlserver2012</span></span><br></pre></td></tr></table></figure></li><li><p>修改SQL语句函数</p><ol><li><p>ifnull 替换为 isnull</p></li><li><p>替换find_in_set，例如：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find_in_set(#&#123;deptId&#125;, ancestors) 替换为  charindex (<span class="string">&#x27;,&#x27;</span> <span class="operator">+</span> <span class="keyword">CONVERT</span> (<span class="type">VARCHAR</span>, #&#123;deptId&#125;), <span class="string">&#x27;,&#x27;</span> <span class="operator">+</span> ancestors) <span class="operator">&gt;</span> <span class="number">0</span></span><br></pre></td></tr></table></figure></li><li><p>concat 替换为 ‘’+’’</p></li><li><p>sysdate() 替换为 getdate()</p></li><li><p>替换date_format，例如：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">date_format(u.create_time,<span class="string">&#x27;%y%m%d&#x27;</span>) <span class="operator">&gt;=</span> date_format(#&#123;params.beginTime&#125;,<span class="string">&#x27;%y%m%d&#x27;</span>) 替换为 DATEDIFF(<span class="keyword">day</span>, u.create_time , #&#123;params.endTime&#125;) <span class="operator">&gt;=</span> <span class="number">0</span></span><br></pre></td></tr></table></figure></li><li><p>limit 1 替换为 top(1)</p></li></ol></li><li><p>修改代码生成器</p><ol><li><p>修改selectDbTableList 为：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">so.name table_name,</span><br><span class="line">sep.value table_comment,</span><br><span class="line">so.create_date create_time,</span><br><span class="line">so.modify_date update_time</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">sys.objects <span class="keyword">AS</span> so</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> sys.extended_properties <span class="keyword">AS</span> sep <span class="keyword">ON</span> so.object_id <span class="operator">=</span> sep.major_id</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">so.type <span class="operator">=</span> <span class="string">&#x27;U&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> sep.minor_id <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">AND</span> so.name <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;qrtz_%&#x27;</span> <span class="keyword">AND</span> so.name <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;gen_%&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> so.name <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">select</span> table_name <span class="keyword">from</span> gen_table)</span><br></pre></td></tr></table></figure></li><li><p>修改selectDbTableListByName为：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">SO.name table_name,</span><br><span class="line">SEP.VALUE table_comment,</span><br><span class="line">SO.create_date create_time,</span><br><span class="line">SO.modify_date update_time</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">sys.objects <span class="keyword">AS</span> SO</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> sys.extended_properties <span class="keyword">AS</span> SEP <span class="keyword">ON</span> SO.object_id <span class="operator">=</span> SEP.major_id</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">SO.type <span class="operator">=</span> <span class="string">&#x27;U&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> SEP.minor_id <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">and</span> SO.name <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;qrtz_%&#x27;</span> <span class="keyword">and</span> SO.name <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;gen_%&#x27;</span></span><br><span class="line"><span class="keyword">and</span> SO.name <span class="keyword">in</span></span><br><span class="line"><span class="operator">&lt;</span>foreach collection<span class="operator">=</span>&quot;array&quot; item<span class="operator">=</span>&quot;name&quot; <span class="keyword">open</span><span class="operator">=</span>&quot;(&quot; separator<span class="operator">=</span>&quot;,&quot; <span class="keyword">close</span><span class="operator">=</span>&quot;)&quot;<span class="operator">&gt;</span></span><br><span class="line">#&#123;name&#125;</span><br><span class="line"><span class="operator">&lt;</span><span class="operator">/</span>foreach<span class="operator">&gt;</span> </span><br></pre></td></tr></table></figure></li><li><p>修改selectDbTableColumnsByName为：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.name <span class="keyword">AS</span> column_name,</span><br><span class="line">(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> a.isnullable <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="number">0</span> <span class="keyword">ELSE</span> <span class="number">1</span> <span class="keyword">END</span> ) <span class="keyword">AS</span> is_required,</span><br><span class="line">(</span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">    <span class="keyword">WHEN</span> (</span><br><span class="line">            <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>)</span><br><span class="line">            <span class="keyword">FROM</span> sysobjects</span><br><span class="line">            <span class="keyword">WHERE</span> (</span><br><span class="line">                    name <span class="keyword">IN</span> (</span><br><span class="line">                    <span class="keyword">SELECT</span> name</span><br><span class="line">                    <span class="keyword">FROM</span> sysindexes</span><br><span class="line">                    <span class="keyword">WHERE</span> (id <span class="operator">=</span> a.id)</span><br><span class="line">                      <span class="keyword">AND</span> (</span><br><span class="line">                            indid <span class="keyword">IN</span> (</span><br><span class="line">                            <span class="keyword">SELECT</span> indid</span><br><span class="line">                            <span class="keyword">FROM</span> sysindexkeys</span><br><span class="line">                            <span class="keyword">WHERE</span> (id <span class="operator">=</span> a.id)</span><br><span class="line">                              <span class="keyword">AND</span> (</span><br><span class="line">                                    colid <span class="keyword">IN</span> (</span><br><span class="line">                                    <span class="keyword">SELECT</span> colid</span><br><span class="line">                                    <span class="keyword">FROM</span> syscolumns</span><br><span class="line">                                    <span class="keyword">WHERE</span> (id <span class="operator">=</span> a.id)</span><br><span class="line">                                      <span class="keyword">AND</span> (name <span class="operator">=</span> a.name)</span><br><span class="line">                                )</span><br><span class="line">                                )</span><br><span class="line">                        )</span><br><span class="line">                        )</span><br><span class="line">                )</span><br><span class="line">                )</span><br><span class="line">              <span class="keyword">AND</span> (xtype <span class="operator">=</span> <span class="string">&#x27;PK&#x27;</span>)</span><br><span class="line">        ) <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">       <span class="number">1</span></span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">       <span class="number">0</span></span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line">)  <span class="keyword">AS</span> is_pk,</span><br><span class="line">a.colorder  <span class="keyword">AS</span> sort,</span><br><span class="line">isnull(g.[<span class="keyword">value</span>], <span class="string">&#x27; &#x27;</span>) <span class="keyword">AS</span> column_comment,</span><br><span class="line">(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> COLUMNPROPERTY(a.id, a.name, <span class="string">&#x27;IsIdentity&#x27;</span>) <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) <span class="keyword">AS</span> is_increment,</span><br><span class="line">b.name  <span class="keyword">AS</span> column_type</span><br><span class="line"><span class="keyword">FROM</span> syscolumns a</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> systypes b <span class="keyword">ON</span> a.xtype <span class="operator">=</span> b.xusertype</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> sysobjects d <span class="keyword">ON</span> a.id <span class="operator">=</span> d.id <span class="keyword">AND</span> d.xtype <span class="operator">=</span> <span class="string">&#x27;U&#x27;</span> <span class="keyword">AND</span> d.name  <span class="operator">&lt;</span><span class="operator">!</span>[CDATA[ <span class="operator">&lt;&gt;</span> ]]<span class="operator">&gt;</span> <span class="string">&#x27;dtproperties&#x27;</span></span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> syscomments e <span class="keyword">ON</span> a.cdefault <span class="operator">=</span> e.id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> sys.extended_properties g <span class="keyword">ON</span> a.id <span class="operator">=</span> g.major_id <span class="keyword">AND</span> a.colid <span class="operator">=</span> g.minor_id <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> sys.extended_properties f <span class="keyword">ON</span> d.id <span class="operator">=</span> f.class <span class="keyword">AND</span> f.minor_id <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> sys.objects h <span class="keyword">ON</span> a.id <span class="operator">=</span> h.object_id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> sys.schemas i <span class="keyword">ON</span> h.schema_id <span class="operator">=</span> i.schema_id</span><br><span class="line"><span class="keyword">WHERE</span> d.name <span class="operator">=</span> #&#123;tableName&#125;</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a.colorder</span><br></pre></td></tr></table></figure></li></ol><h3 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h3><ul><li><p>使用SQLServer数据库mybatis批量插入时数字可能会丢失精度</p><p>解决方法，参考以下批量插入，使用<code>cast(#&#123;item.rate,jdbcType=DECIMAL&#125; as decimal(18,6))</code>如：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;batchBaseMoneyrateDetail&quot;</span>&gt;</span></span><br><span class="line">    insert into base_moneyrate_d( moneyrate_id, item_id, money_id, rate) values</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span> <span class="attr">index</span>=<span class="string">&quot;index&quot;</span> <span class="attr">collection</span>=<span class="string">&quot;list&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">        ( #&#123;item.moneyrateId&#125;, #&#123;item.itemId&#125;, #&#123;item.moneyId&#125;, cast(#&#123;item.rate,jdbcType=DECIMAL&#125; as decimal(18,6)))</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>代码生成器导入表没有可选的表数据</p><p>原因是数据库表没有设置表说明，解决方法（如角色表，添加表说明）：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 为了防止任何可能出现的数据丢失问题，您应该先仔细检查此脚本，然后再在数据库设计器的上下文之外运行此脚本。*/</span></span><br><span class="line"><span class="keyword">BEGIN</span> TRANSACTION</span><br><span class="line"><span class="keyword">SET</span> QUOTED_IDENTIFIER <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">SET</span> ARITHABORT <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">SET</span> NUMERIC_ROUNDABORT OFF</span><br><span class="line"><span class="keyword">SET</span> CONCAT_NULL_YIELDS_NULL <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">SET</span> ANSI_NULLS <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">SET</span> ANSI_PADDING <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">SET</span> ANSI_WARNINGS <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">COMMIT</span></span><br><span class="line"><span class="keyword">BEGIN</span> TRANSACTION</span><br><span class="line">GO</span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@v</span> sql_variant </span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@v</span> <span class="operator">=</span> N<span class="string">&#x27;角色表&#x27;</span></span><br><span class="line"><span class="keyword">EXECUTE</span> sp_addextendedproperty N<span class="string">&#x27;MS_Description&#x27;</span>, <span class="variable">@v</span>, N<span class="string">&#x27;SCHEMA&#x27;</span>, N<span class="string">&#x27;dbo&#x27;</span>, N<span class="string">&#x27;TABLE&#x27;</span>, N<span class="string">&#x27;sys_role&#x27;</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span></span><br><span class="line">GO</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> dbo.sys_role <span class="keyword">SET</span> (LOCK_ESCALATION <span class="operator">=</span> <span class="keyword">TABLE</span>)</span><br><span class="line">GO</span><br><span class="line"><span class="keyword">COMMIT</span></span><br></pre></td></tr></table></figure></li></ul></li></ol>]]></content>
    
    
    <summary type="html">RuoYi系统如何与SQLServer数据库完美搭配</summary>
    
    
    
    
    <category term="SQLServer" scheme="https://www.junle.org/tags/SQLServer/"/>
    
    <category term="Java" scheme="https://www.junle.org/tags/Java/"/>
    
    <category term="RuoYi" scheme="https://www.junle.org/tags/RuoYi/"/>
    
  </entry>
  
  <entry>
    <title>排查SQL Server中运行缓慢的查询问题</title>
    <link href="https://www.junle.org/%E6%8E%92%E6%9F%A5SQL-Server%E4%B8%AD%E8%BF%90%E8%A1%8C%E7%BC%93%E6%85%A2%E7%9A%84%E6%9F%A5%E8%AF%A2%E9%97%AE%E9%A2%98/"/>
    <id>https://www.junle.org/%E6%8E%92%E6%9F%A5SQL-Server%E4%B8%AD%E8%BF%90%E8%A1%8C%E7%BC%93%E6%85%A2%E7%9A%84%E6%9F%A5%E8%AF%A2%E9%97%AE%E9%A2%98/</id>
    <published>2023-07-24T05:34:39.000Z</published>
    <updated>2024-03-22T06:43:55.703Z</updated>
    
    <content type="html"><![CDATA[<ol><li><p>正在执行的慢SQL</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    req.session_id</span><br><span class="line">    , req.total_elapsed_time <span class="keyword">AS</span> duration_ms</span><br><span class="line">    , req.cpu_time <span class="keyword">AS</span> cpu_time_ms</span><br><span class="line">    , req.total_elapsed_time <span class="operator">-</span> req.cpu_time <span class="keyword">AS</span> wait_time</span><br><span class="line">    , req.logical_reads</span><br><span class="line">    , <span class="built_in">SUBSTRING</span> (REPLACE (REPLACE (<span class="built_in">SUBSTRING</span> (ST.text, (req.statement_start_offset<span class="operator">/</span><span class="number">2</span>) <span class="operator">+</span> <span class="number">1</span>, </span><br><span class="line">       ((<span class="keyword">CASE</span> statement_end_offset</span><br><span class="line">           <span class="keyword">WHEN</span> <span class="number">-1</span></span><br><span class="line">           <span class="keyword">THEN</span> DATALENGTH(ST.text)  </span><br><span class="line">           <span class="keyword">ELSE</span> req.statement_end_offset</span><br><span class="line">         <span class="keyword">END</span> <span class="operator">-</span> req.statement_start_offset)<span class="operator">/</span><span class="number">2</span>) <span class="operator">+</span> <span class="number">1</span>) , <span class="type">CHAR</span>(<span class="number">10</span>), <span class="string">&#x27; &#x27;</span>), <span class="type">CHAR</span>(<span class="number">13</span>), <span class="string">&#x27; &#x27;</span>), </span><br><span class="line">      <span class="number">1</span>, <span class="number">512</span>)  <span class="keyword">AS</span> statement_text  </span><br><span class="line"><span class="keyword">FROM</span> sys.dm_exec_requests <span class="keyword">AS</span> req</span><br><span class="line">    <span class="keyword">CROSS</span> APPLY sys.dm_exec_sql_text(req.sql_handle) <span class="keyword">AS</span> ST</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> total_elapsed_time <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure></li><li><p>过去执行的慢SQL</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t.text,</span><br><span class="line">     (qs.total_elapsed_time<span class="operator">/</span><span class="number">1000</span>) <span class="operator">/</span> qs.execution_count <span class="keyword">AS</span> avg_elapsed_time,</span><br><span class="line">     (qs.total_worker_time<span class="operator">/</span><span class="number">1000</span>) <span class="operator">/</span> qs.execution_count <span class="keyword">AS</span> avg_cpu_time,</span><br><span class="line">     ((qs.total_elapsed_time<span class="operator">/</span><span class="number">1000</span>) <span class="operator">/</span> qs.execution_count ) <span class="operator">-</span> ((qs.total_worker_time<span class="operator">/</span><span class="number">1000</span>) <span class="operator">/</span> qs.execution_count) <span class="keyword">AS</span> avg_wait_time,</span><br><span class="line">     qs.total_logical_reads <span class="operator">/</span> qs.execution_count <span class="keyword">AS</span> avg_logical_reads,</span><br><span class="line">     qs.total_logical_writes <span class="operator">/</span> qs.execution_count <span class="keyword">AS</span> avg_writes,</span><br><span class="line">     (qs.total_elapsed_time<span class="operator">/</span><span class="number">1000</span>) <span class="keyword">AS</span> cumulative_elapsed_time_all_executions</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_exec_query_stats qs</span><br><span class="line">     <span class="keyword">CROSS</span> apply sys.Dm_exec_sql_text (sql_handle) t</span><br><span class="line"><span class="keyword">WHERE</span> t.text <span class="keyword">like</span> <span class="string">&#x27;&lt;Your Query&gt;%&#x27;</span></span><br><span class="line"><span class="comment">-- Replace &lt;Your Query&gt; with your query or the beginning part of your query. The special chars like &#x27;[&#x27;,&#x27;_&#x27;,&#x27;%&#x27;,&#x27;^&#x27; in the query should be escaped.</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (qs.total_elapsed_time <span class="operator">/</span> qs.execution_count) <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <summary type="html">通过查询器查询正在执行和过去执行的慢SQL</summary>
    
    
    
    
    <category term="SQLServer" scheme="https://www.junle.org/tags/SQLServer/"/>
    
  </entry>
  
  <entry>
    <title>Print Spooler 服务意外终止</title>
    <link href="https://www.junle.org/Print-Spooler-%E6%9C%8D%E5%8A%A1%E6%84%8F%E5%A4%96%E7%BB%88%E6%AD%A2/"/>
    <id>https://www.junle.org/Print-Spooler-%E6%9C%8D%E5%8A%A1%E6%84%8F%E5%A4%96%E7%BB%88%E6%AD%A2/</id>
    <published>2022-12-01T01:35:51.000Z</published>
    <updated>2024-03-22T06:43:55.682Z</updated>
    
    <content type="html"><![CDATA[<p>Print Spooler服务在后台执行打印作业并处理与打印机的交互。如果关闭该服务，则无法进行打印或查看打印机。</p><span id="more"></span><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>今天遇到这个问题了，打印不了文件，重启电脑后发现Print Spooler并没有启动。手动进到服务里启动服务，没过几秒钟就停止了，查看windows日志发现Print Spooler 服务意外终止。</p><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>解决这个问题可以参考以下步骤：</p><ol><li>停止 Print Spooler 服务；</li><li>删掉 C:\windows\system32\spool\PRINTERS 目录下的所有文件；</li><li>重新启动 Print Spooler 服务；</li></ol>]]></content>
    
    
    <summary type="html">Print Spooler服务在后台执行打印作业并处理与打印机的交互。如果关闭该服务，则无法进行打印或查看打印机。</summary>
    
    
    
    
    <category term="Windows" scheme="https://www.junle.org/tags/Windows/"/>
    
    <category term="笔记" scheme="https://www.junle.org/tags/%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>Odoo14开发者指南第六章-管理模块数据【翻译】</title>
    <link href="https://www.junle.org/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E5%85%AD%E7%AB%A0-%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E6%95%B0%E6%8D%AE%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/"/>
    <id>https://www.junle.org/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E5%85%AD%E7%AB%A0-%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E6%95%B0%E6%8D%AE%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/</id>
    <published>2022-06-16T02:01:36.000Z</published>
    <updated>2024-03-22T06:43:55.677Z</updated>
    
    <content type="html"><![CDATA[<p>在本章中，我们将了解如何在安装附加模块时提供数据。在提供默认值、添加元数据（例如视图描述、菜单或操作）时对我们很有用。另一个重要的用途是提供演示数据，选中<strong>加载演示数据</strong> 复选框后，在创建数据库时加载演示数据。</p><p>在本章中，我们将介绍以下内容：</p><ul><li><p><a href="#%E4%BD%BF%E7%94%A8%E5%A4%96%E9%83%A8ID%E5%92%8C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4">使用外部ID和命名空间</a></p></li><li><p><a href="#%E4%BD%BF%E7%94%A8XML%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE">使用XML文件加载数据</a></p></li><li><p><a href="#%E4%BD%BF%E7%94%A8noupdate%E5%92%8Cforcecreate%E6%A0%87%E5%BF%97">使用<strong>noupdate</strong> 和<strong>forcecreate</strong> 标志</a></p></li><li><p><a href="#%E4%BD%BF%E7%94%A8CSV%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE">使用CSV文件加载数据</a></p></li><li><p><a href="#%E9%99%84%E5%8A%A0%E6%9B%B4%E6%96%B0%E5%92%8C%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB">附加更新和数据迁移</a></p></li><li><p><a href="#%E4%BB%8EXML%E6%96%87%E4%BB%B6%E4%B8%AD%E5%88%A0%E9%99%A4%E8%AE%B0%E5%BD%95">从XML文件中删除记录</a></p></li><li><p><a href="#%E4%BB%8EXML%E6%96%87%E4%BB%B6%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0">从XML文件调用函数</a></p></li></ul><span id="more"></span><h2 id="技术要求"><a href="#技术要求" class="headerlink" title="技术要求"></a>技术要求</h2><p>本章的技术要求包括在线的Odoo平台。</p><p>本章中使用的所有代码都可以从以下GitHub存储库下载：</p><p><a href="https://github.com/PacktPublishing/Odoo-14-Development-Cookbook-Fourth-Edition/tree/master/Chapter06">https://github.com/PacktPublishing/Odoo-14-Development-Cookbook-Fourth-Edition/tree/master/Chapter06</a></p><p>为了避免重复大量代码，我们将使用<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%BA%94%E7%94%A8%E6%A8%A1%E5%9E%8B%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第四章《应用模型》</a>中定义的模型。要遵循这些示例，请确保从<strong>Chapter04&#x2F;r6_hierarchy_model&#x2F;my_library</strong> 获取<strong>my_library</strong> 模块的代码。</p><h2 id="使用外部ID和命名空间"><a href="#使用外部ID和命名空间" class="headerlink" title="使用外部ID和命名空间"></a>使用外部ID和命名空间</h2><p>Odoo中的外部ID或XML ID用于识别记录。到目前为止，在本书中，我们已经在视图、菜单和操作等领域使用了XML ID。但是，我们还没有看到XML ID的真正含义。本节会让你有更深入的了解。</p><h3 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>我们将写入已经存在的记录来演示如何使用跨模块引用：</p><ol><li><p>更新<strong>my_library</strong> 模块的清单文件注册数据文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;data&#x27;</span>: [</span><br><span class="line">    <span class="string">&#x27;data/data.xml&#x27;</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure></li><li><p>在<strong>library.book</strong> 模型中创建一本新书：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;book_cookbook&quot;</span> <span class="attr">model</span>=<span class="string">&quot;library.book&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span> Odoo 14 Development Cookbook <span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>更改主公司名称：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;base.main_company&quot;</span> <span class="attr">model</span>=<span class="string">&quot;res.company&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Packt publishing<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><p>安装模块以应用更改。安装后将创建新的书籍记录<em>Odoo 14 Development Cookbook</em> ，公司将更名为<strong>Packt publishing</strong> 。</p><h3 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h3><p>XML ID是引用数据库中记录的字符串。ID本身是<strong>ir.model.data</strong> 模型的记录。该模型包含声明XML ID的模块名称、ID字符串、引用模型和引用ID等数据。</p><p>每次我们在<strong>&lt;record&gt;</strong> 标签上使用XML ID时，Odoo都会检查字符串是否已命名空间（即它是否正好包含一个点），如果没有，它会将使用当前模块名称作为命名空间。 然后，它会查找<strong>ir.model.data</strong> 中是否已经存在具有指定名称的记录。如果存在，则执行列出字段的<strong>UPDATE</strong> 语句； 如果不存在，则执行<strong>CREATE</strong> 语句。这是在记录已经存在时提供部分数据的方式，就像我们之前所做的那样。</p><p>在章的第一个示例中，记录的ID为<strong>book_cookbook</strong> 。由于它还没有命名，因此最终的外部ID将具有这样的模块名称：<strong>my_library.book_cookbook</strong> 。然后Odoo将尝试查找<strong>my_library.book_cookbook</strong> 的记录。 由于Odoo还没有该外部ID的记录，它将在<strong>library.book</strong> 模型中生成新记录。</p><p>在第二个示例中，我们使用了主公司的外部ID，即<strong>base.main_company</strong>。正如其命名空间所暗示的，它是从基本模块加载的。由于外部ID已经存在，而不是创建记录，Odoo将执行<strong>write(UPDATE)</strong> 操作更新公司名为<strong>Packt publishing</strong> 。</p><blockquote><p><strong>重要笔记</strong><br>除了更改其他模块定义的记录外，部分数据的广泛应用是使用快捷方式元素以方便的方式创建记录并在该记录上写入字段，快捷方式元素不支持：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">act_window</span> <span class="attr">id</span>=<span class="string">&quot;my_action&quot;</span> <span class="attr">name</span>=<span class="string">&quot;My action&quot;</span> <span class="attr">model</span>=<span class="string">&quot;res.partner&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;my_action&quot;</span> <span class="attr">model</span>=<span class="string">&quot;ir.actions.act_window&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;auto_search&quot;</span> <span class="attr">eval</span>=<span class="string">&quot;False&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br></pre></td></tr></table></figure></blockquote><p>在本章的<a href="#%E4%BD%BF%E7%94%A8XML%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE">使用XML文件加载数据</a>一节中使用的<strong>ref</strong> 函数也会在适当的情况下将当前模块添加为命名空间，但如果生成的XML ID不存在，则会引发错误。如果它还没有命名空间，这也适用于id属性。</p><blockquote><p><strong>提示</strong><br>如果您想查看所有外部标识符的列表，请激活开发者模式并打开菜单到<strong>Settings | Technical | Sequence &amp; Identifiers | External<br>Identifiers</strong> 。</p></blockquote><h3 id="扩展内容"><a href="#扩展内容" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>您可能迟早需要通过Python代码访问具有XML ID的记录。在这些情况下使用<strong>self.env.ref()</strong> 函数。这将返回被引用记录的浏览记录（记录集）。请注意，在这里，您始终必须传递完整的XML ID。下面是一个完整的XML ID示例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">module_name</span>&gt;</span>.<span class="tag">&lt;<span class="name">record_id</span>&gt;</span></span><br></pre></td></tr></table></figure><p>您可以从用户界面查看任何记录的XML ID。为此您需要在Odoo中激活开发者模式。请参阅<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%AE%89%E8%A3%85Odoo%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/#%E6%BF%80%E6%B4%BBOdoo%E5%BC%80%E5%8F%91%E8%80%85%E6%A8%A1%E5%BC%8F%E5%B7%A5%E5%85%B7">第一章《安装Odoo开发环境》</a>激活开发者模式。激活开发人员模式后，打开要查找其XML ID的记录的表单视图。您将在顶部栏中看到一个bug图标。从该菜单中，单击<strong>View Metadata</strong> 选项。请参阅以下屏幕截图以供参考：</p><p>   <img src="/images/Menu_to_open_a_records_metadata.png" alt="打开记录元数据的菜单"></p><blockquote><p><strong>也可以看看</strong><br>请参阅本章的<a href="#%E4%BD%BF%E7%94%A8noupdate%E5%92%8Cforcecreate%E6%A0%87%E5%BF%97">使用noupdate和forcecreate标志</a>章节，了解为什么公司名称仅在模块安装期间更改。</p></blockquote><h2 id="使用XML文件加载数据"><a href="#使用XML文件加载数据" class="headerlink" title="使用XML文件加载数据"></a>使用XML文件加载数据</h2><p>在前面的章节中，我们使用外部标识符<strong>book_cookbook</strong> 创建了新的图书记录。在本节中，我们将从XML文件中添加不同类型的数据。我们将添加一本书和一位作者作为演示数据。我们还将在我们的模块中添加一个知名出版社作为常规数据。</p><h3 id="实现步骤-1"><a href="#实现步骤-1" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>按照给定的步骤创建两个数据XML文件并将它们注册到您的<strong>__manifest__.py</strong> 文件中：</p><ol><li><p>在<strong>demo</strong> 中将名为<strong>data&#x2F;demo.xml</strong> 的文件添加到清单中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;demo&#x27;</span>: [</span><br><span class="line">    <span class="string">&#x27;data/demo.xml&#x27;</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure></li><li><p>将以下内容添加到该文件中：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">odoo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;author_pga&quot;</span> <span class="attr">model</span>=<span class="string">&quot;res.partner&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Parth Gajjar<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;author_af&quot;</span> <span class="attr">model</span>=<span class="string">&quot;res.partner&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Alexandre Fayolle<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;author_dr&quot;</span> <span class="attr">model</span>=<span class="string">&quot;res.partner&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Daniel Reis<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;author_hb&quot;</span> <span class="attr">model</span>=<span class="string">&quot;res.partner&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Holger Brunn<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;book_cookbook&quot;</span> <span class="attr">model</span>=<span class="string">&quot;library.book&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Odoo Cookbook<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;short_name&quot;</span>&gt;</span>cookbook<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;date_release&quot;</span>&gt;</span>2016-03-01<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;author_ids&quot;</span> <span class="attr">eval</span>=<span class="string">&quot;[(6, 0, [ref(&#x27;author_af&#x27;), ref(&#x27;author_dr&#x27;), ref(&#x27;author_hb&#x27;)])]&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;publisher_id&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;res_partner_packt&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">odoo</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在<strong>data</strong> 部分中将名为<strong>data&#x2F;data.xml</strong> 的文件添加到清单中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;data&#x27;</span>: [</span><br><span class="line">    <span class="string">&#x27;data/data.xml&#x27;</span>,</span><br><span class="line">    ...</span><br><span class="line">],</span><br></pre></td></tr></table></figure></li><li><p>将以下XML内容添加到<strong>data&#x2F;data.xml</strong> 文件中：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">odoo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;res_partner_packt&quot;</span> <span class="attr">model</span>=<span class="string">&quot;res.partner&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Packt Publishing<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;city&quot;</span>&gt;</span>Birmingham<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;country_id&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;base.uk&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">odoo</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><p>当你现在更新了你的模块，你会看到我们创建的出版社，如果你的数据库启用了演示数据，如<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%88%9B%E5%BB%BAOdoo%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第三章《创建Odoo附加模块》</a>中所指出的，你还会找到这本书及其作者。</p><h3 id="运行原理-1"><a href="#运行原理-1" class="headerlink" title="运行原理"></a>运行原理</h3><p>数据XML文件使用<strong>&lt;record&gt;</strong> 标签在数据库表中创建一行记录。<strong>&lt;record&gt;</strong> 标签有两个强制属性，<strong>id</strong> 和<strong>model</strong> 。对于<strong>id</strong> 属性，请参阅<a href="#%E4%BD%BF%E7%94%A8%E5%A4%96%E9%83%A8ID%E5%92%8C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4">使用外部ID和命名空间</a>章节；<strong>model</strong> 属性是指模型的<strong>_name</strong> 属性。然后，我们使用<strong>&lt;field&gt;</strong> 元素填充数据库中的列，由您命名的模型定义。该模型还决定必须填写哪些字段并定义默认值。在这种情况下，您不需要显式地为这些字段赋值。</p><p>有两种方法可以在模块清单中注册数据XML文件。一个带有<strong>data</strong> 键，第二个带有<strong>demo</strong> 键。每次安装或更新模块时都会加载<strong>data</strong> 键中的XML文件。仅当您为数据库启用演示数据时，才会加载带有<strong>demo</strong> 键的XML文件。</p><p>在第1步中，我们在清单中使用<strong>demo</strong> 注册了一个<strong>data</strong> XML文件。因为我们使用的是<strong>demo</strong> 键，所以只有在您为数据库启用了演示数据时才会加载XML文件。</p><p>在第2步中，在标量值的情况下，<strong>&lt;field&gt;</strong> 元素可以包含作为简单文本的值。如果您需要传递文件的内容（例如设置图像），请使用<strong>&lt;field&gt;</strong> 元素上的文件属性并传递相对于附加组件路径的文件名。</p><p>对于设置引用有两种方法。 最简单的是使用<strong>ref</strong> 属性，它适用于<strong>many2one</strong> 字段，并且只包含要引用的记录的XML ID。对于<strong>one2many</strong> 和 <strong>many2many</strong> 字段，我们需要使用<strong>eval</strong> 属性。这是一个通用属性，可用于运行Python代码来作为字段的值；例如使用<strong>strftime(‘%Y-01-01’)</strong> 来填充<strong>date</strong> 字段。<strong>X2many</strong> 字段应使用三个元素元组列表来填充，其中元组的第一个值决定要执行的操作。 在<strong>eval</strong> 属性中，我们可以访问一个名为<strong>ref</strong> 的函数，该函数返回以字符串传入的XML ID对应的数据库ID。这允许我们在不知道其具体ID的情况下引用记录，这在不同的数据库中可能不同，如下所示：</p><ul><li><p><strong>(2, id, False)</strong> ：这将从数据库中删除带有<strong>id</strong> 的关联记录。 元组的第三个元素被忽略。</p></li><li><p><strong>(3, id, False)</strong> ：取消带有<strong>id</strong> 的记录的从<strong>one2many</strong> 关联。请注意，此操作不会删除记录，它只是将现有记录保持原样。 元组的最后一个元素也被忽略。</p></li><li><p><strong>(4, id, False)</strong> ：添加一个记录与<strong>id</strong> 的记录的关联，并且元组的最后一个元素被忽略。这是最常使用到的，通常会使用<strong>ref</strong> 函数来获取由其XML ID已知的记录的数据库ID。</p></li><li><p><strong>(5, False, False)</strong> ：它会切断所有关联，但仍保持所关联的记录的完整性。</p></li><li><p><strong>(6, False, [id,...])</strong> ：这会清除当前引用的记录，以将它们替换为ID列表中的记录。元组的第二个元素被忽略。</p></li></ul><p>在第3步和第4步与第1步和第2步相同，仅使用<strong>data</strong> 键替换了<strong>demo</strong> 键，这意味着每次安装或升级模块时都会加载XML文件。</p><blockquote><p><strong>重要笔记</strong><br>请注意，数据文件中的顺序是很重要的，并且数据文件中的记录只能引用列表中较早的数据文件中定义的记录。这就是为什么您应该始终检查您的模块是否安装在空数据库中的原因，因为在开发过程中，您经常会在各处添加记录，这是因为之后定义的记录已经在早期更新的数据库中。<br>演示数据总是在<strong>data</strong> 键的文件之后加载，这就是本示例中的引用可生效的原因。</p></blockquote><h3 id="扩展内容-1"><a href="#扩展内容-1" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>虽然您基本上可以使用记录元素做任何事情，但有一些快捷元素可以让开发人员更方便地创建某些类型的记录。其中包括菜单项、模板和动作窗口。有关这些信息，请参阅第九章《后端视图》和第十四章《CMS网站开发》。</p><p>字段元素还可以包含函数元素，它调用模型上定义的函数来提供字段的值。请参阅<a href="#%E4%BB%8EXML%E6%96%87%E4%BB%B6%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0">从XML文件调用函数</a>章节，在该章节里，我们只需调用一个函数直接写入数据库，绕过加载机制。</p><p>前面的列表缺少<strong>0</strong> 和<strong>1</strong> 的条目，因为它们在加载数据时不是很有用。为了完整起见，它们输入如下：</p><ul><li><p><strong>(0, False, {&#39;key&#39;: value})</strong> ：这将创建引用模型的新记录，其字段从位置<strong>3</strong> 的字典中填充。元组的第二个元素被忽略。由于这些记录没有XML ID，并且每次更新模块时都会运行，从而导致重复条目，因此最好避免这种情况。相反，在它自己的记录元素中创建记录，并按照本节的工作原理部分中的说明关联它。</p></li><li><p><strong>(1, id, {&#39;key&#39;: value})</strong> ：这可用于写入已关联的记录。出于我们前面提到的相同原因，您应该在XML文件中避免使用这种语法。</p></li></ul><p>这些语法与我们在<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%BA%94%E7%AB%A0-%E5%9F%BA%E6%9C%AC%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%80%E5%8F%91%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/#%E5%88%9B%E5%BB%BA%E6%96%B0%E8%AE%B0%E5%BD%95">第五章《基本服务器端开发》</a>中的<em>创建新记录</em> 和<em>更新记录集记录的值</em> 中解释的语法相同。</p><h2 id="使用noupdate和forcecreate标志"><a href="#使用noupdate和forcecreate标志" class="headerlink" title="使用noupdate和forcecreate标志"></a>使用noupdate和forcecreate标志</h2><p>大多数附加模块具有不同类型的数据。有些数据只需要存在模块才能正常工作，其他数据不应该由用户更改，并且大多数数据可以根据用户的需要更改并且只是为了方便而提供。本节将详细说明如何处理不同的类型。首先，我们将在已经存在的记录中写入一个字段，然后我们将创建一个应该在模块更新期间重新创建的记录。</p><h3 id="实现步骤-2"><a href="#实现步骤-2" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>通过在<strong>&lt;odoo&gt;</strong> 标签或<strong>&lt;record&gt;</strong> 标签上设置某些属性，我们可以在加载数据时强制执行不同的行为：</p><ol><li><p>添加将在安装时创建但不会在后续更新中更新的发布者。但是，如果用户删除它，它将被重新创建：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">odoo</span> <span class="attr">noupdate</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;res_partner_packt&quot;</span> <span class="attr">model</span>=<span class="string">&quot;res.partner&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Packt publishing<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;city&quot;</span>&gt;</span>Birmingham<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;country_id&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;base.uk&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">odoo</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>添加图书类别，它在附加更新期间不会更改，如果用户删除它也不会重新创建：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">odoo</span> <span class="attr">noupdate</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;book_category_all&quot;</span> <span class="attr">model</span>=<span class="string">&quot;library.book.category&quot;</span> <span class="attr">forcecreate</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>All books<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">odoo</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="运行原理-2"><a href="#运行原理-2" class="headerlink" title="运行原理"></a>运行原理</h3><p><strong>&lt;odoo&gt;</strong> 标签可以有一个<strong>noupdate</strong> 属性，该属性会传递到第一次读取包含的数据记录时创建的<strong>ir.model.data</strong> 记录，从而最终成为该表中的一列。</p><p>当<strong>Odoo</strong> 安装一个插件（称为<strong>init</strong> 模式）时，所有记录都会被写入，无论<strong>noupdate</strong> 是<strong>True</strong> 还是<strong>False</strong> 。当您更新附加组件（称为<strong>update</strong> 模式）时，会检查现有XML ID以查看它们是否设置了<strong>noupdate</strong> 标志，如果是，则忽略尝试写入此XML ID的元素。如果有问题的记录被用户删除，则情况并非如此，这就是为什么您可以通过将记录上的<strong>forcecreate</strong> 标志设置为<strong>false</strong> 来强制在更新模式下不重新创建<strong>noupdate</strong> 记录。</p><blockquote><p><strong>重要笔记</strong><br>在旧版附加组件（包括8.0和之前的版本）中，您经常会发现一个<strong>&lt;openerp&gt;</strong> 元素包含一个<strong>&lt;data&gt;</strong> 元素，该元素包含<strong>&lt;record&gt;</strong> 和其他元素。这仍然是可能的，但已弃用。现在，<strong>&lt;odoo&gt;</strong> 、<strong>&lt;openerp&gt;</strong> 和<strong>&lt;data&gt;</strong> 具有完全相同的语义； 它们是用来括起XML数据的括号。</p></blockquote><h3 id="扩展内容-2"><a href="#扩展内容-2" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>如果您想使用<strong>noupdate</strong> 标志加载记录，您可以使用<strong>--init&#x3D;your_addon</strong> 或<strong>-i your_addon</strong> 参数运行Odoo服务器。这将迫使Odoo重新加载您的记录。这也将导致重新创建已删除的记录。请注意，如果模块绕过XML ID机制，例如通过在<strong>&lt;function&gt;</strong> 标签调用的Python代码中创建记录，这可能会导致重复记录和相关的安装错误。</p><p>使用此代码，您可以绕过任何<strong>noupdate</strong> 标志，但首先，请确保这确实是您想要的。解决此处介绍的场景的另一个选项是编写迁移脚本，在<a href="#%E9%99%84%E5%8A%A0%E6%9B%B4%E6%96%B0%E5%92%8C%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB">附加更新和数据迁移</a>章节中进行详细介绍。</p><blockquote><p><strong>也可看看</strong><br>Odoo还使用XML ID来跟踪插件更新后要删除的数据。如果记录在更新之前具有来自模块命名空间的XML ID，但在更新期间未恢复XML ID，则该记录及其XML ID将从数据库中删除，因为它们被认为已过时。有关此机制的深入讨论，请参阅<a href="#%E9%99%84%E5%8A%A0%E6%9B%B4%E6%96%B0%E5%92%8C%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB">附加更新和数据迁移</a>章节。</p></blockquote><h2 id="使用CSV文件加载数据"><a href="#使用CSV文件加载数据" class="headerlink" title="使用CSV文件加载数据"></a>使用CSV文件加载数据</h2><p>虽然您可以使用XML文件做任何事情，但当您需要提供大量数据时，这种格式并不是最方便的，尤其是考虑到许多人更愿意在Calc或其他电子表格软件中预处理数据。CSV格式的另一个优点是它是您使用标准导出功能时所得到的。在本节中，我们将看看导入类似表格的数据。</p><h3 id="实现步骤-3"><a href="#实现步骤-3" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>一般情况下<strong>access-control lists</strong>（<strong>ACLs</strong> 请参阅第十章《安全访问》）是一种通过CSV文件加载的数据：</p><ol><li><p>将<strong>security&#x2F;ir.model.access.csv</strong> 添加到您的清单的data列表中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;data&#x27;</span>: [</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;security/ir.model.access.csv&#x27;</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure></li><li><p>在这个文件中为我们的书籍添加一个 ACL（我们已经从<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%88%9B%E5%BB%BAOdoo%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/#%E6%B7%BB%E5%8A%A0%E8%AE%BF%E9%97%AE%E5%AE%89%E5%85%A8">第三章《创建Odoo附加模块》</a>的<em>添加访问安全</em> 中获得了一些记录）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink</span><br><span class="line">acl_library_book_user,ACL for books,model_library_book,base.group_user,1,0,0,0</span><br></pre></td></tr></table></figure></li></ol><p>至此我们拥有一个ACL允许普通用户阅读书籍记录，但不允许他们编辑、创建或删除它们。</p><h3 id="运行原理-3"><a href="#运行原理-3" class="headerlink" title="运行原理"></a>运行原理</h3><p>您只需将所有数据文件放入清单的data列表中。Odoo将使用文件扩展名来决定它是哪种类型的文件。CSV文件的一个特点是它们的文件名必须与要导入的模型的名称相匹配，在我们的例子中是<strong>ir.model.access</strong> 。 第一行需要是列名与模型的字段名完全匹配的标题。</p><p>对于标量值，您可以使用带引号的（如有必要，因为字符串本身包含引号或逗号）或不带引号的字符串。</p><p>当使用CSV文件编写<strong>many2one</strong> 字段时，Odoo首先尝试将列值解释为XML ID。 如果没有Odoo将当前模块名称添加为命名空间，并在<strong>ir.model.data</strong> 中查找结果。如果失败，模型的<strong>name_search</strong> 函数以列的值作为参数调用，返回的第一个结果。如果这也失败了，该行被认为是无效的并且Odoo会抛出一个错误。</p><blockquote><p><strong>重要笔记</strong><br>请注意，从CSV文件读取的数据始终为<strong>noupdate&#x3D;False</strong> ，并且没有方便的解决方法。这意味着您的附加组件的后续更新将始终覆盖用户所做的可能更改。如果您需要加载大量数据并且需要<strong>noupdate</strong> 这对您来说是个问题，请使用<strong>init</strong> 钩子加载CSV文件。</p></blockquote><h3 id="扩展内容-3"><a href="#扩展内容-3" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>可以使用CSV文件导入<strong>one2many</strong> 和<strong>many2many</strong> 字段，但有点棘手。通常，您最好分别创建记录并随后使用XML文件设置关系，或者使用设置关系的第二个CSV文件。</p><p>如果您确实需要在同一文件中创建关联记录，请对列进行排序，以便所有标量字段位于左侧，链接模型的字段位于右侧，列标题由链接字段的名称和链接的 模型的字段，用冒号分隔：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;id&quot;,&quot;name&quot;,&quot;model_id:id&quot;,&quot;perm_read&quot;,&quot;perm_read&quot;, &quot;group_id:name&quot;</span><br><span class="line">&quot;access_library_book_user&quot;,&quot;ACL for books&quot;,&quot;model_library_book&quot;,1, &quot;my group&quot;</span><br></pre></td></tr></table></figure><p>这将创建一个名为<strong>my group</strong> 的组；您可以通过在右侧添加列来在组记录中写入更多字段。如果您需要关联多条记录，请重复该行并根据需要更改右侧列。鉴于Odoo使用前一行的值填充空列，因此您不需要复制所有数据，添加一行时，对想要填充值的关联模型字段以外的字段只需使用空值。</p><h2 id="附加更新和数据迁移"><a href="#附加更新和数据迁移" class="headerlink" title="附加更新和数据迁移"></a>附加更新和数据迁移</h2><p>您在编写附加模块时选择的数据模型可能会出现一些弱点，因此您可能需要在附加模块的生命周期中对其进行调整。为了在没有大量操作的情况下实现这一点，Odoo支持附加模块中的版本控制，并在必要时运行迁移。</p><h3 id="实现步骤-4"><a href="#实现步骤-4" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>假设在我们模块的早期版本中<strong>date_release</strong> 字段是一个字符字段，人们在其中写下他们认为合适的任何日期作为日期。我们现在意识到我们需要这个字段来进行比较和聚合，这就是我们想要将其类型更改为<strong>Date</strong> 的原因。</p><p>Odoo在类型转换方面做得很好，但是在这种情况下，我们是靠自己的，这就是为什么我们需要提供有关如何使用安装在数据库上的先前版本的模块来转换数据库的说明，其中当前版本可以运行。让我们尝试以下步骤：</p><ol><li><p>在<strong>__manifest__.py</strong> 文件中添加版本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;version&#x27;</span>: <span class="string">&#x27;13.0.1.0.1&#x27;</span>,</span><br></pre></td></tr></table></figure></li><li><p>在<strong>migrations&#x2F;13.0.1.0.1&#x2F;pre-migrate.py</strong> 中提供预迁移代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">migrate</span>(<span class="params">cr, version</span>):</span><br><span class="line">    cr.execute(<span class="string">&#x27;ALTER TABLE library_book RENAME COLUMN date_release TO date_release_char&#x27;</span>)</span><br></pre></td></tr></table></figure></li><li><p>在<strong>migrations&#x2F;13.0.1.0.1&#x2F;post-migrate.py</strong> 中提供迁移后代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> odoo <span class="keyword">import</span> fields</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">migrate</span>(<span class="params">cr, version</span>):</span><br><span class="line">    cr.execute(<span class="string">&#x27;SELECT id, date_release_char FROM library_book&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> record_id, old_date <span class="keyword">in</span> cr.fetchall():</span><br><span class="line">        <span class="comment"># check if the field happens to be set in Odoo&#x27;s internal format</span></span><br><span class="line">        new_date = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            new_date = fields.Date.to_date(old_date)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(old_date) == <span class="number">4</span> <span class="keyword">and</span> old_date.isdigit():</span><br><span class="line">                <span class="comment"># probably a year</span></span><br><span class="line">                new_date = date(<span class="built_in">int</span>(old_date), <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> new_date:</span><br><span class="line">            cr.execute(<span class="string">&#x27;UPDATE library_book SET date_release=%s&#x27;</span>,(new_date,))   </span><br></pre></td></tr></table></figure></li></ol><p>如果没有此代码，Odoo会将旧的<strong>date_release</strong> 列重命名为<strong>date_release_moved</strong> 并创建一个新列，因为没有从字符字段到日期字段的自动转换。从用户的角度来看，<strong>date_release</strong> 中的数据将完全消失。</p><h3 id="运行原理-4"><a href="#运行原理-4" class="headerlink" title="运行原理"></a>运行原理</h3><p>第一个关键点是增加附加组件的版本号，因为迁移代码仅在版本变更时运行。在每次更新期间，Odoo将更新时清单中的版本号会写入<strong>ir_module_module</strong> 表。如果版本号包含三个或更少的组件，则版本号以Odoo的主要和次要版本作为前缀。在前面的示例中，我们明确命名了Odoo的主要版本和次要版本，这是一个很好的做法，但值为<strong>1.0.1</strong> 会产生相同的效果，因为在内部，Odoo会为带有自己主要版本和次要版本号的附加组件添加版本号前缀。通常使用长符号是一个好主意，因为您可以一眼看出插件适用于哪个版本的Odoo。</p><p>这两个迁移文件只是代码文件，不需要在任何地方注册。更新插件时，Odoo会将插件的版本（如<strong>ir_module_module</strong> 中所述）与插件清单中的版本进行比较。如果清单的版本更高（在添加Odoo的主要和次要版本之后），将搜索此插件的迁移文件夹以查看它是否包含中间版本的文件夹，直到当前更新版本的版本号。</p><p>然后在找到的文件夹中名称以<strong>pre-</strong> 开头的Python文件，加载它们，并为其定义一个名为<strong>migrate</strong> 的函数，该函数有两个参数。该函数以数据库游标作为第一个参数，当前安装的版本作为第二个参数调用。这一时间在Odoo查找插件定义的其它代码之前，因此你可以假定你的数据库结构对比此前版本没有做过任何修改。</p><p>在所有的<strong>pre-migrate</strong> 函数运行成功后，Odoo会加载模型和插件中声明的数据，这会导致数据库布局发生变化。鉴于我们在<strong>pre-migrate.py</strong> 中重命名了<strong>date_release</strong> ，Odoo将使用该名称创建正确的数据类型一个新列。</p><p>之后，使用相同的搜索算法，将搜索并执行迁移后的文件。在我们的例子中，我们需要查看每一个值，看看我们是否可以从中得到一些有用的东西；否则，我们将数据保持为<strong>NULL</strong> 。如果不是绝对必要，不要编写遍历整个表的脚本；在这种情况下，我们可能会编写一个很大且可读性差的SQL的switch语句。</p><blockquote><p><strong>重要提示</strong><br>如果您只是想重命名列，则不需要迁移脚本。在这种情况下，您可以将相关字段的<strong>oldname</strong> 参数设置为该字段的原始列名，Odoo会自动更新它。</p></blockquote><h3 id="扩展内容-4"><a href="#扩展内容-4" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>在迁移前和迁移后步骤中，您只能访问游标，如果您熟悉Odoo环境，这会变得不是很方便。在这个阶段使用模型可能会导致意想不到的结果，因为在预迁移步骤中，附加组件的模型尚未加载，并且在迁移后步骤中，由依赖于当前插件的插件定义的模型也尚未加载。 但是，如果这对您来说不是问题，也许是因为你想要使用你的插件所不涉及的模型或者是你已知这不会是一个问题的模型，那么就可以编写如下代码创建一个习惯的环境：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> odoo <span class="keyword">import</span> api, SUPERUSER_ID</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">migrate</span>(<span class="params">cr, version</span>):</span><br><span class="line">    env = api.Environment(cr, SUPERUSER_ID, &#123;&#125;)</span><br><span class="line">    <span class="comment"># env holds all currently loaded models</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>也可以看看</strong><br>在编写迁移脚本时，您经常会遇到重复性任务，例如检查列或表是否存在、重命名或将一些旧值映射到新值。在这里重新发明轮子是令人沮丧和容易出错的；如果您负担得起额外的依赖，请考虑使用<a href="https://github.com/OCA/openupgradelib">https://github.com/OCA/openupgradelib</a>。</p></blockquote><h2 id="从XML文件中删除记录"><a href="#从XML文件中删除记录" class="headerlink" title="从XML文件中删除记录"></a>从XML文件中删除记录</h2><p>在前面的章节中，我们看到了如何从XML文件创建或更新记录。有时，您希望从依赖模块中删除以前创建的记录。这可以通过<strong>&lt;delete&gt;</strong> 标签来完成。</p><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>在本节中，我们将从XML文件中添加一些类别，后删除它们。在实际情况下，您将从另一个模块创建此记录。但为简单起见，我们将在同一个XML文件中添加一些类别，如下所示：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;book_category_to_delete&quot;</span> <span class="attr">model</span>=<span class="string">&quot;library.book.category&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Test Category<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;book_category_not_delete&quot;</span> <span class="attr">model</span>=<span class="string">&quot;library.book.category&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Test Category 2<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="实现步骤-5"><a href="#实现步骤-5" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>有两种方法可以从XML文件中删除记录：</p><ul><li><p>使用先前创建的记录的XML ID：</p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">model</span>=<span class="string">&quot;library.book.category&quot;</span> <span class="attr">id</span>=<span class="string">&quot;book_category_to_delete&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>使用搜索域：</p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">model</span>=<span class="string">&quot;library.book.category&quot;</span> <span class="attr">search</span>=<span class="string">&quot;[(&#x27;name&#x27;, &#x27;ilike&#x27;, &#x27;Test&#x27;)]&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="运行原理-5"><a href="#运行原理-5" class="headerlink" title="运行原理"></a>运行原理</h3><p>您将需要使用<strong>&lt;delete&gt;</strong> 标签。要从模型中删除记录，您需要在模型属性中提供模型的名称。这是一个强制属性。</p><p>在第一种方法中，您需要提供先前从另一个模块的数据文件创建的记录的XML ID。在模块安装过程中，Odoo会尝试查找记录。如果找到给定XML ID的记录，它将删除该记录，否则将抛出错误。您只能删除从XML文件创建的记录（或具有XML ID的记录）。</p><p>第二种方法，需要在domain属性中传入<strong>domain</strong> 。在安装模块的过程中，Odoo会按这个domain搜索记录。如果找到记录，它将删除它们。如果没有记录与给定域匹配，则此选项不会抛出错误。使用此选项时要格外小心，因为它可能会删除用户的数据，因为搜索选项会删除与域匹配的所有记录。</p><blockquote><p><strong>警告</strong><br><strong>&lt;delete&gt;</strong> 在Odoo中很少使用，因为它很危险。如果您对此不小心，您可能会破坏系统。尽可能避免它。</p></blockquote><h2 id="从XML文件调用函数"><a href="#从XML文件调用函数" class="headerlink" title="从XML文件调用函数"></a>从XML文件调用函数</h2><p>您可以从XML文件创建所有类型的记录，但有时很难生成包含某些业务逻辑的数据。当用户在生产中安装依赖模块时，您可能希望修改记录。例如，假设您要创建一个模块来在线显示书籍。<strong>my_library</strong> 模块已经有一个<strong>image-cover</strong> 字段。 想象一下，在新模块中，您实现了减小图像大小并将其存储在新缩略图字段中的逻辑。现在，当用户安装这个模块时，他们可能已经有了书籍和图像。无法从XML文件中的<strong>&lt;record&gt;</strong> 标签生成缩略图。在这种情况下，您可以通过<strong>&lt;function&gt;</strong> 标签调用模型方法。</p><h3 id="实现步骤-6"><a href="#实现步骤-6" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>本节我们将使用上节中的代码。例如，我们将现有图书价格提高10美元。请注意，您可能会根据公司配置使用其他货币。</p><p>按照以下步骤从XML文件调用Python方法：</p><ol><li><p>在<strong>library.book</strong> 模型中添加<strong>_update_book_price()</strong> 方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api.model</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_update_book_price</span>(<span class="params">self</span>):</span><br><span class="line">    all_books = self.search([])</span><br><span class="line">    <span class="keyword">for</span> book <span class="keyword">in</span> all_books:</span><br><span class="line">        book.cost_price += <span class="number">10</span></span><br></pre></td></tr></table></figure></li><li><p>在数据XML文件中添加<strong>&lt;function&gt;</strong> ：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">model</span>=<span class="string">&quot;library.book&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_update_book_price&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="运行原理-6"><a href="#运行原理-6" class="headerlink" title="运行原理"></a>运行原理</h3><p>在第1步中，我们添加了<strong>_update_book_price()</strong> 方法，该方法搜索所有书籍并将价格提高10美元。 以<strong>_</strong> 开头的函数名称会被ORM认为是私有的，不能通过RPC调用。</p><p>在第2步中，我们使用了具有两个属性的<strong>&lt;function&gt;</strong> 标签：</p><ul><li><p><strong>model</strong> ：声明方法的模型名称</p></li><li><p><strong>name</strong> ：要调用的方法的名称</p></li></ul><p>当您安装此模块时，<strong>_update_book_price()</strong> 将被调用，书籍的价格将增加10美元。</p><blockquote><p><strong>重要笔记</strong><br>始终将此功能与<strong>noupdate</strong> 选项一起使用。 否则，每次更新模块时都会调用它。</p></blockquote><h3 id="扩展内容-5"><a href="#扩展内容-5" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>使用<strong>&lt;function&gt;</strong> 还可以向函数传递参数。假设您只想提高特定类别书籍的价格，并且希望将该金额作为参数发送。</p><p>为此，您需要创建一个接受类别作为参数的方法，如下所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api.model</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_book_price</span>(<span class="params">self, category, amount_to_increase</span>):</span><br><span class="line">    category_books = self.search([(<span class="string">&#x27;category_id&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, category.<span class="built_in">id</span>)])</span><br><span class="line">    <span class="keyword">for</span> book <span class="keyword">in</span> category_books:</span><br><span class="line">        book.cost_price += amount_to_increase</span><br></pre></td></tr></table></figure><p>要将类别和金额作为参数传递，需要使用<strong>eval</strong> 属性，如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">model</span>=<span class="string">&quot;library.book&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">name</span>=<span class="string">&quot;update_book_price&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">eval</span>=<span class="string">&quot;(ref(&#x27;category_xml_id&#x27;), 20)&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>当您安装该模块时，它会将给定类别的书籍的价格增加20美元。</p>]]></content>
    
    
    <summary type="html">在第四章《应用模型》中，我们看到了如何在自定义模块中声明或扩展业务模型。那一章涵盖了计算字段的编写方法，以及约束字段的方法。本章重点介绍Odoo方法定义、记录集操作和扩展继承方法的服务器端开发基础知识。有了这个，您将能够在Odoo模块中添加/修改业务逻辑。</summary>
    
    
    
    
    <category term="Odoo开发者指南" scheme="https://www.junle.org/tags/Odoo%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>Odoo14开发者指南第五章-基本服务端开发【翻译】</title>
    <link href="https://www.junle.org/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%BA%94%E7%AB%A0-%E5%9F%BA%E6%9C%AC%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%80%E5%8F%91%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/"/>
    <id>https://www.junle.org/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%BA%94%E7%AB%A0-%E5%9F%BA%E6%9C%AC%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%80%E5%8F%91%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/</id>
    <published>2022-06-14T01:14:57.000Z</published>
    <updated>2024-03-22T06:43:55.676Z</updated>
    
    <content type="html"><![CDATA[<p>在<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%BA%94%E7%94%A8%E6%A8%A1%E5%9E%8B%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第四章《应用模型》</a>中，我们看到了如何在自定义模块中声明或扩展业务模型。那一章涵盖了计算字段的编写方法，以及约束字段的方法。本章重点介绍Odoo方法定义、记录集操作和扩展继承方法的服务器端开发基础知识。有了这个，您将能够在Odoo模块中添加&#x2F;修改业务逻辑。</p><p>在本章中，我们将介绍以下内容：</p><ul><li><p><a href="#%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9E%8B%E6%96%B9%E6%B3%95%E5%92%8C%E4%BD%BF%E7%94%A8API%E8%A3%85%E9%A5%B0%E5%99%A8">定义模型方法和使用API装饰器</a></p></li><li><p><a href="#%E5%90%91%E7%94%A8%E6%88%B7%E6%8A%A5%E5%91%8A%E9%94%99%E8%AF%AF">向用户报告错误</a></p></li><li><p><a href="#%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%90%8C%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%A9%BA%E8%AE%B0%E5%BD%95%E9%9B%86">获取不同模型的空记录集</a></p></li><li><p><a href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E8%AE%B0%E5%BD%95">创建新记录</a></p></li><li><p><a href="#%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95%E9%9B%86%E8%AE%B0%E5%BD%95%E7%9A%84%E5%80%BC">更新记录集记录的值</a></p></li><li><p><a href="#%E6%90%9C%E7%B4%A2%E8%AE%B0%E5%BD%95">搜索记录</a></p></li><li><p><a href="#%E7%BB%84%E5%90%88%E8%AE%B0%E5%BD%95%E9%9B%86">组合记录集</a></p></li><li><p><a href="#%E8%BF%87%E6%BB%A4%E8%AE%B0%E5%BD%95%E9%9B%86">过滤记录集</a></p></li><li><p><a href="#%E9%81%8D%E5%8E%86%E8%AE%B0%E5%BD%95%E9%9B%86%E5%85%B3%E8%81%94">遍历记录集关联</a></p></li><li><p><a href="#%E6%8E%92%E5%BA%8F%E8%AE%B0%E5%BD%95%E9%9B%86">排序记录集</a></p></li><li><p><a href="#%E6%89%A9%E5%B1%95%E6%A8%A1%E5%9E%8B%E4%B8%AD%E5%AE%9A%E4%B9%89%E7%9A%84%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91">扩展模型中定义的业务逻辑</a></p></li><li><p><a href="#%E6%89%A9%E5%B1%95write-%E5%92%8Ccreate">扩展<strong>write()</strong> 和<strong>create()</strong></a></p></li><li><p><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%90%9C%E7%B4%A2%E8%AE%B0%E5%BD%95%E7%9A%84%E6%96%B9%E5%BC%8F">自定义搜索记录的方式</a></p></li><li><p><a href="#%E4%BD%BF%E7%94%A8read-group-%E5%88%86%E7%BB%84%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE">使用<strong>read_group()</strong> 分组获取数据</a></p></li></ul><span id="more"></span><h2 id="技术要求"><a href="#技术要求" class="headerlink" title="技术要求"></a>技术要求</h2><p>本章的技术要求包括可用的Odoo平台。</p><p>本章中使用的代码可以在<a href="https://github.com/PacktPublishing/Odoo-14-Development-Cookbook-Fourth-Edition/tree/master/Chapter05">https://github.com/PacktPublishing/Odoo-14-Development-Cookbook-Fourth-Edition/tree/master/Chapter05</a>下载。</p><h2 id="定义模型方法和使用API装饰器"><a href="#定义模型方法和使用API装饰器" class="headerlink" title="定义模型方法和使用API装饰器"></a>定义模型方法和使用API装饰器</h2><p>在Odoo模型中，类定义了字段和业务逻辑方法。在<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%BA%94%E7%94%A8%E6%A8%A1%E5%9E%8B%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第四章《应用模型》</a>中，我们看到了如何将字段添加到模型中。现在我们将看到如何向模型添加方法和业务逻辑。</p><p>在本节中我们将看到如何编写一个可以被用户界面中的按钮或应用程序中的另一段代码调用的方法。此方法将作用于<strong>Library Books</strong> 并执行所需的操作以更改所选书籍的状态。</p><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>本节假设你已经准备好一个实例，并且<strong>my_library</strong> 模块可用，如<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%88%9B%E5%BB%BAOdoo%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第三章《创建Odoo附加模块》</a>中所述。 您需要在<strong>Library Books</strong> 模型中添加一个<strong>state</strong> 字段，其定义如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> odoo <span class="keyword">import</span> models, fields, api</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    <span class="comment"># [...]</span></span><br><span class="line">    state = fields.Selection([</span><br><span class="line">        (<span class="string">&#x27;draft&#x27;</span>, <span class="string">&#x27;Unavailable&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;available&#x27;</span>, <span class="string">&#x27;Available&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;borrowed&#x27;</span>, <span class="string">&#x27;Borrowed&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;lost&#x27;</span>, <span class="string">&#x27;Lost&#x27;</span>)],</span><br><span class="line">        <span class="string">&#x27;State&#x27;</span>, default=<span class="string">&quot;draft&quot;</span>)</span><br></pre></td></tr></table></figure><p>请参阅<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%88%9B%E5%BB%BAOdoo%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第三章《创建Odoo附加模块》</a>，以获取更多信息。</p><h3 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>要在library books上定义一个方法来更改所选书籍的状态，您需要在模型定义中添加以下代码：</p><ol><li><p>添加辅助方法来检查是否允许状态转换：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api.model</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_allowed_transition</span>(<span class="params">self, old_state, new_state</span>):</span><br><span class="line">    allowed = [(<span class="string">&#x27;draft&#x27;</span>, <span class="string">&#x27;available&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;available&#x27;</span>, <span class="string">&#x27;borrowed&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;borrowed&#x27;</span>, <span class="string">&#x27;available&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;available&#x27;</span>, <span class="string">&#x27;lost&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;borrowed&#x27;</span>, <span class="string">&#x27;lost&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;lost&#x27;</span>, <span class="string">&#x27;available&#x27;</span>)]</span><br><span class="line">    <span class="keyword">return</span> (old_state, new_state) <span class="keyword">in</span> allowed</span><br></pre></td></tr></table></figure></li><li><p>添加一个方法以将某些书籍的状态更改为作为参数传递的新状态：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">change_state</span>(<span class="params">self, new_state</span>):</span><br><span class="line">    <span class="keyword">for</span> book <span class="keyword">in</span> self:</span><br><span class="line">        <span class="keyword">if</span> book.is_allowed_transition(book.state, new_state):</span><br><span class="line">            book.state = new_state</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure></li><li><p>通过调用<strong>change_state</strong> 方法添加一个更改图书状态的方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">make_available</span>(<span class="params">self</span>):</span><br><span class="line">    self.change_state(<span class="string">&#x27;available&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_borrowed</span>(<span class="params">self</span>):</span><br><span class="line">    self.change_state(<span class="string">&#x27;borrowed&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_lost</span>(<span class="params">self</span>):</span><br><span class="line">    self.change_state(<span class="string">&#x27;lost&#x27;</span>)</span><br></pre></td></tr></table></figure></li><li><p>在<strong>&lt;form&gt;</strong> 视图中添加一个按钮和状态栏。这将帮助我们从用户界面触发这些方法：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">name</span>=<span class="string">&quot;make_available&quot;</span> <span class="attr">string</span>=<span class="string">&quot;Make Available&quot;</span> <span class="attr">type</span>=<span class="string">&quot;object&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">name</span>=<span class="string">&quot;make_borrowed&quot;</span> <span class="attr">string</span>=<span class="string">&quot;Make Borrowed&quot;</span> <span class="attr">type</span>=<span class="string">&quot;object&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">name</span>=<span class="string">&quot;make_lost&quot;</span> <span class="attr">string</span>=<span class="string">&quot;Make Lost&quot;</span> <span class="attr">type</span>=<span class="string">&quot;object&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;state&quot;</span> <span class="attr">widget</span>=<span class="string">&quot;statusbar&quot;</span>/&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span>   </span><br></pre></td></tr></table></figure></li></ol><p>更新或安装模块以使这些更改可用。</p><h3 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h3><p>本节的代码定义了一些方法。它们是普通的Python方法，它们的第一个参数是<strong>self</strong> ，也可以有其他参数。一些方法用<strong>odoo.api</strong> 模块中的装饰器装饰。</p><blockquote><p><strong>提示</strong><br>API装饰器最初是在Odoo 9.0中引入的，用于支持新旧框架。从Odoo 10.0开始，不再支持旧的API，但仍然使用一些装饰器，例如<strong>@api.model</strong> 。</p></blockquote><p>编写新方法时，如果不使用任何装饰器，则该方法将在记录集上执行。在这样的方法中，self是一个可以引用任意数量的数据库记录（这包括空记录集），并且代码通常会循环遍历<strong>self</strong> 中的记录以对每个单独的记录执行某些操作。</p><p><strong>@api.model</strong> 装饰器类似，但它用于仅对模型很重要的方法，而不是记录集的内容，方法不对其进行操作。 这个概念类似于Python的<strong>@classmethod</strong> 装饰器。</p><p>在第1步中，我们创建了<strong>is_allowed_transition()</strong> 方法。此方法的目的是验证从一种状态到另一种状态的转换是否有效。允许列表中的元组是可用的转换。例如，我们希望不允许从<strong>lost</strong> 状态转换到<strong>borrowed</strong> 状态，这就是我们没有加入<code>(&#39;lost, &#39;borrowed&#39;)</code>的原因。</p><p>在第2步中，我们创建了<strong>change_state()</strong> 方法。此方法的目的是更改图书的状态。调用此方法时，它将书的状态更改为<strong>new_state</strong> 参数给定的状态。如果允许转换它只会更改图书状态。我们在这里使用了一个<strong>for</strong> 循环，因为<strong>self</strong> 可以包含多个记录集。</p><p>在第3步中，我们通过调用<strong>change_state()</strong> 方法创建了更改图书状态的方法。在我们的例子中，这个方法将由添加到用户界面的按钮触发。</p><p>在第4步中，我们在<strong>&lt;form&gt;</strong> 视图中添加了<strong>&lt;button&gt;</strong> 标签。 单击此按钮后，Odoo Web 客户端将调用<strong>name</strong> 属性中的Python函数。 请参阅第九章《后端视图》中的<em>向表单添加按钮</em> 一节，了解如何从用户界面调用此类方法。我们还添加了带有状态栏小部件的状态字段，以在<strong>&lt;form&gt;</strong> 视图中显示图书的状态。</p><p>当用户从用户界面单击按钮时，将调用步骤3中的方法之一。在这里，<strong>self</strong> 将是包含<strong>library.book</strong> 模型记录的记录集。之后我们调用<strong>change_state()</strong> 方法并根据单击的按钮传递适当的参数。</p><p>当调用<strong>change_state()</strong> 时，<strong>self</strong> 是<strong>library.book</strong> 模型的相同记录集。<strong>change_state()</strong> 方法的主体循环遍历<strong>self</strong> 以处理记录集中的每一本书。循环遍历<strong>self</strong> 一开始看起来很奇怪，但你很快就会习惯这种模式。</p><p>在循环内部<strong>change_state()</strong> 调用<strong>is_allowed_transition()</strong> ,它使用<strong>book</strong> 局部变量进行的，但它可以在<strong>library.book</strong> 模型的任何记录集上进行，包括例如<strong>self</strong> ，因为<strong>is_allowed_transition()</strong> 是使用<strong>@api.model</strong> 修饰的。如果允许转换，则<strong>change_state()</strong> 通过为记录集的属性分配一个值来将新状态分配给书籍。这仅对长度为<strong>1</strong> 的记录集有效，用于确保和遍历<strong>self</strong> 的情况一致。</p><h2 id="向用户报告错误"><a href="#向用户报告错误" class="headerlink" title="向用户报告错误"></a>向用户报告错误</h2><p>在方法执行期间，有时需要中止处理，因为用户请求的操作无效或已满足错误条件。本节向你展示了如何通过显示有用的错误消息来管理这些情况。</p><h3 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h3><p>本节假设你已经准备好一个实例，并且<strong>my_library</strong> 插件模块可用，如前一节中所述。</p><h2 id="实现步骤-1"><a href="#实现步骤-1" class="headerlink" title="实现步骤"></a>实现步骤</h2><p>我们将对上一节中的<strong>change_state</strong> 方法进行改造，并在用户尝试更改<strong>is_allowed_transition</strong> 方法不允许的状态时显示有用的消息。 执行以下步骤开始：</p><ol><li><p>在Python文件的开头添加以下导入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> odoo.exceptions <span class="keyword">import</span> UserError</span><br><span class="line"><span class="keyword">from</span> odoo.tools.translate <span class="keyword">import</span> _</span><br></pre></td></tr></table></figure></li><li><p>修改<strong>change_state</strong> 方法并从<strong>else</strong> 部分抛出<strong>UserError</strong> 异常：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">change_state</span>(<span class="params">self, new_state</span>):</span><br><span class="line">    <span class="keyword">for</span> book <span class="keyword">in</span> self:</span><br><span class="line">        <span class="keyword">if</span> book.is_allowed_transition(book.state, new_state):</span><br><span class="line">            book.state = new_state</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg = _(<span class="string">&#x27;Moving from %s to %s is not allowed&#x27;</span>) % (book.state, new_state)</span><br><span class="line">            <span class="keyword">raise</span> UserError(msg)</span><br></pre></td></tr></table></figure></li></ol><h3 id="运行原理-1"><a href="#运行原理-1" class="headerlink" title="运行原理"></a>运行原理</h3><p>当Python中抛出异常时，它会向上传播调用堆栈，直到它被处理。在Odoo中，<strong>RPC (remote procedure call)</strong> 层会响应Web客户端捕获所有异常，并根据异常类在Web客户端上触发不同的行为。</p><p><strong>odoo.exceptions</strong> 中未定义的任何异常都将作为内部服务器错误（<strong>HTTP状态500</strong> ）与堆栈跟踪一起处理。<strong>UserError</strong> 将在用户界面中显示错误消息。本节的代码引发<strong>UserError</strong> 以确保消息以用户友好的方式显示。在所有情况下，当前数据库事务都会回滚。</p><p>我们正在使用一个名字奇怪的函数：<strong>_()</strong>，它是在<strong>odoo.tools.translate</strong> 中定义的。此函数用于将字符串标记为可翻译，并在运行时根据上下文中的语言检索已翻译的字符串。有关这方面的更多信息，请查阅第十一章《国际化》。</p><blockquote><p><strong>重要提示</strong><br>使用<strong>_()</strong> 函数时，请确保只传递带有插值占位符的字符串，而不是整个插值字符串。例如，<strong>_(‘Warning: could not find %s’) % value</strong> 是正确的，但<strong>_(‘Warning: could not find %s’ % value)</strong> 是不正确的，因为第一个字符串不能在翻译数据库中找到替换值。</p></blockquote><h3 id="扩展内容"><a href="#扩展内容" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>有时您正在处理容易出错的代码，这意味着您正在执行的操作可能会产生错误。Odoo将捕获此错误并向用户显示回溯。如果您不想向用户显示完整的错误日志，您可以缓存错误并使用有意义的消息引发自定义异常。在提供的示例中，我们从<strong>try…cache</strong> 块生成<strong>UserError</strong>，因此Odoo现在不会显示完整的错误日志，而是显示带有有意义消息的警告：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">post_to_webservice</span>(<span class="params">self, data</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        req = requests.post(<span class="string">&#x27;http://my-test-service.com&#x27;</span>, data=data, timeout=<span class="number">10</span>)</span><br><span class="line">        content = req.json()</span><br><span class="line">    <span class="keyword">except</span> IOError:</span><br><span class="line">        error_msg = _(<span class="string">&quot;Something went wrong during data submission&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span> UserError(error_msg)</span><br><span class="line">    <span class="keyword">return</span> content</span><br></pre></td></tr></table></figure><p>在<strong>odoo.exceptions</strong> 中定义了更多的异常类，它们都派生自基本的遗留的<strong>except_orm</strong> 异常类。它们中的大多数仅在内部使用，除了以下内容：</p><ul><li><strong>ValidationError</strong> ：当不遵守字段上的Python约束时会引发此异常。请参阅<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%BA%94%E7%94%A8%E6%A8%A1%E5%9E%8B%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/#%E5%90%91%E6%A8%A1%E5%9E%8B%E6%B7%BB%E5%8A%A0%E7%BA%A6%E6%9D%9F%E9%AA%8C%E8%AF%81">第四章《应用模型》</a><em>向模型添加约束验证</em> 以获取更多信息。</li><li><strong>AccessError</strong> ：当用户尝试访问不允许的内容时，通常会自动生成此错误。如果要显示代码中的访问错误，可以手动引发错误。</li><li><strong>RedirectWarning</strong> ：使用此错误您可以显示带有错误消息的重定向按钮。你需要给这个异常传递两个参数：第一个参数是action ID，第二个参数是错误信息。</li><li><strong>Warning</strong> ：在Odoo 8.0中，<strong>odoo.exceptions.Warning</strong> 与9.0及更高版本中的<strong>UserError</strong> 所起的作用是相同的。它现在已被弃用，因为该名称具有欺骗性（这是一个错误，而不是警告）并且它与Python内置的警告类发生冲突。它只是为了向后兼容而保留的，您应该在代码中使用<strong>UserError</strong> 。</li></ul><h2 id="获取不同模型的空记录集"><a href="#获取不同模型的空记录集" class="headerlink" title="获取不同模型的空记录集"></a>获取不同模型的空记录集</h2><p>在编写Odoo代码时，当前模型的方法可以通过<strong>self</strong> 获得。如果您需要处理不同的模型，则无法直接实例化该模型的类；首先您需要获取该模型的记录集。</p><p>本节向您展示了如何在模型方法中为在Odoo中注册的任何模型获取空记录集。</p><h3 id="准备工作-2"><a href="#准备工作-2" class="headerlink" title="准备工作"></a>准备工作</h3><p>本节将重用<strong>my_library</strong> 附加模块中库示例的设置。</p><p>我们将在<strong>library.book</strong> 模型中编写一个小方法并搜索所有<strong>library.members</strong>。为此我们需要为<strong>library.members</strong> 获取一个空记录集。确保您已添加<strong>library.members</strong> 模型和该模型的访问权限。</p><h3 id="实现步骤-2"><a href="#实现步骤-2" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>要在<strong>library.book</strong> 的方法中获取<strong>library.members</strong> 的记录集，您需要执行以下步骤：</p><ol><li><p>在<strong>LibraryBook</strong> 类中添加名为<strong>get_all_library_members</strong> 方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_all_library_members</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># This is an empty recordset of model library.member</span></span><br><span class="line">        library_member_model = self.env[<span class="string">&#x27;library.member&#x27;</span>]</span><br><span class="line">        all_members = library_member_model.search([])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ALL MEMBERS:&quot;</span>, all_members)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure></li><li><p>在<strong>&lt;form&gt;</strong> 视图添加一个按钮来调用我们的方法：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">name</span>=<span class="string">&quot;log_all_library_members&quot;</span> <span class="attr">string</span>=<span class="string">&quot;Log Members&quot;</span> <span class="attr">type</span>=<span class="string">&quot;object&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li></ol><p>更新模块以应用更改。之后您将在本书的<strong>&lt;form&gt;</strong> 视图中看到<strong>Log Members</strong> 按钮。单击该按钮后，您将在服务器日志中看到该成员的记录集。</p><h3 id="运行原理-2"><a href="#运行原理-2" class="headerlink" title="运行原理"></a>运行原理</h3><p>在启动时Odoo加载所有模块并组合从模型派生的各种类，并定义或扩展给定模型。这些类存储在Odoo注册表中，按名称索引。任何记录集的<strong>env</strong> 属性（可用作<strong>self.env</strong> ）是<strong>odoo.api</strong> 模块中定义的<strong>Environment</strong> 类的一个实例。</p><p><strong>Environment</strong> 类在Odoo开发中起着核心作用：</p><ul><li>它通过模拟Python字典提供对注册表的快捷访问。如果您知道要查找的模型的名称，可通过<strong>self.env[model_name]</strong> 来获取该模型的空记录集。此外，记录集将共享<strong>self</strong> 的环境。</li><li>它有一个<strong>cr</strong> 属性，这是一个可以用来传递原生<strong>SQL</strong> 查询的数据库游标。有关这方面的更多信息，请参阅第八章《高级服务器端开发》中的<em>执行原生SQL查询</em> 。</li><li>它有一个<strong>user</strong> 属性，是对当前执行的用户的引用。请查看第八章《高级服务器端开发》中的<em>更改执行操作的用户</em> 以了解更多信息。</li><li>它有一个<strong>context</strong> 属性，这是一个包含调用上下文的字典。这包括有关用户语言、时区、当前记录选择等的信息。有关这方面的更多信息，请参阅第八章《高级服务器端开发》中的<em>使用修改的上下文调用方法</em> 方法一节。</li></ul><p>对<strong>search()</strong> 的调用将在稍后的<a href="#%E6%90%9C%E7%B4%A2%E8%AE%B0%E5%BD%95">搜索记录</a>中解释</p><blockquote><p><strong>也可以看看</strong><br>有时您想使用环境的修改版本，一个这样的例子是您想要一个具有不同用户和语言的环境。在第八章《高级服务器端开发》中您将学习如何在运行时修改环境。</p></blockquote><h2 id="创建新记录"><a href="#创建新记录" class="headerlink" title="创建新记录"></a>创建新记录</h2><p>编写业务逻辑方法时的一个常见的要求是创建新记录。本节解释了如何创建<strong>library.book.category</strong> 模型的记录。对于我们的示例，我们将为<strong>library.book.category</strong> 模型创建虚拟类别的方法。要触发此方法，我们将在<strong>&lt;form&gt;</strong> 视图中添加一个按钮。</p><h3 id="准备工作-3"><a href="#准备工作-3" class="headerlink" title="准备工作"></a>准备工作</h3><p>您需要知道要为其创建记录的模型的结构，尤其是它们的名称和类型，以及这些字段上存在的任何约束（例如其中一些是否是强制性的）。</p><p>本节我们将重用<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%BA%94%E7%94%A8%E6%A8%A1%E5%9E%8B%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第四章《应用模型》</a>的<strong>my_library</strong> 模块。看下面的例子快速回忆<strong>library.book.category</strong> 模型：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BookCategory</span>(models.Model):</span><br><span class="line">    _name = <span class="string">&#x27;library.book.category&#x27;</span></span><br><span class="line">    name = fields.Char(<span class="string">&#x27;Category&#x27;</span>)</span><br><span class="line">    description = fields.Text(<span class="string">&#x27;Description&#x27;</span>)</span><br><span class="line">    parent_id = fields.Many2one(</span><br><span class="line">        <span class="string">&#x27;library.book.category&#x27;</span>,</span><br><span class="line">        string=<span class="string">&#x27;Parent Category&#x27;</span>,</span><br><span class="line">        ondelete=<span class="string">&#x27;restrict&#x27;</span>,</span><br><span class="line">        index=<span class="literal">True</span></span><br><span class="line">    )</span><br><span class="line">    child_ids = fields.One2many(</span><br><span class="line">        <span class="string">&#x27;library.book.category&#x27;</span>, <span class="string">&#x27;parent_id&#x27;</span>,</span><br><span class="line">        string=<span class="string">&#x27;Child Categories&#x27;</span>)</span><br></pre></td></tr></table></figure><p>确保您已经为<strong>library.book.category</strong> 模型添加了菜单、视图和访问权限。</p><h2 id="实现步骤-3"><a href="#实现步骤-3" class="headerlink" title="实现步骤"></a>实现步骤</h2><p>要创建具有一些子类别，您需要执行以下步骤：</p><ol><li><p>在<strong>library.book.category</strong> 模型中创建一个名为<strong>create_categories</strong> 的方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create_categories</span>(<span class="params">self</span>):</span><br><span class="line">   ......</span><br></pre></td></tr></table></figure></li><li><p>在此方法的主体内，为第一个子类别的字段准备一个值字典：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">categ1 = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Child category 1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;description&#x27;</span>: <span class="string">&#x27;Description for child 1&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>为第二类字段准备一个值字典：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">categ2 = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Child category 2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;description&#x27;</span>: <span class="string">&#x27;Description for child 2&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>为父类别的字段准备一个值字典：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">parent_category_val = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Parent category&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;Description for parent category&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;child_ids&#x27;</span>: [</span><br><span class="line">        (<span class="number">0</span>, <span class="number">0</span>, categ1),</span><br><span class="line">        (<span class="number">0</span>, <span class="number">0</span>, categ2),</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>调用<strong>create()</strong> 方法创建新记录：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">record = self.env[<span class="string">&#x27;library.book.category&#x27;</span>].create(parent_category_val)</span><br></pre></td></tr></table></figure></li><li><p>在<strong>&lt;form&gt;</strong> 视图中添加一个按钮以从用户界面触发<strong>create_categories</strong> 方法：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">name</span>=<span class="string">&quot;create_categories&quot;</span> <span class="attr">string</span>=<span class="string">&quot;Create Categories&quot;</span> <span class="attr">type</span>=<span class="string">&quot;object&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="运行原理-3"><a href="#运行原理-3" class="headerlink" title="运行原理"></a>运行原理</h3><p>要为模型创建新记录，我们可以在与模型相关的任何记录集上调用<strong>create(values)</strong> 方法。此方法返回一个长度为<strong>1</strong> 的新记录集，其中包含新记录，其字段值在值字典中指定。</p><p>在字典中键是字段的名称，值是对应于字段的值。根据字段类型您需要为值传递不同的Python数据类型：</p><ul><li><strong>Text</strong> 字段对应Python的字符串。</li><li><strong>Float</strong> 和<strong>Interger</strong> 字段对应Python的浮点型和整型。</li><li><strong>Boolean</strong> 字段对应Python的布尔型。</li><li><strong>Date</strong> 字段对应Python的<strong>datetime.date</strong>对象。</li><li><strong>Datetime</strong> 字段对应Python的<strong>datetime.datetime</strong>对象。</li><li><strong>Binary</strong> 字段的值是Base64编码的字符串。Python标准库中的<strong>base64</strong> 模块提供了诸如<strong>encodebytes(bytestring)</strong> 之类的方法来对Base64 中的字符串进行编码。</li><li><strong>Many2one</strong> 字段的值以整数形式给出，该整数必须是关联记录的数据库ID。</li><li><strong>One2many</strong> 和<strong>Many2many</strong> 字段使用特殊语法，该值是一个包含三个元素的元组的列表，如下所示：</li></ul><table><thead><tr><th>Tuple</th><th align="center">Effect</th></tr></thead><tbody><tr><td>(0, 0, dict_val)</td><td align="center">创建与主记录关联的新记录。</td></tr><tr><td>(6, 0, id_list)</td><td align="center">在正在创建的记录和现有记录之间创建关联，其ID在名为<code>id_list</code>的Python列表中。 注意：当在<code>One2many</code> 字段上使用时，这会删除此前关联中的记录。</td></tr></tbody></table><p>本节中我们为我们想要创建的公司中的两个联系人创建字典，然后我们使用我们解释过的<strong>(0, 0, dict_val)</strong> 语法在正在创建的公司的字典的<strong>child_ids</strong> 条目中使用这些字典。</p><p>在步骤5中调用<strong>create()</strong> 时，会创建三个记录：</p><ul><li>一个用于父书类别，由<strong>create</strong> 返回。</li><li>子书类别的两条记录，在<strong>record.child_ids</strong> 中可用。</li></ul><h3 id="扩展内容-1"><a href="#扩展内容-1" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>如果模型为某些字段定义了一些默认值，则不需要做任何特别的事情。<strong>create()</strong> 将自动处理字典中不存在的字段的默认值。</p><p><strong>create()</strong> 方法还支持批量创建记录。要批量创建多条记录，您需要将多个值的列表传递给<strong>create()</strong> 方法，如下例所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">categ1 = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Category 1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;description&#x27;</span>: <span class="string">&#x27;Description for Category 1&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">categ2 = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Category 2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;description&#x27;</span>: <span class="string">&#x27;Description for Category 2&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">multiple_records = self.env[<span class="string">&#x27;library.book.category&#x27;</span>].create([categ1, categ2])</span><br></pre></td></tr></table></figure><h2 id="更新记录集记录的值"><a href="#更新记录集记录的值" class="headerlink" title="更新记录集记录的值"></a>更新记录集记录的值</h2><p>业务逻辑通常要求我们通过更改某些字段的值来更新记录。本节向你展示了如何修改partner的<strong>date</strong> 字段。</p><h3 id="准备工作-4"><a href="#准备工作-4" class="headerlink" title="准备工作"></a>准备工作</h3><p>本章将使用与上一节相同的<strong>library.book</strong> 定义。您可以参考这个简化的定义来了解这些字段。</p><p>我们在<strong>library.book</strong> 模型中有<strong>date_release</strong> 字段。出于说明目的，我们将通过单击按钮更新此字段。</p><h3 id="实现步骤-4"><a href="#实现步骤-4" class="headerlink" title="实现步骤"></a>实现步骤</h3><ol><li><p>要实现更新书籍的<strong>data_update</strong> 字段，你可以新增一个名为<strong>change_update_date()</strong> 的方法，它的定义如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">change_release_date</span>(<span class="params">self</span>):</span><br><span class="line">    self.ensure_one()</span><br><span class="line">    self.date_release = fields.Date.today()</span><br></pre></td></tr></table></figure></li><li><p>然后你需要在<strong>&lt;form&gt;</strong> 视图中添加一个按钮，定义如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">name</span>=<span class="string">&quot;change_release_date&quot;</span> <span class="attr">string</span>=<span class="string">&quot;Update Date&quot;</span> <span class="attr">type</span>=<span class="string">&quot;object&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>重新启动服务器并更新<strong>my_library</strong> 模块以查看更改。单击更新日期按钮后，更新日期将更改。</p></li></ol><h3 id="运行原理-4"><a href="#运行原理-4" class="headerlink" title="运行原理"></a>运行原理</h3><p>该方法首先通过调用<strong>ensure_one()</strong> 检查作为<strong>self</strong> 传递的<strong>book</strong> 记录集是否恰好包含一条记录。如果不是这种情况，此方法将引发异常，并且处理将中止。这是必要的，因为我们不想更改多条记录的日期。如果要更新多个值，可以删除<strong>ensure_one()</strong> 并使用记录集上的循环更新属性。</p><p>最后，该方法修改书籍记录的属性值。它使用当前日期更新<strong>date_release</strong> 字段。只需修改记录集的字段属性，就可以进行写操作。</p><h3 id="扩展内容-2"><a href="#扩展内容-2" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>如果您想将新值写入记录字段，可以使用三个选项：</p><ul><li><p>选项一是本节中使用的选项。它通过将值直接分配给表示记录字段的属性，这种方法可用在所有上下文中。它不可能一次性为所有记录集元素赋值，因此您需要遍历记录集，除非您确定您只处理一条记录。</p></li><li><p>选项二是通过将字典映射字段名称传递给您要设置的值来使用<strong>update()</strong> 方法来赋值。这也仅适用于长度为<strong>1</strong> 的记录集。当您需要在同一笔记录一次更新多个字段的值时，它可以节省一些输入。将本节的第2步重写为以下内容来使用此选项：</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">change_update_date</span>(<span class="params">self</span>):</span><br><span class="line">    self.ensure_one()</span><br><span class="line">    self.update(&#123;</span><br><span class="line">        <span class="string">&#x27;date_release&#x27;</span>: fields.Datetime.now(),</span><br><span class="line">        <span class="string">&#x27;another_field&#x27;</span>: <span class="string">&#x27;value&#x27;</span></span><br><span class="line">         ...</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></li><li><p>选项三是调用<strong>write()</strong> 方法，传递一个将字段名称映射到您要设置的值的字典。 此方法适用于任意大小的记录集，并且当前两个选项对每个记录和每个字段执行一次数据库调用时，将在一次数据库操作中使用指定值更新所有记录。但是，它有一些限制：如果数据库中还没有记录，它就不起作用（有关这方面的更多信息，请参阅第八章《高级服务器端开发》中的关于<em>定义onchange方法</em> ）。此外，在编写关联字段时，它需要一种特殊的格式，类似于<strong>create()</strong> 方法使用的格式。查看下表以了解用于为关系字段生成不同值的格式：</p><table><thead><tr><th>Tuple</th><th align="center">Effect</th></tr></thead><tbody><tr><td>(0, 0, dict_val)</td><td align="center">这将创建一个与主记录关联的新记录。</td></tr><tr><td>(1, id, dict_val)</td><td align="center">这将使用提供的值更新具有指定ID的关联记录。</td></tr><tr><td>(2, id)</td><td align="center">这将从关联记录中删除具有指定ID的记录，并从数据库中删除。</td></tr><tr><td>(3, id)</td><td align="center">这将从关联记录中删除具有指定ID的记录。该记录不会从数据库中删除。</td></tr><tr><td>(4, id)</td><td align="center">这会将具有提供的ID的现有记录添加到相关记录列表中。</td></tr><tr><td>(5, )</td><td align="center">这将删除所有其他相关记录，相当于为每个关联id调用**(3, id)** 。</td></tr><tr><td>(6, 0, id_list)</td><td align="center">这会在正在更新的记录与现有记录之间创建关联，其ID在名为<strong>id_list</strong> 的Python列表中。</td></tr></tbody></table></li></ul><blockquote><p><strong>重要提示</strong><br>操作类型 <strong>1、2、3和5</strong> 不能与<strong>create()</strong> 方法一起使用。</p></blockquote><h2 id="搜索记录"><a href="#搜索记录" class="headerlink" title="搜索记录"></a>搜索记录</h2><p>搜索记录也是业务逻辑方法中的常见操作。本节向您展示如何按名称和类别查找书籍。</p><h3 id="准备工作-5"><a href="#准备工作-5" class="headerlink" title="准备工作"></a>准备工作</h3><p>本章将使用与上一节相同的<strong>library.book</strong> 定义。我们将新增一个名为<strong>find_book(self)</strong> 的新方法。</p><h3 id="实现步骤-5"><a href="#实现步骤-5" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>要查找书籍，您需要执行以下步骤：</p><ol><li><p>在<strong>library.book</strong> 模型种添加<strong>find_book</strong> 方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">find_book</span>(<span class="params">self</span>):</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></li><li><p>为您的条件编写搜索域：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">domain = [</span><br><span class="line">    <span class="string">&#x27;|&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&amp;&#x27;</span>, (<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;ilike&#x27;</span>, <span class="string">&#x27;Book Name&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;category_id.name&#x27;</span>, <span class="string">&#x27;ilike&#x27;</span>, <span class="string">&#x27;Category Name&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;&amp;&#x27;</span>, (<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;ilike&#x27;</span>, <span class="string">&#x27;Book Name 2&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;category_id.name&#x27;</span>, <span class="string">&#x27;ilike&#x27;</span>, <span class="string">&#x27;Category Name 2&#x27;</span>)</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p>使用域调用<strong>search()</strong> 方法，这将返回记录集：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books = self.search(domain</span><br></pre></td></tr></table></figure></li></ol><p>书籍变量将有一个搜索书籍的记录集。您可以打印或记录该变量以在服务器日志中查看结果。</p><h3 id="运行原理-5"><a href="#运行原理-5" class="headerlink" title="运行原理"></a>运行原理</h3><p>第1部定义方法。</p><p>第2步局部变量中创建搜索域。通常您会在搜索调用中看到这种创建内联，但对于复杂的域，最好单独定义它。</p><blockquote><p>有关搜索域语法的完整说明，请参阅第九章《后端视图》中的<em>在记录列表上定义域过滤器</em> 。</p></blockquote><p>第3步使用域调用<strong>search()</strong> 方法。该方法返回一个记录集，其中包含与域匹配的所有记录，然后可以进一步处理。在本节中我们只使用域调用方法，但也支持以下关键字参数：</p><ul><li><p><strong>offset&#x3D;N</strong> ：这用于跳过与查询匹配的前<strong>N</strong> 条记录。这可以与<strong>limit</strong> 一起使用来实现分页或在处理大量记录时减少内存消耗。它的默认值为<strong>0</strong> 。</p></li><li><p><strong>limit&#x3D;N</strong> ：表示最多返回<strong>N</strong> 条记录。默认情况下是没有限制。</p></li><li><p><strong>order&#x3D;sort_specification</strong> ：这用于返回的记录集中的排序。 默认情况下，顺序由模型类的<strong>_order</strong> 属性给出。</p></li><li><p><strong>count&#x3D;boolean</strong> ：如果为<strong>True</strong> ，则返回记录数而不是记录集。它默认为<strong>False</strong> 。</p><blockquote><p><strong>重要提示</strong><br>我们建议使用<strong>search_count(domain)</strong> 方法而不是<strong>search(domain, count&#x3D;True)</strong> ，因为该方法的名称以更清晰的方式传达了行为。两者都会给出相同的结果。</p></blockquote></li></ul><p>有时您需要从另一个模型中搜索，以<strong>self</strong> 来搜索将返回当前模型的记录集。要从另一个模型中搜索，我们需要为模型获取一个空记录集。例如，假设我们要搜索一些联系人。为此，我们需要在<strong>res.partner</strong> 模型上使用<strong>search()</strong> 方法。请参考以下代码，这里我们得到<strong>res.partner</strong> 的空记录集来搜索联系人：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">find_partner</span>(<span class="params">self</span>):</span><br><span class="line">    PartnerObj = self.env[<span class="string">&#x27;res.partner&#x27;</span>]</span><br><span class="line">    domain = [</span><br><span class="line">        <span class="string">&#x27;&amp;&#x27;</span>, (<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;ilike&#x27;</span>, <span class="string">&#x27;Parth Gajjar&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;company_id.name&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;Odoo&#x27;</span>)</span><br><span class="line">    ]</span><br><span class="line">    partner = PartnerObj.search(domain)</span><br></pre></td></tr></table></figure><p>在上面的代码中，你可以在域中省略’<strong>&amp;</strong> ‘，因为当你不指定域时，Odoo会默认使用’<strong>&amp;</strong> ‘。</p><h3 id="扩展内容-3"><a href="#扩展内容-3" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>我们之前说过<strong>search()</strong> 方法返回所有匹配域的记录。这实际上并不完全正确。安全规则确保用户只获得他们具有<strong>读取</strong> 访问权限的那些记录。</p><p>此外，如果模型有一个名为<strong>active</strong> 的布尔字段，并且没有搜索域的术语在该字段上指定条件，则搜索会添加一个隐式条件以仅返回<strong>active&#x3D;True</strong> 的记录。 因此，如果您希望搜索返回某些内容，但只得到空记录集，请确保检查<strong>active</strong> 字段的值（如果存在）以检查记录规则。</p><p>有关不添加隐式<strong>active&#x3D;True</strong> 条件的方法，请参阅第八章《高级服务器端开发》中的<em>使用不同上下文调用方法</em>一节。查看第十章《安全访问》中的<em>使用记录规则限制记录访问</em> 了解有关记录级访问规则的更多信息。</p><p>如果由于某种原因，您需要自己编写原生SQL查询来查找记录ID，请确保使用<strong>self.env[‘record.model’].search([(‘id’, ‘in’, tuple(ids)) ]).ids</strong> 在检索ID之后以确保应用安全规则。这在使用记录规则来区分的多公司的Odoo实例中尤其重要。</p><h2 id="组合记录集"><a href="#组合记录集" class="headerlink" title="组合记录集"></a>组合记录集</h2><p>有时，您会发现您获得的记录集并非您所需要的。本节将展示各种组合它们的方法。</p><h3 id="准备工作-6"><a href="#准备工作-6" class="headerlink" title="准备工作"></a>准备工作</h3><p>在开始学习本节内容之前，你需要有两个或多个相同模型的记录集。</p><h3 id="实现步骤-6"><a href="#实现步骤-6" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>执行以下步骤以对记录集执行常见操作：</p><ol><li><p>要将两个记录集合并为一个，同时保留它们的顺序，请使用以下操作：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = recordset1 + recordset2</span><br></pre></td></tr></table></figure></li><li><p>要将两个记录集合并为一个，同时确保结果中没有重复项，请使用以下操作：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = recordset1 | recordset2</span><br></pre></td></tr></table></figure></li><li><p>要查找两个记录集共有的记录，请使用以下操作:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = recordset1 &amp; recordset2</span><br></pre></td></tr></table></figure></li></ol><h3 id="运行原理-6"><a href="#运行原理-6" class="headerlink" title="运行原理"></a>运行原理</h3><p>记录集的类重载了各种Python的运算符。以下是可用于记录集的最有用的Python运算符的汇总表：</p><table><thead><tr><th>Oprator</th><th align="center">Action performed</th></tr></thead><tbody><tr><td>R1 + R2</td><td align="center">这将返回一个新记录集，其中包含来自R1的记录，然后是来自R2的记录。这会在记录集中生成重复记录。</td></tr><tr><td>R1 - R2</td><td align="center">这将返回一个新记录集，其中包含R1中不在R2中的记录，保留排序。</td></tr><tr><td>R1 &amp; R2</td><td align="center">这将返回一个新记录集，其中包含属于R1和R2的所有记录（记录集的交集）。此处不保留顺序，但没有重复。</td></tr><tr><td>R1</td><td align="center">R2</td></tr><tr><td>R1 &#x3D;&#x3D; R2</td><td align="center">如果两个记录集包含相同的记录，则为<strong>True</strong> 。</td></tr><tr><td>R1 &lt;&#x3D; R2</td><td align="center">如果R1中的所有记录都是R2的子集，则为<strong>True</strong> 。</td></tr><tr><td>R1 &lt; R2</td><td align="center">如果R1中的所有记录都是R2的子集，则为<strong>True</strong> 。</td></tr><tr><td>R1 &gt;&#x3D; R2</td><td align="center">如果R1中的所有记录都是R2的超集，则为<strong>True</strong> 。</td></tr><tr><td>R1 &gt; R2</td><td align="center">如果R1中的所有记录都是R2的超集，则为<strong>True</strong> 。</td></tr><tr><td>R1 !&#x3D; R2</td><td align="center">如果R1和R2不包含相同的记录，则为<strong>True</strong> 。</td></tr><tr><td>R1 in R2</td><td align="center">如果R1（必须是一条记录）是R2的一部分，则为<strong>True</strong> 。</td></tr><tr><td>R1 not in R2</td><td align="center">如果R1（必须是一条记录）不属于R2，则为<strong>True</strong> 。</td></tr></tbody></table><p>还有就地运算符，+&#x3D;、-&#x3D;、&amp;&#x3D; 和 |&#x3D;，它们是修改左侧操作数而不是创建新记录集。这些在更新记录的<strong>One2many</strong> 或<strong>Many2many</strong> 字段时非常有用。有关此示例，请参阅<a href="#%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95%E9%9B%86%E8%AE%B0%E5%BD%95%E7%9A%84%E5%80%BC">更新记录集记录的值</a>。</p><h2 id="过滤记录集"><a href="#过滤记录集" class="headerlink" title="过滤记录集"></a>过滤记录集</h2><p>在某些情况下，您已经有一个记录集，但您只需要对某些记录进行操作。当然，您可以对记录集进行迭代，检查每次迭代的条件并根据检查结果采取行动。构造一个只包含感兴趣的记录并在该记录集上调用单个操作的新记录集可能更容易，并且在某些情况下更有效。</p><p>本节展示了如何使用<strong>filter()</strong> 方法根据条件提取记录集的子集。</p><h3 id="准备工作-7"><a href="#准备工作-7" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将重用<a href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E8%AE%B0%E5%BD%95">创建新记录</a>一节中显示的简化<strong>library.book</strong> 模型。本节定义了一种从提供的记录集中提取具有多个作者的书籍的方法。</p><ol><li><p>定义接受原始记录集的方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api.model</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">books_with_multiple_authors</span>(<span class="params">self, all_books</span>):   </span><br></pre></td></tr></table></figure></li><li><p>定义一个内部谓词函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">predicate</span>(<span class="params">book</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(book.author_ids) &gt; <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure></li><li><p>调用<strong>filter()</strong> ，如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> all_books.<span class="built_in">filter</span>(predicate)</span><br></pre></td></tr></table></figure></li></ol><p>您可以打印或记录此方法的结果以在服务器日志中查看它。有关更多信息，请参阅本节的示例代码。</p><h3 id="运行原理-7"><a href="#运行原理-7" class="headerlink" title="运行原理"></a>运行原理</h3><p><strong>filter()</strong> 方法的实现会创建一个空记录集。谓词函数计算结果为<strong>True</strong> 的所有记录都添加到这个空记录集中。最终返回新记录集。原始记录集中的记录顺序被保留。</p><p>前面的例子使用了一个命名的内部函数。对于这样简单的谓词，您经常会发现使用了一个匿名<strong>Lambda</strong> 函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api.model</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">books_with_multiple_authors</span>(<span class="params">self, all_books</span>):</span><br><span class="line">    <span class="keyword">return</span> all_books.<span class="built_in">filter</span>(<span class="keyword">lambda</span> b: <span class="built_in">len</span>(b.author_ids) &gt; <span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>实际上，您需要根据字段的值在Python意义上为真（非空字符串、非零数字、非空容器等）这一事实来过滤记录集。因此，如果要过滤具有类别集合的记录，可以像这样传递字段名称进行过滤：<strong>all_books.filter(‘category_id’)</strong> 。</p><h3 id="扩展内容-4"><a href="#扩展内容-4" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>请记住<strong>filter()</strong> 是在内存中运行的。如果您需要在关键路径上优化方法的性能，您可能希望使用搜索域甚至迁移到SQL，但以牺牲可读性为代价。</p><h2 id="遍历记录集关联"><a href="#遍历记录集关联" class="headerlink" title="遍历记录集关联"></a>遍历记录集关联</h2><p>使用长度为<strong>1</strong> 的记录集时，各种字段可用作记录属性。关联属性（<strong>One2many</strong> 、<strong>Many2one</strong> 和<strong>Many2many</strong> ) 也可用于记录集的值。例如，假设我们要从<strong>library.book</strong> 模型的记录集中访问类别的名称。您可以通过遍历<strong>Many2one</strong> 字段的<strong>category_id</strong> 来访问类别名称，如下所示：<code>book.category_id.name</code>。但是，当使用具有多个记录的记录集时，不能使用属性。</p><p>本节向你展示了如何使用<strong>mapped()</strong> 方法来遍历记录集关系。我们将编写一个方法来从书籍记录集中检索作者姓名，并作为参数传递。</p><h3 id="准备工作-8"><a href="#准备工作-8" class="headerlink" title="准备工作"></a>准备工作</h3><p>本章重用与<a href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E8%AE%B0%E5%BD%95">创建新记录</a>相同的<strong>library.book</strong> 模型。</p><h3 id="实现步骤-7"><a href="#实现步骤-7" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>要从图书记录集中获取作者姓名，您需要执行以下步骤：</p><ol><li><p>定义一个名为<strong>get_author_name()</strong> 的函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api.model</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_author_name</span>(<span class="params">self, books</span>):</span><br></pre></td></tr></table></figure></li><li><p>调用<strong>mapped()</strong> 获取partner的联系人邮箱地址：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> books.mapped(<span class="string">&#x27;author_ids.name&#x27;</span>)</span><br></pre></td></tr></table></figure></li></ol><h3 id="运行原理-8"><a href="#运行原理-8" class="headerlink" title="运行原理"></a>运行原理</h3><p>第1步只是定义方法。第2步我们调用<strong>mapped(path)</strong> 方法遍历记录集的字段；<strong>path</strong> 是一个字符串，其中包含用点分隔的字段名称。对于路径中的每个字段，<strong>mapped()</strong> 生成一个新记录集，其中包含与该字段相关的所有记录与当前记录集中的所有元素，然后路径中的下一个元素应用于该新记录集。如果路径中的最后一个字段是关联字段，则<strong>mapped()</strong> 将返回一个记录集；否则，返回的是Python列表。</p><p><strong>mapped()</strong> 方法有两个有用的属性：</p><ul><li><p>如果路径是单个标量字段名称，则返回的列表与处理的记录集的顺序相同。</p></li><li><p>如果路径包含关联字段，则不会保留顺序，但会从结果中删除重复项。</p><blockquote><p><strong>重要信息</strong><br>当您想对<strong>self</strong> 中的所有记录的<strong>Many2many</strong> 字段指向的所有记录执行操作时，第二个属性非常有用，但是您需要确保该操作只执行一次（即使<strong>self</strong> 中的两个记录共享同一个目标记录）。</p></blockquote></li></ul><h3 id="扩展内容-5"><a href="#扩展内容-5" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>使用<strong>mapped()</strong> 时，请记住它在Odoo服务器内部的内存中运行的，通过重复遍历关联并因此进行SQL查询，这效率可能不高。但是，这种代码更简洁且可读性高。如果您尝试在实例性能的关键路径上优化方法，您可能需要重写对<strong>mapped()</strong> 的调用并以适当的域以<strong>search()</strong> 进行表现，或者甚至转移到SQL（代码可读性成本增加）。</p><p><strong>mapped()</strong> 方法也可以通过函数作为参数来调用。在这种情况下，它返回一个列表，包含应用于<strong>self</strong> 每条记录的函数的结果列表，或者返回在函数返回的是记录集的情况下由该函数返回的记录集的并集。</p><blockquote><p><strong>也可以看看</strong></p><ul><li><a href="#%E6%90%9C%E7%B4%A2%E8%AE%B0%E5%BD%95">搜索记录</a>章节。</li><li>第八章《高级服务器端开发》中的执行原生SQL查询章节。</li></ul></blockquote><h2 id="排序记录集"><a href="#排序记录集" class="headerlink" title="排序记录集"></a>排序记录集</h2><p>当您使用<strong>search()</strong> 方法获取记录集时，您可以传递一个可选参数<strong>order</strong> 来获取特定排序的记录集。如果您已经拥有来自前一段代码的记录集并且想要对其进行排序，这将非常有用。如果您使用集合操作来组合两个记录集，它也可能很有用，例如，这会导致排序丢失。</p><p>本节向你展示了如何使用<strong>sorted()</strong> 方法对现有记录集进行排序。我们将按发行日期对书籍进行排序。</p><h3 id="准备工作-9"><a href="#准备工作-9" class="headerlink" title="准备工作"></a>准备工作</h3><p>本章重用与<a href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E8%AE%B0%E5%BD%95">创建新记录</a>相同的<strong>library.book</strong> 模型。</p><h3 id="实现步骤-8"><a href="#实现步骤-8" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>您需要执行以下步骤来获取基于<strong>release_date</strong> 排序的图书记录集：</p><ol><li><p>定义名为<strong>sort_books_by_date()</strong> ：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api.model</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sort_books_by_date</span>(<span class="params">self, books</span>):</span><br></pre></td></tr></table></figure></li><li><p>如给定示例所示，使用<strong>sorted()</strong> 方法根据<strong>release_date</strong> 字段对图书记录进行排序：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> books.<span class="built_in">sorted</span>(key=<span class="string">&#x27;release_date&#x27;</span>)</span><br></pre></td></tr></table></figure></li></ol><h3 id="运行原理-9"><a href="#运行原理-9" class="headerlink" title="运行原理"></a>运行原理</h3><p>第1步只是定义方法。在步骤2中，我们调用书籍记录集中的<strong>sorted()</strong> 方法。在内部，<strong>sorted()</strong> 方法将获取作为键参数传递的字段的数据。然后，通过使用Python的原生排序方法，返回一个排序的记录集。</p><p>它还有一个可选参数<strong>reverse&#x3D;True</strong> ，它以相反的顺序返回一个记录集。反向使用如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books.<span class="built_in">sorted</span>(key=<span class="string">&#x27;release_date&#x27;</span>, reverse=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3 id="扩展内容-6"><a href="#扩展内容-6" class="headerlink" title="扩展内容"></a>扩展内容</h3><p><strong>sorted()</strong> 方法将对记录集中的记录进行排序。不带参数调用，默认使用模型的<strong>_order</strong> 属性来排序。也可以传递一个函数以与Python内置的<strong>sorted(sequence, key)</strong> 函数相同的方式计算比较。</p><blockquote><p><strong>重要笔记</strong><br>当使用模型默认的<strong>_order</strong>参数时，排序会在数据库中进行，执行新的SELECT函数获取排序。否则排序由Odoo执行。根据所操作的内容以及记录集的大小，可能存在一些重要的性能差异。</p></blockquote><h2 id="扩展模型中定义的业务逻辑"><a href="#扩展模型中定义的业务逻辑" class="headerlink" title="扩展模型中定义的业务逻辑"></a>扩展模型中定义的业务逻辑</h2><p>在Odoo中，将应用程序功能划分为不同的模块是一种非常常见的做法。通过这样做，您可以通过安装&#x2F;卸载应用程序来简单地启用&#x2F;禁用功能。而且，当您向现有应用程序添加新功能时，就需要自定义在原始应用程序中定义的某些方法的行为。有时，您还想向现有模型添加新字段。这在Odoo中是一项非常简单的任务，也是底层框架最强大的功能之一。</p><p>在本节中，我们将看到如何从另一个模块中的方法扩展一个方法的业务逻辑。我们还将从新模块向现有模块添加新字段。</p><h3 id="准备工作-10"><a href="#准备工作-10" class="headerlink" title="准备工作"></a>准备工作</h3><p>对于本节我们将继续使用上一节中的<strong>my_library</strong> 模块。确保在<strong>my_library</strong> 模块中有<strong>library.book.category</strong> 模型。</p><p>对于本节我们将创建一个名为<strong>my_library_return</strong> 的新模块，它依赖于<strong>my_library</strong> 模块。在新模块中，我们将管理借书的归还日期。我们还将根据类别自动计算归还日期。</p><p>在第四章《应用模型》中的<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%BA%94%E7%94%A8%E6%A8%A1%E5%9E%8B%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/#%E4%BD%BF%E7%94%A8%E7%BB%A7%E6%89%BF%E5%90%91%E6%A8%A1%E5%9E%8B%E6%B7%BB%E5%8A%A0%E5%8A%9F%E8%83%BD">使用继承向模型添加功能</a>小节中，我们看到了如何向现有模型添加字段。在这个模块中，需要扩展<strong>library.book</strong> 模型如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    _inherit = <span class="string">&#x27;library.book&#x27;</span></span><br><span class="line">    date_return = fields.Date(<span class="string">&#x27;Date to return&#x27;</span>)</span><br></pre></td></tr></table></figure><p>然后扩展<strong>library.book.category</strong> 模型，如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBookCategory</span>(models.Model):</span><br><span class="line">    _inherit = <span class="string">&#x27;library.book.category&#x27;</span></span><br><span class="line">    max_borrow_days = fields.Integer(</span><br><span class="line">        <span class="string">&#x27;Maximum borrow days&#x27;</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;For how many days book can be borrowed&quot;</span>,</span><br><span class="line">        default=<span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>要在视图中添加此字段，您需要遵循第九章《后端视图》中的<em>更改现有视图-视图继承</em> 章节。您可以在<a href="https://github.com/PacktPublishing/Odoo-13-Development-Cookbook-Fourth-Edition">https://github.com/PacktPublishing/Odoo-13-Development-Cookbook-Fourth-Edition</a>找到完整的代码示例。</p><h3 id="实现步骤-9"><a href="#实现步骤-9" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>要扩展<strong>library.book</strong> 模型中的业务逻辑，您需要执行以下步骤：</p><ol><li><p>在<strong>my_library_return</strong> 中，当我们将图书状态更改为已借阅时，我们希望在图书记录中设置<strong>date_return</strong> 。 为此，我们将重写<strong>my_module_return</strong> 模块中的<strong>make_borrowed</strong> 方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">make_borrowed</span>(<span class="params">self</span>):</span><br><span class="line">    day_to_borrow = self.category_id.max_borrow_days <span class="keyword">or</span> <span class="number">10</span></span><br><span class="line">    self.date_return = fields.Date.today() + timedelta(days=day_to_borrow)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>(LibraryBook, self).make_borrowed()</span><br></pre></td></tr></table></figure></li><li><p>我们还想在图书归还时重置<strong>date_return</strong> ，因此我们将重写<strong>make_available</strong> 方法来重置日期：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">make_available</span>(<span class="params">self</span>):</span><br><span class="line">    self.date_return = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>(LibraryBook, self).make_available()</span><br></pre></td></tr></table></figure></li></ol><h3 id="运行原理-10"><a href="#运行原理-10" class="headerlink" title="运行原理"></a>运行原理</h3><p>步骤1和2对业务逻辑进行了扩展。我们定义了一个扩展的<strong>library.books</strong> 模型，并重新定义了<strong>make_borrowed()</strong> 和<strong>make_available()</strong> 方法。在这两个方法的最后一行，返回的是父类实现的结果：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="built_in">super</span>(LibraryBook, self).make_borrowed()</span><br></pre></td></tr></table></figure><p>对于Odoo模型，通过查看Python类定义，父类并不是您所期望的。框架为我们的记录集动态生成了一个类层次结构，父类是我们依赖的模块中模型的定义。因此使用<strong>super()</strong> 方法从<strong>my_module</strong> 中调用<strong>library.book</strong> 中的实现。 本例中的<strong>make_borrowed()</strong> 需要将图书的状态更改为已借阅。 因此使用<strong>super()</strong> 调用父类中的方法并将图书状态设置为已借阅。</p><h3 id="扩展内容-7"><a href="#扩展内容-7" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>在本节中我们选择扩展默认的实现方法。在<strong>make_borrow()</strong> 和<strong>make_available()</strong> 方法中，我们在<strong>super()</strong> 调用之前修改了返回的结果。请注意，当您调用<strong>super()</strong> 时，它将执行父类中的逻辑。也可以在<strong>super()</strong> 调用之后执行一些操作。当然，我们也可以同时做这两件事。</p><p>但是，更改方法中间的行为更加困难。为此我们需要重构代码，以便我们可以将扩展点提取到单独的方法中，并在扩展模块中重写这个新方法。</p><p>您可能很想完全重写一个方法。这样做时要非常小心。如果您不调用方法的 super() 实现，您将破坏扩展机制并可能破坏扩展方法的附加组件，这意味着永远不会调用扩展方法。除非您在受控环境中工作，您确切知道安装了哪些附加组件，并且您已经检查过您没有破坏它们，请避免这样做。此外如果必须确保以非常明显的方式记录您正在做的事情。</p><p>在调用方法的原始实现之前和之后可以做什么？有很多东西包括（但不限于）以下内容：</p><ul><li>修改传递给原始实现的参数（之前）</li><li>修改传递给原始实现的上下文（之前）</li><li>修改原始实现返回的结果（之后）</li><li>调用另一个方法（之前和之后）</li><li>创建记录（之前和之后）</li><li>在禁止的情况下（之前和之后）抛出<strong>UserError</strong> 错误以取消执行</li><li>将<strong>self</strong> 拆分为更小的记录集，并以不同的方式（之前）在每个子集上调用原始实现</li></ul><h2 id="扩展write-和create"><a href="#扩展write-和create" class="headerlink" title="扩展write()和create()"></a>扩展write()和create()</h2><p>本章的<a href="#%E6%89%A9%E5%B1%95%E6%A8%A1%E5%9E%8B%E4%B8%AD%E5%AE%9A%E4%B9%89%E7%9A%84%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91">扩展模型中定义的业务逻辑</a>一节向我们展示了如何扩展定义在模型类上的方法。您应该知道，在父类模型上定义的方法也是模型的一部分。这意味着<strong>models.Model</strong> 上定义的所有基础方法（实际上是<strong>models.BaseModel</strong> ，它是<strong>models.Model</strong> 的父类）也是可用的并且可以扩展。</p><p>本节向你展示了如何扩展<strong>create()</strong> 和<strong>write()</strong> 来控制对记录的某些字段的访问。</p><h3 id="准备工作-11"><a href="#准备工作-11" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将使用<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%88%9B%E5%BB%BAOdoo%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第三章《创建Odoo附加模块》</a>中的<strong>my_library</strong> 模块来扩展。</p><p>将<strong>manager_remarks</strong> 字段添加到<strong>library.book</strong> 模型。我们只希望<strong>Library Managers</strong> 组的成员能够写入该字段：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> odoo <span class="keyword">import</span> models, api, exceptions</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    _name = <span class="string">&#x27;library.book&#x27;</span></span><br><span class="line">    manager_remarks = fields.Text(<span class="string">&#x27;Manager Remarks&#x27;</span>)</span><br></pre></td></tr></table></figure><p>将<strong>manager_remarks</strong> 字段添加到<strong>view&#x2F;library_book.xml</strong> 文件的<strong>&lt;form&gt;</strong> 视图，以便从用户界面访问此字段：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;manager_remarks&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>修改<strong>security&#x2F;ir.model.access.csv</strong> 文件，为Library用户提供写入权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink</span><br><span class="line">acl_book_user,library.book_default,model_library_book,base.group_user,1,1,0,0</span><br><span class="line">acl_book_librarian,library.book_librarian,model_library_book,group_librarian,1,1,1,1</span><br></pre></td></tr></table></figure><h3 id="实现步骤-10"><a href="#实现步骤-10" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>为了防止非librarian组成员的用户修改<strong>manager_remarks</strong> 的值，您需要执行以下步骤：</p><ol><li><p>扩展<strong>create()</strong> 方法，如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api.model</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">self, values</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.user_has_groups(<span class="string">&#x27;my_library.group_librarian&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;manager_remarks&#x27;</span> <span class="keyword">in</span> values:</span><br><span class="line">            <span class="keyword">raise</span> UserError(</span><br><span class="line">                <span class="string">&#x27;You are not allowed to modify &#x27;</span></span><br><span class="line">                <span class="string">&#x27;manager_remarks&#x27;</span></span><br><span class="line">            )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>(LibraryBook, self).create(values)</span><br></pre></td></tr></table></figure></li><li><p>扩展<strong>write()</strong> 方法，如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">self, values</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.user_has_groups(<span class="string">&#x27;my_library.group_librarian&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;manager_remarks&#x27;</span> <span class="keyword">in</span> values:</span><br><span class="line">            <span class="keyword">raise</span> UserError(</span><br><span class="line">                <span class="string">&#x27;You are not allowed to modify &#x27;</span></span><br><span class="line">                <span class="string">&#x27;manager_remarks&#x27;</span></span><br><span class="line">            )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>(LibraryBook, self).write(values)</span><br></pre></td></tr></table></figure></li></ol><p>安装模块以查看运行中的代码。现在只有manager类型的用户可以修改<strong>manager_remarks</strong> 字段。要测试此实现，您可以以demo用户登录或撤销当前用户的图书管理员访问权限。</p><h3 id="运行原理-11"><a href="#运行原理-11" class="headerlink" title="运行原理"></a>运行原理</h3><p>第1步重新定义<strong>create()</strong> 方法。在调用<strong>create()</strong> 的基础实现之前，我们的方法使用<strong>user_has_groups()</strong> 方法检查用户是否属于<strong>my_library.group_librarian</strong> 组（这是组的XML ID）。如果用户不属于<strong>my_library.group_librarian</strong> 组并且为<strong>manager_remarks</strong> 传递了一个值，则会抛出<strong>UserError</strong> 异常，从而阻止创建记录。此检查应放在调用父类实现之前执行。</p><p>第2步对<strong>write()</strong> 方法执行相同的操作。在写入之前，我们检查组和值中是否存在要写入的字段，如果有问题则抛出<strong>UserError</strong> 异常</p><blockquote><p><strong>重要笔记</strong><br>当在Web客户端中将该字段设置为只读时不会阻止RPC调用写入它。这就是我们扩展<strong>create()</strong> 和<strong>write()</strong> 的原因。</p></blockquote><p>在本节中，你已经看到了如何重写<strong>create()</strong> 和<strong>write()</strong> 方法。 但请注意，这不仅限于<strong>create()</strong> 和<strong>write()</strong> 方法。您可以重写任何模型方法。例如假设您想在删除记录时执行某些操作。为此您需要重写<strong>unlink()</strong> 方法（删除记录时会调用<strong>unlink()</strong> 方法）。下面是重写<strong>unlink()</strong> 方法的小代码片段：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">unlink</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="comment"># 这里写你的业务逻辑</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>(LibraryBook, self).unlink()</span><br></pre></td></tr></table></figure><blockquote><p><strong>警告</strong><br>在Odoo中重写方法时，千万不要忘记调用<strong>super()</strong> 方法，否则会遇到问题。这是因为当你不使用<strong>super()</strong> 方法时，父类方法中的代码永远不会执行。如果在我们之前的代码片段中，我们没有调用**super(…).unlink()**，则记录不会被删除。</p></blockquote><h3 id="扩展内容-8"><a href="#扩展内容-8" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>在扩展<strong>write()</strong> 时，请注意在调用<strong>write()</strong> 的<strong>super()</strong> 实现之前，<strong>self</strong>仍然是未修改的。您可以使用它来将字段的当前值与值字典中的值进行比较。</p><p>在本节中，我们选择了抛出异常，但我们也可以选择从值字典中删除有问题的字段，并默默地跳过更新记录中的该字段：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">self, values</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.user_has_groups( <span class="string">&#x27;my_library.group_librarian&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;manager_remarks&#x27;</span> <span class="keyword">in</span> values:</span><br><span class="line">            <span class="keyword">del</span> values[<span class="string">&#x27;manager_remarks&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>(LibraryBook, self).write(values)</span><br></pre></td></tr></table></figure><p>在调用<strong>super().write()</strong> 之后，如果你想执行额外的操作，你必须警惕任何可能导致再次调用<strong>write()</strong> 的事情，否则你将创建一个无限递归的循环。解决方法是在上下文中放置一个标记，以便检查以中断递归：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyModel</span>(models.Model):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">self, values</span>):</span><br><span class="line">        sup = <span class="built_in">super</span>(MyModel, self).write(values)</span><br><span class="line">        <span class="keyword">if</span> self.env.context.get(<span class="string">&#x27;MyModelLoopBreaker&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self = self.with_context(MyModelLoopBreaker=<span class="literal">True</span>)</span><br><span class="line">        self.compute_things() <span class="comment"># can cause calls to writes</span></span><br><span class="line">        <span class="keyword">return</span> sup</span><br></pre></td></tr></table></figure><p>在前面的示例中，我们在<strong>compute_things()</strong> 方法之前添加了<strong>MyModelLoopBreaker</strong> 键。因此，如果再次调用<strong>write()</strong> 方法，它不会进入无限循环。</p><h2 id="自定义搜索记录的方式"><a href="#自定义搜索记录的方式" class="headerlink" title="自定义搜索记录的方式"></a>自定义搜索记录的方式</h2><p>在<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%BA%94%E7%94%A8%E6%A8%A1%E5%9E%8B%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/#%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9E%8B%E8%A1%A8%E7%8E%B0%E5%8F%8A%E6%8E%92%E5%BA%8F">第四章《应用模型》</a>中的<em>定义模型表现及排序</em> ，介绍了<strong>name_get()</strong> 方法，该方法用于计算不同位置的记录表示，包括用于显示<strong>Many2one</strong> 关联的小部件。</p><p>本节向您展示如何通过重新定义<strong>name_search</strong> 在<strong>Many2one</strong> 小部件中按标题、作者或ISBN搜索一本书。</p><h3 id="准备工作-12"><a href="#准备工作-12" class="headerlink" title="准备工作"></a>准备工作</h3><p>对于本节，我们将使用以下模型定义：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    _name = <span class="string">&#x27;library.book&#x27;</span></span><br><span class="line">    name = fields.Char(<span class="string">&#x27;Title&#x27;</span>)</span><br><span class="line">    isbn = fields.Char(<span class="string">&#x27;ISBN&#x27;</span>)</span><br><span class="line">    author_ids = fields.Many2many(<span class="string">&#x27;res.partner&#x27;</span>, <span class="string">&#x27;Authors&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">name_get</span>(<span class="params">self</span>):</span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">for</span> book <span class="keyword">in</span> self:</span><br><span class="line">            authors = book.author_ids.mapped(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">            name = <span class="string">&#x27;%s (%s)&#x27;</span> % (book.name, <span class="string">&#x27;, &#x27;</span>.join(authors))</span><br><span class="line">            result.append((book.<span class="built_in">id</span>, name))</span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>使用此模型时，<strong>Many2one</strong> 小部件中的一本书显示为<strong>书名(作者1, 作者2…)</strong> 。 用户希望能够输入作者的姓名并找到根据此姓名过滤的列表，但这不会起作用，因为<strong>name_search</strong> 的默认实现仅使用模型类的<strong>_rec_name</strong> 属性所引用的属性，在我们的例子是<strong>&#39;name&#39;</strong> 。我们还希望允许按ISBN编号进行过滤。</p><h3 id="实现步骤-11"><a href="#实现步骤-11" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>您需要执行以下步骤：</p><ol><li><p>为了能够通过书名、作者或ISBN号搜索<strong>library.book</strong> ，您需要在<strong>LibraryBook</strong> 类中定义<strong>name_search()</strong> 方法，如下所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api.model</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_name_search</span>(<span class="params">self, name=<span class="string">&#x27;&#x27;</span>, args=<span class="literal">None</span>, operator=<span class="string">&#x27;ilike&#x27;</span>, imit=<span class="number">100</span>, name_get_uid=<span class="literal">None</span></span>):</span><br><span class="line">    args = [] <span class="keyword">if</span> args <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> args.copy()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span>(name == <span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> operator == <span class="string">&#x27;ilike&#x27;</span>):</span><br><span class="line">        args += [<span class="string">&#x27;|&#x27;</span>, <span class="string">&#x27;|&#x27;</span>,</span><br><span class="line">            (<span class="string">&#x27;name&#x27;</span>, operator, name),</span><br><span class="line">            (<span class="string">&#x27;isbn&#x27;</span>, operator, name),</span><br><span class="line">            (<span class="string">&#x27;author_ids.name&#x27;</span>, operator, name)</span><br><span class="line">        ]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>(LibraryBook, self)._name_search(name=name, args=args, operator=operator, limit=limit, name_get_uid=name_get_uid)</span><br></pre></td></tr></table></figure></li><li><p>在<strong>library.book</strong> 模型中添加名为<strong>old_editions</strong> 的<strong>Many2one</strong> 字段以测试<strong>_name_search</strong> 实现：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">old_edition = fields.Many2one(<span class="string">&#x27;library.book&#x27;</span>, string=<span class="string">&#x27;Old Edition&#x27;</span>)</span><br></pre></td></tr></table></figure></li><li><p>将以下字段添加到用户界面：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;old_edition&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>重新启动并更新模块以反映这些更改。</p></li></ol><p>您可以通过在<strong>old_edition Many2one</strong> 字段中来调用<strong>_name_search</strong> 方法搜索。</p><h3 id="运行原理-12"><a href="#运行原理-12" class="headerlink" title="运行原理"></a>运行原理</h3><p><strong>name_search()</strong> 的默认实现实际上只调用<strong>_name_search()</strong> 方法，它完成了真正的工作。这个<strong>_name_search()</strong> 方法有一个额外的参数<strong>name_get_uid</strong>，它在一些极端情况下使用，例如如果你想使用<strong>sudo()</strong> 或不同的用户来计算结果。</p><p>我们将收到的大部分参数原封不动地传递给方法的<strong>super()</strong> 实现：</p><ul><li><strong>name</strong> 是一个字符串，其中包含用户输入的值。</li><li><strong>args</strong> 是<strong>None</strong> 或用作可能记录的预过滤器的搜索域。（例如它可以来自<strong>Many2one</strong> 关联的域参数。）</li><li><strong>operator</strong> 是包含匹配运算符的字符串。一般来说，你会有<strong>&#39;ilike&#39;</strong> 或<strong>&#39;&#x3D;&#39;</strong>。</li><li><strong>limit</strong> 是要检索的最大行数。</li><li><strong>name_get_uid</strong> 可用于在调用<strong>name_get()</strong> 以计算要在小部件中显示的字符串时指定不同的用户。</li></ul><p>我们对该方法的实现执行以下操作：</p><ol><li><p>如果<strong>args</strong> 为<strong>None</strong>，它会生成一个新的空列表，否则会生成<strong>args</strong> 的副本。我们制作一个副本以避免我们对列表的修改对调用者产生副作用。</p></li><li><p>然后，我们检查<strong>name</strong> 不是空字符串或者操作符不是<strong>&#39;ilike&#39;</strong> 。这是为了避免生成一个不过滤任何内容的哑域<strong>[(&#39;name&#39;, ilike, &#39;&#39;)]</strong> 。在这种情况下，我们直接跳转到<strong>super()</strong> 调用实现。</p></li><li><p>如果我们有<strong>name</strong> ，或者如果<strong>operator</strong> 不是<strong>&#39;ilike&#39;</strong> ，那么我们会在<strong>args</strong> 中添加一些过滤条件。在我们的例子中，我们添加了对所提供名称在图书标题、ISNB 或作者姓名中搜索的语句。</p></li><li><p>最后，我们使用<strong>args</strong> 中修改的域调用<strong>super()</strong> 实现，并强制<strong>name</strong> 为<strong>&#39;&#39;</strong> 和<strong>operator</strong> 为 <strong>ilike</strong> 。我们这样做是为了强制<strong>_name_search()</strong> 的默认实现不改变它接收的域，因此将使用我们指定的域。</p></li></ol><h3 id="扩展内容-9"><a href="#扩展内容-9" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>我们在介绍中提到，这个方法用在<strong>Many2one</strong> 小部件中。为了完整起见，它也用于<strong>Odoo</strong> 的以下部分：</p><ul><li>在域中的<strong>One2many</strong> 和<strong>Many2many</strong> 字段上使用<strong>in</strong> 运算符时</li><li>在<strong>many2many_tags</strong> 小部件中搜索记录</li><li>在CSV文件中搜索记录导入</li></ul><blockquote><p><strong>也可以看看</strong><br><a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%BA%94%E7%94%A8%E6%A8%A1%E5%9E%8B%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/#%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9E%8B%E8%A1%A8%E7%8E%B0%E5%8F%8A%E6%8E%92%E5%BA%8F">第四章《应用模型》</a>中的<em>定义模型表现及排序</em> 介绍了如何定义<strong>name_get()</strong> 方法，该方法用于创建记录的文本表示。<br>第九章《后端视图》中的<em>在记录列表上定义过滤器-域</em> 提供了有关搜索域语法的更多信息。</p></blockquote><h2 id="使用read-group-分组获取数据"><a href="#使用read-group-分组获取数据" class="headerlink" title="使用read_group()分组获取数据"></a>使用read_group()分组获取数据</h2><p>在之前章节中，我们看到了如何从数据库中搜索和获取数据。但有时，您希望通过汇总记录获得结果，例如上个月销售订单的平均成本。通常我们在SQL查询中使用<strong>group by</strong> 和<strong>aggregate</strong> 函数来获得这样的结果。幸运的是在Odoo中，我们有<strong>read_group()</strong> 方法。在本节中，你将学习如何使用<strong>read_group()</strong> 方法来获取聚合结果。</p><h3 id="准备工作-13"><a href="#准备工作-13" class="headerlink" title="准备工作"></a>准备工作</h3><p>本节我们将使用<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%88%9B%E5%BB%BAOdoo%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第三章《创建Odoo附加模块》</a>中的<strong>my_library</strong> 模块。</p><p>修改<strong>library.book</strong> 模型，如下模型定义所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    _name = <span class="string">&#x27;library.book&#x27;</span></span><br><span class="line">    name = fields.Char(<span class="string">&#x27;Title&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line">    date_release = fields.Date(<span class="string">&#x27;Release Date&#x27;</span>)</span><br><span class="line">    pages = fields.Integer(<span class="string">&#x27;Number of Pages&#x27;</span>)</span><br><span class="line">    cost_price = fields.Float(<span class="string">&#x27;Book Cost&#x27;</span>)</span><br><span class="line">    category_id = fields.Many2one(<span class="string">&#x27;library.book.category&#x27;</span>)</span><br><span class="line">    author_ids = fields.Many2many(<span class="string">&#x27;res.partner&#x27;</span>, string=<span class="string">&#x27;Authors&#x27;</span>)</span><br></pre></td></tr></table></figure><p>添加<strong>library.book.category</strong> 模型。为简单起见，我们只需将其添加到同一个<strong>library_book.py</strong> 文件中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BookCategory</span>(models.Model):</span><br><span class="line">    _name = <span class="string">&#x27;library.book.category&#x27;</span></span><br><span class="line">    name = fields.Char(<span class="string">&#x27;Category&#x27;</span>)</span><br><span class="line">    description = fields.Text(<span class="string">&#x27;Description&#x27;</span>)</span><br></pre></td></tr></table></figure><p>我们将使用<strong>library.book</strong> 模型并获得每个类别的平均成本价格。</p><h3 id="实现步骤-12"><a href="#实现步骤-12" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>为了提取分组结果，我们将<strong>_get_average_cost</strong> 方法添加到<strong>library.book</strong> 模型中，该模型将使用<strong>read_group()</strong> 方法获取组中的数据：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api.model</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_average_cost</span>(<span class="params">self</span>):</span><br><span class="line">    grouped_result = self.read_group(</span><br><span class="line">        [(<span class="string">&#x27;cost_price&#x27;</span>, <span class="string">&quot;!=&quot;</span>, <span class="literal">False</span>)], <span class="comment"># Domain</span></span><br><span class="line">        [<span class="string">&#x27;category_id&#x27;</span>, <span class="string">&#x27;cost_price:avg&#x27;</span>], <span class="comment"># Fields to access</span></span><br><span class="line">        [<span class="string">&#x27;category_id&#x27;</span>] <span class="comment"># group_by</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> grouped_result</span><br></pre></td></tr></table></figure><p>要测试此实现，您需要在用户界面中添加一个按钮来触发此方法。然后，您可以在服务器日志中打印结果。</p><h3 id="运行原理-13"><a href="#运行原理-13" class="headerlink" title="运行原理"></a>运行原理</h3><p><strong>read_group()</strong> 方法在内部使用SQL <strong>group by</strong> 和 <strong>aggregate</strong> 函数来获取数据。传递给<strong>read_group()</strong> 方法的最常见参数如下：</p><ul><li><p><strong>domain</strong> :这用于过滤记录以进行分组。有关域的更多信息请参阅第九章《后端视图》中的<em>搜索视图</em> 章节。</p></li><li><p><strong>fields</strong> :这将传递您要与分组数据一起获取的字段的名称。此参数的可能值如下：</p><ul><li><strong>field name</strong> ：可以将字段名称传递给<strong>fields</strong> 参数，但如果使用此选项，则必须将此字段名称也传递给<strong>groupby</strong> 参数，否则会产生错误。</li><li><strong>field_name:agg</strong>：可以通过<strong>aggregate</strong> 函数传递字段名称。例如，在<strong>cost_price:avg</strong> 中，<strong>avg</strong> 是一个SQL聚合函数。可以在<a href="https://www.postgresql.org/docs/current/static/functions-aggregate.html">https://www.postgresql.org/docs/current/static/functions-aggregate.html</a> 找到PostgreSQL聚合函数的列表。</li><li><strong>name:agg(field_name)<strong>：这与前一个相同，但使用此语法，您可以提供列别名，例如</strong>average_price:avg(cost_price)</strong> 。</li></ul></li><li><p><strong>groupby</strong> :此参数接受字段描述列表。记录将根据这些字段进行分组。对于日期和时间列，您可以<br>通过<strong>groupby_function</strong> 根据不同的持续时间应用日期分组，例如<strong>date_release:month</strong> 。这将应用基于月份的分组。</p></li><li><p><strong>read_group()</strong> 还支持一些可选参数，如下：</p><ul><li><strong>offset</strong> ：这表示要跳过的记录数。</li><li><strong>limit</strong> ：这表示要返回的最大记录数。</li><li><strong>orderby</strong> ：如果使用了这个选项，结果将根据给定的字段进行排序。</li><li><strong>lazy</strong> ：这接收布尔值，默认情况下为<strong>True</strong> 。如果为<strong>True</strong> ，则结果仅按第一个<strong>groupby</strong> 分组，其余<strong>groupby</strong> 放在<strong>__context</strong> 键中。如果为<strong>False</strong> ，则所有<strong>groupby</strong> 函数都在一次调用中完成。</li></ul><blockquote><p><strong>性能提示</strong><br><strong>read_group()</strong> 比从记录集中读取和处理值要快得多。 因此，对于KPI或图表，您应该始终使用<strong>read_group()</strong> 。</p></blockquote></li></ul><h3 id="扩展内容-10"><a href="#扩展内容-10" class="headerlink" title="扩展内容"></a>扩展内容</h3>]]></content>
    
    
    <summary type="html">在第四章《应用模型》中，我们看到了如何在自定义模块中声明或扩展业务模型。那一章涵盖了计算字段的编写方法，以及约束字段的方法。本章重点介绍Odoo方法定义、记录集操作和扩展继承方法的服务器端开发基础知识。有了这个，您将能够在Odoo模块中添加/修改业务逻辑。</summary>
    
    
    
    
    <category term="Odoo开发者指南" scheme="https://www.junle.org/tags/Odoo%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>Odoo14开发者指南第四章-应用模型【翻译】</title>
    <link href="https://www.junle.org/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%BA%94%E7%94%A8%E6%A8%A1%E5%9E%8B%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/"/>
    <id>https://www.junle.org/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%BA%94%E7%94%A8%E6%A8%A1%E5%9E%8B%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/</id>
    <published>2022-06-08T06:55:20.000Z</published>
    <updated>2024-03-22T06:43:55.678Z</updated>
    
    <content type="html"><![CDATA[<p>本章中的教程将对现有的附加模块稍稍进行补充。在上一章中，我们在Odoo实例中注册了我们的附加模块。在本章中，我们将对模块的数据库方面进行深入的探讨。我们将添加一个新模型（数据库表）、新字段和约束。我们还将研究Odoo中模型的继承使用。本章中我们将继续使用在<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%88%9B%E5%BB%BAOdoo%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第三章</a>中创建的附加模块。<br>本章中包含以下小节：</p><ul><li><p><a href="#%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9E%8B%E8%A1%A8%E7%8E%B0%E5%8F%8A%E6%8E%92%E5%BA%8F">定义模型表现及排序</a></p></li><li><p><a href="#%E5%90%91%E6%A8%A1%E5%9E%8B%E6%B7%BB%E5%8A%A0%E6%95%B0%E6%8D%AE%E5%AD%97%E6%AE%B5">向模型添加数据字段</a></p></li><li><p><a href="#%E4%BD%BF%E7%94%A8%E5%8F%AF%E9%85%8D%E7%BD%AE%E7%B2%BE%E5%BA%A6%E7%9A%84%E6%B5%AE%E7%82%B9%E5%9E%8B%E5%AD%97%E6%AE%B5">使用可配置精度的浮点型字段</a></p></li><li><p><a href="#%E5%90%91%E6%A8%A1%E5%9E%8B%E6%B7%BB%E5%8A%A0%E8%B4%A7%E5%B8%81%E5%AD%97%E6%AE%B5">向模型添加货币字段</a></p></li><li><p><a href="#%E5%90%91%E6%A8%A1%E5%9E%8B%E6%B7%BB%E5%8A%A0%E5%85%B3%E8%81%94%E5%AD%97%E6%AE%B5">向模型添加关联字段</a></p></li><li><p><a href="#%E6%B7%BB%E5%8A%A0%E6%A8%A1%E5%9E%8B%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84">添加模型层次结构</a></p></li><li><p><a href="#%E5%90%91%E6%A8%A1%E5%9E%8B%E6%B7%BB%E5%8A%A0%E7%BA%A6%E6%9D%9F%E9%AA%8C%E8%AF%81">向模型添加约束验证</a></p></li><li><p><a href="#%E5%90%91%E6%A8%A1%E5%9E%8B%E6%B7%BB%E5%8A%A0%E8%AE%A1%E7%AE%97%E5%AD%97%E6%AE%B5">向模型添加计算字段</a></p></li><li><p><a href="#%E6%9A%B4%E9%9C%B2%E5%AD%98%E5%82%A8%E5%9C%A8%E5%85%B6%E4%BB%96%E6%A8%A1%E5%9E%8B%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%85%B3%E5%AD%97%E6%AE%B5">暴露存储在其他模型中的相关字段</a></p></li><li><p><a href="#%E4%BD%BF%E7%94%A8%E5%BC%95%E7%94%A8%E5%AD%97%E6%AE%B5%E6%B7%BB%E5%8A%A0%E5%8A%A8%E6%80%81%E5%85%B3%E8%81%94">使用引用字段添加动态关联</a></p></li><li><p><a href="#%E4%BD%BF%E7%94%A8%E7%BB%A7%E6%89%BF%E5%90%91%E6%A8%A1%E5%9E%8B%E6%B7%BB%E5%8A%A0%E5%8A%9F%E8%83%BD">使用继承向模型添加功能</a></p></li><li><p><a href="#%E4%BD%BF%E7%94%A8%E7%BB%A7%E6%89%BF%E5%A4%8D%E5%88%B6%E6%A8%A1%E5%9E%8B%E5%AE%9A%E4%B9%89">使用继承复制模型定义</a></p></li><li><p><a href="#%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%90%86%E7%BB%A7%E6%89%BF%E5%B0%86%E5%8A%9F%E8%83%BD%E5%A4%8D%E5%88%B6%E8%87%B3%E5%8F%A6%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9E%8B">使用代理继承将功能复制至另一个模型</a></p></li><li><p><a href="#%E4%BD%BF%E7%94%A8%E6%8A%BD%E8%B1%A1%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0%E5%8F%AF%E5%A4%8D%E7%94%A8%E7%9A%84%E6%A8%A1%E5%9E%8B%E5%8A%9F%E8%83%BD">使用抽象模型实现可复用的模型功能</a></p></li></ul><span id="more"></span><h2 id="技术要求"><a href="#技术要求" class="headerlink" title="技术要求"></a>技术要求</h2><p>您应该拥有我们在<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%88%9B%E5%BB%BAOdoo%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第三章</a>创建的模块，并且该模块必须可以使用。<br>本章中使用的所有代码都可以从<a href="https://github.com/PacktPublishing/Odoo-14-Development-Cookbook-Fourth-Edition/tree/master/Chapter04">https://github.com/PacktPublishing/Odoo-14-Development-Cookbook-Fourth-Edition/tree/master/Chapter04</a>上下载。</p><h2 id="定义模型表现及排序"><a href="#定义模型表现及排序" class="headerlink" title="定义模型表现及排序"></a>定义模型表现及排序</h2><p>模型中使用结构性属性来定义模型的行为，这些属性是前缀带下划线的。<em>_name</em> 属性是模型中最重要的属性，它是模型的内部全局标识符，Odoo会根据<em>_name</em> 属性来创建数据库表。例如：模型的<em>_name&#x3D;”library.book”</em> ，Odoo的ORM会在数据库中创建名为<em>library_book</em> 的表。模型的<em>_name</em> 属性在整个Odoo实例中必须是唯一的。<br>在模型中可以使用另外两个属性：</p><ul><li><strong>_rac_name</strong> ：用于设置用作记录的表示或标题的字段。</li><li><strong>_order</strong> ：用于设置记录的排序。</li></ul><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>你需要准备好一个带有<strong>my_library</strong> 模块的Odoo实例（第三章中创建的模块）。</p><h3 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h3><p><em>my_library</em> 模块应该已经包含一个名为<em>models/library_book.py</em> 的Python文件，它定义了一个基本模型。我们将对其进行编辑，在<em>_name</em> 之后添加一个新的类级属性：</p><ol><li><p>要为模型添加用户友好的标题，请添加以下代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_description = <span class="string">&#x27;Library Book&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p>要首先对记录进行排序（从最新到最旧，然后按标题排序），请添加以下代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_order = <span class="string">&#x27;date_release desc, name&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p>要将<em>short_name</em> 字段用作记录的显示，请添加以下代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_rec_name = <span class="string">&#x27;short_name&#x27;</span></span><br><span class="line">short_name = fields.Char(<span class="string">&#x27;Short Title&#x27;</span>, required=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li><li><p>在表单视图中添加<em>short_name</em> 字段，以便它可以在视图中显示新字段：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;short_name&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li></ol><p>完成后，我们的<em>library_book.py</em> 文件应如下所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> odoo <span class="keyword">import</span> models, fields</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    _name = <span class="string">&#x27;library.book&#x27;</span></span><br><span class="line">    _description = <span class="string">&#x27;Library Book&#x27;</span></span><br><span class="line">    _order = <span class="string">&#x27;date_release desc, name&#x27;</span></span><br><span class="line">    _rec_name = <span class="string">&#x27;short_name&#x27;</span></span><br><span class="line">    </span><br><span class="line">    name = fields.Char(<span class="string">&#x27;Title&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line">    short_name = fields.Char(<span class="string">&#x27;Short Title&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line">    date_release = fields.Date(<span class="string">&#x27;Release Date&#x27;</span>)</span><br><span class="line">    author_ids = fields.Many2many(<span class="string">&#x27;res.partner&#x27;</span>, string=<span class="string">&#x27;Authors&#x27;</span>)</span><br></pre></td></tr></table></figure><p><em>library_book.xml</em> 文件中的<em>&lt;form&gt;</em> 视图将如下所示：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;author_ids&quot;</span> <span class="attr">widget</span>=<span class="string">&quot;many2many_tags&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;short_name&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;date_release&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后我们需要升级模块以激活Odoo中的这些更改。要更新模块，您可以打开<strong>Apps</strong> 菜单，搜索<strong>my_library</strong> 模块，然后通过下拉列表更新模块，如下图所示：</p><p>   <img src="/images/Update_Odoo_apps.png" alt="更新模块选项"></p><p>或者，您也可以在命令行中使用<strong>-u my_library</strong> 命令来更新模块。</p><h3 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h3><p>第一步为模型的定义添加一个对用户更友好的标题。这不是强制性的，但可以为一些附加组件使用。例如，邮件插件模块中的跟踪功能将它用于创建新记录时的通知文本。 有关详细信息，请参阅第二十三章，在Odoo中管理电子邮件。如果您的模型不使用<em>_description</em> ，在这种情况下，Odoo将在日志中显示警告信息。</p><p>默认情况下，Odoo使用内部id值（自动生成的主键）对记录进行排序。但是，这可以更改，我们可以通过提供一个包含字段名以逗号隔开的字符串作为<em>_order</em> 属性，字段名称后可以跟<em>desc</em> 关键字以降序排列。</p><blockquote><p><strong>重要提示</strong><br>只能使用存储在数据库中的字段。非存储计算域不能用于对记录进行排序；<br><em>_order</em> 字符串的语法类似于SQL ORDER BY子句，不允许使用例如NULLS FIRST等特殊子句；</p></blockquote><p>模型记录在被其他记录引用时使用的一种表示形式。例如，user_id值为1的 员用户代表的管理员用户。当在表单视图中显示时，Odoo将显示用户名，而不是数据库ID。简而言之，<em>_rec_name</em> 是用于Odoo界面上显示记录的名称。默认情况下，使用的是<em>name</em> 字段。事实上，这是<em>_rec_name</em> 属性的默认值。在我们的示例中，<em>library.book</em> 模型有一个<em>name</em> 字段，因此，默认情况下，Odoo将使用它作为显示名称。我们第3步中使用了<em>short_name</em> 作为<em>_rec_name</em> 。之后，<em>library.book</em> 模型的显示名称从<em>name</em> 更改为了<em>short_name</em> ，Odoo显示界面将使用<em>short_name</em> 的值来展示记录。</p><blockquote><p><strong>警告</strong><br>如果您的模型没有<em>name</em> 字段并且在这种情况下您也没有指定<em>_rec_name</em> ，那么您的显示名称将是模型名称和记录ID的组合，如下所示：<em>(library.book, 1)</em> 。</p></blockquote><p>由于我们向模型添加了一个新字段<em>short_name</em> ，Odoo的ORM将向数据库表添加一个新列，但它不会在视图中显示该字段。为此，我们需要将此字段添加到表单视图中。在第4步中，我们将<em>short_name</em> 字段添加到表单视图中。</p><h3 id="扩展内容"><a href="#扩展内容" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>记录的展示也可以在一个神奇的计算<strong>display_name</strong> 设置，并且自8.0版以来已自动添加到所有模型中。它的值是使用<strong>name_get()</strong> 模型方法生成的，该方法在当前版本的Odoo中已经存在。</p><p><em>name_get()</em> 的默认实现使用<em>_rec_name</em> 属性来查找哪个字段保存数据，用于生成显示名称。如果您想要自己实现显示名称的方法，您可以覆盖<em>name_get()</em> 的逻辑以生成自定义显示名称。该方法必须返回一个包含两个元素的元组列表：记录的ID和记录的Unicode字符串。</p><p>例如，要在显示中包含标题及其发布日期，例如<em>Moby Dick (1851-10-18)</em> ，我们可以定义以下内容：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">name_get</span>(<span class="params">self</span>):</span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> record <span class="keyword">in</span> self:</span><br><span class="line">        rec_name = <span class="string">&quot;%s (%s)&quot;</span> % (record.name, record.date_release)</span><br><span class="line">        result.append((record.<span class="built_in">id</span>, rec_name))</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>添加上述代码后，您的<em>display_name</em> 记录将被更新。假设您有一个名为<em>Odoo Cookbook</em> 的记录和发布日期为<em>19-04-2019</em> ，那么前面的<em>name_get()</em> 方法会生成一个这样的名字<em>Cookbook (19-04-2019)</em> 。</p><h2 id="向模型添加数据字段"><a href="#向模型添加数据字段" class="headerlink" title="向模型添加数据字段"></a>向模型添加数据字段</h2><p>模型用于存储数据，并且这些数据是按字段构造的。在这里，您将了解可以存储在字段中的几种数据类型，以及如何将它们添加到模型中。</p><h3 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h3><p>你需要准备好一个带有<strong>my_library</strong> 模块的Odoo实例（第三章中创建的模块）。</p><h3 id="实现过程-1"><a href="#实现过程-1" class="headerlink" title="实现过程"></a>实现过程</h3><p><em>my_library</em> 模块应该已经有<em>models/library_book.py</em> 定义了一个基本模型。 我们将对其进行编辑以添加新字段：</p><ol><li>使用最少的语法添加字段到<em>Libraty Book</em> 模型：</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> odoo <span class="keyword">import</span> models, fields</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    short_name = fields.Char(<span class="string">&#x27;Short Title&#x27;</span>)</span><br><span class="line">    notes = fields.Text(<span class="string">&#x27;Internal Notes&#x27;</span>)</span><br><span class="line">    state = fields.Selection(</span><br><span class="line">        [(<span class="string">&#x27;draft&#x27;</span>, <span class="string">&#x27;Not Available&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;available&#x27;</span>, <span class="string">&#x27;Available&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;lost&#x27;</span>, <span class="string">&#x27;Lost&#x27;</span>)],</span><br><span class="line">        <span class="string">&#x27;State&#x27;</span>)</span><br><span class="line">    description = fields.Html(<span class="string">&#x27;Description&#x27;</span>)</span><br><span class="line">    cover = fields.Binary(<span class="string">&#x27;Book Cover&#x27;</span>)</span><br><span class="line">    out_of_print = fields.Boolean(<span class="string">&#x27;Out of Print?&#x27;</span>)</span><br><span class="line">    date_release = fields.Date(<span class="string">&#x27;Release Date&#x27;</span>)</span><br><span class="line">    date_updated = fields.Datetime(<span class="string">&#x27;Last Updated&#x27;</span>)</span><br><span class="line">    pages = fields.Integer(<span class="string">&#x27;Number of Pages&#x27;</span>)</span><br><span class="line">    reader_rating = fields.Float(</span><br><span class="line">        <span class="string">&#x27;Reader Average Rating&#x27;</span>,</span><br><span class="line">        digits=(<span class="number">14</span>, <span class="number">4</span>), <span class="comment"># Optional precision decimals,</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure><ol start="2"><li>我们在模型中添加了新字段。我们仍然需要将这些字段添加到表单视图中，以便在用户界面中反映这些更改。参考以下代码在表单视图中添加字段：</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;author_ids&quot;</span> <span class="attr">widget</span>=<span class="string">&quot;many2many_tags&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;state&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;pages&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;notes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;short_name&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;date_release&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;date_updated&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;cover&quot;</span> <span class="attr">widget</span>=<span class="string">&quot;image&quot;</span> <span class="attr">class</span>=<span class="string">&quot;oe_avatar&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;reader_rating&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;description&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p>升级模块将使这些更改在 Odoo 模型中生效。<br>查看如下这些不同字段的示例。这里我们对字段使用了不同类型的属性。这会让读者对字段声明拥有更好的概念：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">short_name = fields.Char(<span class="string">&#x27;Short Title&#x27;</span>,translate=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">state = fields.Selection(</span><br><span class="line">    [(<span class="string">&#x27;draft&#x27;</span>, <span class="string">&#x27;Not Available&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;available&#x27;</span>, <span class="string">&#x27;Available&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;lost&#x27;</span>, <span class="string">&#x27;Lost&#x27;</span>)],</span><br><span class="line">    <span class="string">&#x27;State&#x27;</span>, default=<span class="string">&quot;draft&quot;</span>)</span><br><span class="line">description = fields.Html(<span class="string">&#x27;Description&#x27;</span>, sanitize=<span class="literal">True</span>, strip_style=<span class="literal">False</span>)</span><br><span class="line">pages = fields.Integer(<span class="string">&#x27;Number of Pages&#x27;</span>,</span><br><span class="line">    groups=<span class="string">&#x27;base.group_user&#x27;</span>,</span><br><span class="line">    states=&#123;<span class="string">&#x27;lost&#x27;</span>: [(<span class="string">&#x27;readonly&#x27;</span>, <span class="literal">True</span>)]&#125;,</span><br><span class="line">    <span class="built_in">help</span>=<span class="string">&#x27;Total book page count&#x27;</span>, company_dependent=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><h3 id="运行原理-1"><a href="#运行原理-1" class="headerlink" title="运行原理"></a>运行原理</h3><p>通过在其Python类中定义一个属性，将字段添加到模型中。可用的非关系字段类型如下：</p><ul><li><p><strong>Char</strong> 用于字符串值。</p></li><li><p><strong>Text</strong> 用于多行字符串值。</p></li><li><p><strong>Selection</strong> 用于选择列表。这是一个值和描述的列表。所选择的值会存储在数据库中，可以是字符串或整型。描述可自动翻译。</p><blockquote><p>重要提示<br>在Selection类型的字段中，值您可以使用整数，但注意Odoo会将0解释为内部未设置，如果存储的值为0，则不会显示描述。因此您需要考虑到这一点。</p></blockquote></li><li><p><strong>Html</strong> 类似于文本字段，通常以HTML格式存的储富文本。</p></li><li><p><strong>Binary</strong> 二进制字段存储二进制文件，例如图像或文档。</p></li><li><p><strong>Boolean</strong> 布尔类型，存储<em>True&#x2F;False</em> 值。</p></li><li><p><strong>Date</strong> 用于存储日期值。在数据库中以日期存储。在ORM中以Python日期对象的形式处理。您可以使用<em>fields.Date.today()</em> 将当前日期设置为日期字段中的默认值。</p></li><li><p><strong>Datetime</strong> 用于存储日期时间值。在数据库中以原生<strong>UTC</strong> 时区存储。在ORM中以Python日期时间对象的形式处理。您可以使用<em>fields.Date.now()</em> 将当前时间设置为DateTime字段中的默认值。</p></li><li><p><strong>Integer</strong> 字段无需进一步解释。</p></li><li><p><strong>Float</strong> 字段存储数值。精度可以用总位数和小数位数来定义。</p></li><li><p><strong>Monetary</strong> 可以存储某种货币的金额。这也将在本章的<em>向模型添加货币字段</em> 中进行解释。</p></li></ul><p>本小节第一步展示了添加到每个字段类型的最小语法。第二步中扩展了字段定义的其他可选属性。<br>这是对使用的字段属性的解释：</p><ul><li><p><strong>string</strong> 是字段的标题，用于Odoo界面视图标签。它是可选的。如果未设置，自动通过字段名首字母大写，并用空格替换下划线规则产生。</p></li><li><p><strong>translate</strong> 当设置为<em>True</em> 时，该字段可翻译。该字段可以根据用户界面设置的语言来保存不同的值。</p></li><li><p><strong>default</strong> 字段的默认值，也可以设置为一个计算默认值的函数；例如：<code>default = _computer_default</code>，其中<em>_compute_default</em> 是在字段定义之前在模型上定义的方法。</p></li><li><p><strong>help</strong> 是显示在界面提示中的说明文本。</p></li><li><p><strong>groups</strong> 使该字段仅对某些安全组可用。它是一个字符串，包含以逗号分隔的安全组XML ID列表。这在第十章<em>《安全访问》</em> 中有更详细的说明。</p></li><li><p><strong>states</strong> 允许用户界面根据<em>state</em> 字段的值来动态设置<em>readonly</em> 、<em>required</em> 和<em>invisible</em> 属性的值。因此，它需要<em>state</em> 字段存在并在表单视图中使用（即使它是隐藏的）。状态属性的名称在Odoo中是硬编码的，不能更改。</p></li><li><p><strong>copy</strong> 标记在复制记录时是否复制字段值。默认情况下，非关联字段和<em>Many2one</em> 字段为True，<em>One2many</em> 和计算字段为 False。</p></li><li><p><strong>index</strong> 当设置为<em>True</em> 时，为该字段会创建一个数据库索引。它替换了已弃用的<code>select=1</code>属性。</p></li><li><p><strong>readonly</strong> 标志该字段在用户界面中默认为只读。</p></li><li><p><strong>required</strong> 标志该字段在用户界面中默认为必填项。</p><blockquote><p>这里提到的各种白名单在<em>odoo&#x2F;tools&#x2F;mail.py</em> 中定义。</p></blockquote></li><li><p><strong>company_dependent</strong> 标志该字段按不同的公司存储不同的值。取代了已弃用的<em>Property</em> 字段类型。</p></li><li><p><strong>group_operator</strong> 是一个聚合函数，用于在<em>group by</em> 模式下显示结果。此属性的可能值包括<em>count</em> 、<em>count_distinct</em> 、<em>array_agg</em> 、<em>bool_and</em> 、<em>bool_or</em> 、<em>max</em> 、<em>min</em> 、<em>avg</em> 和<em>sum</em> 。整数、浮点数和货币字段类型此属性的默认值为<em>sum</em> 。</p></li><li><p><strong>sanitize</strong> 标志用于HTML字段，并从可能不安全的标签中去除其内容。使用它执行输入的全局清理。<br> 如果您需要对HTML清理进行更精细的控制，可以使用以下属性，这些属性仅在启用<em>sanitize</em> 时才有效：</p><ul><li><strong>sanitize_tags&#x3D;True</strong>：删除不属于白名单的标签（这是默认设置）</li><li><strong>sanitize_attributes&#x3D;True</strong>：删除不属于白名单的标签的属性</li><li><strong>sanitize_style&#x3D;True</strong>：删除不属于白名单的样式属性</li><li><strong>strip_style&#x3D;True</strong>：删除所有样式元素</li><li><strong>strip_class&#x3D;True</strong>：删除类属性</li></ul></li></ul><p>最后，我们根据模型中新增的字段更新了表单视图。我们在这里以任意方式放置 <strong>&lt;field&gt;</strong> 标记，但您也可以将它们放置在任何您想要的位置。表单视图在第九章<em>《后端视图》</em> 中有更详细的解释。</p><h3 id="扩展内容-1"><a href="#扩展内容-1" class="headerlink" title="扩展内容"></a>扩展内容</h3><p><em>Selection</em> 字段还接受函数引用作为其选择属性而不是列表。这允许动态生成选项列表。您可以在本章的<em>使用引用字段添加动态关联</em> 一节中找到与此相关的示例，其中也使用了选择属性。</p><p><em>Date</em> 和<em>Datetime</em> 字段对象公开了一些方便的实用方法。</p><p>对于<em>Date</em> ，我们有以下内容：</p><ul><li><strong>fields.Date.to_date(string_value)</strong> ：将字符串解析为日期对象。</li><li><strong>fields.Date.to_string(date_value)</strong> ：将Python Date对象转换为字符串。</li><li><strong>fields.Date.today()</strong> ：以字符串格式返回当前日期。这适用于默认值。</li><li><strong>fields.Date.context_today(record, timestamp)</strong> ：根据记录（或记录集）上下文的时区，以字符串格式返回时间戳的日期（如果省略时间戳，返回当前日期）。</li></ul><p>对于<em>Datetime</em> ，我们有以下内容：</p><ul><li><strong>fields.Datetime.to_datetime(string_value)</strong> ：将字符串解析为日期时间对象。</li><li><strong>fields.Datetime.to_string(datetime_value)</strong> ：将日期时间对象转换为字符串。</li><li><strong>fields.Datetime.now()</strong> ：以字符串格式返回当前日期和时间。这适用于默认值。</li><li><strong>fields.Datetime.context_timestamp(record, timestamp)</strong> ：将原生的时间戳Datime对象转换到记录的上下文中的时区。这不适用于默认值，但可用于将数据发送到外部系统的实例。</li></ul><p>除了基本字段，我们还有关系字段：<em>Many2one</em> 、<em>One2many</em> 和<em>Many2many</em> 。这些在本章的<em>向模型添加关联字段</em> 中进行了解释。</p><p>也可以有具有自动计算值的字段，使用<em>计算字段</em> 属性定义计算函数。这在<em>向模型添加计算字段</em> 中进行了说明。</p><p>在Odoo模型中默认添加了一些字段，因此我们不应该为我们的字段使用这些名称。这些是id字段，用于记录自动生成的标识符，以及一些审计日志字段，如下所示：</p><ul><li><strong>create_date</strong> ：记录创建的时间戳。</li><li><strong>create_uid</strong> ：记录创建的用户。</li><li><strong>write_date</strong> ：记录最后一次修改的时间戳。</li><li><strong>write_uid</strong> ：记录最后一次修改的用户。</li></ul><p>可以通过设置<strong>_log_access&#x3D;False</strong> 模型属性来禁用这些日志字段的自动创建。<br>另一个特殊字段是<strong>active</strong> 。它必须是一个布尔字段，允许用户将记录标记为非活动。它用于启用记录的归档&#x2F;取消归档功能。其定义如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">active = fields.Boolean(<span class="string">&#x27;Active&#x27;</span>, default=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>默认情况下，只有<strong>active</strong> 属性设置为<strong>True</strong> 的记录才可见，要检索它们，我们需要使用带有<strong>[(‘active’, ‘&#x3D;’, False)]</strong> 的域过滤器。或者，如果<code>&#39;active_test&#39;: False</code>值被添加到环境的上下文中，ORM将不会过滤掉非活动记录。</p><p>在某些情况下，您可能无法修改上下文以获取活动记录和非活动记录。在这种情况下，您可以使用<strong>[‘|’, (‘active’, ‘&#x3D;’, True), (‘active’, ‘&#x3D;’, False)]</strong> 域过滤器。</p><blockquote><p><strong>警告</strong><br><strong>[(‘active’, ‘in’ (True, False))]</strong> 不像你想象的那样工作。Odoo明确地在域中寻找* (‘active’, ‘&#x3D;’, False)* 子句。它将默认将搜索限制为仅活动记录。</p></blockquote><h2 id="使用可配置精度的浮点型字段"><a href="#使用可配置精度的浮点型字段" class="headerlink" title="使用可配置精度的浮点型字段"></a>使用可配置精度的浮点型字段</h2><p>使用浮点字段时，我们可能希望让用户可配置要使用的小数精度。在本节中，我们将向Library Books模型添加一个成本价格字段，该字段具有用户可配置的小数精度。</p><h3 id="准备工作-2"><a href="#准备工作-2" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将继续使用上一小节中的<strong>my_library</strong> 附加模块。</p><h3 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>执行以下步骤以将动态小数精度应用于模型的<em>cost_price</em> 字段：</p><ol><li><p>从设置菜单中的链接激活开发人员模式（请参阅<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%AE%89%E8%A3%85Odoo%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第一章</a>安装Odoo开发环境中的激活Odoo激活Odoo开发者模式工具）。这将启用<strong>Settings | Technical</strong> 菜单。</p></li><li><p>访问小数精度配置。为此，请打开设置顶部菜单并选择<strong>Technical | Database Structure | Decimal Accuracy</strong> 。我们应该看到当前定义的设置列表。</p></li><li><p>添加新配置，将<strong>Usage</strong> 设置为<strong>Book Price</strong> ，并填写<strong>Digits</strong> 精度：</p><p><img src="/images/Creating_new_decimal_precision.png" alt="创建新的小数精度"></p></li><li><p>要使用此小数精度设置需要添加模型字段，请通过添加以下代码来编辑<em>models&#x2F;library_book.py</em> 文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    cost_price = fields.Float(<span class="string">&#x27;Book Cost&#x27;</span>, digits=<span class="string">&#x27;Book Price&#x27;</span>)</span><br></pre></td></tr></table></figure><blockquote><p><strong>提示</strong><br>每当您在模型中添加新字段时，您还需要将它们添加到视图中以便从用户界面访问它们。在前面的示例中，我们添加了<em>cost_price</em> 字段。 要在表单视图中看到这一点，您需要使用<code>&lt;field name=&quot;cost_price&quot;/&gt;</code>添加它。</p></blockquote></li></ol><h3 id="运行原理-2"><a href="#运行原理-2" class="headerlink" title="运行原理"></a>运行原理</h3><p>当您将字符串值添加到字段的<strong>digits</strong> 属性时，Odoo在小数精度模型的<strong>Usage</strong> 字段中查找该字符串并返回具有<strong>16</strong> 位精度和配置中定义的小数位数的元组。使用字段定义，而不是硬编码，允许最终用户根据他们的需要进行配置。</p><blockquote><p><strong>提示</strong><br>如果您使用的是<em>v13</em> 之前的版本，则需要一些额外的工作才能在浮点字段中使用<strong>digits</strong> 属性。在旧版本中，小数精度在一个名为<strong>decimal_precision</strong> 的单独模块中。要在您的字段中启用自定义小数精度，您必须使用<strong>decimal_precision</strong> 模块的<code>get_precision()</code>方法，如下所示：<strong>cost_price &#x3D; fields.Float(‘Book Cost’, digits&#x3D;dp.get_precision(‘Book Price’))</strong> 。</p></blockquote><h2 id="向模型添加货币字段"><a href="#向模型添加货币字段" class="headerlink" title="向模型添加货币字段"></a>向模型添加货币字段</h2><p>Odoo对与货币相关的货币字段有特殊的支持。 让我们看看如何在模型中使用它。</p><h3 id="准备工作-3"><a href="#准备工作-3" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将继续使用上一小节中的<strong>my_library</strong> 附加模块。</p><h3 id="实现步骤-1"><a href="#实现步骤-1" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>货币字段需要一个额外的币别字段来存储相应的货币金额。</p><p><strong>my_library</strong> 已经有<em>models&#x2F;library_book.py</em> ，它定义了一个基本模型。我们将对其进行编辑以添加必填字段：</p><ol><li><p>添加币别字段用于存储币别：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    currency_id = fields.Many2one(<span class="string">&#x27;res.currency&#x27;</span>, string=<span class="string">&#x27;Currency&#x27;</span>)</span><br></pre></td></tr></table></figure></li><li><p>添加货币字段用于存储金额：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    retail_price = fields.Monetary(<span class="string">&#x27;Retail Price&#x27;</span>,</span><br><span class="line">        <span class="comment"># optional: currency_field=&#x27;currency_id&#x27;,</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure></li></ol><p>现在，升级附加模块，新字段应该在模型中可用。在将它们添加到视图之前，它们不会在视图中可见，但我们可以通过开发者模式进入到<strong>Settings | Technical | Database Structure | Models</strong> 中查看。</p><p>将它们添加到表单视图后，它将如下所示：</p><p>   <img src="/images/Currency_symbol_in_the_monetary_field.png" alt="货币字段的货币符号"></p><h3 id="运行原理-3"><a href="#运行原理-3" class="headerlink" title="运行原理"></a>运行原理</h3><p>货币字段类似于浮点型字段，Odoo能够在用户界面中正确地表示它们，因为它通过第二个字段知道它们的货别是什么。</p><p>这个货币字段应该被称为<strong>currency_id</strong> ，但我们可以使用我们喜欢的任何字段名称，只要它使用可选的<strong>currency_field</strong> 参数来指示即可。</p><blockquote><p><strong>提示</strong><br>如果您将币别信息存储在名称为<em>currency_id</em> 的字段中，则可以省略货币字段中的<em>currency_field</em> 属性。<br>当您需要在同一记录中维护不同货币的金额时，这非常有用。例如，如果我们要包含销售订单的货币和公司的货币，您可以将这两个字段配置为<code>fields.Many2one(res.currency)</code>并将第一个用于第一个金额，另一个用于 第二笔金额。<br>您还应知道金额的小数精度取自货币定义（<em>res.currency</em> 模型的<em>decimal_precision</em> 字段）。</p></blockquote><h2 id="向模型添加关联字段"><a href="#向模型添加关联字段" class="headerlink" title="向模型添加关联字段"></a>向模型添加关联字段</h2><p>Odoo模型之间的关系由关系字段表示。存在三种不同类型的关系：</p><ul><li><strong>many-to-one</strong> ：多对一，通常缩写为m2o。</li><li><strong>one-to-many</strong> ：一对多，通常缩写为o2m。</li><li><strong>many-to-many</strong> ：多对多，通常缩写为m2m。</li></ul><p>查看<strong>Library Books</strong> 示例，我们可以看到每本书只能有一个出版商，因此我们可以在书籍和出版商之间建立多对一的关系。</p><p>但是，每个出版商可以拥有许多书籍。 因此，前面的多对一关系意味着一对多的反向关系。</p><p>最后，在某些情况下，我们可以建立多对多关系。在我们的示例中，每本书可以有几个（许多）作者。此外，相反，每个作者可能写过很多书。从任何一方来看，这是一个多对多的关系。</p><h3 id="准备工作-4"><a href="#准备工作-4" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将继续使用上一小节中的<strong>my_library</strong> 附加模块。</p><h3 id="实现步骤-2"><a href="#实现步骤-2" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>Odoo使用<em>partner</em> 模型<strong>res.partner</strong> 来表示人员、组织和地址。我们应该为作者和出版商使用它。我们将编辑<strong>models&#x2F;library_book.py</strong> 文件以添加这些字段：</p><ol><li><p>向Library Books模型添加图书出版商的多对一（<strong>many-to-one</strong> ）字段:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    publisher_id = fields.Many2one(</span><br><span class="line">       <span class="string">&#x27;res.partner&#x27;</span>, string=<span class="string">&#x27;Publisher&#x27;</span>,</span><br><span class="line">        <span class="comment"># optional:</span></span><br><span class="line">        ondelete=<span class="string">&#x27;set null&#x27;</span>,</span><br><span class="line">        context=&#123;&#125;,</span><br><span class="line">        domain=[],</span><br><span class="line">    )</span><br></pre></td></tr></table></figure></li><li><p>要为出版商的书籍添加一对多（<strong>one-to-many</strong> ）字段，我们需要扩展<em>partner</em> 模型。为简单起见，我们将其添加到同一个 Python文件中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResPartner</span>(models.Model):</span><br><span class="line">    _inherit = <span class="string">&#x27;res.partner&#x27;</span></span><br><span class="line">    published_book_ids = fields.One2many(</span><br><span class="line">        <span class="string">&#x27;library.book&#x27;</span>, <span class="string">&#x27;publisher_id&#x27;</span>,</span><br><span class="line">        string=<span class="string">&#x27;Published Books&#x27;</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure><blockquote><p>我们在这里使用的<strong>_inherit</strong> 属性用于继承现有模型。这将在本章后面的<em>使用继承向模型添加功能</em> 中解释。</p></blockquote></li><li><p>我们已经创建了书籍和作者之间的多对多（<strong>many-to-many</strong> ）关系，但让我们重新查看一下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    author_ids = fields.Many2many(<span class="string">&#x27;res.partner&#x27;</span>, string=<span class="string">&#x27;Authors&#x27;</span>)</span><br></pre></td></tr></table></figure></li><li><p>同样的关联，但作者对书籍的关联应该添加到<strong>partner</strong> 模型中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResPartner</span>(models.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    authored_book_ids = fields.Many2many(</span><br><span class="line">        <span class="string">&#x27;library.book&#x27;</span>,</span><br><span class="line">        string=<span class="string">&#x27;Authored Books&#x27;</span>,</span><br><span class="line">        <span class="comment"># relation=&#x27;library_book_res_partner_rel&#x27; # optional</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure></li></ol><p>现在，升级附加模块，新字段应该在模型中可用。在将它们添加到视图之前，它们不会出现在视图中，但我们可以通过开发者模式进入到<strong>Settings | Technical | Database Structure | Models</strong> 中查看。</p><h3 id="运行原理-4"><a href="#运行原理-4" class="headerlink" title="运行原理"></a>运行原理</h3><p>多对一字段会在模型的数据库表中添加一列，存储相关记录的数据库ID。在数据库级别，还将创建外键约束，确保存储的ID是对相关表中记录的有效引用。这些关联字段不会创建数据库索引，但这可以通过添加<strong>index&#x3D;True</strong> 属性来创建数据库索引。</p><p>我们可以看到还有四个属性可以用于多对一字段。<strong>ondelete</strong> 属性确定删除相关记录时会发生什么。例如，当图书的出版商记录被删除时，图书会发生什么情况？默认值为<strong>&#39;set null&#39;</strong> ，它在字段上设置一个空值。它也可以是<strong>&#39;restrict&#39;</strong> ，防止删除相关记录，或<strong>&#39;cascade&#39;</strong> ，这将导致链接的记录也被删除。</p><p>最后两个（<strong>context</strong> 和<strong>domain</strong> ）对其他关系字段也有效。这些字段在客户端是很有意义的，在模型层面，它们作为默认值在客户端视图中使用。</p><ul><li><strong>context</strong> ：在点击字段进入相关记录视图时，会将添加到客户端上下文变量中。例如，我们可以用它来为创建的新记录设置默认值。</li><li><strong>domain</strong> ：是一个搜索过滤器，用于限制可用的关联记录的列表。</li></ul><p>context和domain在第九章<em>《后台视图》</em> 中都有详细的解释。</p><p>一对多字段是多对一的反关联，尽管它们像其他字段一样被添加到模型中，但它们在数据库中没有实际的表示。相反，它们是程序化的快捷方式，它们使视图能够表示这些相关记录的列表。这意味着一对多字段在关联模型中需要一个多对一字段。在我们的例子中，我们通过继承一个<em>partner</em> 模型来添加一对多字段。我们将在本章的<em>使用继承向模型添加功能</em> 中详细了解模型的继承。在我们的例子中，一对多字段<strong>published_book_ids</strong> 引用了<strong>library.book</strong> 模型的<strong>publisher_id</strong> 字段。</p><p>多对多的关联也不为模型的表添加列。这种类型的关联在数据库中使用一个中间关联表来存储，其中两列存储两个关联对象的ID。在书籍和作者之间添加新关系会在关联表中创建一条新记录，其中包含书籍ID和作者ID。</p><p>Odoo自动处理这个关联表的创建。默认情况下，关联表名称是使用两个关联模型的名称构建的，按字母顺序排序，加上一个<strong>_rel</strong> 后缀。但是，我们可以使用字段属性覆盖它。</p><p>需要记住的一个情况是，当两个表名足够大，以至于自动生成的数据库标识符超过<em>PostgreSQL</em> 63个字符的限制时。根据规则，如果两个相关表的名称超过23个字符，则应使用字段属性设置较短的名称。在下一节中，我们将对此进行更详细的介绍。</p><h3 id="扩展内容-2"><a href="#扩展内容-2" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>Many2one字段支持附加的<strong>auto_join</strong> 属性。这是一个允许ORM在该字段上使用SQL连接的标志。因此，它绕过了通常的ORM控制，例如用户访问控制和记录访问规则。在特定情况下，它可以解决性能问题，一般建议避免使用它。</p><p>我们已经介绍了如何通过最简单的方法来定义关联字段。让我们看一下特定于该类型字段的属性。</p><p><strong>One2many</strong> 字段有以下属性：</p><ul><li><strong>commodel_name</strong> ：这是目标模型标识符，对于所有关系字段都是必需的，但可以按位置定义，无需使用关键字。</li><li><strong>inverse_name</strong> ：这仅适用于<strong>One2many</strong> 并且是反向<strong>Many2one</strong> 关联的目标模型中的字段名称。</li><li><strong>limit</strong> ：这适用于<strong>One2many</strong> 和<strong>Many2many</strong> ，并可在用户界面级别限制用户读取的记录数量。</li></ul><p><strong>Many2many</strong> 字段有以下属性：</p><ul><li><strong>comodel_name</strong> ：这与<strong>One2many</strong> 字段相同。</li><li><strong>relation</strong> ：设置多对多关联表表名。</li><li><strong>column1</strong> ：这是链接到此模型的关联表中的<strong>Many2one</strong> 字段的名称。</li><li><strong>column2</strong> ：这是链接到<strong>comodel</strong> 的关联表中的<strong>Many2one</strong> 字段的名称。</li></ul><p>对于<strong>Many2many</strong> 关联，在大多数情况下ORM会处理这些属性的默认值。它甚至能够检测反向Many2many关联，检测已经存在的关联表，并适当地反转column1和column2的值。</p><p>但是，有两种情况我们需要介入并为这些属性提供我们自己的值：</p><ul><li>一种情况是我们在相同的两个模型之间需要不止一个<strong>Many2many</strong> 关系时，我们必须自己提供第二个关系的关联表名称，该名称必须与第一个关联表不同。</li><li>另一种情况是相关表的数据库名称足够长，以至于自动生成的关联表名超过了<strong>PostgreSQL</strong> 数据库对象名称的<em>63</em> 个字符的限制。</li></ul><p>自动生成的关联表名称格式是<strong>&lt;model1&gt;_&lt;model2&gt;_rel</strong> 。但此关联表还为其创建了一个主键索引，其标识符如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&lt;</span>model1<span class="operator">&gt;</span>_<span class="operator">&lt;</span>model2<span class="operator">&gt;</span>_rel_<span class="operator">&lt;</span>model1<span class="operator">&gt;</span>_id_<span class="operator">&lt;</span>model2<span class="operator">&gt;</span>_id_key</span><br></pre></td></tr></table></figure><p>此主键还需要满足<em>63</em> 个字符的限制。因此，如果两个表名的字符总和超过<em>63</em> ，需要手动设置关联属性。</p><h2 id="添加模型层次结构"><a href="#添加模型层次结构" class="headerlink" title="添加模型层次结构"></a>添加模型层次结构</h2><p>层次结构（<strong>Hierarchies</strong> ）表示在同一模型之间做关联。每个记录在同一模型中都有一个父记录，以及许多子记录。这可以通过简单地使用模型与其自身之间的多对一关联来实现。</p><p>然而，Odoo还可通过使用<em>嵌套集模型 (<a href="https://en.wikipedia.org/wiki/Nested_set_model">https://en.wikipedia.org/wiki/Nested_set_model</a>)</em> 为此类字段提供了更好的支持。启用后，在其域过滤器中使用<strong>child_of</strong> 运算符进行查询会发现查询速度明显的变快。</p><p>继续以<strong>Library Books</strong> 为例，我们将构建一个分层类别树，可用于对图书进行分类。</p><h3 id="准备工作-5"><a href="#准备工作-5" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将继续使用上一小节中的<strong>my_library</strong> 附加模块。</p><h3 id="实现步骤-3"><a href="#实现步骤-3" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>我们将新建一个Python文件，<strong>models&#x2F;library_book_categ.py</strong> ，如下所示：</p><ol><li><p>要加载新的Python代码文件，请将以下行添加到<strong>models&#x2F;<strong>init</strong>.py</strong> 文件中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> library_book_categ</span><br></pre></td></tr></table></figure></li><li><p>要创建具有父子关系的<strong>Book Category</strong> 模型，请使用以下代码创建<strong>models&#x2F;library_book_categ.py</strong> 文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> odoo <span class="keyword">import</span> models, fields, api</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookCategory</span>(models.Model):</span><br><span class="line">    _name = <span class="string">&#x27;library.book.category&#x27;</span></span><br><span class="line">    name = fields.Char(<span class="string">&#x27;Category&#x27;</span>)</span><br><span class="line">    parent_id = fields.Many2one(</span><br><span class="line">        <span class="string">&#x27;library.book.category&#x27;</span>,</span><br><span class="line">        string=<span class="string">&#x27;Parent Category&#x27;</span>,</span><br><span class="line">        ondelete=<span class="string">&#x27;restrict&#x27;</span>,</span><br><span class="line">        index=<span class="literal">True</span></span><br><span class="line">    )</span><br><span class="line">    child_ids = fields.One2many(</span><br><span class="line">        <span class="string">&#x27;library.book.category&#x27;</span>, <span class="string">&#x27;parent_id&#x27;</span>,</span><br><span class="line">        string=<span class="string">&#x27;Child Categories&#x27;</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure></li><li><p>要启用特殊的层次结构支持，还要添加以下代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_parent_store = <span class="literal">True</span></span><br><span class="line">_parent_name = <span class="string">&quot;parent_id&quot;</span> <span class="comment"># optional if field is &#x27;parent_id&#x27;</span></span><br><span class="line">parent_path = fields.Char(index=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li><li><p>要添加防止循环关联的检查，请将以下行添加到模型中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> odoo.exceptions <span class="keyword">import</span> ValidationError</span><br><span class="line">...</span><br><span class="line"><span class="meta">    @api.constraints(<span class="params"><span class="string">&#x27;parent_id&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_hierarchy</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._check_recursion():</span><br><span class="line">            <span class="keyword">raise</span> models.ValidationError(</span><br><span class="line">                <span class="string">&#x27;Error! You cannot create recursive categories.&#x27;</span>)</span><br></pre></td></tr></table></figure></li><li><p>现在我们需要为一本书分配一个类别。为此，我们将向<strong>library.book</strong> 模型添加一个新的<strong>many2one</strong> 字段：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">category_id = fields.Many2one(<span class="string">&#x27;library.book.category&#x27;</span>)</span><br></pre></td></tr></table></figure></li></ol><p>最后需要升级模块使这些更改生效。</p><blockquote><p>要在用户界面中显示<strong>librart.book.category</strong> 模型，您需要添加菜单、视图和安全规则。 有关详细信息，请参阅第三章<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%88%9B%E5%BB%BAOdoo%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">创建Odoo附加模块</a>。 或者，您可以在<a href="https://github.com/PacktPublishing/Odoo-13-Development-Cookbook-FourthEdition">https://github.com/PacktPublishing/Odoo-13-Development-Cookbook-FourthEdition</a>查看所有代码。</p></blockquote><h3 id="运行原理-5"><a href="#运行原理-5" class="headerlink" title="运行原理"></a>运行原理</h3><p>步骤1和2创建具有层次结构的新模型。<strong>Many2one</strong> 关联添加一个字段来与父记录关联。为了更快地搜索子记录，使用<strong>index&#x3D;True</strong> 参数在数据库中对该字段进行索引。<strong>parent_id</strong> 字段必须将<strong>ondelete</strong> 设置为<strong>&#39;cascade&#39;</strong> 或<strong>&#39;restrict&#39;</strong> 。 在这一点上，我们已经具备了实现层次结构所需的一切，但我们还可以做一些额外的事情来改善它。<strong>One2many</strong> 关系不会向数据库添加任何其他字段，但提供了一种快捷方式来访问以该记录的所有子记录。</p><p>在第3步中，我们启用了对层次结构的特殊支持。这对于高读低写指令非常有用，因为它带来了更快的数据浏览速度，但代价是性能更低的的写操作。这是通过添加一个辅助字段<strong>parent_path</strong> 并将模型属性设置为<strong>_parent_store&#x3D;True</strong> 来实现的。启用此属性后，帮助字段将用于在分层树中的搜索中存储数据。默认情况下，假定记录的父字段名为<strong>parent_id</strong> ，但也可以使用不同的名称。在这种情况下，应使用附加模型属性<strong>_parent_name</strong> 指示正确的字段名称。 默认如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_parent_name = <span class="string">&#x27;parent_id&#x27;</span></span><br></pre></td></tr></table></figure><p>步骤4是为了防止层次结构中出现循环依赖，这意味着在升序树和降序树中都有记录。这对于在树中导航的程序来说是危险的，因为它们可能会进入无限循环。<strong>models.Model</strong> 为我们提供了一个有效的方法（<em>_check_recursion</em> ）我们在这里进行了复用。</p><p>第5步是在<strong>libary.book</strong> 图书中添加类型为<strong>many2one</strong> 的<strong>category_id</strong> 字段，这样我们就可以在图书记录上设置一个类别。 这只是为了完成我们的示例。</p><h3 id="扩展内容-3"><a href="#扩展内容-3" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>此处显示的技术应该用于<em>静态</em> 层次结构，这些层次结构经常被读取和查询，但更新频率较低。图书类别就是一个很好的例子，因为图书馆不会不断地创建新类别；但是，读者通常会将他们的搜索限制在一个类别及其子类别中。其原因在于数据库中嵌套集合模型的实现，每当插入、删除或移动类别时，都需要更新所有记录的<strong>parent_path</strong> 列（以及相关的数据库索引）。这可能是一项非常消耗资源的操作，尤其是在并行事务中执行多行编辑时。</p><p>如果您正在处理一个非常动态的层次结构，标准的<strong>parent_id</strong> 和<strong>child_ids</strong> 关联通常会通过避免表级锁定来提高性能。</p><h2 id="向模型添加约束验证"><a href="#向模型添加约束验证" class="headerlink" title="向模型添加约束验证"></a>向模型添加约束验证</h2><p>模型可以进行验证，以防止它们输入不希望的条件判断。</p><p>Odoo提供两种不同类型的约束：</p><ul><li>数据库级别的约束检查。</li><li>服务端级别的约束检查。</li></ul><p>数据库级别的约束仅限于<strong>PostgreSQL</strong> 支持的约束。最常用的是<strong>UNIQUE</strong> 约束，但也可以使用<strong>CHECK</strong> 和<strong>EXCLUDE</strong> 约束。 如果这些还不足以满足我们的需求，我们可以使用Python代码编写的Odoo服务端级约束。</p><p>我们将使用在<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%88%9B%E5%BB%BAOdoo%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第三章</a>创建的<strong>Library Books</strong> 模型，创建Odoo附加模块，并为其添加一些约束。我们将添加一个防止重复书名的数据库约束，以及一个防止发布日期大于当前日期的Python模型约束。</p><h3 id="准备工作-6"><a href="#准备工作-6" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将继续使用上一小节中的<strong>my_library</strong> 附加模块。</p><p>我们希望它至少包含以下内容：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> odoo <span class="keyword">import</span> models, fields</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">_name = <span class="string">&#x27;library.book&#x27;</span></span><br><span class="line">name = fields.Char(<span class="string">&#x27;Title&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line">date_release = fields.Date(<span class="string">&#x27;Release Date&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="实现步骤-4"><a href="#实现步骤-4" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>我们将在<strong>models&#x2F;library_book.py</strong> Python文件中编辑<strong>LibraryBook</strong> 类：</p><ol><li><p>要创建数据库约束，请添加模型属性：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    _sql_constraints = [</span><br><span class="line">        (<span class="string">&#x27;name_uniq&#x27;</span>, <span class="string">&#x27;UNIQUE (name)&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Book title must be unique.&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;positive_page&#x27;</span>, <span class="string">&#x27;CHECK(pages&gt;0)&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;No of pages must be positive&#x27;</span>)</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure></li><li><p>要创建Python代码约束，请添加模型方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> odoo <span class="keyword">import</span> api, models, fields</span><br><span class="line"><span class="keyword">from</span> odoo.exceptions <span class="keyword">import</span> ValidationError</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"><span class="meta">    @api.constrains(<span class="params"><span class="string">&#x27;date_release&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_release_date</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> record <span class="keyword">in</span> self:</span><br><span class="line">            <span class="keyword">if</span> record.date_release <span class="keyword">and</span> record.date_release &gt; fields.Date.today():</span><br><span class="line">                <span class="keyword">raise</span> models.ValidationError(<span class="string">&#x27;Release date must be in the past&#x27;</span>)</span><br></pre></td></tr></table></figure></li></ol><p>对代码文件进行这些更改后，需要升级附加模块并重新启动服务器。</p><h3 id="运行原理-6"><a href="#运行原理-6" class="headerlink" title="运行原理"></a>运行原理</h3><p>第一步在模型的表上创建一个数据库约束。 它在数据库级别强制执行。<strong>_sql_constraints</strong> 模型属性接受要创建的约束列表。每个约束由一个三元素元组定义。这些列表如下：</p><ul><li>用于约束标识符的后缀。在我们的示例中，我们使用了<strong>name_uniq</strong> ，生成的约束名称是<strong>library_book_name_uniq</strong> 。</li><li><strong>PostgreSQL</strong> 用于更改或创建数据库表的SQL语句。</li><li>违反约束时向用户报告的消息。</li></ul><p>在我们的示例中，我们使用了两个SQL约束。第一个是唯一的书名，第二个是检查该书的页数是否为正数。</p><blockquote><p><strong>警告</strong><br>如果通过模型继承向现有模型添加SQL约束，请确保没有违反约束的行。如果有这样的行，则不会添加SQL约束，并且会在日志中输出错误信息。</p></blockquote><p>正如我们前面提到的，也可以使用其他数据库表约束。请注意，不能以例如<strong>NOT NULL</strong> 这种方式添加列约束。有关一般<strong>PostgreSQL</strong> 约束和特别是表约束的更多信息，请查看 <a href="http://www.postgresql.org/docs/current/static/ddlconstraints.html">http://www.postgresql.org/docs/current/static/ddlconstraints.html</a>。</p><p>在第二步中，我们添加了一个方法来执行Python代码验证。这里使用了<strong>@api.constrains</strong> 修饰，这意味着当参数列表中的一个字段发生更改时，应该执行它以运行检查。如果检查失败，将会抛出<strong>ValidationError</strong> 异常。</p><h3 id="扩展内容-4"><a href="#扩展内容-4" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>通常如果需要复杂的验证，可以使用<strong>@api.constrains</strong> ，但对于一些简单的情况，可以使用带有<strong>CHECK</strong> 选项的<strong>_sql_constraints</strong> 。 看看下面的例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_sql_constraints = [</span><br><span class="line">( <span class="string">&#x27;check_credit_debit&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;CHECK(credit + debit&gt;=0 AND credit * debit=0)&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Wrong credit or debit value in accounting entry!&#x27;</span></span><br><span class="line">)</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>在前面的示例中，我们使用了<strong>CHECK</strong> 选项，并且我们正在使用<strong>AND</strong> 运算符检查同一约束中的多个条件。</p><h2 id="向模型添加计算字段"><a href="#向模型添加计算字段" class="headerlink" title="向模型添加计算字段"></a>向模型添加计算字段</h2><p>有时我们需要一个字段，该字段的值是从同一记录或相关记录中的其他字段计算或派生的。一个典型的例子是总金额，它是通过将单价乘以数量来计算的。在Odoo模型中，这可以使用计算字段来实现。</p><p>为了向您展示计算字段的工作原理，我们将在<strong>Library Books</strong> 模型中添加一个来计算自图书发行日期以来的天数。</p><p>还可以使计算字段可编辑和可搜索。 这也将在我们的示例中实现这一点。</p><h3 id="准备工作-7"><a href="#准备工作-7" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将继续使用上一小节中的<strong>my_library</strong> 附加模块。</p><h3 id="实现步骤-5"><a href="#实现步骤-5" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>我们将编辑<strong>models&#x2F;library_book.py</strong> 代码文件以添加一个新字段和支持其逻辑的方法：</p><ol><li><p>首先将新字段添加到<strong>Library Books</strong> 模型：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    age_days = fields.Float(</span><br><span class="line">        string=<span class="string">&#x27;Days Since Release&#x27;</span>,</span><br><span class="line">        compute=<span class="string">&#x27;_compute_age&#x27;</span>,</span><br><span class="line">        inverse=<span class="string">&#x27;_inverse_age&#x27;</span>,</span><br><span class="line">        search=<span class="string">&#x27;_search_age&#x27;</span>,</span><br><span class="line">        store=<span class="literal">False</span>, <span class="comment"># optional</span></span><br><span class="line">        compute_sudo=<span class="literal">True</span> <span class="comment"># optional</span></span><br><span class="line">    )  </span><br></pre></td></tr></table></figure></li><li><p>接下来，添加具有值计算逻辑的方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="keyword">from</span> odoo <span class="keyword">import</span> api <span class="comment"># if not already imported</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"><span class="meta">    @api.depends(<span class="params"><span class="string">&#x27;date_release&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_compute_age</span>(<span class="params">self</span>):</span><br><span class="line">        today = fields.Date.today()</span><br><span class="line">        <span class="keyword">for</span> book <span class="keyword">in</span> self:</span><br><span class="line">            <span class="keyword">if</span> book.date_release:</span><br><span class="line">                delta = today - book.date_release</span><br><span class="line">                book.age_days = delta.days</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                book.age_days = <span class="number">0</span></span><br></pre></td></tr></table></figure></li><li><p>要添加方法并实现写入计算字段的逻辑，请使用以下代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_inverse_age</span>(<span class="params">self</span>):</span><br><span class="line">    today = fields.Date.today()</span><br><span class="line">    <span class="keyword">for</span> book <span class="keyword">in</span> self.filtered(<span class="string">&#x27;date_release&#x27;</span>):</span><br><span class="line">        d = today - timedelta(days=book.age_days)</span><br><span class="line">        book.date_release = d   </span><br></pre></td></tr></table></figure></li><li><p>要实现允许您在计算字段可搜索的逻辑，请使用以下代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_search_age</span>(<span class="params">self, operator, value</span>):</span><br><span class="line">        today = fields.Date.today()</span><br><span class="line">        value_days = timedelta(days=value)</span><br><span class="line">        value_date = today - value_days</span><br><span class="line">        <span class="comment"># convert the operator:</span></span><br><span class="line">        <span class="comment"># book with age &gt; value have a date &lt; value_date</span></span><br><span class="line">        operator_map = &#123;</span><br><span class="line">            <span class="string">&#x27;&gt;&#x27;</span>: <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;&gt;=&#x27;</span>: <span class="string">&#x27;&lt;=&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;&lt;&#x27;</span>: <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;&lt;=&#x27;</span>: <span class="string">&#x27;&gt;=&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        new_op = operator_map.get(operator, operator)</span><br><span class="line">        <span class="keyword">return</span> [(<span class="string">&#x27;date_release&#x27;</span>, new_op, value_date)]</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><p>需要重新启动Odoo，然后升级模块，才能正确激活这些新增功能。</p><h3 id="运行原理-7"><a href="#运行原理-7" class="headerlink" title="运行原理"></a>运行原理</h3><p>计算字段的定义与常规字段的定义相同，只是添加了一个<strong>compute</strong> 属性来指定用于其计算的方法的名称。</p><p>它们的相似性可能具有欺骗性，因为计算域在内部与常规域完全不同。计算字段是在运行时动态计算的，因此它们不会存储在数据库中，因此默认情况下您无法搜索或写入计算字段。您需要做一些额外的工作才能启用对计算字段的写入和搜索支持。让我们看看怎么做。</p><p>计算函数是在运行时动态计算的，但是ORM使用缓存来避免每次访问其值时重新计算它而造成性能低下。 所以它需要知道它依赖于哪些字段。使用<strong>@depends</strong> 装饰器来检测其缓存值何时应失效并重新计算。</p><p>确保<strong>compute</strong> 函数始终在计算字段上设置一个值。否则将引发错误。当您的代码中有<strong>if</strong> 条件且无法在计算字段上设置值时，可能会发生这种情况。这可能很难进行调试。</p><p>可以通过实现反函数（<strong>inverse</strong> ）来添加写支持。使用分配给计算字段的值来更新源字段。当然这只对简单的计算有用。尽管如此，仍然存在一些有用的情况。在我们的示例中，我们可以通过编辑自发行以来的天数计算字段来设置图书发行日期。<strong>inverse</strong> 属性是可选的；如果您不想使计算字段可编辑，则可以跳过它。</p><p>也可以通过设置<strong>search</strong> 属性为方法名称来使非存储计算字段也可搜索（类似于<strong>compute</strong> 和<strong>inverse</strong> ）。 和<strong>inverse</strong> 属性一样，<strong>search</strong> 属性也是可选的；如果您不想让计算字段可搜索，您可以跳过它。</p><p>但是这种方法预计不会实现在实际的搜索中。相反，它接收用于在字段上搜索的运算符和值作为参数，并期望返回一个具有替换搜索条件的域以供使用。在我们的示例中，我们将对<em>发布以来的天数</em> 字段的搜索转换为<em>发布日期</em> 字段上的等效搜索条件。</p><p>可选的<strong>store&#x3D;True</strong> 标志将字段存储在数据库中。在这种情况下，在计算之后字段值将存储在数据库中，然后以与常规字段相同的方式检索它们，而不是在运行时重新计算。 由于<strong>@api.depends</strong> 装饰器，ORM将知道何时需要重新计算和更新这些存储的值。您可以将其视为持久缓存。它还具有使该字段可用于搜索条件的优点，包括按操作排序和分组。如果在计算字段中使用<strong>store&#x3D;True</strong> ，则不再需要实现<strong>search</strong> 方法，因为该字段存储在数据库中，您可以根据存储的字段进行搜索或排序。</p><p>在需要以提升的权限完成计算的情况下，使用<strong>compute_sudo&#x3D;True</strong> 标志来实现。在当计算需要使用最终用户可能无法访问的字段数据时，可使用这种方法实现。</p><blockquote><p><strong>重要提示</strong><br>在Odoo v13中更改了<strong>compute_sudo</strong> 的默认值。在Odoo v13之前，<strong>compute_sudo</strong> 的值为<strong>False</strong> 。 但在v13中，<strong>compute_sudo</strong> 的默认值将基于<strong>store</strong> 属性。 如果<strong>store</strong> 属性的值为<strong>True</strong> ，则<strong>compute_sudo</strong> 为<strong>True</strong> 否则为<strong>False</strong> 。但是您始终可以通过在字段定义中显式放置<strong>compute_sudo</strong> 来手动更改它。</p></blockquote><h3 id="扩展内容-5"><a href="#扩展内容-5" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>Odoo v13为ORM引入了一种新的缓存机制。早期版本中，缓存是基于环境的，但现在在Odoo v13中，我们有一个全局缓存。因此，如果您有一个依赖于上下文值的计算字段，那么您有时可能会得到不正确的值。要解决此问题，您需要使用<strong>@api.depends_context</strong> 装饰器。 请参考以下示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api.depends(<span class="params"><span class="string">&#x27;price&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@api.depends_context(<span class="params"><span class="string">&#x27;company_id&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_compute_value</span>(<span class="params">self</span>):</span><br><span class="line">company_id = self.env.context.get(<span class="string">&#x27;company_id&#x27;</span>)</span><br><span class="line">...</span><br><span class="line"><span class="comment"># other computation</span></span><br></pre></td></tr></table></figure><p>您可以在上面的示例中看到，我们的计算使用上下文中的<strong>company_id</strong> 。通过在<strong>depends_context</strong> 装饰器中使用<strong>company_id</strong> ，我们可以确保字段值将根据上下文中<strong>company_id</strong> 的值重新计算。</p><h2 id="暴露存储在其他模型中的相关字段"><a href="#暴露存储在其他模型中的相关字段" class="headerlink" title="暴露存储在其他模型中的相关字段"></a>暴露存储在其他模型中的相关字段</h2><p>从服务器读取数据时，Odoo客户端只能获取模型中可用和正在查询的字段的值。与服务器端代码不同，客户端代码不能使用点表示法访问相关表中的数据。</p><p>但是这些字段可通过将它们添加为关联字段来进行访问。我们将这样做以使出版商所在的城市在<strong>Library Books</strong> 模型中可用。</p><h3 id="准备工作-8"><a href="#准备工作-8" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将继续使用上一小节中的<strong>my_library</strong> 附加模块。</p><h3 id="实现步骤-6"><a href="#实现步骤-6" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>编辑<strong>models&#x2F;library_book.py</strong> 文件以添加新的相关字段：</p><ol><li><p>确保我们有图书出版商的字段：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">    publisher_id = fields.Many2one(<span class="string">&#x27;res.partner&#x27;</span>, string=<span class="string">&#x27;Publisher&#x27;</span>)</span><br></pre></td></tr></table></figure></li><li><p>现在，添加发布者所在城市的相关字段：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># class LibraryBook(models.Model):</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">    publisher_city = fields.Char(</span><br><span class="line">        <span class="string">&#x27;Publisher City&#x27;</span>,</span><br><span class="line">        related=<span class="string">&#x27;publisher_id.city&#x27;</span>,</span><br><span class="line">        readonly=<span class="literal">True</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure></li></ol><p>最后，我们需要升级附加模块以使新字段在模型中可用。</p><h3 id="运行原理-8"><a href="#运行原理-8" class="headerlink" title="运行原理"></a>运行原理</h3><p>关联字段就像常规字段一样，但它们有一个附加属性<strong>related</strong> ，带有一个分隔字段链遍历的字符串。</p><p>在我们的例子中，我们通过<strong>publisher_id</strong> 访问与发布者相关的记录，然后读取它的<strong>city</strong> 字段。我们还可以有更长的链，例如<strong>publisher_id.country_id.country_code</strong> 。</p><p>请注意在本例中，我们将相关字段设置为<strong>只读</strong> 。如果我们不这样做，该字段将是可写的，并且用户可能会更改其值。这将具有更改相关发布者的城市字段值的效果。虽然这可能是一个有用的副作用，但需要谨慎。由同一出版商出版的所有书籍都将更新其<strong>publisher_city</strong> 字段，这可能不是用户期望的。</p><h3 id="扩展内容-6"><a href="#扩展内容-6" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>关联字段实际上是计算字段。它们只是提供了一种方便的快捷语法来从相关模型中读取字段值。作为一个计算域，这意味着<strong>store</strong> 属性也是可用的。作为一种快捷方式，它们还具有引用字段的所有属性，例如<strong>name</strong> 、<strong>translatable</strong> 。</p><p>此外，它们支持类似于<strong>compute_sudo</strong> 的<strong>related_sudo</strong> 标志；当设置为<strong>True</strong> 时，遍历时不检查用户的访问权限。</p><p>在<strong>create()</strong> 方法中使用关联字段可能会影响性能，因为这些字段的计算会延迟到它们的创建结束。因此，如果您有一个<strong>One2many</strong> 关联，例如在<strong>sale.order</strong> 和<strong>sale.order.line</strong> 模型中，并且您在line模型上有一个关联字段引用了order模型上的字段，应当在记录创建时在order模型中显式读取该字段，而不是使用关联字段快捷方式，尤其是在有很多行的情况下。</p><h2 id="使用引用字段添加动态关联"><a href="#使用引用字段添加动态关联" class="headerlink" title="使用引用字段添加动态关联"></a>使用引用字段添加动态关联</h2><p>对于关联字段，我们需要事先确定关联的目标模型（或comodel）。但是，有时我们可能需要将决定权留给用户，首先选择我们想要的模型，然后选择我们想要链接到的记录。</p><p>在Odoo中可以使用引用字段来实现。</p><h3 id="准备工作-9"><a href="#准备工作-9" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将继续使用上一小节中的<strong>my_library</strong> 附加模块。</p><h3 id="实现步骤-7"><a href="#实现步骤-7" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>编辑<strong>models&#x2F;library_book.py</strong> 文件以添加新的相关字段：</p><ol><li><p>首先，我们需要添加一个辅助方法来动态构建可选择目标模型的列表：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> odoo <span class="keyword">import</span> models, fields, api</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"><span class="meta">    @api.model</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_referencable_models</span>(<span class="params">self</span>):</span><br><span class="line">        models = self.env[<span class="string">&#x27;ir.model&#x27;</span>].search([</span><br><span class="line">            (<span class="string">&#x27;field_id.name&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;message_ids&#x27;</span>)])</span><br><span class="line">        <span class="keyword">return</span> [(x.model, x.name) <span class="keyword">for</span> x <span class="keyword">in</span> models]</span><br></pre></td></tr></table></figure></li><li><p>然后，我们需要添加引用字段并使用前面的函数提供可选模型列表：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ref_doc_id = fields.Reference(</span><br><span class="line">    selection=<span class="string">&#x27;_referencable_models&#x27;</span>,</span><br><span class="line">    string=<span class="string">&#x27;Reference Document&#x27;</span>)</span><br></pre></td></tr></table></figure></li></ol><p>由于我们正在更改模型的结构，因此需要升级模块来激活这些更改。</p><h3 id="运行原理-9"><a href="#运行原理-9" class="headerlink" title="运行原理"></a>运行原理</h3><p>引用字段类似于多对一字段，不同之处在于它们允许用户选择要链接到的模型。</p><p>可以从<strong>selection</strong> 属性提供的列表中选择目标模型。<strong>selection</strong> 属性必须是两个元素元组的列表，其中第一个是模型的内部标识符，第二个是它的文本描述。例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(<span class="string">&#x27;res.users&#x27;</span>, <span class="string">&#x27;User&#x27;</span>), (<span class="string">&#x27;res.partner&#x27;</span>, <span class="string">&#x27;Partner&#x27;</span>)]</span><br></pre></td></tr></table></figure><p>但是，我们可以使用最常见的模型，而不是提供固定列表。为简单起见，我们使用所有具有消息传递功能的模型。使用<strong>_referencable_models</strong> 方法动态组装模型列表。</p><p>上例中，我们首先提供了一个函数来浏览所有可以引用的模型记录，以动态构建<strong>selection</strong> 属性。虽然这两种形式都允许，但是我们在引号内声明了函数名，而不是直接引用不带引号的函数。这样更灵活，它允许引用的函数只在代码的后面定义，而使用直接引用时这是不可以的。</p><p>该函数需要<strong>@api.model</strong> 装饰器，因为它在模型级别上运行，而不是在记录集级别上运行。</p><p>虽然此功能看起来不错，但它带来了明显的性能开销。显示大量记录的引用字段（例如，在列表视图中）可能会产生繁重的数据库负载，因为必须在单独的查询中查找每个值。与常规关系字段不同，它也无法利用数据库引用完整性。</p><h2 id="使用继承向模型添加功能"><a href="#使用继承向模型添加功能" class="headerlink" title="使用继承向模型添加功能"></a>使用继承向模型添加功能</h2><p>Odoo最重要的特性之一是模块插件能够在其他模块插件的基础上扩展功能，而无需编辑原始功能的代码。这可能是添加字段或方法、修改现有字段或扩展现有方法以执行附加逻辑。</p><p>根据官方文档，Odoo提供了三种继承方式：</p><ul><li>类继承（扩展）</li><li>原型继承</li><li>代理继承</li></ul><p>我们将在单独的小节中介绍每一种继承方式。在本小节中我们将介绍类继承（扩展）。它用于向现有模型添加新字段或方法。</p><p>我们将扩展Odoo内置的合作伙伴模型<strong>res.partner</strong> 为其添加<em>创作书籍数量</em> 的计算字段。这涉及向现有模型添加字段和方法。</p><h3 id="准备工作-10"><a href="#准备工作-10" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将继续使用上一小节中的<strong>my_library</strong> 附加模块。</p><h3 id="实现步骤-8"><a href="#实现步骤-8" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>我们将扩展Odoo内置的合作伙伴模型。如果你还记得的话，我们已经在本章的<em>向模型添加关联字段</em> 中继承了<strong>res.parnter</strong> 模型。为了使解释尽可能简单，我们将在<strong>models&#x2F;library_book.py</strong> 代码文件中重用<strong>res.partner</strong> 模型：</p><ol><li><p>首先我们要确保在partner模型中存在<strong>authored_book_ids</strong> 反向关联，并添加计算域：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResPartner</span>(models.Model):</span><br><span class="line">    _inherit = <span class="string">&#x27;res.partner&#x27;</span></span><br><span class="line">    _order = <span class="string">&#x27;name&#x27;</span></span><br><span class="line">    authored_book_ids = fields.Many2many(</span><br><span class="line">        <span class="string">&#x27;library.book&#x27;</span>, string=<span class="string">&#x27;Authored Books&#x27;</span>)</span><br><span class="line">    count_books = fields.Integer( <span class="string">&#x27;Number of Authored Books&#x27;</span>,</span><br><span class="line">        compute=<span class="string">&#x27;_compute_count_books&#x27;</span> )</span><br></pre></td></tr></table></figure></li><li><p>接下来添加计算图书数量所需的方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="keyword">from</span> odoo <span class="keyword">import</span> api <span class="comment"># if not already imported</span></span><br><span class="line"><span class="comment"># class ResPartner(models.Model):</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"><span class="meta">    @api.depends(<span class="params"><span class="string">&#x27;authored_book_ids&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_compute_count_books</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> self:</span><br><span class="line">            r.count_books = <span class="built_in">len</span>(r.authored_book_ids)</span><br></pre></td></tr></table></figure></li></ol><p>最后我们需要升级附加模块才能使修改生效。</p><h3 id="运行原理-10"><a href="#运行原理-10" class="headerlink" title="运行原理"></a>运行原理</h3><p>当使用<strong>_inherit</strong> 属性定义模型类时，它会向继承的模型添加修改，而不是替换它。</p><p>这意味着继承类中定义的字段在父模型上添加或更改。在数据库层，ORM将字段添加到同一个数据库表中。</p><p>字段也被增量修改。这意味着如果该字段已经存在于父类中，则只修改继承类中声明的属性；其他属性保持在父类中。</p><p>继承类中定义的方法替换父类中的方法。如果你不使用<strong>super</strong> 调用调用父方法，在这种情况下，父类中的方法将不会被执行，我们将失去父类中的功能。因此，每当您通过继承现有方法添加新逻辑时，您应该包含一个带有<strong>super</strong> 的语句以调用父类中的功能。这在<em>第五章《基本服务器端开发》</em> 中有更详细的讨论。</p><blockquote><p>本小节将向现有模型添加新字段。如果您还想将这些新字段添加到现有视图（用户界面），请参阅<em>第九章《后端视图中的更改现有视图-视图继承》</em> 。</p></blockquote><h2 id="使用继承复制模型定义"><a href="#使用继承复制模型定义" class="headerlink" title="使用继承复制模型定义"></a>使用继承复制模型定义</h2><p>我们已经在前一节中看到了类继承（扩展）。现在我们将看到原型继承，它用于复制现有模型的整个定义。在本节中，我们将复制<strong>library.book</strong> 模型。</p><h3 id="准备工作-11"><a href="#准备工作-11" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将继续使用上一小节中的<strong>my_library</strong> 附加模块。</p><h3 id="实现步骤-9"><a href="#实现步骤-9" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>原型继承是通过同时使用<strong>_name</strong> 和<strong>_inherit</strong> 类属性来执行的。执行以下步骤以生成<strong>library.book</strong> 模型的副本：</p><ol><li><p>将名为<strong>library_book_copy.py</strong> 的新文件添加到<strong>/my_library/models/</strong> 目录。</p></li><li><p>将以下内容添加到<strong>library_book_copy.py</strong> 文件中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> odoo <span class="keyword">import</span> models, fields, api</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBookCopy</span>(models.Model):</span><br><span class="line">    _name = <span class="string">&quot;library.book.copy&quot;</span></span><br><span class="line">    _inherit = <span class="string">&quot;library.book&quot;</span></span><br><span class="line">    _description = <span class="string">&quot;Library Book&#x27;s Copy&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>将新文件引用导入<strong>/my_library/models/__init__.py</strong> 文件。更改后您的<strong>__init__.py</strong> 文件将如下所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> library_book</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> library_book_categ</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> library_book_copy</span><br></pre></td></tr></table></figure></li></ol><p>最后，我们需要升级附加模块才能使修改生效。进入<strong>Settings | Technical |<br>Database Structure | Models</strong> 菜单检查新模型的定义，您将在此处看到<strong>library.book.copy</strong> 模型的新条目。</p><blockquote><p><strong>提示</strong><br>为了查看新模型的菜单和视图，您需要添加视图和菜单的XML定义。要了解有关视图和菜单的更多信息，请参阅请参阅<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%88%9B%E5%BB%BAOdoo%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第三章</a><em>创建Odoo附加模块</em> 中的添加菜单项和视图。</p></blockquote><h3 id="运行原理-11"><a href="#运行原理-11" class="headerlink" title="运行原理"></a>运行原理</h3><p>通过同时使用<strong>_name</strong> 和<strong>_inherit</strong> 类属性，您可以复制模型的定义。当您在模型中使用这两个属性时，Odoo将复制<strong>_inherit</strong> 的模型定义并使用<strong>_name</strong> 属性创建一个新模型。</p><p>在我们的示例中，Odoo将复制<strong>library.book</strong> 模型的定义并创建一个新模型<strong>library.book.copy</strong> 。新的<strong>library.book.copy</strong> 模型有自己的数据库表，其数据完全独立于<strong>library.book</strong> 父模型。由于它仍然继承自partner模型，因此对它的任何后续修改也会影响新模型。</p><p>原型继承复制父类的所有属性。它复制字段、属性和方法。如果要在子类中修改它们，只需向子类添加新定义即可。例如，<strong>library.book</strong> 模型具有<strong>_name_get</strong> 方法。如果要在子类中使用不同的<strong>_name_get</strong> 逻辑，需要重新定义<strong>library.book.copy</strong> 模型中的<strong>_name_get</strong> 方法。</p><blockquote><p><strong>警告</strong><br>如果您在<strong>_inherit</strong> 和<strong>_name</strong> 属性中使用相同的模型名称，则原型继承不起作用。如果您确实在<strong>_inherit</strong> 和<strong>_name</strong> 属性中使用了相同的模型名称，那么它的行为就像普通的扩展继承一样。</p></blockquote><h3 id="扩展内容-7"><a href="#扩展内容-7" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>在官方文档中，这称为原型继承，但在实践中很少使用。这样做的原因是代理继承通常以更有效的方式满足这一需求，而无需复制数据结构。有关这方面的更多信息，您可以参考下一小节<em>使用代理继承将功能复制至另一个模型</em> 。</p><h2 id="使用代理继承将功能复制至另一个模型"><a href="#使用代理继承将功能复制至另一个模型" class="headerlink" title="使用代理继承将功能复制至另一个模型"></a>使用代理继承将功能复制至另一个模型</h2><p>第三种继承是委托继承。它使用<strong>_inherits</strong> 类属性而不是<strong>_inherit</strong> 。在某些情况下，我们不想修改现有模型，而是希望基于现有模型创建一个新模型以使用它已有的功能。我们可以使用原型继承来复制模型的定义，但这会产生重复的数据结构。如果您想复制模型的定义而不复制数据结构，那么可以使用委托继承，它使用<strong>_inherits</strong> 模型属性（注意附加的<strong>s</strong> ）。</p><p>传统的继承与面向对象编程中的概念有很大不同。反过来，委托继承也是类似的，因为可以创建一个新模型来包含父模型的特征。它还支持多态继承，我们从两个或多个其他模型继承。</p><p>我们图书馆中已经有书了。是时候给图书馆添加会员了。对于图书馆会员，我们需要在partner模型中找到的所有身份和地址数据，并且我们还希望它还能记录一些与会员资格相关的信息：开始日期、终止日期和卡号。</p><p>将这些字段添加到partner模型不是最佳解决方案，因为这些字段对于非会员是不需要的。我们需要将partner模型扩展到具有这些附加字段的新模型。</p><h3 id="准备工作-12"><a href="#准备工作-12" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将继续使用上一小节中的<strong>my_library</strong> 附加模块。</p><h3 id="实现步骤-10"><a href="#实现步骤-10" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>新的图书馆会员模型应该在它自己的Python代码文件中，但为了使解释尽可能简单，我们将重用<strong>models/library_book.py</strong> 文件：</p><ol><li><p>添加新的模型，继承自<strong>res.partner</strong> 模型:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryMember</span>(models.Model):</span><br><span class="line">    _name = <span class="string">&#x27;library.member&#x27;</span></span><br><span class="line">    _inherits = &#123;<span class="string">&#x27;res.partner&#x27;</span>: <span class="string">&#x27;parent_id&#x27;</span>&#125;</span><br><span class="line">    partner_id = fields.Many2one(</span><br><span class="line">        <span class="string">&#x27;res.partner&#x27;</span>,</span><br><span class="line">        ondelete=<span class="string">&#x27;cascade&#x27;</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure></li><li><p>接着我们添加会员的其他特殊字段：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># class LibraryMenber(models.Model):</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    date_start = fields.Date(<span class="string">&#x27;Member Since&#x27;</span>)</span><br><span class="line">    date_end = fields.Date(<span class="string">&#x27;Termination Date&#x27;</span>)</span><br><span class="line">    member_number = fields.Char()</span><br><span class="line">    date_of_birth = fields.Date(<span class="string">&#x27;Date of birth&#x27;</span>)</span><br></pre></td></tr></table></figure></li></ol><p>现在我们需要升级附加模块才能使修改生效。</p><h3 id="运行原理-12"><a href="#运行原理-12" class="headerlink" title="运行原理"></a>运行原理</h3><p><strong>_inherits</strong> 模型属性填的是我们需要继承的父模型。在这种情况下，我们的示例中只有一个<strong>res.partner</strong> 。它的值是一个<strong>键值字典</strong>，其中键是继承的模型，值是用于链接到它们的字段名称。我们还必须在模型中定义的<strong>Many2one</strong> 字段。在我们的示例中，<strong>partner_id</strong> 是用于与<strong>Partner</strong> 父模型链接的字段。</p><p>为了更好的理解它的运行原理，让我们从数据库层面看看，当新建一个图书馆会员时它做了什么动作：</p><ul><li>在<strong>res_partner</strong> 表新增了一条记录。</li><li>在<strong>library_member</strong> 表新增了一条记录。</li><li><strong>library_member</strong> 表中的<strong>partner_id</strong> 字段存储的是<strong>res_partner</strong> 表记录的ID。</li></ul><p>会员记录会自动链接到新的partner记录。这只是一个多对一的关系，但代理机制增加了一些魔力，使partner的字段可以在会员记录中使用，并且新的partner记录也会自动与新会员记录一起创建。</p><p>您可能想知道这个自动创建的partner记录并没有什么特别之处。它是一个普通的partner，如果您浏览partner模型，您将能够找到该记录（当然没有额外的会员特殊字段数据）。所有会员都是partner，但只有部分partner也是会员。</p><p>那么如果您删除了partner记录那会员记录会发生什么？您可以通过选择关系字段的<strong>ondelete</strong> 值来决定。对于<strong>partner_id</strong> ，我们使用了<strong>cascade</strong> 。这意味着当partner删除时相关的会员记录也会删除。我们本可以使用更保守的<strong>restrict</strong> 来禁止删除具有链接到会员的partner记录。在这种情况下，只有删除该会员才有效。</p><blockquote><p>请务必注意，代理继承仅适用于字段继承，不适用于方法继承。因此如果partner模型有一个<strong>do_something()</strong> 方法，会员模型将不会自动继承它。</p></blockquote><h3 id="扩展内容-8"><a href="#扩展内容-8" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>代理继承有一个捷径，您可以在<strong>Many2one</strong> 字段定义中使用<strong>delegate&#x3D;True</strong> 属性，而不是创建<strong>_inherits</strong> 字典。 这样做与使用<strong>_inherits</strong> 选项效果完全相同。主要优点是这样写更简单。在给定的示例中，我们执行了与前一个相同的继承委托，但在这种情况下，我们没有创建<strong>_inherits</strong> 字典，而是在<strong>partner_id</strong> 字段中使用了<strong>delegate&#x3D;True</strong> 选项：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryMember</span>(models.Model):</span><br><span class="line">    _name = <span class="string">&#x27;library.member&#x27;</span></span><br><span class="line">    partner_id = fields.Meny2one(<span class="string">&#x27;res.partner&#x27;</span>, ondelete=<span class="string">&#x27;cascade&#x27;</span>, delegate=<span class="literal">True</span>)</span><br><span class="line">    date_start = fields.Date(<span class="string">&#x27;Member Since&#x27;</span>)</span><br><span class="line">    date_end = fields.Date(<span class="string">&#x27;Termination Date&#x27;</span>)</span><br><span class="line">    member_mumber = fields.Char()</span><br><span class="line">    date_of_birth = fields.Date(<span class="string">&#x27;Date of birth&#x27;</span>)</span><br></pre></td></tr></table></figure><p>一个值得注意的代理继承案例是用户模型<strong>res.users</strong> 。它继承自partner模型 (<strong>res.partner</strong> )。 这意味着您可以在用户上看到的某些字段实际上存储在partner模型中（特别是名称字段）。创建新用户时，我们还会获得一个自动创建的新partner。</p><p>我们还应该提到，使用<strong>_inherit</strong> 的传统继承也可以将功能复制到新模型中，尽管效率较低。这在<a href="#%E4%BD%BF%E7%94%A8%E7%BB%A7%E6%89%BF%E5%90%91%E6%A8%A1%E5%9E%8B%E6%B7%BB%E5%8A%A0%E5%8A%9F%E8%83%BD">使用继承向模型添加功能</a>中进行了讨论。</p><h2 id="使用抽象模型实现可复用的模型功能"><a href="#使用抽象模型实现可复用的模型功能" class="headerlink" title="使用抽象模型实现可复用的模型功能"></a>使用抽象模型实现可复用的模型功能</h2><p>有时我们希望能够将某个特定功能添加到几个不同的模型中。在不同的文件中重复相同的代码是一种不好的编程习惯；最好实现一次并重用它。</p><p>抽象模型允许我们创建一个通用模型，该模型实现了一些可以被常规模型继承的特性，以使该特性可用。</p><p>例如我们需要实现一个简单的存档功能。它将活动字段添加到模型中（如果它不存在）并提供存档方法来切换活动标志。这是有效的，因为<strong>active</strong> 是一个魔法字段。如果默认在模型中出现，<strong>active&#x3D;False</strong> 的记录会在查询中被过滤掉。</p><p>然后我们将它添加到<strong>Library Books</strong> 模型中。</p><h3 id="准备工作-13"><a href="#准备工作-13" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将继续使用上一小节中的<strong>my_library</strong> 附加模块。</p><h3 id="实现步骤-11"><a href="#实现步骤-11" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>本节中我们需要添加存档功能到Library Books模型中。为了使解释尽可能简单，我们将把它塞进<strong>models&#x2F;library_book.py</strong> 文件中：</p><ol><li><p>为存档功能添加抽象模型。 它必须在<strong>Library Book</strong> 模型中定义，将在其中使用它：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BaseArchive</span>(models.AbstractModel):</span><br><span class="line">    _name = <span class="string">&#x27;base.archive&#x27;</span></span><br><span class="line">    active = fields.Boolean(default=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_archive</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> record <span class="keyword">in</span> self:</span><br><span class="line">            record.active = <span class="keyword">not</span> record.active</span><br></pre></td></tr></table></figure></li><li><p>接着我们将编辑<strong>Library Book</strong> 模型以继承上一步的抽象模型：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">    _name = <span class="string">&#x27;library.book&#x27;</span></span><br><span class="line">    _inherit = [<span class="string">&#x27;base.archive&#x27;</span>]</span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></table></figure></li></ol><p>需要升级附加模块才能激活更改。</p><h3 id="运行原理-13"><a href="#运行原理-13" class="headerlink" title="运行原理"></a>运行原理</h3><p>抽象模型基于<strong>models.AbstractModel</strong> 类，而不是通常的<strong>models.Model</strong> 。它具有常规模型的所有属性和功能；不同之处在于ORM不会在数据库中为其创建实际的表。这意味着它不能存储任何数据。它仅用作要添加到常规模型中的可重用功能的模板。</p><p>我们的存档抽象模型非常简单。它只是添加了活动字段和一个方法来切换活动标志的值，我们希望稍后通过用户界面上的按钮使用它。</p><p>当使用<strong>_inherit</strong> 属性定义模型类时，它会继承那些类的属性方法，并且在当前类中定义的属性方法会对这些继承的特性进行修改。</p><p>这里起作用的机制与常规模型扩展的机制相同（根据<a href="#%E4%BD%BF%E7%94%A8%E7%BB%A7%E6%89%BF%E5%90%91%E6%A8%A1%E5%9E%8B%E6%B7%BB%E5%8A%A0%E5%8A%9F%E8%83%BD">使用继承向模型添加功能</a>）。 您可能已经注意到<strong>_inherit</strong> 使用模型标识符列表而不是具有一个模型标识符的字符串。事实上，<strong>_inherit</strong> 可以有两种形式。使用列表形式允许我们从多个（通常是抽象的）类继承。在这种情况下，我们只继承一个，所以一个文本字符串就可以了。为了说明的目的，使用了一个列表。</p><h3 id="扩展内容-9"><a href="#扩展内容-9" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>一个值得注意的内置抽象模型是<strong>mail.thread</strong> ，它由<strong>mail (Discuss)</strong> 附加模块提供。在模型上，它启用了为在许多表单底部看到的消息墙提供动力的讨论功能。</p><p>除了<strong>AbstractModel</strong> 之外，还有第三种模型类型可用：<strong>models.TransientModel</strong> 。这有一个类似<strong>models.Model</strong> 的数据库表示，但是在那里创建的记录应该是临时的，并且由服务器计划的作业定期清除。除此之外，瞬态模型就像常规模型一样工作。</p><p><strong>models.TransientModel</strong> 对于更复杂的用户交互（称为向导）很有用。该向导用于请求用户输入。在第八 章《高级服务器端开发技术》中，我们再探讨如何使用这些技术进行高级用户交互。</p>]]></content>
    
    
    <summary type="html">本章中的教程将对现有的附加模块稍稍进行补充。在上一章中，我们在Odoo实例中注册了我们的附加模块。在本章中，我们将对模块的数据库方面进行深入的探讨。我们将添加一个新模型（数据库表）、新字段和约束。我们还将研究Odoo中模型的继承使用。</summary>
    
    
    
    
    <category term="Odoo开发者指南" scheme="https://www.junle.org/tags/Odoo%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>如何在Ubuntu20.04部署Metabase</title>
    <link href="https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8Ubuntu20-04%E9%83%A8%E7%BD%B2Metabase/"/>
    <id>https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8Ubuntu20-04%E9%83%A8%E7%BD%B2Metabase/</id>
    <published>2022-05-28T02:32:43.000Z</published>
    <updated>2024-03-22T06:43:55.700Z</updated>
    
    <content type="html"><![CDATA[<p>Metabase是一款简单的开源BI工具。Metabase的两个核心概念是问题及其对应的答案，Metabase一切都基于问题和答案。Metabase有以下特点：</p><ul><li>在五分钟内完成设置（我们不是在开玩笑）。</li><li>让团队中的任何人在不了解SQL的情况下提出问题。</li><li>更复杂的查询可使用SQL编辑器实现。</li><li>使用过滤器、自动刷新、全屏和自定义点击行为构建美观的交互式仪表板。</li><li>创建清理、注释和组合原始表的模型。</li><li>定义规范的细分和指标供您的团队使用。</li><li>使用仪表板订阅按计划将数据发送到Slack或电子邮件。</li><li>设置警报，让Metabase在您的数据更改时通知您。</li><li>在您的应用程序甚至整个元数据库中嵌入图表和仪表板。</li></ul><p><img src="/images/metabase_kanban_demo_form.png" alt="Demo"></p><p>官方支持的数据库，以下数据库的官方驱动程序是由Metabase团队进行维护的。付费计划的客户将获得官方支持。</p><ul><li><a href="https://www.metabase.com/docs/latest/administration-guide/databases/bigquery.html">BigQuery</a> (Google Cloud Platform)</li><li>Druid</li><li><a href="https://www.metabase.com/docs/latest/administration-guide/databases/google-analytics.html">Google Analytics</a></li><li>H2</li><li><a href="https://www.metabase.com/docs/latest/administration-guide/databases/mongodb.html">MongoDB (version 3.6 or higher)</a></li><li><a href="https://www.metabase.com/docs/latest/administration-guide/databases/mysql.html">MySQL (version 5.7 or higher, as well as MariaDB version 10.2 or higher)</a></li><li><a href="https://www.metabase.com/docs/latest/administration-guide/databases/oracle.html">Oracle</a></li><li><a href="https://www.metabase.com/docs/latest/administration-guide/databases/postgresql.html">PostgreSQL</a></li><li>Presto</li><li>Redshift (Amazon Web Services)</li><li><a href="https://www.metabase.com/docs/latest/administration-guide/databases/snowflake.html">Snowflake</a></li><li>SparkSQL</li><li>SQL Server</li><li>SQLite</li><li><a href="https://www.metabase.com/docs/latest/administration-guide/databases/vertica.html">Vertica</a></li></ul><span id="more"></span><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><p>本文使用PostgreSQL数据库作为Metabase的数据库，使用以下命令安装依赖：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install openjdk-17-jdk postgresql postgresql-contrib nginx</span><br></pre></td></tr></table></figure><h2 id="创建PostgreSQL数据库和数据库用户"><a href="#创建PostgreSQL数据库和数据库用户" class="headerlink" title="创建PostgreSQL数据库和数据库用户"></a>创建PostgreSQL数据库和数据库用户</h2><ul><li><p>通过以下命令登录到PostgreSQL数据库：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres psql</span><br></pre></td></tr></table></figure></li><li><p>创建Superset数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE metabase_db;</span><br></pre></td></tr></table></figure></li><li><p>创建数据库用户</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> metabase_user <span class="keyword">WITH</span> PASSWORD <span class="string">&#x27;password&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p>修改数据库链接参数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> ROLE metabase_user <span class="keyword">SET</span> client_encoding <span class="keyword">TO</span> <span class="string">&#x27;utf8&#x27;</span>;</span><br><span class="line"><span class="keyword">ALTER</span> ROLE metabase_user <span class="keyword">SET</span> default_transaction_isolation <span class="keyword">TO</span> <span class="string">&#x27;read committed&#x27;</span>;</span><br><span class="line"><span class="keyword">ALTER</span> ROLE metabase_user <span class="keyword">SET</span> timezone <span class="keyword">TO</span> <span class="string">&#x27;UTC&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p>superset_user访问管理superset数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> DATABASE metabase_db <span class="keyword">TO</span> metabase_user;</span><br></pre></td></tr></table></figure></li><li><p>配置完成后使用以下命令退出PostgreSQL交互界面</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\q</span><br></pre></td></tr></table></figure></li></ul><h2 id="安装和配置Metabase"><a href="#安装和配置Metabase" class="headerlink" title="安装和配置Metabase"></a>安装和配置Metabase</h2><ul><li><p>下载最新版的Metabase jar包，当前最新的版本是v0.43.1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://downloads.metabase.com/v0.43.1/metabase.jar</span><br></pre></td></tr></table></figure></li><li><p>创建Metabase配置文件<code>mkdir -p /etc/metabase &amp;&amp; sudo vim /etc/metabase/config</code></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">MB_PASSWORD_COMPLEXITY</span>=<span class="string">strong</span></span><br><span class="line"><span class="attr">MB_PASSWORD_LENGTH</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">MB_JETTY_HOST</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="attr">MB_JETTY_PORT</span>=<span class="string">3000</span></span><br><span class="line"><span class="attr">MB_DB_TYPE</span>=<span class="string">postgres</span></span><br><span class="line"><span class="attr">MB_DB_DBNAME</span>=<span class="string">metabase_db</span></span><br><span class="line"><span class="attr">MB_DB_PORT</span>=<span class="string">5432</span></span><br><span class="line"><span class="attr">MB_DB_USER</span>=<span class="string">metabase_user</span></span><br><span class="line"><span class="attr">MB_DB_PASS</span>=<span class="string">password</span></span><br><span class="line"><span class="attr">MB_DB_HOST</span>=<span class="string">localhost</span></span><br><span class="line"><span class="attr">MB_EMOJI_IN_LOGS</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure><ul><li>MB_PASSWORD_COMPLEXITY：密码复杂度，可填内容<code>&lt;weak|normal|strong&gt;</code>；</li><li>MB_PASSWORD_LENGTH：密码最小长度；</li><li>MB_JETTY_HOST：Metabase绑定的地址；</li><li>MB_JETTY_HOST：Metabase监听的端口；</li><li>MB_DB_TYPE：数据库类型，可填内容<code>&lt;postgres|mysql|h2&gt;</code>；</li><li>MB_DB_DBNAME：数据库名称；</li><li>MB_DB_PORT：数据库端口；</li><li>MB_DB_USER：数据库用户；</li><li>MB_DB_PASS：数据库用户密码；</li><li>MB_DB_HOST：数据库地址；</li><li>MB_EMOJI_IN_LOGS：日志中包含表情符号，默认情况下true，可填内容<code>&lt;true|false&gt;</code>；</li></ul></li><li><p>创建系统日志配置文件<code>/etc/rsyslog.d/metabase.conf</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="variable">$programname</span> == <span class="string">&#x27;metabase&#x27;</span> <span class="keyword">then</span> /var/log/metabase.log</span><br><span class="line">&amp; stop</span><br></pre></td></tr></table></figure></li><li><p>重启系统日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart rsyslog.service</span><br></pre></td></tr></table></figure></li><li><p>创建Metabase服务<code>/etc/systemd/system/metabase.service</code></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=<span class="string">Metabase server</span></span><br><span class="line"><span class="attr">After</span>=<span class="string">syslog.target</span></span><br><span class="line"><span class="attr">After</span>=<span class="string">network.target</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Service]</span></span><br><span class="line"><span class="attr">WorkingDirectory</span>=<span class="string">/home/metabase/</span></span><br><span class="line"><span class="attr">ExecStart</span>=<span class="string">/usr/bin/java -jar /home/metabase/metabase.jar</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=<span class="string">/etc/metabase/config</span></span><br><span class="line"><span class="attr">User</span>=<span class="string">metabase</span></span><br><span class="line"><span class="attr">Type</span>=<span class="string">simple</span></span><br><span class="line"><span class="attr">StandardOutput</span>=<span class="string">syslog</span></span><br><span class="line"><span class="attr">StandardError</span>=<span class="string">syslog</span></span><br><span class="line"><span class="attr">SyslogIdentifier</span>=<span class="string">metabase</span></span><br><span class="line"><span class="attr">SuccessExitStatus</span>=<span class="string">143</span></span><br><span class="line"><span class="attr">TimeoutStopSec</span>=<span class="string">120</span></span><br><span class="line"><span class="attr">Restart</span>=<span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=<span class="string">multi-user.target</span></span><br></pre></td></tr></table></figure><p>配置完成后执行以下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure></li><li><p>配置Nginx</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">listen</span> [::]:<span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> your.domain.com;</span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:3000;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>启动Metabase服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start metabase.service</span><br></pre></td></tr></table></figure></li></ul><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><ul><li><p>打开页面首先进入到以下界面，点击按钮开始初始化实例</p><p><img src="/images/metabase_setup_form.png" alt="初始化"></p></li><li><p>配置语言</p><p><img src="/images/metabase_setup_language_form.png" alt="语言"></p></li><li><p>配置管理员用户</p><p><img src="/images/metabase_setup_administrator_form.png" alt="管理员用户"></p></li><li><p>添加数据库，这里我们先不添加</p><p><img src="/images/metabase_setup_adddb_form.png" alt="添加数据库"></p></li><li><p>配置匿名信息</p><p><img src="/images/metabase_setup_anonymous_form.png" alt="匿名信息"></p></li><li><p>配置完成</p><p><img src="/images/metabase_setup_complate_form.png" alt="配置完成"></p><p>配置完成后</p><p><img src="/images/metabase_homepage_form.png" alt="主页"></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Metabase是一款简单的开源BI工具。Metabase的两个核心概念是问题及其对应的答案，Metabase一切都基于问题和答案。Metabase有以下特点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在五分钟内完成设置（我们不是在开玩笑）。&lt;/li&gt;
&lt;li&gt;让团队中的任何人在不了解SQL的情况下提出问题。&lt;/li&gt;
&lt;li&gt;更复杂的查询可使用SQL编辑器实现。&lt;/li&gt;
&lt;li&gt;使用过滤器、自动刷新、全屏和自定义点击行为构建美观的交互式仪表板。&lt;/li&gt;
&lt;li&gt;创建清理、注释和组合原始表的模型。&lt;/li&gt;
&lt;li&gt;定义规范的细分和指标供您的团队使用。&lt;/li&gt;
&lt;li&gt;使用仪表板订阅按计划将数据发送到Slack或电子邮件。&lt;/li&gt;
&lt;li&gt;设置警报，让Metabase在您的数据更改时通知您。&lt;/li&gt;
&lt;li&gt;在您的应用程序甚至整个元数据库中嵌入图表和仪表板。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/images/metabase_kanban_demo_form.png&quot; alt=&quot;Demo&quot;&gt;&lt;/p&gt;
&lt;p&gt;官方支持的数据库，以下数据库的官方驱动程序是由Metabase团队进行维护的。付费计划的客户将获得官方支持。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.metabase.com/docs/latest/administration-guide/databases/bigquery.html&quot;&gt;BigQuery&lt;/a&gt; (Google Cloud Platform)&lt;/li&gt;
&lt;li&gt;Druid&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.metabase.com/docs/latest/administration-guide/databases/google-analytics.html&quot;&gt;Google Analytics&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;H2&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.metabase.com/docs/latest/administration-guide/databases/mongodb.html&quot;&gt;MongoDB (version 3.6 or higher)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.metabase.com/docs/latest/administration-guide/databases/mysql.html&quot;&gt;MySQL (version 5.7 or higher, as well as MariaDB version 10.2 or higher)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.metabase.com/docs/latest/administration-guide/databases/oracle.html&quot;&gt;Oracle&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.metabase.com/docs/latest/administration-guide/databases/postgresql.html&quot;&gt;PostgreSQL&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Presto&lt;/li&gt;
&lt;li&gt;Redshift (Amazon Web Services)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.metabase.com/docs/latest/administration-guide/databases/snowflake.html&quot;&gt;Snowflake&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;SparkSQL&lt;/li&gt;
&lt;li&gt;SQL Server&lt;/li&gt;
&lt;li&gt;SQLite&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.metabase.com/docs/latest/administration-guide/databases/vertica.html&quot;&gt;Vertica&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    
    <category term="数据可视化" scheme="https://www.junle.org/tags/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/"/>
    
    <category term="Metabase" scheme="https://www.junle.org/tags/Metabase/"/>
    
  </entry>
  
  <entry>
    <title>如何在Ubuntu 20.04部署Apache Superset</title>
    <link href="https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8Ubuntu-20-04%E9%83%A8%E7%BD%B2Apache-Superset/"/>
    <id>https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8Ubuntu-20-04%E9%83%A8%E7%BD%B2Apache-Superset/</id>
    <published>2022-05-25T08:50:33.000Z</published>
    <updated>2024-03-22T06:43:55.699Z</updated>
    
    <content type="html"><![CDATA[<p>Apache Superset 是一个开源数据可视化软件，能够处理 PB 级大数据。该应用程序最初是 Maxime Beauchemin（Apache Airflow的创建者）在 Airbnb 工作时的一个 hack-a-thon 项目，并于 2017 年进入 Apache 孵化器计划。除了 Airbnb，该项目还得到了其他领先科技公司的重大贡献，包括 Lyft 和 Dropbox。 2021年Superset 从孵化器项目毕业，成为 Apache 软件基金会的顶级项目。——维基百科</p><p><img src="/images/superset_kanban_sales_dashboard_form.png"></p><p>Superset提供：</p><ul><li>用于快速构建图表的无代码界面</li><li>强大的、基于 Web 的 SQL 编辑器，可用于高级查询</li><li>用于快速定义自定义维度和指标的轻量级语义层</li><li>对几乎所有 SQL 数据库或数据引擎的开箱即用支持</li><li>各种漂亮的可视化展示您的数据，从简单的条形图到地理空间可视化</li><li>轻量级、可配置的缓存层，有助于减轻数据库负载</li><li>高度可扩展的安全角色和身份验证选项</li><li>用于程序化定制的 API</li><li>从头开始设计的云原生架构以实现规模化</li></ul><span id="more"></span><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><p>使用以下命令安装依赖：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential libssl-dev libffi-dev python3-dev python3-pip libsasl2-dev libldap2-dev default-libmysqlclient-dev postgresql postgresql-contrib nginx</span><br></pre></td></tr></table></figure><h2 id="创建PostgreSQL数据库和数据库用户"><a href="#创建PostgreSQL数据库和数据库用户" class="headerlink" title="创建PostgreSQL数据库和数据库用户"></a>创建PostgreSQL数据库和数据库用户</h2><p>本教程使用PostgreSQL数据库作为Superset的数据库，安装完成后需要进行以下配置。</p><ul><li><p>通过以下命令登录到PostgreSQL数据库：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres psql</span><br></pre></td></tr></table></figure></li><li><p>创建Superset数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE superset_db;</span><br></pre></td></tr></table></figure></li><li><p>创建数据库用户</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> superset_user <span class="keyword">WITH</span> PASSWORD <span class="string">&#x27;password&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p>修改数据库链接参数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> ROLE superset_user <span class="keyword">SET</span> client_encoding <span class="keyword">TO</span> <span class="string">&#x27;utf8&#x27;</span>;</span><br><span class="line"><span class="keyword">ALTER</span> ROLE superset_user <span class="keyword">SET</span> default_transaction_isolation <span class="keyword">TO</span> <span class="string">&#x27;read committed&#x27;</span>;</span><br><span class="line"><span class="keyword">ALTER</span> ROLE superset_user <span class="keyword">SET</span> timezone <span class="keyword">TO</span> <span class="string">&#x27;UTC&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p>superset_user访问管理superset数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> DATABASE superset_db <span class="keyword">TO</span> superset_user;</span><br></pre></td></tr></table></figure></li><li><p>配置完成后使用以下命令退出PostgreSQL交互界面</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\q</span><br></pre></td></tr></table></figure></li></ul><h2 id="为您Superset创建-Python-虚拟环境"><a href="#为您Superset创建-Python-虚拟环境" class="headerlink" title="为您Superset创建 Python 虚拟环境"></a>为您Superset创建 Python 虚拟环境</h2><ul><li><p>更新pip和安装必要的包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install --upgrade pip</span><br><span class="line">sudo pip install virtualenv</span><br></pre></td></tr></table></figure></li><li><p>创建虚拟环境</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virtualenv superset</span><br></pre></td></tr></table></figure></li><li><p>激活虚拟环境</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> superset/bin/activate</span><br></pre></td></tr></table></figure></li><li><p>安装Superset</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install apache-superset</span><br></pre></td></tr></table></figure></li><li><p>安装其他python依赖</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install gunicorn gevent Pillow pymssql</span><br></pre></td></tr></table></figure></li></ul><h2 id="配置Superset"><a href="#配置Superset" class="headerlink" title="配置Superset"></a>配置Superset</h2><ul><li><p>在<code>superset/bin</code>目录创建Superset配置文件<code>superset_config.py</code>，详细配置可参考<a href="https://superset.apache.org/docs/installation/configuring-superset">官方文档</a>或<a href="https://github.com/apache/superset/blob/master/superset/config.py">这里</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Superset specific config</span></span><br><span class="line">ROW_LIMIT = <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#SUPERSET_WEBSERVER_PORT = 8088</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Flask App Builder configuration</span></span><br><span class="line"><span class="comment"># Your App secret key will be used for securely signing the session cookie</span></span><br><span class="line"><span class="comment"># and encrypting sensitive information on the database</span></span><br><span class="line"><span class="comment"># Make sure you are changing this key for your deployment with a strong key.</span></span><br><span class="line"><span class="comment"># You can generate a strong key using `openssl rand -base64 42`</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">使用命令“openssl rand -base64 42”创建SECRET_KEY填写到下面&#x27;&#x27;&#x27;</span></span><br><span class="line">SECRET_KEY = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The SQLAlchemy connection string to your database backend</span></span><br><span class="line"><span class="comment"># This connection defines the path to the database that stores your</span></span><br><span class="line"><span class="comment"># superset metadata (slices, connections, tables, dashboards, ...).</span></span><br><span class="line"><span class="comment"># Note that the connection information to connect to the datasources</span></span><br><span class="line"><span class="comment"># you want to explore are managed directly in the web UI</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">数据库连接，我是用的是PostgreSQL数据库</span></span><br><span class="line"><span class="string">链接字符串：postgresql://&lt;数据库用户&gt;:&lt;密码&gt;@&lt;主机名/ip&gt;/&lt;数据库名&gt;&#x27;&#x27;&#x27;</span></span><br><span class="line">SQLALCHEMY_DATABASE_URI = <span class="string">&#x27;postgresql://superset_user:password@127.0.0.1/superset_db&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Flask-WTF flag for CSRF</span></span><br><span class="line">WTF_CSRF_ENABLED = <span class="literal">True</span></span><br><span class="line"><span class="comment"># Add endpoints that need to be exempt from CSRF protection</span></span><br><span class="line">WTF_CSRF_EXEMPT_LIST = []</span><br><span class="line"><span class="comment"># A CSRF token that expires in 1 year</span></span><br><span class="line">WTF_CSRF_TIME_LIMIT = <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">365</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set this API key to enable Mapbox visualizations</span></span><br><span class="line">MAPBOX_API_KEY = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">COMPRESS_REGISTER = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#默认中文</span></span><br><span class="line">BABEL_DEFAULT_LOCALE = <span class="string">&quot;zh&quot;</span></span><br><span class="line"><span class="comment">#superset支持的语言</span></span><br><span class="line">LANGUAGES = &#123;</span><br><span class="line">    <span class="string">&quot;en&quot;</span>: &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">&quot;us&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;English&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;es&quot;</span>: &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">&quot;es&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Spanish&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;it&quot;</span>: &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">&quot;it&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Italian&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;fr&quot;</span>: &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">&quot;fr&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;French&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;zh&quot;</span>: &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">&quot;cn&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Chinese&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;ja&quot;</span>: &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">&quot;jp&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Japanese&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;de&quot;</span>: &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">&quot;de&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;German&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;pt&quot;</span>: &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">&quot;pt&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Portuguese&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;pt_BR&quot;</span>: &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">&quot;br&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Brazilian Portuguese&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;ru&quot;</span>: &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">&quot;ru&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Russian&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;ko&quot;</span>: &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">&quot;kr&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Korean&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;sk&quot;</span>: &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">&quot;sk&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Slovak&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;sl&quot;</span>: &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">&quot;si&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Slovenian&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;nl&quot;</span>: &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">&quot;nl&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Dutch&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SHOW_STACKTRACE = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">DEBUG = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">APP_NAME = <span class="string">&quot;Superset&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>通过运行以下命令完成初始化Superset</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化数据库</span></span><br><span class="line">superset db upgrade</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在您的元数据数据库中创建一个管理员用户（使用 `admin` 作为用户名以便能够加载示例）</span></span><br><span class="line">$ <span class="built_in">export</span> FLASK_APP=superset</span><br><span class="line">superset fab create-admin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载演示数据</span></span><br><span class="line">superset load_examples</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建默认角色和权限</span></span><br><span class="line">superset init</span><br></pre></td></tr></table></figure></li><li><p>创建<code>/etc/systemd/system/superset.service</code>服务</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=<span class="string">superset daemon</span></span><br><span class="line"><span class="attr">After</span>=<span class="string">network.target</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Service]</span></span><br><span class="line"><span class="attr">User</span>=<span class="string">superset</span></span><br><span class="line"><span class="attr">Group</span>=<span class="string">superset</span></span><br><span class="line"><span class="attr">WorkingDirectory</span>=<span class="string">/home/superset/superset/</span></span><br><span class="line"><span class="attr">ExecStart</span>=<span class="string">/home/superset/superset/bin/gunicorn -w 2 -k gevent --worker-connections 1000 --timeout 120 -b localhost:6666 --limit-request-line 0 --limit-request-field_size 0 --statsd-host localhost:8125 &quot;superset.app:create_app()&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=<span class="string">multi-user.target</span></span><br></pre></td></tr></table></figure></li><li><p>服务创建完成后需要执行以下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure></li><li><p>启动Superset服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start superset</span><br></pre></td></tr></table></figure></li></ul><p>服务启动后会监听本地的6666端口。</p><h2 id="配置Nginx"><a href="#配置Nginx" class="headerlink" title="配置Nginx"></a>配置Nginx</h2><ul><li><p>下面的是我的配置文件，需根据自己的实际情况修改</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> superset &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:6666</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">listen</span> [::]:<span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> _;</span><br><span class="line">        <span class="attribute">return</span>  <span class="number">301</span> https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">        <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl http2;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">server_name</span> _;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/fullchain.cer;</span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/private.key;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">                <span class="attribute">proxy_pass</span> http://superset;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置完成后reload一下Nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl reload nginx</span><br></pre></td></tr></table></figure></li></ul><h2 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h2><p>登陆界面右上角可以选择语言，输入之前创建的管理员用户名密码</p><p><img src="/images/superset_login_form.png" alt="登陆界面"></p><p>演示数据包含以下已经做好的看板</p><p><img src="/images/superset_kanban_form.png" alt="演示看板"></p><p>看板效果</p><p><img src="/images/superset_kanban_world_banks_data_form.png" alt="看板效果"></p><h2 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h2><ol><li><p>初始化执行<code>superset db upgrade</code> 时报错：<code>ImportError: cannot import name &#39;soft_unicode&#39; from &#39;markupsafe&#39; in...</code></p><ul><li><p>原因：MarkupSafe:2.1.0版本取消了soft_unicode（<a href="https://markupsafe.palletsprojects.com/en/2.1.x/changes/#version-2-1-0">https://markupsafe.palletsprojects.com/en/2.1.x/changes/#version-2-1-0</a>），Superset安装的时候默认安装的MarkupSafe:2.1.0。</p></li><li><p>解决方法：<code>pip install --upgrade MarkupSafe==2.0.1</code>，降低MarkupSafe的版本。</p></li></ul></li><li><p>优化汉化问题，修改<code>site-packages/superset/translations/zh/LC_MESSAGES/</code>目录下的po文件，修改后进入<code>site-packages/superset</code>目录执行命令：<code>pybabel compile -d translations</code>重新编译。</p></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;Apache Superset 是一个开源数据可视化软件，能够处理 PB 级大数据。该应用程序最初是 Maxime Beauchemin（Apache Airflow的创建者）在 Airbnb 工作时的一个 hack-a-thon 项目，并于 2017 年进入 Apache 孵化器计划。除了 Airbnb，该项目还得到了其他领先科技公司的重大贡献，包括 Lyft 和 Dropbox。 2021年Superset 从孵化器项目毕业，成为 Apache 软件基金会的顶级项目。——维基百科&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/superset_kanban_sales_dashboard_form.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;Superset提供：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;用于快速构建图表的无代码界面&lt;/li&gt;
&lt;li&gt;强大的、基于 Web 的 SQL 编辑器，可用于高级查询&lt;/li&gt;
&lt;li&gt;用于快速定义自定义维度和指标的轻量级语义层&lt;/li&gt;
&lt;li&gt;对几乎所有 SQL 数据库或数据引擎的开箱即用支持&lt;/li&gt;
&lt;li&gt;各种漂亮的可视化展示您的数据，从简单的条形图到地理空间可视化&lt;/li&gt;
&lt;li&gt;轻量级、可配置的缓存层，有助于减轻数据库负载&lt;/li&gt;
&lt;li&gt;高度可扩展的安全角色和身份验证选项&lt;/li&gt;
&lt;li&gt;用于程序化定制的 API&lt;/li&gt;
&lt;li&gt;从头开始设计的云原生架构以实现规模化&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    
    <category term="Python" scheme="https://www.junle.org/tags/Python/"/>
    
    <category term="数据可视化" scheme="https://www.junle.org/tags/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/"/>
    
    <category term="Superset" scheme="https://www.junle.org/tags/Superset/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu 编译树莓派4B OpenWRT固件</title>
    <link href="https://www.junle.org/Ubuntu-%E7%BC%96%E8%AF%91%E6%A0%91%E8%8E%93%E6%B4%BE4B-OpenWRT%E5%9B%BA%E4%BB%B6/"/>
    <id>https://www.junle.org/Ubuntu-%E7%BC%96%E8%AF%91%E6%A0%91%E8%8E%93%E6%B4%BE4B-OpenWRT%E5%9B%BA%E4%BB%B6/</id>
    <published>2022-03-23T07:16:22.000Z</published>
    <updated>2024-03-22T06:43:55.684Z</updated>
    
    <content type="html"><![CDATA[<h2 id="迫于树莓派吃灰"><a href="#迫于树莓派吃灰" class="headerlink" title="迫于树莓派吃灰"></a>迫于树莓派吃灰</h2><p>最近在网上了解了一下R2S，又看了看某宝的价格，嗯打扰了打扰了。回想起自己买了两年的树莓派4b，除了吃灰还是吃灰，干脆拿出来改造成一个旁路由。</p><p><a href="https://openwrt.org/toh/hwdata/raspberry_pi_foundation/raspberry_pi_foundation_raspberry_pi_4_b">Raspberry Pi Foundation Raspberry Pi 4 B</a></p><span id="more"></span><h2 id="准备内容"><a href="#准备内容" class="headerlink" title="准备内容"></a>准备内容</h2><ul><li>树莓派4b一台</li><li>Ubuntu系统</li><li>参考：<a href="https://leyao-daily.github.io/2021/05/10/OpenWrt-BKM/">编译环境</a>，<a href="https://leux.cn/doc/OPENWRT%E7%BC%96%E8%AF%91%E4%B9%8B%E6%A0%91%E8%8E%93%E6%B4%BE4B.html">参数配置</a></li></ul><h2 id="编译环境搭建"><a href="#编译环境搭建" class="headerlink" title="编译环境搭建"></a>编译环境搭建</h2><ol><li><p>安装编译需要的包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install build-essential ccache ecj fastjar file g++ gawk \</span><br><span class="line">gettext git java-propose-classpath libelf-dev libncurses5-dev \</span><br><span class="line">libncursesw5-dev libssl-dev python python2.7-dev python3 unzip wget \</span><br><span class="line">python3-distutils python3-setuptools rsync subversion swig time \</span><br><span class="line">xsltproc zlib1g-dev </span><br></pre></td></tr></table></figure></li></ol><h2 id="编译源码"><a href="#编译源码" class="headerlink" title="编译源码"></a>编译源码</h2><ol><li><p>获取OpenWRT源码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://git.openwrt.org/openwrt/openwrt.git</span><br><span class="line"><span class="built_in">cd</span> openwrt</span><br></pre></td></tr></table></figure><p>如需编译特定版本，需要切换到对应版本分支。这里直接跳到步骤3，从主分支构建。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git branch</span><br><span class="line">git checkout &lt;branch name&gt;</span><br></pre></td></tr></table></figure></li><li><p>更新和安装feeds</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./scripts/feeds update -a</span><br><span class="line">./scripts/feeds install -a</span><br></pre></td></tr></table></figure></li><li><p>配置编译内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译的目标系统</span></span><br><span class="line">Target System -&gt; Broadcom BCM27xx</span><br><span class="line">Subtarget -&gt; BCM2711 boards (64 bit)</span><br><span class="line">Target Profile -&gt; Raspberry Pi 4B/400/4CM (64bit) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 镜像参数</span></span><br><span class="line">Target Images -&gt; ext4<span class="comment"># ext4格式的固件可方便地调整分区大小</span></span><br><span class="line">Target Images -&gt; squashfs<span class="comment"># squashfs格式的固件可恢复出厂设置</span></span><br><span class="line">Target Images -&gt; Kernel partition size = 64<span class="comment"># boot分区大小为64M</span></span><br><span class="line">Target Images -&gt; Root filesystem partition size = 512<span class="comment"># root分区大小为512M</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选工具</span></span><br><span class="line">Base system -&gt; block-mount<span class="comment"># 在LuCI界面添加&lt;挂载点&gt;菜单</span></span><br><span class="line">Base system -&gt; blockd<span class="comment"># 自动挂载设备</span></span><br><span class="line">Base system -&gt; wireless-tools<span class="comment"># 无线扩展工具</span></span><br><span class="line">Administration -&gt; htop<span class="comment"># 添加htop命令</span></span><br><span class="line">Firmware -&gt; xxx<span class="comment"># 选择你需要的网卡固件，默认即可</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件系统</span></span><br><span class="line">Kernel modules -&gt; Filesystems -&gt; kmod-fs-ext4</span><br><span class="line">Kernel modules -&gt; Filesystems -&gt; kmod-fs-ntfs</span><br><span class="line">Kernel modules -&gt; Filesystems -&gt; kmod-fs-squashfs</span><br><span class="line">Kernel modules -&gt; Filesystems -&gt; kmod-fs-vfat</span><br><span class="line">Kernel modules -&gt; Filesystems -&gt; kmod-fuse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网卡支持</span></span><br><span class="line">Kernel modules -&gt; Network Devices -&gt; kmod-xxx<span class="comment"># 有线网卡支持，跟以下几项可根据需求选择性添加</span></span><br><span class="line">Kernel modules -&gt; Wireless Drivers -&gt; kmod-rt2800-usb<span class="comment"># 添加Ralink RT5370芯片的USB无线网卡驱动</span></span><br><span class="line">Kernel modules -&gt; USB Support -&gt; kmod-usb-net -&gt; kmod-usb-net-sr9700<span class="comment"># 添加USB2.0的有线网卡SR9700芯片支持</span></span><br><span class="line">Kernel modules -&gt; USB Support -&gt; kmod-usb-net -&gt; kmod-usb-net-rtl8152<span class="comment"># 添加USB2/3的有线网卡RTL8152/3芯片支持</span></span><br><span class="line">Kernel modules -&gt; USB Support -&gt; kmod-usb-net -&gt; kmod-usb-net-asix<span class="comment"># 添加支持亚信的有线网卡支持</span></span><br><span class="line">Kernel modules -&gt; USB Support -&gt; kmod-usb-net -&gt; kmod-usb-net-asix-ax88179  <span class="comment"># 添加USB3.0的有线网卡芯片AX88179的驱动</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># USB支持</span></span><br><span class="line">Kernel modules -&gt; USB Support -&gt; kmod-usb-core<span class="comment"># 启用USB支持</span></span><br><span class="line">Kernel modules -&gt; USB Support -&gt; kmod-usb-hid<span class="comment"># USB键鼠支持</span></span><br><span class="line">Kernel modules -&gt; USB Support -&gt; kmod-usb-ohci<span class="comment"># 添加OHCI支持</span></span><br><span class="line">Kernel modules -&gt; USB Support -&gt; kmod-usb-uhci<span class="comment"># 添加UHCI支持</span></span><br><span class="line">Kernel modules -&gt; USB Support -&gt; kmod-usb-storage<span class="comment"># 启用USB存储</span></span><br><span class="line">Kernel modules -&gt; USB Support -&gt; kmod-usb-storage-extras</span><br><span class="line">Kernel modules -&gt; USB Support -&gt; kmod-usb2<span class="comment"># 开启USB2支持</span></span><br><span class="line">Kernel modules -&gt; USB Support -&gt; kmod-usb3<span class="comment"># 开启USB3支持</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LuCI设置</span></span><br><span class="line">LuCI -&gt; Collections -&gt; luci<span class="comment"># 开启luci</span></span><br><span class="line">LuCI -&gt; Modules -&gt; Translations-&gt; Chinese(zh-cn)<span class="comment"># 中文支持</span></span><br><span class="line">LuCI -&gt; Themes -&gt; luci-theme-material<span class="comment"># 添加主题</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LuCI应用</span></span><br><span class="line">LuCI -&gt; Applications -&gt; luci-app-aria2<span class="comment"># 下载工具</span></span><br><span class="line">LuCI -&gt; Applications -&gt; luci-app-firewall<span class="comment"># 防 火 墙</span></span><br><span class="line">LuCI -&gt; Applications -&gt; luci-app-hd-idle<span class="comment"># 硬盘休眠</span></span><br><span class="line">LuCI -&gt; Applications -&gt; luci-app-opkg<span class="comment"># 软 件 包</span></span><br><span class="line">LuCI -&gt; Applications -&gt; luci-app-qos<span class="comment"># 服务质量</span></span><br><span class="line">LuCI -&gt; Applications -&gt; luci-app-samba4<span class="comment"># 网络共享</span></span><br><span class="line">LuCI -&gt; Applications -&gt; luci-app-frpc<span class="comment"># 内网穿透</span></span><br><span class="line">LuCI -&gt; Applications -&gt; luci-app-shadowsocks-libev<span class="comment"># 翻墙软件</span></span><br><span class="line">LuCI -&gt; Applications -&gt; luci-app-upnp<span class="comment"># UPnP服务</span></span><br><span class="line">LuCI -&gt; Applications -&gt; luci-app-wol<span class="comment"># 网络唤醒</span></span><br><span class="line"></span><br><span class="line">Network -&gt; Download Manager -&gt; ariang<span class="comment"># Aria2管理页面</span></span><br><span class="line">Network -&gt; File Transfer -&gt; Aria2 Configuration -&gt; ***<span class="comment"># 选择Aria2支持的功能</span></span><br><span class="line">Network -&gt; File Transfer -&gt; curl<span class="comment"># 添加curl命令</span></span><br><span class="line">Network -&gt; File Transfer -&gt; wget<span class="comment"># 添加wget命令</span></span><br><span class="line">Utilities -&gt; Compression -&gt; bsdtar<span class="comment"># tar打包工具</span></span><br><span class="line">Utilities -&gt; Compression -&gt; gzip<span class="comment"># GZ 压缩套件</span></span><br><span class="line">Utilities -&gt; Compression -&gt; xz-utils<span class="comment"># XZ 压缩套件</span></span><br><span class="line">Utilities -&gt; Compression -&gt; unzip<span class="comment"># zip解压工具</span></span><br><span class="line">Utilities -&gt; Compression -&gt; zip<span class="comment"># zip压缩工具</span></span><br><span class="line">Utilities -&gt; Disc -&gt; fdisk<span class="comment"># 磁盘分区工具</span></span><br><span class="line">Utilities -&gt; Disc -&gt; lsblk<span class="comment"># 磁盘查看工具</span></span><br><span class="line">Utilities -&gt; Editors -&gt; vim<span class="comment"># vim编辑器</span></span><br><span class="line">Utilities -&gt; Filesystem -&gt; ntfs-3g<span class="comment"># NTFS读写支持</span></span><br><span class="line">Utilities -&gt; Filesystem -&gt; resize2fs<span class="comment"># 分区大小调整</span></span><br><span class="line">Utilities -&gt; Terminal -&gt; screen<span class="comment"># 添加screen</span></span><br><span class="line">Utilities -&gt; pciutils<span class="comment"># 添加lspci命令</span></span><br><span class="line">Utilities -&gt; usbutils<span class="comment"># 添加lsusb命令</span></span><br></pre></td></tr></table></figure></li><li><p>下载所需源码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make download -j8 V=s<span class="comment">#请尽量使用梯子</span></span><br></pre></td></tr></table></figure></li><li><p>编译源码，首次编译推荐用单线程；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j1 V=s</span><br></pre></td></tr></table></figure><p>再次编译前建议使用make clean清理；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make clean<span class="comment"># 清除bin目录</span></span><br><span class="line">make dirclean<span class="comment"># 清除bin目录和交叉编译工具及工具链目录</span></span><br><span class="line">make distclean<span class="comment"># 清除所有相关的东西，包括下载的软件包，配置文件，feed内容等</span></span><br></pre></td></tr></table></figure><p>经过漫长的编译，编译完的固件放在<code>./bin/targets/bcm27xx/bcm2711/</code>目录下；</p></li></ol><h2 id="刷写固件"><a href="#刷写固件" class="headerlink" title="刷写固件"></a>刷写固件</h2><ol><li><p>我们需要的文件是<code>openwrt-bcm27xx-bcm2711-rpi-4-ext4-factory.img.gz</code>，解压压缩文件；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> bin/targets/bcm27xx/bcm2711</span><br><span class="line">gzip -d openwrt-bcm27xx-bcm2711-rpi-4-ext4-factory.img.gz</span><br></pre></td></tr></table></figure></li><li><p>安装<a href="https://www.balena.io/etcher/">BalenaEtcher</a>工具刷写固件</p><p>官方代码编译出来的固件500多MB，建议选择4GB以上的TF卡刷写。成功后把TF卡插入树莓派，树莓派插电后红灯常亮表示正常。</p></li></ol><h2 id="配置OpenWRT"><a href="#配置OpenWRT" class="headerlink" title="配置OpenWRT"></a>配置OpenWRT</h2><p>使用网线连接树莓派与电脑配置OpenWRT，路由器的默认IP地址是<code>192.168.1.1</code>，管理员<code>root</code>，密码<code>password</code>。</p><h2 id="已发现的问题"><a href="#已发现的问题" class="headerlink" title="已发现的问题"></a>已发现的问题</h2><ul><li>WIFI不能开启5G功能；</li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;迫于树莓派吃灰&quot;&gt;&lt;a href=&quot;#迫于树莓派吃灰&quot; class=&quot;headerlink&quot; title=&quot;迫于树莓派吃灰&quot;&gt;&lt;/a&gt;迫于树莓派吃灰&lt;/h2&gt;&lt;p&gt;最近在网上了解了一下R2S，又看了看某宝的价格，嗯打扰了打扰了。回想起自己买了两年的树莓派4b，除了吃灰还是吃灰，干脆拿出来改造成一个旁路由。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://openwrt.org/toh/hwdata/raspberry_pi_foundation/raspberry_pi_foundation_raspberry_pi_4_b&quot;&gt;Raspberry Pi Foundation Raspberry Pi 4 B&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="RaspberryPI" scheme="https://www.junle.org/tags/RaspberryPI/"/>
    
    <category term="OpenWRT" scheme="https://www.junle.org/tags/OpenWRT/"/>
    
  </entry>
  
  <entry>
    <title>Odoo14 systemd service模板</title>
    <link href="https://www.junle.org/Odoo14-systemd-service%E6%A8%A1%E6%9D%BF/"/>
    <id>https://www.junle.org/Odoo14-systemd-service%E6%A8%A1%E6%9D%BF/</id>
    <published>2022-03-22T08:02:54.000Z</published>
    <updated>2024-03-22T06:43:55.672Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Odoo14-systemd-service-模板"><a href="#Odoo14-systemd-service-模板" class="headerlink" title="Odoo14 systemd service 模板"></a>Odoo14 systemd service 模板</h3><span id="more"></span><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=odoo14</span><br><span class="line">Requires=postgresql.service</span><br><span class="line">After=network.target postgresql.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">SyslogIdentifier=odoo14</span><br><span class="line">PermissionsStartOnly=<span class="literal">true</span></span><br><span class="line">User=your_user</span><br><span class="line">Group=your_user</span><br><span class="line">ExecStart=/your/python/path/python3 /your/odoo/path/odoo-bin -c /your/odoo/config/path/odoo.config</span><br><span class="line">StandardOutput=journal+console</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;Odoo14-systemd-service-模板&quot;&gt;&lt;a href=&quot;#Odoo14-systemd-service-模板&quot; class=&quot;headerlink&quot; title=&quot;Odoo14 systemd service 模板&quot;&gt;&lt;/a&gt;Odoo14 systemd service 模板&lt;/h3&gt;</summary>
    
    
    
    
    <category term="Odoo" scheme="https://www.junle.org/tags/Odoo/"/>
    
  </entry>
  
  <entry>
    <title>Odoo14配置文件模板</title>
    <link href="https://www.junle.org/Odoo14%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%A8%A1%E6%9D%BF/"/>
    <id>https://www.junle.org/Odoo14%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%A8%A1%E6%9D%BF/</id>
    <published>2022-03-22T08:01:58.000Z</published>
    <updated>2024-03-22T06:43:55.680Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Odoo14-配置文件模板"><a href="#Odoo14-配置文件模板" class="headerlink" title="Odoo14 配置文件模板"></a>Odoo14 配置文件模板</h3><span id="more"></span><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[options]</span><br><span class="line">addons_path = /your/odoo/path/odoo/addons,/your/odoo/path/addons,/your/custom/addons/path</span><br><span class="line">admin_passwd = <span class="variable">$pbkdf2</span>-sha512$25000$eO8dw3iPEYKwtlZqDQGAkA<span class="variable">$PpiUtsix0GRNvwOmd4RYAuIA7Q</span>.hWJSYuYervSE0RJtJTjcLx08KJ871RhE4/JZ6q3ExMe1if.jv8V3beM9oow</span><br><span class="line">csv_internal_sep = ,</span><br><span class="line">data_dir = /your/data/path</span><br><span class="line">db_host = your_db_host</span><br><span class="line">db_maxconn = 64</span><br><span class="line">db_name = False</span><br><span class="line">db_password = your_db_password</span><br><span class="line">db_port = 5432</span><br><span class="line">db_sslmode = prefer</span><br><span class="line">db_template = template0</span><br><span class="line">db_user = your_db_user</span><br><span class="line">dbfilter =</span><br><span class="line">demo = &#123;&#125;</span><br><span class="line">email_from = False</span><br><span class="line">geoip_database = /your/GeoIP/path</span><br><span class="line">http_enable = True</span><br><span class="line">http_interface = 127.0.0.1</span><br><span class="line">http_port = 8069</span><br><span class="line">import_partial =</span><br><span class="line">limit_memory_hard = 2684354560</span><br><span class="line">limit_memory_soft = 2147483648</span><br><span class="line">limit_request = 8192</span><br><span class="line">limit_time_cpu = 60</span><br><span class="line">limit_time_real = 120</span><br><span class="line">limit_time_real_cron = -1</span><br><span class="line">list_db = True</span><br><span class="line">log_db = False</span><br><span class="line">log_db_level = warning</span><br><span class="line">log_handler = :INFO</span><br><span class="line">log_level = info</span><br><span class="line">logfile = /your/odoo/log/path/server.log</span><br><span class="line">longpolling_port = 8072</span><br><span class="line">max_cron_threads = 2</span><br><span class="line">osv_memory_age_limit = False</span><br><span class="line">osv_memory_count_limit = False</span><br><span class="line">pg_path =</span><br><span class="line">pidfile =</span><br><span class="line">proxy_mode = True</span><br><span class="line">reportgz = False</span><br><span class="line">screencasts =</span><br><span class="line">screenshots = /tmp/odoo_tests</span><br><span class="line">server_wide_modules = base,web</span><br><span class="line">smtp_password = False</span><br><span class="line">smtp_port = 25</span><br><span class="line">smtp_server = localhost</span><br><span class="line">smtp_ssl = False</span><br><span class="line">smtp_user = False</span><br><span class="line">syslog = False</span><br><span class="line">test_enable = False</span><br><span class="line">test_file =</span><br><span class="line">test_tags = None</span><br><span class="line">transient_age_limit = 1.0</span><br><span class="line">translate_modules = [<span class="string">&#x27;all&#x27;</span>]</span><br><span class="line">unaccent = False</span><br><span class="line">upgrade_path =</span><br><span class="line">without_demo = False</span><br><span class="line">workers = 4</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;Odoo14-配置文件模板&quot;&gt;&lt;a href=&quot;#Odoo14-配置文件模板&quot; class=&quot;headerlink&quot; title=&quot;Odoo14 配置文件模板&quot;&gt;&lt;/a&gt;Odoo14 配置文件模板&lt;/h3&gt;</summary>
    
    
    
    
    <category term="Odoo" scheme="https://www.junle.org/tags/Odoo/"/>
    
  </entry>
  
  <entry>
    <title>分享一款有趣的工具——neural-style</title>
    <link href="https://www.junle.org/%E5%88%86%E4%BA%AB%E4%B8%80%E6%AC%BE%E6%9C%89%E8%B6%A3%E7%9A%84%E5%B7%A5%E5%85%B7%E2%80%94%E2%80%94neural-style/"/>
    <id>https://www.junle.org/%E5%88%86%E4%BA%AB%E4%B8%80%E6%AC%BE%E6%9C%89%E8%B6%A3%E7%9A%84%E5%B7%A5%E5%85%B7%E2%80%94%E2%80%94neural-style/</id>
    <published>2022-03-18T03:15:37.000Z</published>
    <updated>2024-03-22T06:43:55.693Z</updated>
    
    <content type="html"><![CDATA[<p>neural-style是一款使用机器学习给照片添加各种风格的Python工具，详细介绍可以参考<a href="https://github.com/anishathalye/neural-style">https://github.com/anishathalye/neural-style</a>。</p><ol><li><p>安装Python3；</p></li><li><p>从Github克隆代码；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/anishathalye/neural-style</span><br></pre></td></tr></table></figure></li><li><p>安装需求的包<code>numpy</code>，<code>Pillow</code>，<code>scipy</code>，<code>tensorflow</code>；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure></li><li><p>下载训练好的模型放在neural-style的根目录；</p><p><a href="https://www.vlfeat.org/matconvnet/models/imagenet-vgg-verydeep-19.mat">Pre-trained VGG network</a> (MD5 <code>106118b7cf60435e6d8e04f6a6dc3657</code>) </p></li><li><p>运行；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python neural_style.py --content &lt;content file&gt; --styles &lt;style file&gt; --output &lt;output file&gt;</span><br></pre></td></tr></table></figure><span id="more"></span><ul><li><p><code>&lt;content file&gt;</code>：原图路径；</p></li><li><p><code>&lt;style file&gt;</code>：风格图片路径；</p></li><li><p><code>&lt;output file&gt;</code>：输出文件路径；</p><p>更多参数设置可运行<code>python neural_style.py -h</code>查看。</p></li></ul></li></ol><ul><li><p>原图</p><p><img src="/images/cat.jpg"></p></li><li><p>风格</p><p><img src="/images/1-style.jpg"></p></li><li><p>处理后的图片</p><p><img src="/images/styles-cat.jpg"></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;neural-style是一款使用机器学习给照片添加各种风格的Python工具，详细介绍可以参考&lt;a href=&quot;https://github.com/anishathalye/neural-style&quot;&gt;https://github.com/anishathalye/neural-style&lt;/a&gt;。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;安装Python3；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;从Github克隆代码；&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git &lt;span class=&quot;built_in&quot;&gt;clone&lt;/span&gt; https://github.com/anishathalye/neural-style&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;安装需求的包&lt;code&gt;numpy&lt;/code&gt;，&lt;code&gt;Pillow&lt;/code&gt;，&lt;code&gt;scipy&lt;/code&gt;，&lt;code&gt;tensorflow&lt;/code&gt;；&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;pip install -r requirements.txt&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;下载训练好的模型放在neural-style的根目录；&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.vlfeat.org/matconvnet/models/imagenet-vgg-verydeep-19.mat&quot;&gt;Pre-trained VGG network&lt;/a&gt; (MD5 &lt;code&gt;106118b7cf60435e6d8e04f6a6dc3657&lt;/code&gt;) &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;运行；&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;python neural_style.py --content &amp;lt;content file&amp;gt; --styles &amp;lt;style file&amp;gt; --output &amp;lt;output file&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    
    <category term="Python" scheme="https://www.junle.org/tags/Python/"/>
    
    <category term="工具分享" scheme="https://www.junle.org/tags/%E5%B7%A5%E5%85%B7%E5%88%86%E4%BA%AB/"/>
    
  </entry>
  
  <entry>
    <title>SQLServer2017对象名STRING_SPLIT无效</title>
    <link href="https://www.junle.org/SQLServer2017%E5%AF%B9%E8%B1%A1%E5%90%8DSTRING_SPLIT%E6%97%A0%E6%95%88/"/>
    <id>https://www.junle.org/SQLServer2017%E5%AF%B9%E8%B1%A1%E5%90%8DSTRING_SPLIT%E6%97%A0%E6%95%88/</id>
    <published>2021-12-30T03:30:07.000Z</published>
    <updated>2024-03-22T06:43:55.682Z</updated>
    
    <content type="html"><![CDATA[<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>SQL Server 2017在使用“STRING_SPLIT”方法时报错：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> STRING_SPLIT(<span class="string">&#x27;1,2,3,4,5&#x27;</span>,<span class="string">&#x27;,&#x27;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">消息 <span class="number">208</span>，级别 <span class="number">16</span>，状态 <span class="number">1</span>，第 <span class="number">3</span> 行</span><br><span class="line">对象名 &#x27;STRING_SPLIT&#x27; 无效。</span><br></pre></td></tr></table></figure><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>STRING_SPLIT方法要求数据库的兼容级别至少为130。当级别小于130时，SQL Server无法找到STRING_SPLIT函数。</p><p>STRING_SPLIT方法介绍可参考：<a href="https://docs.microsoft.com/en-us/sql/t-sql/functions/string-split-transact-sql?view=sql-server-ver15">https://docs.microsoft.com/en-us/sql/t-sql/functions/string-split-transact-sql?view=sql-server-ver15</a></p><p>使用以下SQL语句查看数据库的兼容级别：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> compatibility_level <span class="keyword">FROM</span> sys.databases <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;DBName&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>使用以下SQL语句修改数据库兼容级别：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> DATABASE [DatabaseName] <span class="keyword">SET</span> COMPATIBILITY_LEVEL<span class="operator">=</span><span class="number">140</span></span><br></pre></td></tr></table></figure><p><strong>140代表SQLServer2017</strong></p>]]></content>
    
    
    <summary type="html">SQLServer2017对象名STRING_SPLIT无效</summary>
    
    
    
    
    <category term="SQLServer" scheme="https://www.junle.org/tags/SQLServer/"/>
    
  </entry>
  
  <entry>
    <title>Odoo14打印PDF中文显示乱码解决方法</title>
    <link href="https://www.junle.org/Odoo14%E6%89%93%E5%8D%B0PDF%E4%B8%AD%E6%96%87%E6%98%BE%E7%A4%BA%E4%B9%B1%E7%A0%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"/>
    <id>https://www.junle.org/Odoo14%E6%89%93%E5%8D%B0PDF%E4%B8%AD%E6%96%87%E6%98%BE%E7%A4%BA%E4%B9%B1%E7%A0%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</id>
    <published>2021-08-20T09:15:21.000Z</published>
    <updated>2024-03-22T06:43:55.679Z</updated>
    
    <content type="html"><![CDATA[<p>安装字体：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install ttf-wqy-zenhei</span><br><span class="line">$ sudo apt-get install ttf-wqy-microhei</span><br></pre></td></tr></table></figure><p>安装完成后重启服务。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;安装字体：&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br</summary>
      
    
    
    
    
    <category term="Odoo" scheme="https://www.junle.org/tags/Odoo/"/>
    
  </entry>
  
  <entry>
    <title>Odoo14开发者指南第三章-创建Odoo附加模块【翻译】</title>
    <link href="https://www.junle.org/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%88%9B%E5%BB%BAOdoo%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/"/>
    <id>https://www.junle.org/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%88%9B%E5%BB%BAOdoo%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/</id>
    <published>2021-04-02T08:52:38.000Z</published>
    <updated>2024-03-22T06:43:55.674Z</updated>
    
    <content type="html"><![CDATA[<p>现在我们已经有了一个开发环境，也知道如何管理Odoo服务器实例和数据库，下面我们可以学习如何创建Odoo附加模块。</p><p>我们在本章的主要目标是了解一个附加模块的结构，以及向其添加组件的典型渐进式学习路线。本章教程名称中提到的各种组件将在后续章节中广泛介绍。</p><p>在这章中，包含以下教程：</p><ul><li><p><a href="#%E5%88%9B%E5%BB%BA%E5%92%8C%E5%AE%89%E8%A3%85%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97">创建和安装一个新的附加模块</a></p></li><li><p><a href="#%E5%AE%8C%E6%88%90%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E7%9A%84%E5%A3%B0%E6%98%8E">完成附加模块的声明</a></p></li><li><p><a href="#%E7%BB%84%E7%BB%87%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97%E7%9A%84%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84">组织附加模块的文件结构</a></p></li><li><p><a href="#%E6%B7%BB%E5%8A%A0%E6%A8%A1%E5%9E%8B">添加模型</a></p></li><li><p><a href="#%E6%B7%BB%E5%8A%A0%E8%8F%9C%E5%8D%95%E9%A1%B9%E7%9B%AE%E5%92%8C%E7%95%8C%E9%9D%A2">添加菜单项目和界面</a></p></li><li><p><a href="#%E6%B7%BB%E5%8A%A0%E8%AE%BF%E9%97%AE%E5%AE%89%E5%85%A8">添加访问安全</a></p></li><li><p><a href="#%E4%BD%BF%E7%94%A8scaffold%E5%91%BD%E4%BB%A4%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97">使用scaffold命令创建一个模块</a></p></li></ul><span id="more"></span><h2 id="技术要求"><a href="#技术要求" class="headerlink" title="技术要求"></a>技术要求</h2><p>在本章中，希望您已经安装了Odoo，并按照《第一章-安装Odoo开发环境》中的方法进行操作。此外，您还需要熟悉发现和安装额外的附加模块，如《第二章-管理Odoo服务器实例》中所述。</p><p>本章使用的所有代码你可以到以下GitHub仓库下载：</p><p><a href="https://github.com/PacktPublishing/Odoo-14-Development-Cookbook-Fourth-Edition/tree/master/Chapter03">https://github.com/PacktPublishing/Odoo-14-Development-Cookbook-Fourth-Edition/tree/master/Chapter03</a></p><h2 id="什么是Odoo附加模块"><a href="#什么是Odoo附加模块" class="headerlink" title="什么是Odoo附加模块"></a>什么是Odoo附加模块</h2><p>处理Odoo框架的代码，Odoo的所有代码库都是以模块的形式打包的。这些模块可以随时从数据库中安装或卸载。这些模块有两个主要目的。要么你可以添加新的应用程序&#x2F;业务逻辑，要么你可以修改现有的应用程序。简单地说，在Odoo中，一切都以模块开始和结束。</p><p>Odoo被各种规模的公司所使用，每个公司都有不同的业务流程和要求。为了处理这个问题，Odoo将应用程序的功能分割成不同的模块。这些模块可以根据需求在数据库中加载。基本上，用户可以启用&#x2F;禁用这些模块的功能。因此，同一软件可以根据不同的要求进行调整。请看以下Odoo模块的截图；栏目中的第一个模块是主应用程序，其他模块是为了在该应用程序中添加额外的功能。要获得按应用类别分组的模块列表，请进入应用菜单，应用按类别分组：</p><p><img src="/images/Grouping_apps_by_category.png" alt="Grouping apps by category"></p><p>如果你计划在Odoo中开发新的应用程序，你应该为各种功能创建边界。这对于将你的应用程序划分为不同的附加模块非常有帮助。现在你知道了Odoo中附加模块的目的，我们可以开始构建自己的附加模块了。</p><h2 id="创建和安装新的附加模块"><a href="#创建和安装新的附加模块" class="headerlink" title="创建和安装新的附加模块"></a>创建和安装新的附加模块</h2><p>在以下教程中我们会创建一个新的模块使其可以被Odoo实例识别并安装。</p><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>首先我们需要一个正在运行的Odoo实例，如果你进行了《第一章-安装Odoo开发环境》的操作，你的Odoo应该安装在 <strong>~&#x2F;odoo-dev&#x2F;odoo</strong> 中。为了便于讲解教程，我们假设你的实例已经安装在以上目录中，当然你也可以根据你的喜好进行修改。</p><p>我们还需要一个目录来存放我们开发的Odoo模块。为了方便讲解，我们会使用odoo实例目录下的 <strong>local-addons</strong> 目录作为该目录，目录路径为 <strong>~&#x2F;odoo-dev&#x2F;local-addons</strong> 。</p><h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><p>我们将创建一个小的附加模块，用于管理图书馆的图书列表来作为本章的例子。</p><p>使用以下步骤来创建和安装一个新的附加模块：</p><ol><li><p>进入Odoo实例目录并创建一个新的目录来存放我们开发的模块：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/odoo-dev</span><br><span class="line">$ <span class="built_in">mkdir</span> local-addons</span><br></pre></td></tr></table></figure></li><li><p>为新模块选择一个技术名称，并为模块创建一个同名的目录，例如我们使用 <strong>my_library</strong> 作为模块名称：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> local-addons/my_library</span><br></pre></td></tr></table></figure><p>一个模块的技术名称必须是一个有效的Python标识符，它必须以字母开头并且只包含字母、数字和下划线字符。最好在模块名中只是用小写字母。</p></li><li><p>添加<code>__init__.py</code>文件使模块能被Python导入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">touch</span> local-addons/my_library/__init__.py</span><br></pre></td></tr></table></figure></li><li><p>添加一个最小的模块清单，以便Odoo检测到它是一个附加模块。在my_library文件夹中，创建一个<code>__manifest__.py</code>文件，其中有这样一行：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;My Library&#x27;</span>&#125;</span><br></pre></td></tr></table></figure></li><li><p>开启你的Odoo实例，在addons-path中添加我们模块目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ odoo/odoo-bin --addons-path=odoo/addon/,loacl-addons/</span><br></pre></td></tr></table></figure><p>如果使用了<code>--save</code>选项，add-ons 路径会被保存到配置文件中。下次启动服务器时，如果没有提供add-ons路径选项，将使用这个选项。</p></li><li><p>要使新模块在你的Odoo实例中可用，使用管理员登录Odoo，在<strong>关于</strong>框中启用<strong>开发者模式</strong>，在<strong>应用</strong>顶部菜单中选择<strong>更新应用程序列表</strong>。现在，Odoo应该能识别我们的Odoo模块了：</p><p><img src="/images/Dialog_to_update_the_app_list.png" alt="Dialog to update the app list"></p></li><li><p>选择顶部的<strong>应用</strong>菜单，在右上角的搜索栏中，删除默认的<strong>应用</strong>筛选器，搜索<strong>my_library</strong>。点击<strong>安装</strong>按钮，即可完成安装。</p></li></ol><h3 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h3><p>一个Odoo模块目录包含代码文件和其他资源文件。文件夹的名称使用模块的技术名称。模块的清单文件中的<strong>name</strong>的value也是模块的技术名称。</p><p><code>__manifest__.py</code>文件是模块的清单文件。这包含一个Python字典，其中包含模块元数据，包括类别、版本、它所依赖的模块，以及它将加载的数据文件列表。在本节教程中，我们使用了一个最小的清单文件，但在实际的模块中，我们将需要其他重要的键。这些将在下一节<em>完成附加模块清单</em>中再介绍。</p><p>模块的目录必须是Python能导入的，因此该目录中需要有<code>__init__.py</code>文件，该文件甚至可以是空文件。要加载一个模块，Odoo服务器将导入它。这将导致<code>__init__.py</code>文件中的代码被执行，所以它可以作为运行模块Python代码的入口点。由于这个原因，它通常会包含导入语句来加载模块的Python文件和子模块。</p><p>已知的模块可以使用<code>--ini</code>t或<code>-i</code>选项直接从命令行安装。例如，如果你想安装crm和网站应用，你可以使用<code>-i crm,website</code>。当你从当时提供的add-ons路径上找到的模块创建一个新的数据库时，这个列表会被初始化。可以在现有的数据库中通过更新模块列表菜单进行更新。</p><h2 id="完善附加模块的清单文件"><a href="#完善附加模块的清单文件" class="headerlink" title="完善附加模块的清单文件"></a>完善附加模块的清单文件</h2><p>清单文件是Odoo模块的重要的一部分。它包含了关于附加模块的重要元数据，并声明了应该加载的数据文件。</p><h3 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们应该有一个模块来工作，已经包含一个<code>__manifest__.py</code>清单文件。你可能想按照前面的配方来提供这样一个模块来工作。</p><h3 id="操作步骤-1"><a href="#操作步骤-1" class="headerlink" title="操作步骤"></a>操作步骤</h3><p>我们将为我们的模块添加一个清单文件和图标：</p><ol><li><p>创建一个清单文件<code>__manifest__.py</code>，编辑文件如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&quot;My library&quot;</span>,</span><br><span class="line"><span class="string">&#x27;summary&#x27;</span>: <span class="string">&quot;Manage books easily&quot;</span>,</span><br><span class="line"><span class="string">&#x27;description&#x27;</span>: <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Manage Library</span></span><br><span class="line"><span class="string">==============</span></span><br><span class="line"><span class="string">Description related to library.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>,</span><br><span class="line"><span class="string">&#x27;author&#x27;</span>: <span class="string">&quot;Your name&quot;</span>,</span><br><span class="line"><span class="string">&#x27;website&#x27;</span>: <span class="string">&quot;http://www.example.com&quot;</span>,</span><br><span class="line"><span class="string">&#x27;category&#x27;</span>: <span class="string">&#x27;Uncategorized&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;version&#x27;</span>: <span class="string">&#x27;13.0.1&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;depends&#x27;</span>: [<span class="string">&#x27;base&#x27;</span>],</span><br><span class="line"><span class="string">&#x27;data&#x27;</span>: [<span class="string">&#x27;views/views.xml&#x27;</span>],</span><br><span class="line"><span class="string">&#x27;demo&#x27;</span>: [<span class="string">&#x27;demo.xml&#x27;</span>],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>选择一个PNG格式的图片复制到<code>static/description/icon.png</code>。</p></li></ol><h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>清单文件中的内容是一个常规的Python字典，有键和值。我们最常用的键如下：</p><ul><li>name：模块的名称。</li><li>summary：这是带有单行说明的副标题。</li><li>description：这是一个以纯文本或 ReStructuredText (RST) 格式书写的长描述。它通常由三个引号包围，在 Python 中用于限定多行文本。对于RST的快速入门参考<a href="https://docutils.sourceforge.io/docs/user/rst/quickstart.html">https://docutils.sourceforge.io/docs/user/rst/quickstart.html</a>。</li><li>author：这是一个带有作者姓名的字符串。当有多个作者时，通常的做法是用逗号来分隔他们的名字，但注意它仍然应该是一个字符串，而不是一个Python列表。</li><li>website：这是一个URL，以了解作者和模块的更多信息。</li><li>category：用于组织模块，可用的标准别名列表可参考<a href="https://github.com/odoo/odoo/blob/13.0/odoo/addons/base/data/ir_module_category_data.xml">https://github.com/odoo/odoo/blob/13.0/odoo/addons/base/data/ir_module_category_data.xml</a>。你也可以定义其他类别名称。</li><li>version：这是模块的版本号，它可以被Odoo应用商店检查以安装模块的较新版本。如果版本号不是以Odoo版本号（例如13.0），则会自动添加。不过，如果你明确说明Odoo的目标版本，例如使用13.0.1.0.0或13.0.1.0，而不是1.0.0或1.0，会更有参考价值。</li><li>depends：这是一个直接依赖的模块的技术名称列表，如果你的模块不依赖任何其他附加模块，则至少依赖 <strong>base</strong> 模块。不要忘记包括任何定义XML ID、视图或模型的模块，这些模块被该模块引用。这将确保它们都以正确的顺序加载，避免出现难以预计的错误。</li><li>data：这是一些用于安装和升级时加载的文件的路径列表。这些路径是相对与模块目录的相对路径。通常情况下，这些文件都是XML和CSV文件，但也有可能是YAML数据文件。这些将在第六章-管理模块数据中详细讨论。</li><li>demo：这是演示数据文件的相对路径列表，只有在创建数据库时启用了<strong>演示数据</strong>时才会加载这些数据。</li></ul><p>用作模块图标的文件位于<code>static/description/icon.png</code>。</p><p>Odoo在不同的主要版本之间会有很大的变化，所以为一个主要版本建立的模块在没有转换和迁移工作的情况下不可能与下一个版本兼容。因此，在安装模块之前，一定要确定模块的Odoo目标版本。</p><h3 id="扩展内容"><a href="#扩展内容" class="headerlink" title="扩展内容"></a>扩展内容</h3><p>也可以用一个单独的描述文件来代替清单文件中定义的长描述，从8.0版本开始，可以用README文件代替，扩展名为.txt、.rst或.md（markdown）。此外，在模块中包含一个description&#x2F;index.html文件。</p><p>HTML描述会覆盖清单文件中的长描述。</p><p>以下是一些常用的其他键：</p><ul><li>licence：默认值是<strong>LGPL-3</strong>，用于定义模块的许可证，其他可能的许可包括 <strong>AGPL-3</strong> 、 <strong>Odoo Proprietary License v1.0</strong>* （主要用于付费应用）和 <strong>Other OSI Approved Licence</strong> 。</li><li>application：该值如果为True，则模块为应用，通常情况下用于功能区的核心模块。</li><li>auto_install：该值如果为True，表示它是一个胶水模块，当所有的依赖项都安装完毕后，它会自动安装。</li><li>installable：默认值为True，表示该模块可以被安装。</li><li>external_dependencies：一些Odoo模块内部使用Python&#x2F;bin库。如果你的模块使用了这样的库，你需要把它们放在这里。如果所列出的模块没有安装在主机上，这将阻止用户安装模块。</li><li>{pre_init, post_init, uninstall}_hook：这是一个Python函数钩子，在安装&#x2F;卸载时被调用。更详细的例子，请参考第8章，高级服务器端开发技术。</li></ul><p>以下是一些特殊的键，用于app商店的：</p><ul><li>price：这个键用于设置你的附加模块的价格，该值应该设置为整型值，如果为空则表示你的应用是免费的。</li><li>currency：币别，可用的值包括USD和EUR。默认值为EUR。</li><li>live_test_url：如果你想提供一个在线测试的URL，你可以使用这个键，设置后在App商店上会显示Live Preview按钮。</li><li>iap：如果这个模块提供IAP服务，可以使用这个键设置你的IAP开发者密钥。</li><li>images：图片的路径，用于设置在Odoo的App商店上显示你的App封面的图片。</li></ul><h2 id="组织附加模块的文件结构"><a href="#组织附加模块的文件结构" class="headerlink" title="组织附加模块的文件结构"></a>组织附加模块的文件结构</h2><p>一个附加模块包含代码文件和其他资源文件，例如XML文件和图片文件，对于其中的大部分文件，我们可以自由选择放在模块目录内的位置。</p><p>但是，Odoo在模块结构上使用了一些约定，所以建议遵循这些约定。</p><h3 id="准备工作-2"><a href="#准备工作-2" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们希望有一个附加模块目录，里面只有<code>__init__.py</code>和<code>__manifest__.py</code>文件。在这个教程中，我们假设它是<code>local-addons/my_library</code>。</p><h3 id="操作步骤-2"><a href="#操作步骤-2" class="headerlink" title="操作步骤"></a>操作步骤</h3><p>执行以下步骤创建附加模块的基本框架：</p><ol><li><p>创建代码文件的目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> local-addons/my_library</span><br><span class="line">$ <span class="built_in">mkdir</span> models</span><br><span class="line">$ <span class="built_in">touch</span> models/__init__.py</span><br><span class="line">$ <span class="built_in">mkdir</span> controllers</span><br><span class="line">$ <span class="built_in">touch</span> controllers/__init__.py</span><br><span class="line">$ <span class="built_in">mkdir</span> views</span><br><span class="line">$ <span class="built_in">touch</span> views/views.xml</span><br><span class="line">$ <span class="built_in">mkdir</span> security</span><br><span class="line">$ <span class="built_in">mkdir</span> wizard</span><br><span class="line">$ <span class="built_in">touch</span> wizard/__init__.py</span><br><span class="line">$ <span class="built_in">mkdir</span> report</span><br><span class="line">$ <span class="built_in">mkdir</span> data</span><br><span class="line">$ <span class="built_in">mkdir</span> demo</span><br><span class="line">$ <span class="built_in">mkdir</span> i18n</span><br></pre></td></tr></table></figure></li><li><p>编辑模块根目录的<code>__init__.py</code>，以便加载子目录中的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> controllers</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> wizard</span><br></pre></td></tr></table></figure></li></ol><p>我们应该会得到一个包含最常用的目录的结构，类似于这个my_library模块的结构：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">├── __init__.py</span><br><span class="line">├── __manifest__.py</span><br><span class="line">├── controllers</span><br><span class="line">│ └── __init__.py</span><br><span class="line">├── data</span><br><span class="line">├── demo</span><br><span class="line">├── i18n</span><br><span class="line">├── models</span><br><span class="line">│ └── __init__.py</span><br><span class="line">├── security</span><br><span class="line">├── static</span><br><span class="line">│ ├── description</span><br><span class="line">│ └── src</span><br><span class="line">│ ├─ js</span><br><span class="line">│ ├─ scss</span><br><span class="line">│ ├─ css</span><br><span class="line">│ └ xml</span><br><span class="line">├── report</span><br><span class="line">├── wizard</span><br><span class="line">│ └── __init__.py</span><br><span class="line">└──views</span><br><span class="line">└── __init__.py</span><br></pre></td></tr></table></figure><h3 id="运行原理-1"><a href="#运行原理-1" class="headerlink" title="运行原理"></a>运行原理</h3><p>为了提供一些背景，一个Odoo附加模块可以有三种类型的文件。</p><ul><li>Python代码由<code>__init__.py</code>文件加载，其中导入了.py文件和代码子目录。包含Python代码的子目录，则需要自己的<code>__init__.py</code>文件。</li><li>在<code>__manifest__.py</code>模块清单文件的data和demo键中要声明的数据文件才能加载，通常是用户界面、夹具数据和演示数据的XML和CSV文件。也可能有YAML文件，它可以包含一些程序指令，在模块加载时运行，例如，以编程方式而不是静态地在XML文件中生成或更新记录。</li><li>Web资源文件，如JavaScript代码和库、CSS、SASS和QWeb&#x2F;HTML模板。这些文件用于构建UI部件和管理用户在这些UI元素中的操作。这些都是通过一个XML文件来声明的，这个XML文件是扩展主模板的，它将这些资产添加到Web客户端或网站页面中。</li></ul><p>附加模块文件将被组织到以下目录中：</p><ul><li><strong>models&#x2F;</strong> 包含后台创建模型及其业务逻辑的代码文件。每个模型建议使用一个与模型同名的文件，例如，library_book.py代表library.book模型。这些内容在《第4章-应用模型》中会有深入的阐述。</li><li><strong>views&#x2F;</strong> 包含用户界面的actions、forms、list等XML文件。如模型，建议每个模型都有一个文件。网站模板的文件名应以 <strong>_tmplate</strong> 为后缀。后台视图在《第九章-后台视图》中讲解，网站视图在《第十四章-CMS网站开发》中讲解。</li><li><strong>data&#x2F;</strong> 包含模块初始化的数据文件，数据文件将在《第六章-管理模块数据》中讲解。</li><li><strong>demo&#x2F;</strong> 包含模块演示数据的数据文件，这些数据用于测试、培训和模块评估。</li><li><strong>i18n&#x2F;</strong> 是Odoo寻找翻译.pot和.po文件的地方。更多细节请参考《第十一章-国际化》。这些文件不需要在清单文件中提及。</li><li><strong>security&#x2F;</strong> 包含定义访问控制列表的数据文件，通常是一个ir.model.access.csv文件，也可能是一个XML文件，用于定义行级安全的访问组和记录规则。请看《第十章-安全访问》了解更多细节。</li><li><strong>controllers&#x2F;</strong> 包含了网站控制器以及提供该类功能的模块的代码文件。Web控制器在第《十三章-Web服务器开发》中有所涉及。</li><li><strong>static&#x2F;</strong> 是所有网站资源文件放置的地方。与其他目录不同的是，这个目录名不仅仅是一个约定俗成的名称。这个目录里面的文件是公开的，不需要用户登录就可以访问。这个目录主要包含JavaScript、样式表和图片等文件。它们不需要在模块清单中声明，但要在网页模板中必须要提及。这一点在《第十四章-CMS网站开发》中会详细讨论。</li><li><strong>wizard&#x2F;</strong> 包含所有与向导相关的文件。在Odoo中，向导是用来保存中间数据的。我们在《第八章-高级服务器端开发技术》中学习更多关于向导的知识。</li><li><strong>report&#x2F;</strong> Odoo提供了一个生成PDF文件的功能，如销售订单和发票。这个目录下存放了所有与PDF报表相关的文件。我们将在《第十二章-自动化、工作流、电子邮件和打印》中了解更多关于PDF报告的内容。</li></ul><p>当为模块添加新文件时，不要忘记在<code>__manifest__.py</code>文件(数据文件)或<code>__init__.py</code>文件(代码文件)中声明它们，否则这些文件将被忽略并不会被加载。</p><h2 id="添加模型"><a href="#添加模型" class="headerlink" title="添加模型"></a>添加模型</h2><p>模型定义了我们业务应用程序将使用的数据结构。本节教程向您展示了如何在模块中添加一个基本模型。</p><h3 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>要添加一个新的模型，我们需要添加一个描述它的Python文件，然后升级附加模块(或者安装它，如果还没有安装的话)。使用的路径是相对于我们的附加模块的位置(例如，<code>~/odoo-dev/local-addons/my_library/</code>)。</p><ol><li><p>添加<code>models/library_book.py</code> Python文件，代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> odoo <span class="keyword">import</span> models, fields</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryBook</span>(models.Model):</span><br><span class="line">_name = <span class="string">&#x27;library.book&#x27;</span></span><br><span class="line">name = fields.Char(<span class="string">&#x27;Title&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line">date_release = fields.Date(<span class="string">&#x27;Release Date&#x27;</span>)</span><br><span class="line">author_ids = fields.Many2many(</span><br><span class="line"><span class="string">&#x27;res.partner&#x27;</span>,</span><br><span class="line">string=<span class="string">&#x27;Authors&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></li><li><p>添加一个Python初始化文件<code>models/__init__.py</code>，代码如下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> library_book</span><br></pre></td></tr></table></figure></li><li><p>编辑模块的Python初始化文件来加载models&#x2F;目录：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> models</span><br></pre></td></tr></table></figure></li><li><p>通过命令行或用户界面的Apps菜单升级Odoo模块。如果你在升级模块时仔细观察服务器日志，你应该会看到以下一行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">odoo.modules.registry: module my_library: creating or updating database table</span><br></pre></td></tr></table></figure></li></ol><p>在这之后，新的 library.book 模型应该在我们的 Odoo 实例中可用。有两种方法可以检查我们的模型是否已经被添加到数据库中。</p><p>第一种方法，你可以在Odoo用户界面中查看。计划开发者工具，打开菜单的设置-&gt;技术-&gt;数据库结构-&gt;模型，在这里搜索library.book模型。</p><p>第二种方法是检查PostgreSQL数据库中的表项，你可以在数据库中搜索library_book表。在下面的示例代码中我们使用test-14.0作为我们的数据库。然而，在以下的命令中你也可以替换你的数据库名称：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ psql test<span class="number">-14.0</span></span><br><span class="line">test<span class="number">-14.0</span># \d library_book;</span><br></pre></td></tr></table></figure><h3 id="运行原理-2"><a href="#运行原理-2" class="headerlink" title="运行原理"></a>运行原理</h3><p>我们的第一步是创建一个Python文件，其中创建了我们的新模块。</p><p>Odoo框架有自己的<strong>Object Relational Mapping(ORM)</strong> 框架。这个ORM框架提供了对PostgreSQL数据库的抽象。通过继承Odoo Python类<strong>Model</strong> ，我们可以创建自己的模型（表）。当定义一个新模型时，它也会被添加到一个中央模型注册表中。这使得其他模块以后更容易对其进行修改。</p><p>模型有一些以下划线为前缀的通用属性。最重要的是<strong>_name</strong> ，它提供了一个唯一的内部标识符，将在整个Odoo实例中使用。ORM框架会根据这个属性生成数据库表。在本节中我们使用了<strong>_name &#x3D; ‘library.book’</strong> 。基于此属性，ORM框架将创建一个名为<strong>library_book</strong> 的新表。请注意，ORM框架通过替换<strong>_name</strong>属性的值的<code>.</code>为<code>_</code>来创建表名。</p><p>模型字段被定义为类属性。我们首先定义<strong>name</strong> 字段，字段类型为<strong>Char</strong> 。模型有这个字段很方便，因为默认情况下，它被其他模型引用时用作记录描述。</p><p>我们还使用了一个关系字段的示例<strong>author_ids</strong> 。这定义了<strong>Library Books</strong> 与其partner之间的多对多关系。一本书可以有很多作者，每个作者可以写很多书。</p><p>关于模型还有很多话要说，我们将在<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%BA%94%E7%94%A8%E6%A8%A1%E5%9E%8B%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第四章《应用模型》</a>中深入介绍。</p><p>接下来，我们必须让我们的模块知道这个新的Python文件。这是由<strong>__init__.py</strong> 文件完成的。由于我们将代码放在<strong>models&#x2F;</strong> 子目录中，我们需要之前的<strong>__init__</strong> 文件来导入该目录，该目录又应该包含另一个<strong>__init__</strong> 文件，在那里导入每个代码文件（在我们的例子中只有一个）。</p><blockquote><p>通过升级模块激活对Odoo模型的更改。Odoo服务器将处理模型类到数据库结构更改的转换。</p></blockquote><p>虽然这里没有提供示例，但也可以通过向模型的类添加新方法，或者通过扩展现有方法，例如 <strong>create()</strong> 或<strong>write()</strong> ，将业务逻辑添加到这些Python文件中。这将在第五章《基本服务器端开发》中讨论。</p><h2 id="添加菜单项目和界面"><a href="#添加菜单项目和界面" class="headerlink" title="添加菜单项目和界面"></a>添加菜单项目和界面</h2><p>一旦我们有了满足数据结构需求的模型，我们就需要一个用户界面，以便我们的用户可以与它们进行交互。本节将在上一节的<strong>Library Book</strong> 模型之上添加了一个菜单项来显示具有列表和表单视图的用户界面。</p><h3 id="准备工作-3"><a href="#准备工作-3" class="headerlink" title="准备工作"></a>准备工作</h3><p>需要上一节中实现的<strong>library.book</strong> 模型的附加模块。将使用的路径与我们的附加模块位置相关（例如，<strong>~&#x2F;odoo-dev&#x2F;localaddons&#x2F;my_library&#x2F;</strong> ）。</p><h3 id="实现步骤-1"><a href="#实现步骤-1" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>要添加视图，我们将在模块中添加一个带有其定义的<strong>XML</strong> 文件。由于它是一个新模型，我们还必须添加一个菜单选项，以便用户能够访问它。</p><p>请注意，以下步骤的顺序是相关的，因为其中一些使用对前面步骤中定义的ID的引用：</p><ol><li><p>创建XML文件以添加描述用户界面的数据记录，<strong>views&#x2F;library_book.xml</strong> ：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">odoo</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Data records go here --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">odoo</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>将新数据文件添加到附加模块清单<strong>__manifest__.py</strong> ，方法是将其添加到<strong>views&#x2F;library_book.xml</strong> ：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&quot;My Library&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;summary&#x27;</span>: <span class="string">&quot;Manage books easily&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;depends&#x27;</span>: [<span class="string">&#x27;base&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;data&#x27;</span>: [<span class="string">&#x27;views/library_book.xml&#x27;</span>],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在<strong>library_book.xml</strong> 文件中添加打开视图的操作：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&#x27;library_book_action&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ir.actions.act_window&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Library Books<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;res_model&quot;</span>&gt;</span>library.book<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;view_mode&quot;</span>&gt;</span>tree,form<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>将菜单项添加到<strong>library_book.xml</strong> 文件中，使其对用户可见：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">menuitem</span> <span class="attr">name</span>=<span class="string">&quot;My Library&quot;</span> <span class="attr">id</span>=<span class="string">&quot;library_base_menu&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">menuitem</span> <span class="attr">name</span>=<span class="string">&quot;Books&quot;</span> <span class="attr">id</span>=<span class="string">&quot;library_book_menu&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">parent</span>=<span class="string">&quot;library_base_menu&quot;</span> <span class="attr">action</span>=<span class="string">&quot;library_book_action&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>将自定义表单视图添加到<strong>library_book.xml</strong> 文件：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;library_book_view_form&quot;</span> <span class="attr">model</span>=<span class="string">&quot;ir.ui.view&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Library Book Form<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;model&quot;</span>&gt;</span>library.book<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;arch&quot;</span> <span class="attr">type</span>=<span class="string">&quot;xml&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;author_ids&quot;</span> <span class="attr">widget</span>=<span class="string">&quot;many2many_tags&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;date_release&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>将自定义树（列表）视图添加到<strong>library_book.xml</strong> 文件：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;library_book_view_tree&quot;</span> <span class="attr">model</span>=<span class="string">&quot;ir.ui.view&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Library Book List<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;model&quot;</span>&gt;</span>library.book<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;arch&quot;</span> <span class="attr">type</span>=<span class="string">&quot;xml&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tree</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;date_release&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tree</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>将自定义搜索选项添加到<strong>library_book.xml</strong> 文件：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;library_book_view_search&quot;</span> <span class="attr">model</span>=<span class="string">&quot;ir.ui.view&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Library Book Search<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;model&quot;</span>&gt;</span>library.book<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;arch&quot;</span> <span class="attr">type</span>=<span class="string">&quot;xml&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">search</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;author_ids&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">filter</span> <span class="attr">string</span>=<span class="string">&quot;No Authors&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">name</span>=<span class="string">&quot;without_author&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">domain</span>=<span class="string">&quot;[(&#x27;author_ids&#x27;,&#x27;=&#x27;,False)]&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">search</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><p>在Odoo中添加新模型时，用户默认没有任何访问权限。我们必须为新模型定义访问权限才能获得访问权限。在我们的示例中，我们没有定义任何访问权限，因此用户无权访问我们的新模型。如果没有访问权限，我们的菜单和视图也不可见。幸运的是，有一个捷径！通过切换到超级用户模式，您可以在没有访问权限的情况下查看我们应用程序的菜单。</p><h4 id="以超级用户身份访问-Odoo"><a href="#以超级用户身份访问-Odoo" class="headerlink" title="以超级用户身份访问 Odoo"></a>以超级用户身份访问 Odoo</h4><p>通过将管理员用户转换为超级用户类型，可以绕过访问权限限制，从而访问菜单和视图而无需提供默认访问权限。要将管理员用户转换为超级用户，请激活开发人员模式。完成此操作后，从开发人员工具选项中，单击成为超级用户选项。</p><p>以下屏幕截图已作为参考提供：</p><p>   <img src="/images/Option_to_activate_superuser_mode.png" alt="激活超级用户模式的选项"></p><p>成为超级用户后，您的菜单将具有条纹背景，如下图所示：</p><p>   <img src="/images/Superuser_mode_activated.png" alt="超级用户模式激活"></p><p>如果您现在尝试升级模块，您应该能够看到一个新的菜单选项（您可能需要刷新您的Web浏览器）。单击 <strong>Books</strong> 菜单将打开book模型的列表视图，如以下屏幕截图所示：</p><p>  <img src="/images/Menu_to_access_book.png" alt="访问书籍的菜单"></p><h3 id="运行原理-3"><a href="#运行原理-3" class="headerlink" title="运行原理"></a>运行原理</h3><p>在底层，用户界面由存储在特殊模型中的记录定义。前两步创建一个空的XML文件来定义要加载的记录，然后将它们添加到模块的要安装的数据文件列表中。</p><p>数据文件可以放在模块目录中的任何位置，但惯例是在<strong>views&#x2F;</strong> 子目录中定义用户界面。通常这些文件的名称基于模型的名称。在我们的例子中，我们正在为<strong>library.book</strong> 模型创建用户界面，因此我们创建了<strong>views&#x2F;library_book.xml</strong> 文件。</p><p>下一步是定义一个窗口动作以在Web客户端的主区域中显示用户界面。action是一个由<strong>res_model</strong> 定义的目标模型，<strong>name</strong> 属性用于在用户打开action时向用户显示标题，这些只是基本属性。窗口操作支持其他属性，可以更好地控制视图的呈现方式，例如要显示哪些视图、在可用记录上添加过滤器或设置默认值。 这些将在第九章《后端视图中》详细讨论。</p><p>通常，数据记录是使用<strong>&lt;record&gt;</strong> 标签定义的，我们在示例中为<strong>ir.actions.act_window</strong> 模型创建了一条记录。这将创建窗口操作。</p><p>同样，菜单项存储在<strong>ir.ui.menu</strong> 模型中，我们可以使用<strong>&lt;record&gt;</strong> 标记创建它们。但是在Odoo中有一个名为<strong>&lt;menuitem&gt;</strong> 的快捷方式标签，因此我们在示例中使用了它。</p><p>这些是菜单项的主要属性：</p><ul><li><strong>name</strong> ：这是要显示的菜单项文本。</li><li><strong>action</strong> ：这是要执行的操作的标识符。我们使用在上一步中创建的窗口操作的ID。</li><li><strong>sequence</strong> ：用于设置同级菜单项的显示顺序。</li><li><strong>parent</strong> ：这是父菜单项的标识符。我们的示例菜单项没有父项，这意味着它将显示在菜单的顶部。</li><li><strong>web_icon</strong> ：此属性用于显示菜单的图标。此图标仅在Odoo企业版中显示。</li></ul><p>此时我们还没有在我们的模块中定义任何视图。但是，如果您在此阶段升级您的模块，Odoo将自动动态创建它们。 尽管如此，我们肯定希望控制视图的外观，因此，在接下来的两个步骤中，将创建一个表单和一个树视图。</p><p>两个视图都使用<strong>ir.ui.view</strong> 模型上的记录定义。 我们使用的属性如下：</p><ul><li><p><strong>name</strong> ：这是标识视图的标题。在Odoo的源代码中，您会发现这里重复了XML ID，但如果您愿意，可以添加一个更易读的标题作为名称。</p><blockquote><p>如果<strong>name</strong> 字段被省略，Odoo将使用模型名称和视图类型生成一个。这对于新模型的标准视图来说非常好。建议在扩展视图时使用更明确的名称，当您在Odoo的用户界面中查找特定视图时，将变得非常方便。</p></blockquote></li><li><p><strong>model</strong> ：这是目标模型的内部标识符，在其<strong>_name</strong> 属性中定义。</p></li><li><p><strong>arch</strong> ：这是视图架构，实际定义结构的地方。不同类型的视图都不相同。</p></li></ul><p>表单视图由顶部的<strong>&lt;form&gt;</strong> 元素定义，其画布是一个双列网格。在表单内部，<strong>&lt;group&gt;</strong> 元素用于垂直组合字段。两个组产生两个带有字段的列，它们是使用<strong>&lt;field&gt;</strong> 元素添加的。字段根据其数据类型使用默认小部件，但可以在小部件属性的帮助下使用特定小部件。</p><p>树视图更简单；它们由顶部<strong>&lt;tree&gt;</strong> 元素定义，该元素包含要显示的列的<strong>&lt;field&gt;</strong> 元素。</p><p>最后，我们添加了一个搜索视图以扩展右上角框中的搜索选项。 在<strong>&lt;search&gt;</strong> 顶级标签内，我们可以有<strong>&lt;field&gt;</strong> 和<strong>&lt;filter&gt;</strong> 元素。字段元素是可以从搜索视图中给出的输入中搜索的附加字段。过滤器元素是预定义的过滤条件，可以通过单击激活。这些主题在第九章《后端视图》中详细讨论。</p><h2 id="添加访问安全"><a href="#添加访问安全" class="headerlink" title="添加访问安全"></a>添加访问安全</h2><p>添加新数据模型时，您需要定义谁可以创建、读取、更新和删除记录。当创建一个全新的应用程序时，这可能涉及定义新的用户组。因此，如果用户没有这些访问权限，那么Odoo将不会显示您的菜单和视图。在上一节中，我们通过将管理员用户转换为超级用户来访问我们的菜单。通过本节，您将能够以管理员用户的身份直接访问我们的库模块的菜单和视图。</p><p>本节中建立在前一章节的Library Books之上，并定义了一个新的用户安全组来控制谁可以访问或修改图书记录。</p><h3 id="准备工作-4"><a href="#准备工作-4" class="headerlink" title="准备工作"></a>准备工作</h3><p>需要上一章节使用的<strong>library.book</strong> 模型的附加模块，我们将为它添加安全规则。使用的路径与我们的附加模块位置相关（例如，<strong>~&#x2F;odoo-dev&#x2F;local-addons&#x2F;my_library&#x2F;</strong> ）。</p><h3 id="实现步骤-2"><a href="#实现步骤-2" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>在本小节中我们要添加的安全规则如下：</p><ul><li>每个人都可以阅读图书馆的图书记录。</li><li>新建具有权创建、读取、更新和删除图书记录的安全组：<strong>Librarians</strong> 。</li></ul><p>要实现这一点，您需要执行以下步骤：</p><ol><li><p>创建一个名为<strong>security&#x2F;groups.xml</strong> 的文件，其内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">odoo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">record</span> <span class="attr">id</span>=<span class="string">&quot;group_librarian&quot;</span> <span class="attr">model</span>=<span class="string">&quot;res.groups&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Librarians<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;users&quot;</span> <span class="attr">eval</span>=<span class="string">&quot;[(4, ref(&#x27;base.user_admin&#x27;))]&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">record</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">odoo</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>创建名为<strong>security&#x2F;ir.model.access.csv</strong> 文件，其内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink</span><br><span class="line">acl_book,library.book_default,model_library_book,,1,0,0,0</span><br><span class="line">acl_book_librarian,library.book_librarian,model_library_book,group_librarian,1,1,1,1</span><br></pre></td></tr></table></figure></li><li><p>将以上两个文件添加到<strong>__manifest__.py</strong> 文件的<strong>data</strong> 条目中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="string">&#x27;data&#x27;</span>: [</span><br><span class="line">    <span class="string">&#x27;security/groups.xml&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;security/ir.model.access.csv&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;views/library_book.xml&#x27;</span></span><br><span class="line">],</span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure></li></ol><p>更新实例中的插件后，新定义的安全规则将生效。</p><h3 id="运行原理-4"><a href="#运行原理-4" class="headerlink" title="运行原理"></a>运行原理</h3><p>我们提供了两个新的数据文件，将它们添加到附加模块的清单中，以便安装或更新模块会将它们加载到数据库中：</p><ul><li><strong>security&#x2F;groups.xml</strong> 文件通过创建<strong>res.groups</strong> 记录来定义新的安全组。我们还通过使用其参考ID <strong>base.user_admin</strong> 将<strong>Librarians</strong> 的权限授予<strong>admin</strong> 用户，这样admin用户将拥有<strong>library.book</strong> 模型的权限。</li><li><strong>ir.model.access.csv</strong> 文件将模型的权限与组相关联。第一行有一个空的<strong>group_id:id</strong> 列，这意味着该规则适用于所有人。最后一行将所有权限授予我们刚刚创建的组的成员。</li></ul><p>清单文件中的的数据部分文件的顺序很重要。创建安全组的文件必须在列出访问权限的文件之前加载，因为访问权限的定义取决于组的存在。由于视图可以特定于安全组，我们建议将组的定义文件放在列表中以更安全。</p><blockquote><p><strong>也可以看看</strong><br>本书有一章专门介绍安全性。有关安全性的更多信息，请参阅第十章《安全访问》。</p></blockquote><h2 id="使用scaffold命令创建一个模块"><a href="#使用scaffold命令创建一个模块" class="headerlink" title="使用scaffold命令创建一个模块"></a>使用scaffold命令创建一个模块</h2><p>创建新的Odoo模块时，需要设置一些样板代码。为了帮助快速启动新模块，Odoo提供了脚手架（<strong>scaffold</strong> ）命令。</p><p>本节向你展示了如何使用脚手架命令创建一个新模块，它将生成一个模块需要的文件目录。</p><h3 id="准备工作-5"><a href="#准备工作-5" class="headerlink" title="准备工作"></a>准备工作</h3><p>我们将在自定义模块目录中创建新的附加模块，因此我们需要安装Odoo和自定义模块的目录。假设 Odoo安装在<strong>~&#x2F;odoo-dev&#x2F;odoo</strong> 并且我们的自定义模块放置在<strong>~&#x2F;odoo-dev&#x2F;local-addons</strong> 目录中。</p><h3 id="实现步骤-3"><a href="#实现步骤-3" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>我们将使用<strong>scaffold</strong> 命令来创建模板代码。执行以下步骤以使用<strong>scaffold</strong> 命令创建新模块：</p><ol><li><p>将工作目录更改为我们希望模块所在的位置。这可以是您选择的任何目录，但它必须位于附加路径中才能有用。 按照我们在上面中使用的目录选择，应该如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/odoo-dev/local-addons</span><br></pre></td></tr></table></figure></li><li><p>为新模块选择一个技术名称，并使用<strong>scaffold</strong> 命令创建它。对于我们的示例，我们将选择<strong>my_module</strong> ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/odoo-dev/odoo/odoo-bin scaffold my_module</span><br></pre></td></tr></table></figure></li><li><p>编辑提供的<strong>__manifest__.py</strong> 默认模块清单并更改相关值。您肯定希望至少更改<strong>name</strong> 键中的模块标题。</p></li></ol><p>这是生成的附加模块应如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">tree my_module</span><br><span class="line">my_module/</span><br><span class="line">├── controllers</span><br><span class="line">│   ├── controllers.py</span><br><span class="line">│   └── __init__.py</span><br><span class="line">├── demo</span><br><span class="line">│   └── demo.xml</span><br><span class="line">├── __init__.py</span><br><span class="line">├── __manifest__.py</span><br><span class="line">├── models</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   └── models.py</span><br><span class="line">├── security</span><br><span class="line">│   └── ir.model.access.csv</span><br><span class="line">└── views</span><br><span class="line">    ├── templates.xml</span><br><span class="line">    └── views.xml</span><br><span class="line"> </span><br><span class="line">5 directories, 10 files</span><br></pre></td></tr></table></figure><p>您现在应该编辑各种生成的文件并使它们适应新模块的用途。</p><h3 id="运行原理-5"><a href="#运行原理-5" class="headerlink" title="运行原理"></a>运行原理</h3><p><strong>scaffold</strong> 命令可使用模板来创建新模块的结构框架。</p><p>默认情况下，新模块是在当前工作目录中创建的，但我们可以提供一个特定的目录来创建模块，将其作为附加参数传递。</p><p>类似以下示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/odoo-dev/odoo/odoo-bin scaffold my_module ~/odoo-dev/local-addons</span><br></pre></td></tr></table></figure><p>使用<strong>default</strong> 模板，但<strong>theme</strong> 模板也可用于网站主题创作。要选择特定模板，可以使用<strong>-t</strong> 选项。 我们还可以使用带有模板的目录的路径。</p><p>这意味着我们可以通过<strong>scaffold</strong> 命令使用我们自己的模板。 内置模板可以在<strong>/odoo/cli/templates</strong> 的子目录中找到。要使用我们自己的模板，我们可以使用类似以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/odoo-dev/odoo/odoo-bin scaffold -t path/to/template my_module</span><br></pre></td></tr></table></figure><p>默认情况下，Odoo在<strong>/odoo/cli/templates</strong> 目录中有两个模板。一是<strong>default</strong> 模板，二是<strong>theme</strong> 模板。 但是，您可以创建自己的模板或将其与<strong>-t</strong> 一起使用，如前面的命令所示。</p>]]></content>
    
    
    <summary type="html">现在我们已经有了一个开发环境，也知道如何管理Odoo服务器实例和数据库，下面我们可以学习如何创建Odoo附加模块。</summary>
    
    
    
    
    <category term="Odoo开发者指南" scheme="https://www.junle.org/tags/Odoo%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>Odoo14开发者指南第二章-管理Odoo服务器实例【翻译】</title>
    <link href="https://www.junle.org/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E7%AE%A1%E7%90%86Odoo%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%9E%E4%BE%8B%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/"/>
    <id>https://www.junle.org/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E7%AE%A1%E7%90%86Odoo%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%9E%E4%BE%8B%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/</id>
    <published>2021-03-27T02:15:21.000Z</published>
    <updated>2024-03-22T06:43:55.675Z</updated>
    
    <content type="html"><![CDATA[<p>在<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%AE%89%E8%A3%85Odoo%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第一章</a>，安装Odoo开发环境中，我们研究了如何仅使用源附带的标准核心插件来设置Odoo实例。本章着重于向Odoo添加非核心或自定义插件。在Odoo中，您可以从多个目录加载add-ons，此外，建议使用单独的文件夹加载第三方add-ons或自己的自定义add-ons，以免与Odoo核心模块发生冲突。</p><span id="more"></span><p>在本章中，我们将介绍以下Recipes：</p><ul><li><p>配置add-ons路径；</p></li><li><p>标准化您的实例目录布局；</p></li><li><p>安装和升级本地的add-ons；</p></li><li><p>从GitHub安装add-ons；</p></li><li><p>将更改应用到add-ons；</p></li><li><p>应用并尝试建议的拉取请求。</p><blockquote><p>有关术语</p><p>在本书中，我们将交替使用（插件）<strong>add-no</strong>或（模块）<strong>module</strong>或（应用）<strong>app</strong>或（插件模块）<strong>add-on module</strong>这些术语。这些属于都代表一个意思，就是可以从用户界面安装的Odoo应用程序或者Extension应用程序。</p></blockquote></li></ul><h2 id="配置add-ons路径"><a href="#配置add-ons路径" class="headerlink" title="配置add-ons路径"></a>配置add-ons路径</h2><p>借助<strong>addons_path</strong>参数，您可以将自己的附加模块加载到Odoo中。当Odoo初始化新数据库时，它将在<strong>addons_path</strong>配置参数提供的目录中搜索附加模块。</p><p><strong>addons_path</strong>中列出的目录应该包含子目录，每个子目录都是一个附加模块。在数据库初始化之后，您将能够安装这些目录中提供的模块。</p><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>此Recipes假定您已准备好一个实例，并且已生成一个配置文件，如第1章的安装Odoo开发环境中的在文件配方中存储实例配置中所述。请注意，Odoo的源码目录是<code>~/odoo-dev/odoo</code>，Odoo配置文件目录是<code>~/odoo-dev/myodoo.cfg</code>。</p><h3 id="如何配置add-no路径"><a href="#如何配置add-no路径" class="headerlink" title="如何配置add-no路径"></a>如何配置add-no路径</h3><p>要将<code>~/odoo-dev/loacl-addons</code>目录添加到实例的<strong>addons-path</strong>配置中，需要以下步骤：</p><ol><li><p>编辑你的实例的配置文件<code>~/odoo-dev/myodoo.cfg</code>;</p></li><li><p>找到以 <strong>addons_path&#x3D;</strong> 开头的行,默认情况下，它应如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addons_path = ~/odoo-dev/odoo/addons</span><br></pre></td></tr></table></figure></li><li><p>用逗号分隔，后跟要添加到addons_path的目录的名称，如以下代码所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addons_path = ~/odoo-dev/odoo/addons,~/odoo-dev/local-addons</span><br></pre></td></tr></table></figure></li><li><p>重启你的实例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ~/odoo-dev/odoo/odoo-bin -c my-instance.cfg</span><br></pre></td></tr></table></figure></li></ol><h3 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h3><p>当Odoo实例重启后，它会读取配置文件的<strong>addons_path</strong>变量并根据逗号分隔各个值。<strong>addons_path</strong>可以使用相对路径，但它们是相对于当前工作目录的，因此应避免在配置文件中使用。</p><p>至此，我们只添加了add-on目录<code> ~/odoo-dev/local-addons</code>但是该目录中还没有模块。甚至在该目录下添加了新的模块，也不会显示在Odoo的用户界面中。为此，您需要执行额外的操作，我们将在下一部分<em>更新插件模块列表</em>中会进行讲解。</p><blockquote><p>这背后的原因是，当初始化新数据库时，Odoo会自动在可用模块中列出您的自定义模块，但是如果在数据库初始化后添加新模块，则需要手动更新可用模块列表。</p></blockquote><h3 id="更多内容"><a href="#更多内容" class="headerlink" title="更多内容"></a>更多内容</h3><p>当你使用<code>odoo-bin</code>脚本来初始化新的数据库时，你可以在命令行输入<code>--addons-path</code>参数和以逗号分隔的插件目录。这样做Odoo会根据参数的内容来初始化插件目录。执行此操作时，必须显式包括基本加载项目录（odoo&#x2F;odoo&#x2F;addons）和核心加载项目录（odoo&#x2F;addons）。与前面的方法的一个小区别是本地附加组件不能为空；它们必须至少包含一个子目录，该子目录具有附加模块的最小结构。</p><p>在第三章，创建Odoo附加模块，我们会介绍如何创建自己的模块，这里顺便介绍一些如何创建一个满足Odoo需求的模块的快捷方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p ~/odoo-dev/local-addons/dummy</span><br><span class="line">$ <span class="built_in">touch</span> ~/odoo-dev/local-addons/dummy/ init .py</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;&#123;&quot;name&quot;: &quot;dummy&quot;, &quot;installable&quot;: False&#125;&#x27;</span> &gt; \</span><br><span class="line">~/odoo-dev/local-addons/dummy/ manifest .py</span><br></pre></td></tr></table></figure><p>您可以使用<code>--save</code>选项将路径保存到配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ odoo/odoo-bin -d mydatabase \</span><br><span class="line">--add-ons-path=<span class="string">&quot;odoo/odoo/addons,odoo/addons,~/odoo-dev/local-addons&quot;</span></span><br><span class="line">\</span><br><span class="line">--save -c ~/odoo-dev/my-instance.cfg --stop-after-init</span><br></pre></td></tr></table></figure><p>这里我们使用的是相对路径，保存时Odoo会自动转换为绝对路径存放到配置文件中。</p><h2 id="标准化您的实例目录布局"><a href="#标准化您的实例目录布局" class="headerlink" title="标准化您的实例目录布局"></a>标准化您的实例目录布局</h2><p>这个方法创建了一个结构化的目录，该目录将将相似生命周期或相似用途的文件分组放在特点的子目录中。</p><blockquote><p>这个方法仅在你想使用类似的文件夹结构来管理开发环境和生产环境时使用，如果你不想可以跳过。</p></blockquote><p>当然这个文件结构不是强制要求的，你可以根据你的需求更改此结构。</p><h3 id="如何标准化你的实例目录布局"><a href="#如何标准化你的实例目录布局" class="headerlink" title="如何标准化你的实例目录布局"></a>如何标准化你的实例目录布局</h3><p>要创建标准的实例布局，你需要执行以下步骤：</p><ol><li><p>为每个实例创建一个目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> ~/odoo-dev/projectname</span><br><span class="line">$ <span class="built_in">cd</span> ~/odoo-dev/projectname</span><br></pre></td></tr></table></figure></li><li><p>创建Python虚拟环境：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python3 -m venv <span class="built_in">env</span></span><br></pre></td></tr></table></figure></li><li><p>创建子目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> src <span class="built_in">local</span> bin filestore logs</span><br></pre></td></tr></table></figure><p>子目录功能如下：</p><ul><li><strong>src&#x2F;</strong>: 它包含Odoo本身的克隆，以及各种第三方附加项目。</li><li><strong>local&#x2F;</strong>: 这用于保存您的实例特定的插件。</li><li><strong>bin&#x2F;</strong>: 这包括各种帮助程序可执行的Shell脚本。</li><li><strong>filestore&#x2F;</strong>: 这用作文件存储。</li><li><strong>logs&#x2F; (可选)</strong>: 这用作服务日期存储。</li></ul></li><li><p>克隆Odoo源码和安装需求（详情可参考<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%AE%89%E8%A3%85Odoo%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第一章</a>，安装Odoo开发环境）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> -b 14.0 --single-branch --depth 1</span><br><span class="line">https://github.com/odoo/odoo.git src/odoo</span><br><span class="line">$ <span class="built_in">env</span>/bin/pip3 install -r src/odoo/requirements.txt</span><br></pre></td></tr></table></figure></li><li><p>保存以下代码到<strong>bin&#x2F;odoo</strong>：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh ROOT=$(dirname $0)/..</span></span><br><span class="line">PYTHON=<span class="variable">$ROOT</span>/env/bin/python3 ODOO=<span class="variable">$ROOT</span>/src/odoo/odoo-bin</span><br><span class="line"><span class="variable">$PYTHON</span> <span class="variable">$ODOO</span> -c <span class="variable">$ROOT</span>/projectname.cfg <span class="string">&quot;<span class="variable">$@</span>&quot;</span> <span class="built_in">exit</span> $?</span><br></pre></td></tr></table></figure></li><li><p>为<strong>bin&#x2F;odoo</strong>添加可执行权限：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">chmod</span> +x bin/odoo</span><br></pre></td></tr></table></figure></li><li><p>创建一个空的名为dummy的本地模块：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p <span class="built_in">local</span>/dummy</span><br><span class="line">$ <span class="built_in">touch</span> <span class="built_in">local</span>/dummy/ init .py</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;&#123;&quot;name&quot;: &quot;dummy&quot;, &quot;installable&quot;: False&#125;&#x27;</span> &gt;\</span><br><span class="line"><span class="built_in">local</span>/dummy/ manifest .py</span><br></pre></td></tr></table></figure></li><li><p>为你的实例创建配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ bin/odoo --stop-after-init --save \</span><br><span class="line">--addons-path src/odoo/odoo/addons,src/odoo/addons,<span class="built_in">local</span> \</span><br><span class="line">--data-dir filestore</span><br></pre></td></tr></table></figure></li><li><p>添加<strong>.gitignore</strong>文件，用于告诉GitHub排除给定目录，以便在提交代码时Git会忽略这些目录，例如: <strong>filestore&#x2F;</strong>, <strong>env&#x2F;</strong>, <strong>logs&#x2F;</strong> 和 <strong>src&#x2F;</strong> 。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dotfiles, with exceptions:</span></span><br><span class="line">.*</span><br><span class="line">!.gitignore</span><br><span class="line"><span class="comment"># python compiled files</span></span><br><span class="line">*.py[co]</span><br><span class="line"><span class="comment"># emacs backup files</span></span><br><span class="line">*~</span><br><span class="line"><span class="comment"># not tracked subdirectories</span></span><br><span class="line">/env/</span><br><span class="line">/src/</span><br><span class="line">/filestore/</span><br><span class="line">/logs/</span><br></pre></td></tr></table></figure></li><li><p>为你的实例创建一个Git仓库并添加文件到Git仓库：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git init</span><br><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">&quot;initial version of projectname&quot;</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="运行原理-1"><a href="#运行原理-1" class="headerlink" title="运行原理"></a>运行原理</h3><p>我们会生成一个干净的目录结构，其中包含明确标记的目录和专门的角色。我们使用不同的目录来存储以下内容：</p><ul><li>由其他人管理的代码（放在 <strong>src&#x2F;</strong> 目录下）；</li><li>本地相关的代码；</li><li>实例的文件存储。</li></ul><p>为每个项目都创建一个Python虚拟环境，我们可以确保项目的依赖关系不会干扰到其他不同版本的Odoo实例，这个Python虚拟环境只会占有少量的硬盘空间。</p><p>以类似的方式，通过为我们的不同项目使用Odoo和第三方加载项模块的单独克隆，我们能够使它们各自独立发展，并且仅在需要它们的实例上安装更新，从而降低了发生更新回退的风险。</p><p><strong>bin&#x2F;odoo</strong>脚本不仅使我们无需记住各种路径或激活Python虚拟环境即可运行服务器，也为我们设置了配置文件。您可以在其中添加其他脚本来帮助您进行日常工作。例如，您可以添加脚本来检查运行实例所需的其他第三方项目。</p><p>关于配置文件，我们仅展示了在此处设置的最小化的选项，您也可以设置更多的选项，例如数据库名称，数据库过滤器或项目侦听的端口。详情可参考<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%AE%89%E8%A3%85Odoo%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第一章</a>，安装Odoo开发环境，以获取有关此主题的更多信息。</p><p>最后，通过在Git仓库中管理所有这些内容，将设置复制到另一台计算机上并在团队之间共享开发变得非常容易。</p><blockquote><p>为了方便项目创建，您可以创建一个包含空结构的模板存储库，并为每个新项目fork该存储库。这将使您不必重新键入bin&#x2F;odoo脚本，.gitignore文件以及所需的任何其他模板文件（连续集成配置，README.md，ChangeLog等）。</p></blockquote><h3 id="更多内容-1"><a href="#更多内容-1" class="headerlink" title="更多内容"></a>更多内容</h3><p>复杂模块的开发需要各种配置选项，每当您尝试使用任何配置选项时，都会导致更新配置文件。 频繁更新配置文件可能会让人头疼，为避免这种情况，另一种方法是从命令行传递所有配置选项，如下所示：</p><ol><li><p>手动激活Python虚拟环境：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> <span class="built_in">env</span>/bin/activate</span><br></pre></td></tr></table></figure></li><li><p>进入Odoo源码目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> src/odoo</span><br></pre></td></tr></table></figure></li><li><p>运行Odoo服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./odoo-bin --addons-path=addons,../../local -d test-14 -i</span><br><span class="line">account,sale,purchase --log-level=debug</span><br></pre></td></tr></table></figure></li></ol><p>在第3步中，我们直接在命令行中输入了一些选项，第一个是<code>--add-ons-path</code>，它会加载Odoo的核心插件目录addons以及你的本地的插件目录，您将在其中放置自己的加载项模块。<code>-d</code>选项将使用<strong>test-14</strong>数据库或创建一个新数据库（如果数据库不存在）<code>-i</code>选项将安装<strong>account</strong>，<strong>sale</strong> 和 <strong>purchase</strong>模块。接下来，我们传递了日志级别的选项，并设置了日志级别为<strong>debug</strong>，以便在日志中显示更多信息。</p><p>通过使用命令行，您可以快速更改配置选项。您还可以在终端中查看实时日志。 有关所有可用选项，请参阅可参考<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%AE%89%E8%A3%85Odoo%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第一章</a>，安装Odoo开发环境，或使用<code>--help</code>命令查看所有选项的列表以及每个选项的描述。</p><h2 id="安装和升级本地附加模块"><a href="#安装和升级本地附加模块" class="headerlink" title="安装和升级本地附加模块"></a>安装和升级本地附加模块</h2><p>Odoo的核心功能来自其附加模块，您可以从Odoo本身中获得大量附加模块，以及可以从App Store下载或自己编写的附加模块。</p><p>在这个Recipe中，我们会介分别绍如何通过web界面和命令行的方式去安装和更新这些附加模块。</p><p>使用命令行执行这些操作的主要好处包括：一次可以操作多个插件，并在安装或更新的过程中可以清晰的查看服务日子，这在开发模式下或编写实例安装脚本时非常有用。</p><h3 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h3><p>确保您有一个正在运行的Odoo实例，其数据库已初始化并且正确设置了附加组件路径。在本教程中，我们将安装&#x2F;升级一些附加模块。</p><h3 id="如何安装和升级"><a href="#如何安装和升级" class="headerlink" title="如何安装和升级"></a>如何安装和升级</h3><p>有两种可能的方法来安装或更新加载项-您可以使用Web界面或命令行。</p><h4 id="使用Web界面安装和更新"><a href="#使用Web界面安装和更新" class="headerlink" title="使用Web界面安装和更新"></a>使用Web界面安装和更新</h4><p>使用Web界面安装新的附件模块，你需要进行以下操作：</p><ol><li><p>使用管理员账号登陆你的Odoo实例，进入<strong>应用</strong>菜单：</p><p><img src="/images/List_of_Odoo_apps.png" alt="List of Odoo apps"></p></li><li><p>搜索你要安装的附加模块，下面是一些提示帮助你完成这个步骤：</p><ul><li>激活<strong>未安装</strong>过滤器。</li><li>如果您正在寻找特定的功能附加组件，而不是广泛的功能附加组件，请删除<strong>应用程序</strong>过滤器。</li><li>在搜索栏输入模块的名称作为模块的过滤器。</li><li>您可能会发现使用列表视图使内容更具可读性。</li></ul></li><li><p>点击模块名下面的<strong>安装</strong>按钮。</p><blockquote><p>请注意，某些Odoo附加模块具有外部Python依赖关系。如果您的系统中未安装Python依赖关系，则Odoo将中止安装并显示以下对话框：</p></blockquote><p><img src="/images/Warning_for_external_library_dependency.png" alt="Warning for external library dependency"></p><p>通过安装相关的Python依赖来修复它。</p></li></ol><p>要更新数据库中的预安装模块，请执行以下步骤：</p><ol><li><p>使用管理员账号登陆你的Odoo实力，进入<strong>应用</strong>菜单；</p></li><li><p>点击<strong>应用</strong>：</p><p><img src="/images/Odoo_apps_list.png" alt="Odoo apps list"></p></li><li><p>搜索你要安装的附加模块，下面是一些提示帮助你完成这个步骤：</p><ul><li><p>激活<strong>已安装</strong>过滤器。</p></li><li><p>如果您正在寻找特定的功能附加组件，而不是广泛的功能附加组件，请删除<strong>应用程序</strong>过滤器。</p></li><li><p>在搜索栏输入模块的名称作为模块的过滤器。例如，这里我们输入CRM。</p></li><li><p>您可能会发现使用列表视图使内容更具可读性。</p></li></ul></li><li><p>点击应用卡片右上角的三点，在弹出的菜单中选择*<strong>更新</strong>。</p><p><img src="/images/Drop-down_link_for_upgrading_the_module.png" alt="Drop-down link for upgrading the module"></p></li></ol><p>激活开发者模式以查看模块的技术名称。如果您不知道如何激活开发人员模式，请参考<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%AE%89%E8%A3%85Odoo%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第一章</a>，安装Odoo开发环境：</p><p><img src="/images/Application's_technical_names.png" alt="Application&#39;s technical names"></p><p>激活开发者模式后，它将以红色显示该模块的技术名称。如果您使用的是Odoo Community Edition，则您会看到一些带有<strong>升级</strong>按钮的其他应用程序。这些应用程序是Odoo Enterprise Edition应用程序，如要安装&#x2F;使用它们您需要购买许可证。</p><h4 id="使用命令行安装和更新"><a href="#使用命令行安装和更新" class="headerlink" title="使用命令行安装和更新"></a>使用命令行安装和更新</h4><p>使用命令行界面安装新的附件模块，你需要进行以下操作：</p><ol><li><p>查找附件模块的名称。模块名称的定义是 <code>__manifest__.py</code>文件所在的目录名称，不带前导路径。</p></li><li><p>关闭Odoo实例，如果你是在生产环境中操作，请先进行数据库备份。</p></li><li><p>执行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ odoo/odoo-bin -c instance.cfg -d dbname -i addon1,addon2 \</span><br><span class="line">--stop-after-init</span><br></pre></td></tr></table></figure><p>如果你在配置文件中设置了数据库名称，你可以忽略<code>-d</code>选项。</p></li><li><p>重启Odoo实例。</p></li></ol><p>要更新数据库中的预安装模块，请执行以下步骤：</p><ol><li><p>查找附件模块的名称。模块名称的定义是 <code>__manifest__.py</code>文件所在的目录名称，不带前导路径。</p></li><li><p>关闭Odoo实例，如果你是在生产环境中操作，请先进行数据库备份。</p></li><li><p>执行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ odoo/odoo-bin -c instance.cfg -d dbname -u addon1 \</span><br><span class="line">--stop-after-init</span><br></pre></td></tr></table></figure><p>如果你在配置文件中设置了数据库名称，你可以忽略<code>-d</code>选项。</p></li><li><p>重启Odoo实例。</p></li></ol><h3 id="运行原理-2"><a href="#运行原理-2" class="headerlink" title="运行原理"></a>运行原理</h3><p>附加模块的安装和更新是两个紧密相关的过程，但是有一些重要的区别，如以下两节所强调。</p><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>当您安装插件时，Odoo会检查其可用附件列表中是否有带有提供名称的未安装的插件，还会检查该插件的依赖项，如果有依赖项，它将以递归方式安装它们。</p><p>单个模块的安装过程包括以下步骤：</p><ol><li>如果有，运行插件的<strong>preinit</strong>挂钩。</li><li>从Python源代码加载模型定义，并在必要时更新数据库结构（有关详细信息，请参见第4章，应用程序模型）。</li><li>加载插件的数据文件，并在必要时更新数据库内容（有关详细信息，请参见第6章，管理模块数据）。</li><li>如果实例中已启用演示数据，安装附加演示数据。</li><li>如果有，运行插件的<strong>preinit</strong>挂钩。</li><li>对附加插件的视图定义进行验证。</li><li>如果启用了演示数据并启用了测试，运行附加组件的测试（有关详细信息，请参见第18章，自动测试用例）。</li><li>更新数据库中的模块状态。</li><li>从附加组件的翻译中更新数据库中的翻译（有关详细信息，请参见第11章，国际化）。</li></ol><blockquote><p>在<code>__manifest__.py</code>文件中分别使用<strong>pre_init_hook</strong>和<strong>post_init_hook</strong> key 定义了<strong>preinit</strong>和<strong>postinit</strong> hooks。 这些钩子用于在安装附加模块之前和之后调用Python函数。要了解有关init钩子的更多信息，请参阅第3章，创建Odoo附加模块。</p></blockquote><h4 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h4><p>更新插件时，Odoo会在可用插件模块列表中检查给定名称的已安装附件，还检查该附件的反向依赖关系（这些插件是取决于要更新的插件）。如果有的话，它也会递归地更新它们。</p><p>单个模块的更新过程包括以下步骤：</p><ol><li>运行附加模块的预迁移步骤（如果有）（有关详细信息，请参见第6章，管理模块数据）。</li><li>从Python源代码加载模型定义，并在必要时更新数据库结构（有关详细信息，请参见第4章，应用程序模型）。</li><li>加载插件的数据文件，并在必要时更新数据库的内容（有关详细信息，请参见第6章，管理模块数据）。</li><li>如果实例中启用了演示数据，则更新加载项的演示数据。</li><li>如果您的模块有任何迁移方法，请运行附加的迁移后步骤（有关详细信息，请参阅第6章，管理模块数据）。</li><li>对加载项的视图定义进行验证。</li><li>如果启用了演示数据并启用了测试，请运行附加组件的测试（有关详细信息，请参见第18章，自动测试用例）。</li><li>更新数据库中的模块状态。</li><li>从附加组件的翻译中更新数据库中的翻译（有关详细信息，请参见第11章，国际化）。</li></ol><blockquote><p>请注意，更新未安装的附加模块根本没有任何作用，但是，安装已安装的附加模块会重新安装该附加模块，这可能会对某些包含文件数据的数据文件产生意外影响应该由用户更新，而不是在常规模块更新过程中更新（请参阅第6章，管理模块数据中的使用noupdate和forcecreate标志配方）。这种情况一般发生在从命令行界面更新模块，Web界面更新不会发生这种错误的风险。</p></blockquote><h3 id="更多内容-2"><a href="#更多内容-2" class="headerlink" title="更多内容"></a>更多内容</h3><p>请谨慎处理依赖项。考虑一个情况您要在实例中安装<strong>sale</strong>，<strong>sale_stock</strong>和<strong>sale_specific</strong>模块，<strong>sale_specific</strong>依赖于<strong>sale_stock</strong>，<strong>sale_stock</strong>依赖于<strong>sale</strong>。要安装这三个组件，您只需要安装<strong>sale_specific</strong>，因为它将递归地安装<strong>sale_stock</strong>和<strong>sale</strong>依赖项。要更新所有三个，您需要更新<strong>sale</strong>，因为这将递归更新反向依赖关系<strong>sale_stock</strong>和<strong>sale_specific</strong>。</p><p>管理依赖项的另一个棘手的部分是，当您向已经安装了版本的加载项中添加依赖项时。让我们继续前面的示例来理解这一点，假设您在<strong>sale_specific</strong>中添加了对<strong>stock_dropshipping</strong>的依赖关系。更新<strong>sale_specific</strong>加载项不会自动安装新的依赖关系，也不会请求安装<strong>sale_specific</strong>。在这种情况下，您会收到非常讨厌的错误消息，因为未能成功加载插件的Python代码，但是数据库中存在加载项的数据和模型表。要解决此问题，您需要停止实例并手动安装新的依赖项。</p><h2 id="从GitHub安装插件模块"><a href="#从GitHub安装插件模块" class="headerlink" title="从GitHub安装插件模块"></a>从GitHub安装插件模块</h2><p>GitHub是第三方加载项的绝佳来源。许多Odoo合作伙伴使用GitHub在内部共享他们维护的插件，Odoo社区协会（OCA）在GitHub上集体维护了数百个插件。在开始编写自己的插件之前，请确保已检查是否存在可以直接使用的内容。</p><p>此教程将向您展示如何从GitHub克隆OCA的合作伙伴的项目，以及如何在您的实例中使用其中包含的附加模块。</p><h3 id="准备工作-2"><a href="#准备工作-2" class="headerlink" title="准备工作"></a>准备工作</h3><p>假设您要向客户（合作伙伴）表单添加新字段。通常情况下，Odoo客户模型没有性别字段，如果要添加性别字段，则需要创建一个新模块。幸运的是，邮件列表中的某人向您介绍了<strong>partner_contact_gender</strong>附加模块，该模块由OCA维护，作为 **partner-contact ** 联系项目的一部分。</p><p>此教程中使用的路径遵循了<em>标准化实例目录布局教程</em>中建议的布局。</p><h3 id="如何实现"><a href="#如何实现" class="headerlink" title="如何实现"></a>如何实现</h3><p>安装 <strong>partner_contact_gender</strong> 模块，你需要执行以下步骤：</p><ol><li><p>进入你的项目目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/odoo-dev/my-odoo/src</span><br></pre></td></tr></table></figure></li><li><p>克隆 <strong>partner-contact</strong> 项目的<strong>14.0</strong>分支代码到 <strong>src&#x2F;</strong> 目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> --branch 14.0 \</span><br><span class="line">https://github.com/OCA/partner-contact.git src/partner-contact</span><br></pre></td></tr></table></figure></li><li><p>更改附件路径以包括该目录并更新实例的附件列表（请参阅本章中的配置附件路径配方和更新附件模块列表教程）。 instance.cfg的内容应如下所示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">addons_path = ~/odoo-dev/my-odoo/src/odoo/odoo/addons, \</span><br><span class="line">~/odoo-dev/my-odoo/src/odoo/addons, \</span><br><span class="line">~/odoo-dev/my-odoo/src/, \</span><br><span class="line">~/odoo-dev/local-addons</span><br></pre></td></tr></table></figure></li><li><p>安装<strong>partner_contact_gender</strong>附加插件（如果您不知道如何安装该模块，请查看上一教程<em>安装和升级本地附加模块</em>）。</p></li></ol><h3 id="运行原理-3"><a href="#运行原理-3" class="headerlink" title="运行原理"></a>运行原理</h3><p>所有Odoo社区协会代码存储库的插件模块都包含在单独的子目录中，这与Odoo对附件路径中的目录所期望的一致。因此，只需将存储库克隆到某个位置，然后将该位置添加到附加组件路径中就足够了。</p><h3 id="更多内容-3"><a href="#更多内容-3" class="headerlink" title="更多内容"></a>更多内容</h3><p>一些维护者采用不同的方法，每个存储库都有一个附加模块，位于存储库的根目录中。在这种情况下，您需要创建一个新目录，将其添加到加载项路径，并从该目录中所需的维护者中克隆所有加载项。请记住，每次添加新的存储库克隆时，都要更新插件模块列表。</p><h2 id="将更改应用到模块"><a href="#将更改应用到模块" class="headerlink" title="将更改应用到模块"></a>将更改应用到模块</h2><p>GitHub上可用的大多数附件都可能会发生更改，并且不遵循Odoo为其稳定版本强制执行的规则。他们可能会收到错误修复或增强功能，包括您提交的问题或功能请求，并且这些更改可能会在数据文件和视图中引入数据库架构更改或更新。本教程将介绍如何安装更新的版本。</p><h3 id="准备工作-3"><a href="#准备工作-3" class="headerlink" title="准备工作"></a>准备工作</h3><p>假设您报告了<strong>partner_contact_gender</strong>的一个问题，并且收到有关该问题已在<strong>partner-contact</strong>项目的14.0分支的最新版本中解决的通知。在这种情况下，你想更新你的实例到最新的版本。</p><h3 id="如何操作"><a href="#如何操作" class="headerlink" title="如何操作"></a>如何操作</h3><p>要将应用于来自GitHub的模块的源代码修改，您需要执行以下步骤：</p><ol><li><p>停止你的Odoo实例。</p></li><li><p>如果这是生产数据库，请先进行数据库备份（请参阅第1章，安装Odoo开发环境中的管理Odoo服务器数据库教程）。</p></li><li><p>进入<strong>partner-contact</strong>模块目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/odoo-dev/my-odoo/src/partner-contact</span><br></pre></td></tr></table></figure></li><li><p>为项目创建一个本地标签，以便万一发生问题可以恢复到该版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout 14.0</span><br><span class="line">$ git tag 14.0-before-update-$(<span class="built_in">date</span> --iso)</span><br></pre></td></tr></table></figure></li><li><p>获取最新版本的代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git pull --ff-only</span><br></pre></td></tr></table></figure></li><li><p>更新数据库中的<strong>partner_address_street3</strong>模块（请参阅安装和升级本地加载项模块教程）。</p></li></ol><h3 id="运行原理-4"><a href="#运行原理-4" class="headerlink" title="运行原理"></a>运行原理</h3><p>通常，模块的开发人员有时会发布该加载项的最新版本。此更新通常包含错误修复和新功能。在这里，我们将获得该插件的新版本并在我们的实例中对其进行更新。</p><p>如果<code>git pull --ff-only</code>失败，则可以使用以下命令还原到以前的版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git reset --hard 14.0-before-update-$(<span class="built_in">date</span> --iso)</span><br></pre></td></tr></table></figure><p>然后，您可以尝试<code>git pull</code>（不带<code>--ff-only</code>），这将导致合并，但这意味着您的模块本地代码被修改过。</p><h3 id="也可以看看"><a href="#也可以看看" class="headerlink" title="也可以看看"></a>也可以看看</h3><p>如果更新步骤中断，请参阅第1章，安装Odoo开发环境中的从源代码更新Odoo以获得恢复说明。请记住，始终先对生产环境的数据库副本进行更新测试。</p><h2 id="应用并尝试建议的Pull-Requests"><a href="#应用并尝试建议的Pull-Requests" class="headerlink" title="应用并尝试建议的Pull Requests"></a>应用并尝试建议的Pull Requests</h2><p>在Github的世界里，一个Pull Request(PR)是由开发者提出的请求，以便项目的维护者可以加入一些新的开发。例如一个PR可以修复Bug或者添加新的特性。这些请求在被合并到主分支之前都会进行审查和测试。</p><p>本节我们会介绍怎么应用一个PR到你的Odoo项目，以测试一个改进或修复一个错误。</p><h3 id="准备工作-4"><a href="#准备工作-4" class="headerlink" title="准备工作"></a>准备工作</h3><p>就像之前的教程一样，假设你报告了一个 <strong>Partner_address_street3</strong> 的问题，并且受到一个通知，说这个问题已经在PR中解决了，但是还没被合并到14.0分支中。</p><p>开发者要求你严重PR #123中的修复。你需要用这个分支更新一个测试实例。</p><p>你不应该直接在生产数据库上尝试这种分支，所以首先要创建一个测试环境和生产数据库副本（详情可参考<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%AE%89%E8%A3%85Odoo%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">第一章</a>，安装Odoo开发环境）。</p><h3 id="如何实现-1"><a href="#如何实现-1" class="headerlink" title="如何实现"></a>如何实现</h3><p>要实现应用Github PR到模块上你需要进行以下步骤：</p><ol><li><p>停止实例。</p></li><li><p>进入模块所在目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/odoo-dev/my-odoo/src/partner-contact</span><br></pre></td></tr></table></figure></li><li><p>为项目创建一个本地tag，以便你出现问题可以恢复到当前版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout 14.0</span><br><span class="line">$ git tag 14.0-before-update-$(<span class="built_in">date</span> --iso)</span><br></pre></td></tr></table></figure></li><li><p>拉取请求分支，最简单的方法就是使用PR的编号，这个编号应该是由开发者告知你的，在本例子中我们的PR号为123：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git pull origain pull/123/head</span><br></pre></td></tr></table></figure></li><li><p>重启实例后更新 <strong>partner_contact_gender1</strong> 模块（如果你不知道怎么操作，可参考<em>安装和升级本地附件模块</em>小节）。</p></li><li><p>测试更新，尝试重现你的问题，或者尝试你想要的新功能。</p></li></ol><p>如果不能正常运行，可以到Github的PR页面进行评论，向开发者说明你做了什么和什么不能正常运行以便开发者更新PR。</p><p>如果能正常运行，也要评论PR页面，这是PR验证过程中必不可少的一部分，它将加快主分支的合并速度。</p><h3 id="运行原理-5"><a href="#运行原理-5" class="headerlink" title="运行原理"></a>运行原理</h3><p>我们使用的是GitHub的一个特性，可以使用 <strong>pull&#x2F;nnnn&#x2F;head</strong> 分支名按编号拉取PR，其中nnnn是PR的编号。Git pull命令会将远程分支合并到我们的分支中，应用我们代码库中的改动。在这之后，我们更新附加模块，测试它，并向作者汇报任何失败或成功的变化。</p><h3 id="更多内容-4"><a href="#更多内容-4" class="headerlink" title="更多内容"></a>更多内容</h3><p>如果你想同时测试不同的PR你可以重复上述教程的第4步。如果你对测试结果很满意，你可以创建一个分支来保留对应用的更改：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout -b 14.0-custom</span><br></pre></td></tr></table></figure><p>使用不同的分支可以协助你记住你使用的不是Github的版本，而是你自定义的版本。</p><blockquote><p><code>git branch</code>命令可以用于列出你的本地仓库的所有分支。从此，如果你需要应用Githun 14.0的最新版本代码，你需要使用以下命令（不带–ff-only）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git pull origin 14.0</span><br></pre></td></tr></table></figure></blockquote>]]></content>
    
    
    <summary type="html">在第1章，安装Odoo开发环境中，我们研究了如何仅使用源附带的标准核心插件来设置Odoo实例。本章着重于向Odoo添加非核心或自定义插件。在Odoo中，您可以从多个目录加载加载项，此外，建议从单独的文件夹加载第三方加载项或自己的自定义加载项，以免与Odoo核心模块发生冲突。</summary>
    
    
    
    
    <category term="Odoo开发者指南" scheme="https://www.junle.org/tags/Odoo%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>Odoo14开发者指南第一章-安装Odoo开发环境【翻译】</title>
    <link href="https://www.junle.org/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%AE%89%E8%A3%85Odoo%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/"/>
    <id>https://www.junle.org/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%AE%89%E8%A3%85Odoo%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/</id>
    <published>2021-03-18T01:32:23.000Z</published>
    <updated>2024-03-22T06:43:55.673Z</updated>
    
    <content type="html"><![CDATA[<p>有几种方法可以建立Odoo开发环境。 本章提出其中一个。您肯定会在网络上找到许多其他教程，这些教程介绍了其他方法。请记住，本章是关于与生产环境有不同要求的开发环境。</p><p>如果您不熟悉Odoo开发，则必须了解Odoo生态系统的某些方面。第一个Recipe将为您简要介绍Odoo生态系统，然后我们将继续进行Odoo的安装以进行开发。</p><span id="more"></span><p>在本章中，我们将介绍以下Recipe：</p><ul><li>了解Odoo生态系统</li><li>从源代码轻松安装Odoo</li><li>管理Odoo服务器数据库</li><li>将实例配置存储在文件中</li><li>激活Odoo开发者工具和更新附加模块列表</li></ul><h2 id="了解Odoo生态系统"><a href="#了解Odoo生态系统" class="headerlink" title="了解Odoo生态系统"></a>了解Odoo生态系统</h2><p>Odoo为开发人员提供了现成的模块化。 它强大的框架可帮助开发人员快速构建项目。 在开始成为一名成功的Odoo开发人员之前，您应该熟悉Odoo生态系统中的各种角色。</p><h2 id="Odoo版本"><a href="#Odoo版本" class="headerlink" title="Odoo版本"></a>Odoo版本</h2><p>Odoo带有两个不同的版本。第一个是开源的<strong>社区版</strong>，第二个是具有许可费的<strong>企业版</strong>。与其他软件供应商不同，Odoo企业版只是一堆额外的应用程序，它们为社区版添加了额外的功能或新的应用程序。基本上，企业版在社区版之上运行。社区版已获得<strong>Lesser General Public License v3.0 (LGPLv3)</strong> 许可证，并随附所有基本的企业资源计划（ERP）应用程序，例如销售，客户关系管理（CRM），发票，购买和网站构建器 。另外，企业版附带Odoo企业版许可证，这是专有许可证。Odoo企业版具有许多高级功能，例如完整记帐，工作室，互联网协议语音（VoIP），移动响应设计，电子签名，营销自动化，交付和银行集成，IoT等。企业版还为您提供了无限的错误修复支持。下图显示了企业版取决于社区版，这就是为什么您需要后者才能使用前者的原因：</p><p><img src="/images/Differences_between_the_Community_and_Enterprise_Editions.png" alt="社区版和企业版之间的差异"></p><p>您可以在这里看到两个版本的完整比较：<a href="https://www.odoo.com/page/editions">https://www.odoo.com/page/editions</a>.</p><blockquote><p>Odoo拥有最多的社区开发人员，这就是为什么您会在应用商店中找到大量第三方应用（模块）的原因。一些免费应用程序使用**Affero General Public License version 3 (AGPLv3)**。如果您的应用程序对此类应用程序有依赖性，则不能在该应用程序上使用专有许可证。具有Odoo专有许可证的应用程序只能在具有LGPL或其他专有许可证的模块上开发。</p></blockquote><h2 id="Git存储库"><a href="#Git存储库" class="headerlink" title="Git存储库"></a>Git存储库</h2><p>Odoo的整个代码库都托管在GitHub上。您可以在此处发布稳定版本的错误&#x2F;问题。您还可以通过提交拉取请求（PR）提出新功能。Odoo中有几个存储库。有关更多信息，请参见下表：</p><table><thead><tr><th>Repositories</th><th>仓库用途</th></tr></thead><tbody><tr><td><a href="https://github.com/odoo/odoo">https://github.com/odoo/odoo</a></td><td>Odoo社区版，对公众开放。</td></tr><tr><td><a href="https://github.com/odoo/enterprise">https://github.com/odoo/enterprise</a></td><td>Odoo企业版，仅对Odoo的合作伙伴开放。</td></tr><tr><td><a href="https://github.com/odoo-dev/odoo">https://github.com/odoo-dev/odoo</a></td><td>开发中的仓库，对公众开放。（已废弃）</td></tr></tbody></table><p>每年，Odoo都会发布一个主要（长期支持（LTS））版本和一些次要版本。 次版本主要用于Odoo的在线SaaS服务，这意味着Odoo SaaS用户可以尽早使用这些功能。在GitHub上，主要版本分支的名称为14.0、13.0和12.0，次要版本分支的名称为saas-14.1和saas-14.2。这些次要版本主要用于Odoo的SaaS平台。master分支正在开发中并且不稳定，因此建议不要将此分支用于生产中，因为它可能会破坏数据库。</p><h2 id="Runbot"><a href="#Runbot" class="headerlink" title="Runbot"></a>Runbot</h2><p>Runbot是Odoo的自动化测试环境。每当Odoo的GitHub分支中有新的提交时，Runbot都会提取这些最新更改并为最后四个提交创建构建测试环境。在这里，您可以测试所有稳定和未开发的分支。您甚至可以使用企业版及其开发分支。每个内部版本都有不同的背景颜色，用于指示测试用例的状态：</p><ul><li>绿色的背景色表示所有测试用例都可以成功运行，并且您可以测试该分支；</li><li>红色的背景色则表示该分支上的某些测试用例已失败，并且某些功能可能在该版本上被破坏。</li></ul><p>您可以查看所有测试用例的日志，准确显示安装过程中发生的情况。每个版本都有两个数据库。全部数据库已安装所有模块，而基础数据库仅已安装基本Odoo模块。每个版本都安装了基本的演示数据，因此您无需额外配置即可快速对其进行测试。</p><blockquote><p>你可以通过<a href="http://runbot.odoo.com/runbot">http://runbot.odoo.com/runbot</a>链接访问Runbot，以下凭证可用于访问任何Runbot构建的测试环境：</p><ul><li><strong>Login ID</strong>: admin <strong>Password</strong>: admin </li><li><strong>Login ID</strong>: demo <strong>Password</strong>: demo </li><li><strong>Login ID</strong>: portal <strong>Password</strong>: portal</li></ul></blockquote><blockquote><p>这是一个公共测试环境，因此有时其他用户可能正在使用&#x2F;测试您正在测试的同一分支。</p></blockquote><h2 id="Odoo-app-store"><a href="#Odoo-app-store" class="headerlink" title="Odoo app store"></a>Odoo app store</h2><p>几年前，Odoo推出了应用程序商店，这立刻引起了轰动。 目前，这里托管了22,000多种不同的应用程序。 在应用商店中，您会找到许多针对不同版本的免费和付费应用。 这包括针对不同业务领域的特定解决方案，例如教育，食品工业和医学。 它还包括可扩展或向现有Odoo应用程序添加新功能的应用程序。 该应用程序商店还为Odoo网站构建者提供了许多精美的主题。 在第三章，创建Odoo附加模块中，我们将研究如何为自定义模块设置价格和货币。</p><p>您可以通过以下URL访问Odoo应用商店：</p><p><a href="https://www.odoo.com/apps">https://www.odoo.com/apps</a></p><p>您可以通过以下URL访问Odoo主题：</p><p><a href="https://apps.odoo.com/apps/themes">https://apps.odoo.com/apps/themes</a></p><blockquote><p>Odoo已开源了13版和14版的几个主题。请注意，这些主题是以前版本中的付费主题。 这意味着，在Odoo 13和14版本中，您可以免费下载和使用这些精美的主题。</p></blockquote><h2 id="Odoo社区协会（OCA）"><a href="#Odoo社区协会（OCA）" class="headerlink" title="Odoo社区协会（OCA）"></a>Odoo社区协会（OCA）</h2><p><strong>Odoo Community Association (OCA)</strong> 是一个非营利性组织，开发&#x2F;管理基于社区的Odoo模块。所有OCA模块都是开源的，由Odoo社区成员维护。在OCA的GitHub帐户下，您可以找到用于不同Odoo应用程序的多个存储库。 除了Odoo模块之外，它还包含各种工具，迁移库，会计本地化等等。</p><p>这是OCA的官方GitHub帐户的URL：<a href="https://github.com/OCA">https://github.com/OCA</a>。</p><h2 id="官方Odoo帮助论坛"><a href="#官方Odoo帮助论坛" class="headerlink" title="官方Odoo帮助论坛"></a>官方Odoo帮助论坛</h2><p>Odoo具有非常强大的框架，仅通过使用&#x2F;激活选项或遵循特定的模式就可以完成很多事情。因此，如果您遇到一些技术问题或不确定某些复杂情况，可以将查询发布到Odoo的官方帮助论坛上。许多开发人员都在这个论坛上很活跃，其中包括Odoo的一些正式员工。</p><p>您可以在以下URL搜索问题或发布新问题：<a href="https://help.odoo.com.help.odoo.com/">https://help.odoo.com.help.odoo.com</a>。</p><h2 id="Odoo的eLearning-学习平台"><a href="#Odoo的eLearning-学习平台" class="headerlink" title="Odoo的eLearning 学习平台"></a>Odoo的eLearning 学习平台</h2><p>最近，Odoo启动了一个新的电子学习平台。 这个平台上有很多视频，解释了如何使用不同的Odoo应用程序。 在撰写本书时，该平台没有技术视频，而只是功能视频。</p><p>这是Odoo电子学习平台的URL：<a href="https://www.odoo.com/slides">https://www.odoo.com/slides</a>。</p><h2 id="从源代码轻松安装Odoo"><a href="#从源代码轻松安装Odoo" class="headerlink" title="从源代码轻松安装Odoo"></a>从源代码轻松安装Odoo</h2><p>强烈建议使用Linux Ubuntu操作系统来安装Odoo，因为除了大多数Odoo开发人员还使用Odoo进行所有测试、调试和安装外，Odoo还是使用该操作系统。使用GNU &#x2F; Linux发行版，并且比<strong>Windows</strong>或<strong>macOS</strong>更容易获得Odoo社区对<strong>GNU &#x2F; Linux</strong>中发生的OS级问题的支持。</p><p>还建议使用与生产环境相同的环境（相同的发行版和相同的版本）开发Odoo附加模块。这将避免令人讨厌的意外情况，例如在部署当天发现库具有比预期不同的版本，并且行为略有不同和不兼容的情况。如果您的工作站使用的是其他操作系统，则一种好的方法是在您的工作站上设置虚拟机（VM），然后在该VM中安装GNU &#x2F; Linux发行版。</p><blockquote><p>Ubuntu是Microsoft Store中的一个应用程序，因此，如果您不想切换到Ubuntu OS，也可以使用它。</p></blockquote><p>对于这本书，我们将使用Ubuntu Server 18.04 LTS，但您可以使用任何其他Debian GNU &#x2F; Linux OS。无论选择哪种Linux发行版，都应该对如何从命令行使用它有所了解，并且了解系统管理当然不会有任何危害。</p><h3 id="做好准备"><a href="#做好准备" class="headerlink" title="做好准备"></a>做好准备</h3><p>我们假设您已启动并运行Ubuntu 18.04，并且您具有具有root用户访问权限的帐户或已配置sudo。 在以下各节中，我们将安装Odoo的依赖项并从GitHub下载Odoo的源代码。</p><blockquote><p>有些配置需要系统登录用户名，因此只要命令行中需要登录用户名，我们都会使用<code>$(whoami)</code>。 这是一个shell命令，它将代替您在键入的命令中的登录名。</p></blockquote><p>如果您拥有GitHub帐户，某些操作肯定会更容易。如果您还没有，请访问<a href="https://github.com/">https://github.com</a>并创建一个。</p><h3 id="怎么做…"><a href="#怎么做…" class="headerlink" title="怎么做…"></a>怎么做…</h3><p>要从源代码安装Odoo，请执行以下步骤：</p><ol><li><p>运行以下命令以安装主要依赖项：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt install git python3-pip build-essential wget python3-dev python3-venv python3-wheel libxslt-dev libzip-dev libldap2-dev libsasl2-dev python3-setuptools libpng-dev libjpeg-dev gdebi -y</span><br></pre></td></tr></table></figure></li><li><p>下载和安装wkhtmltopdf:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.5/wkhtmltox_0.12.5-1.bionic_amd64.deb</span><br><span class="line">$ sudo dpkg -i wkhtmltox_0.12.5-1.bionic_amd64.deb</span><br></pre></td></tr></table></figure><p>如果在上一个命令中发现错误，请使用以下命令强制安装依赖项：</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install -f</span><br></pre></td></tr></table></figure></li><li><p>现在，安装PostgreSQL数据库：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install postgresql -y</span><br></pre></td></tr></table></figure></li><li><p>配置PostgreSQL数据库：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u postgres createuser --superuser $(<span class="built_in">whoami</span>)</span><br></pre></td></tr></table></figure></li><li><p>配置git：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git config --global user.name <span class="string">&quot;Your Name&quot;</span></span><br><span class="line">$ git config --global user.email youremail@example.com</span><br></pre></td></tr></table></figure></li><li><p>克隆Odoo代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> ~/odoo-dev</span><br><span class="line">$ <span class="built_in">cd</span> ~/odoo-dev</span><br><span class="line">$ git <span class="built_in">clone</span> -b 14.0 --single-branch --depth 1 https://github.com/odoo/odoo.git</span><br></pre></td></tr></table></figure></li><li><p>创建odoo-14虚拟环境并激活：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python3 -m venv ~/venv-odoo-14.0</span><br><span class="line">$ <span class="built_in">source</span> ~/venv-odoo-14.0/bin/activate</span><br></pre></td></tr></table></figure></li><li><p>在虚拟环境中安装Odoo的Python依赖：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/odoo-dev/odoo/</span><br><span class="line">$ pip3 install -r requirements.txt</span><br></pre></td></tr></table></figure></li><li><p>创建和开启你的Odoo实例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ createdb odoo-test</span><br><span class="line">$ python3 odoo-bin -d odoo-test –i base --addons-path=addons --dbfilter=odoo-test$</span><br></pre></td></tr></table></figure></li><li><p>在浏览器中访问<a href="http://localhost:8069/">http://localhost:8069</a>并通过使用admin帐户并使用admin作为密码对它进行身份验证。</p></li></ol><blockquote><p>如果需要RTL支持，请通过以下命令安装node和rtlcss：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install nodejs npm -y </span><br><span class="line">$ sudo npm install -g rtlcss</span><br></pre></td></tr></table></figure></blockquote><h3 id="怎么运行的…"><a href="#怎么运行的…" class="headerlink" title="怎么运行的…"></a>怎么运行的…</h3><p>在第1步中，我们安装了几个核心依赖项。 这些依赖项包括各种工具，例如<strong>git</strong>，<strong>pip3</strong>，<strong>wget</strong>，<strong>Python</strong>设置工具等。 这些核心工具将帮助我们使用简单的命令安装其他Odoo依赖项。</p><p>在第2步中，我们下载并安装了<strong>wkhtmltopdf</strong>软件包，该软件包在Odoo中用于打印PDF文档，例如销售订单，发票和其他报告。Odoo 14.0需要<strong>wkhtmltopdf</strong>的0.12.5版本，并且可能不包括该版本 在当前的Linux发行版中。对于我们来说幸运的是，<strong>wkhtmltopdf</strong>的维护者在<a href="http://wkhtmltopdf.org/downloads.html">http://wkhtmltopdf.org/downloads.html</a>上为各种发行版提供预构建的软件包，我们已经从该URL下载并安装了该软件包。</p><h4 id="PostgreSQL的配置"><a href="#PostgreSQL的配置" class="headerlink" title="PostgreSQL的配置"></a>PostgreSQL的配置</h4><p>在第3步中，我们安装了PostgreSQL数据库。</p><p>在第4步中，我们使用系统的登录名创建了一个新的数据库用户。<code>$(whoami)</code>用于获取您的登录名，<code>-s</code>选项用于提供超级用户权限。 让我们看看为什么我们需要这些配置。</p><p>Odoo使用<strong>psycopg2</strong> Python库连接PostgreSQL数据库。要使用<strong>psycopg2</strong>库访问PostgreSQL数据库，Odoo默认使用以下值：</p><ul><li>默认情况下，psycopg2尝试使用与本地连接上的当前用户相同的用户名连接到数据库，这将启用无密码身份验证（这对开发环境很有用）。</li><li>本地连接使用Unix域套接字。</li><li>数据库服务器在端口<strong>5432</strong>上侦听。</li></ul><p> 现在您的PostgreSQL数据库已准备就绪，可以与Odoo连接。</p><p>由于这是开发服务器，因此我们已向用户授予<code>--superuser</code>权限。可以给PostgreSQL用户更多的权限，因为这将是您的开发实例。对于生产实例，可以使用<code>--createdb</code>命令行而不是<code>--superuser</code>来限制权限。生产服务器中使用<code>--superuser</code>权限将被攻击者利用在已部署的代码的某些部分中的漏洞提供额外的杠杆作用。</p><p>如果要使用具有不同登录名的数据库用户，则需要提供该用户的密码。这是通过在创建用户时在命令行上传递<code>--pwprompt</code>标志来完成的，在这种情况下，该命令将提示您输入密码。</p><p>如果已经创建了用户，并且想要设置密码（或修改忘记的密码），则可以使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ psql -c <span class="string">&quot;alter role <span class="subst">$(whoami)</span> with password &#x27;newpassword&#x27;&quot;</span></span><br></pre></td></tr></table></figure><p>如果此命令失败，并显示一条错误消息，指出该数据库不存在，那是因为您没有在本Recipe的第4步中创建以登录名命名的数据库。没关系，只需添加<code>--dbname</code>选项和现有数据库名称即可，例如<code>--dbname template1</code>。</p><h4 id="Git的配置"><a href="#Git的配置" class="headerlink" title="Git的配置"></a>Git的配置</h4><p>对于开发环境，我们使用源自GitHub的Odoo。 使用<strong>git</strong>，您可以轻松地在不同的Odoo版本之间切换。 另外，您可以使用<strong>git pull</strong>命令获取最新更改。</p><p>在第5步中，我们配置了您的git用户。</p><p>在第6步中，我们从Odoo的官方GitHub存储库下载了源代码。 我们已经使用<strong>git clone</strong>命令下载Odoo的源代码。 我们只使用了一个分支，因为我们只想要14.0版本的分支。 另外，我们使用<code>--depth 1</code>来避免下载分支的完整提交历史记录。 这些选项将非常快速地下载源代码，但是如果需要，您可以省略这些选项。</p><p>Odoo开发人员还建议每晚进行构建，这些构建可以作为tarball和发行包使用。使用<strong>git clone</strong>的主要优点是，当在源树中提交新的错误修复程序时，您将能够更新您的存储库。您还可以轻松测试任何建议的修复程序并跟踪回归，从而可以使错误报告更加准确并对开发人员有所帮助。</p><blockquote><p>如果您有权访问企业版源代码，也可以在<code>~/odoo-dev</code>目录下的单独文件夹中下载该源代码。</p></blockquote><h4 id="虚拟环境"><a href="#虚拟环境" class="headerlink" title="虚拟环境"></a>虚拟环境</h4><p>Python虚拟环境（简称<strong>venv</strong>）是隔离的Python工作区。 这些对Python开发人员非常有用，因为它们允许安装具有不同版本的各种Python库的不同工作区，并且可能安装在不同的Python解释器版本上。</p><p>您可以使用<code>python3 -m venv ~/newvenv</code>命令创建任意数量的环境。这将在指定位置创建一个<strong>newvenv</strong>目录，其中包含<strong>bin&#x2F;<strong>子目录和</strong>lib&#x2F;python3.6</strong>子目录。</p><p>在第7步中，我们在<strong>~&#x2F;venv-odoo-14.0</strong>目录中创建了一个新的虚拟环境。这将是我们隔离的Odoo Python环境，所有Odoo的Python依赖项都将安装在此环境中。</p><p>要激活虚拟环境，我们需要使用<strong>source</strong>命令。使用<code>source ~/venv-odoo-14.0/bin/activate</code>命令，我们已经激活了虚拟环境。</p><h4 id="安装Python包"><a href="#安装Python包" class="headerlink" title="安装Python包"></a>安装Python包</h4><p>Odoo源代码的<strong>requirements.txt</strong>文件中列出了Python依赖项。在第8步中，我们通过<strong>pip3 install</strong>命令安装了所有这些要求。</p><p>至此，您可以运行Odoo实例。</p><h4 id="开启实例"><a href="#开启实例" class="headerlink" title="开启实例"></a>开启实例</h4><p>现在到了您一直在等待的时刻。要启动我们的第一个实例，在步骤9中，我们首先创建一个新的空数据库，使用odoo-bin脚本，然后使用以下命令启动Odoo实例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 odoo-bin -d odoo-test -i base --addons-path=addons --db-filter=odootest$</span><br></pre></td></tr></table></figure><p>您也可以在odoo-bin之前使用.&#x2F;来省略python3，因为它是可执行的Python脚本，如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./odoo-bin -d odoo-test –i base --addons-path=addons --db-filter=odoo-test$</span><br></pre></td></tr></table></figure><p>对于odoo-bin，将使用具有以下命令行参数的脚本：</p><ul><li><code>-d database_name</code>：默认情况下使用此数据库。</li><li><code>--db-filter=database_name$</code>：仅尝试连接到与提供的正则表达式匹配的数据库。一个Odoo安装可以为位于单独数据库中的多个实例提供服务，并且此参数限制了可用数据库。尾随的$很重要，因为正则表达式用于匹配模式。 这样可以避免选择以指定字符串开头的名称。</li><li><code>--addons-path=directory1,directory2,...</code>：这是逗号分隔的目录列表，Odoo将在这些目录中查找附加组件。在实例创建时将扫描此列表，以填充实例中可用的附加模块的列表。如果要使用Odoo的企业版，请使用此选项添加其目录。</li><li><code>-i base</code>: 这用于安装基本模块。通过命令行创建数据库时，这是必需的。</li></ul><p>如果您使用的数据库用户的登录名与Linux登录名不同，则需要传递以下附加参数：</p><ul><li><code>--db_host=localhost</code>: 使用与数据库服务器的TCP连接。</li><li><code>--db_user=database_username</code>: 使用指定的数据库登录名。</li><li><code>--db_password=database_password</code>: 这是用于对PostgreSQL服务器进行身份验证的密码。</li></ul><p>要获得所有可用选项的概述，请使用<code>--help</code>参数。 我们将在本章后面看到更多的<strong>odoo-bin</strong>脚本。</p><p>在空数据库上启动Odoo时，它将首先创建支持其操作所需的数据库结构。它还将扫描加载项路径以找到可用的加载项模块，并将其插入数据库的初始记录中。这包括具有默认管理员密码的admin用户，您将使用该密码进行身份验证。</p><p>在浏览器中访问<a href="http://localhost:8069/">http://localhost:8069</a>会将您带到新创建的实例的登录页面，如以下屏幕截图所示：</p><p><img src="/images/Login_screen_of_the_Odoo_instance.png" alt="Login screen of the Odoo instance"></p><p>这是由于Odoo包含了HTTP服务器。默认情况下，它在TCP端口8069上侦听所有本地网络接口。</p><h2 id="管理Odoo服务器数据库"><a href="#管理Odoo服务器数据库" class="headerlink" title="管理Odoo服务器数据库"></a>管理Odoo服务器数据库</h2><p>使用Odoo时，实例中的所有数据都存储在PostgreSQL数据库中。您可以使用所有常用的标准数据库管理工具，但是Odoo还建议使用Web界面进行一些常见操作。</p><p>我们假设您的工作环境已建立并且您正在运行一个实例。</p><h3 id="怎么做…-1"><a href="#怎么做…-1" class="headerlink" title="怎么做…"></a>怎么做…</h3><p>Odoo数据库管理界面提供了用于创建，复制，删除，备份和还原数据库的工具。 还有一种更改主密码的方法，该密码用于保护对数据库管理界面的访问。</p><h4 id="访问数据库管理界面"><a href="#访问数据库管理界面" class="headerlink" title="访问数据库管理界面"></a>访问数据库管理界面</h4><p>要访问数据库，请执行以下步骤：</p><ol><li><p>转到实例的登录屏幕（如果已通过身份验证，请注销）。</p></li><li><p>单击<strong>Manage Databases</strong>链接。 这将导航到<a href="http://localhost:8069/web/database/manager">http://localhost:8069/web/database/manager</a>（您也可以将浏览器直接指向该URL）：</p><p><img src="/images/Database_manager.png" alt="Database manager"></p></li></ol><h4 id="设置或更改主密码"><a href="#设置或更改主密码" class="headerlink" title="设置或更改主密码"></a>设置或更改主密码</h4><p>如果您已经为实例设置了默认值并且尚未修改它，正如我们将在下一节中说明的那样，数据库管理屏幕将显示一条警告，告诉您尚未设置<strong>master password</strong>，并且将 建议您设置一个直接链接：</p><p><img src="/images/Master_password_warning.png" alt="Master password warning"></p><p>要设置master password，请执行以下步骤：</p><ol><li><p>单击<strong>Set Master Password</strong>按钮。 您将看到一个对话框，要求您填写<strong>New Master Password</strong>字段：</p><p><img src="/images/Setting_a_new_master_password_dialog.png" alt="Setting a new master password dialog"></p></li><li><p>输入新密码然后单击继续。</p></li></ol><p>如果已经设置了主密码，请单击屏幕底部的<strong>Set Master Password</strong>按钮进行更改。在显示的对话框中，键入以前的主密码和新的主密码，然后单击<strong>Continue</strong>。</p><blockquote><p>主密码是服务器配置文件的<code>admin_password</code>的值。如果在未指定配置文件的情况下启动服务器，则会在<code>~/.odoorc</code>中生成一个新的密码。有关该配置文件的更多信息，请参考下一个Recipe。</p></blockquote><h4 id="新建一个新的数据库"><a href="#新建一个新的数据库" class="headerlink" title="新建一个新的数据库"></a>新建一个新的数据库</h4><p>此对话框可用于创建将由当前Odoo服务器处理的新数据库实例：</p><ol><li><p>在数据库管理窗口中，单击<strong>Create Database</strong>按钮，该按钮可在屏幕底部找到。这将弹出以下对话框：</p><p><img src="/images/Creating_a_new_database_dialog.png" alt="Creating a new database dialog"></p></li><li><p>填写表格，如下所示：</p><ul><li><p><strong>Master Password</strong>：这是此实例的Master Password。</p></li><li><p><strong>Database Name</strong>：输入要创建的数据库的名称。</p></li><li><p><strong>Email</strong>：在此处添加您的电子邮件地址； 以后将用作您的用户名。</p></li><li><p><strong>Password</strong>：输入您要为新实例的管理员用户设置的密码。</p></li><li><p><strong>Phone Number</strong>：设置电话号码（可选）。</p></li><li><p><strong>Language</strong>：选择默认情况下要安装的语言下拉列表中的新数据库。Odoo将自动加载所选语言的翻译。</p></li><li><p><strong>Country</strong>：在下拉菜单中选择主要公司的国家列表。 选择此项将自动配置一些东西，包括公司币种。</p></li><li><p><strong>Demo data</strong>：选中此框可获得演示数据。 这对于运行交互式测试或为客户设置演示很有用，但不应检查旨在包含生产数据的数据库。</p><blockquote><p>如果您希望使用数据库来运行模块的自动化测试（请参阅第7章，调试模块），则需要具有演示数据，因为Odoo中的绝大多数自动化测试都依赖于这些记录，以便运行成功。</p></blockquote></li></ul></li><li><p>单击<strong>Continue</strong>按钮，等待一段时间，直到新数据库被初始化。然后，您将被重定向到实例并以管理员身份连接。</p><blockquote><p>故障排除</p><p>如果将您重定向到登录屏幕，这可能是因为<code>--db-filter</code>选项已传递给Odoo且新的数据库名称与新的数据库名称不匹配。请注意，<code>odoo-bin start</code>命令以静默方式执行此操作，仅使当前数据库可用。要解决此问题，只需在不使用start命令的情况下重新启动Odoo，如本章从源代码轻松安装Odoo所示。如果有配置文件（请参阅本章后面的在文件配方中存储实例配置），然后检查<code>db_filter</code>选项是否未设置或设置为与新数据库名称匹配的值。</p></blockquote></li></ol><h4 id="复制数据库"><a href="#复制数据库" class="headerlink" title="复制数据库"></a>复制数据库</h4><p>通常您将拥有一个现有的数据库，并且您想尝试使用该数据库尝试一个过程或运行一个测试，而无需修改现有的数据。这里的解决方案很简单：复制数据库并在副本上运行测试。根据需要重复多次：</p><ol><li><p>在数据库管理屏幕中，单击要克隆的数据库名称旁边的<strong>Duplicate Database</strong>链接：</p><p><img src="/images/Duplicate_Database_dialog.png" alt="Duplicate Database dialog"></p></li><li><p>填写以下表格：</p><ul><li><strong>Master Password</strong>: 这是Odoo服务器的主密码。</li><li><strong>New Name</strong>: 您要赋予副本的名称。</li></ul></li><li><p>点击<strong>Continue</strong>按钮。</p></li><li><p>然后您可以在数据库管理屏幕中单击新创建的数据库的名称，以访问该数据库的登录屏幕。</p></li></ol><h4 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h4><p>完成测试后，您将需要清理重复的数据库。为此，请执行以下步骤：</p><ol><li><p>在数据库管理屏幕中，您将在数据库名称旁边找到<strong>Delete</strong>按钮。点击它会弹出如下对话框：</p><p><img src="/images/Delete_Database_dialog.png" alt="Delete Database dialog"></p></li><li><p>填写表格并填写<strong>Master Password</strong>字段，这是Odoo服务器的主密码。</p></li><li><p>单击<strong>Delete</strong>按钮。</p><blockquote><p>警告！ 潜在的数据丢失！<br>如果您选择了错误的数据库并且没有备份，则无法恢复丢失的数据。</p></blockquote></li></ol><h4 id="备份数据库"><a href="#备份数据库" class="headerlink" title="备份数据库"></a>备份数据库</h4><p>要创建备份，请执行以下步骤：</p><ol><li><p>在数据库管理屏幕中，您将在数据库名称旁边找到“备份”按钮。单击它会弹出对话框，如以下屏幕截图所示：</p><p><img src="/images/Backup_Database_dialog.png" alt="Backup Database dialog"></p></li><li><p>填写表格，如下所示：</p><ul><li><strong>Master Password</strong>：这是Odoo服务器的主密码。</li><li><strong>Backup Format</strong>：始终对生产数据库使用<strong>zip</strong>，因为这是唯一真正的完整备份格式。仅当您不太在乎文件存储时，才使用<strong>pg_dump</strong>的格式，<strong>pg_dump</strong>格式仅用在开发数据库。</li></ul></li><li><p>点击<strong>Backup</strong>按钮，备份文件随后将下载到您的浏览器中。</p></li></ol><h4 id="恢复数据库备份"><a href="#恢复数据库备份" class="headerlink" title="恢复数据库备份"></a>恢复数据库备份</h4><p>如果需要还原备份，则需要执行以下操作：</p><ol><li><p>在数据库管理屏幕中，您将在屏幕底部找到一个<strong>Restore Database</strong>按钮。单击它会弹出一个对话框，如以下屏幕截图所示：</p><p><img src="/images/Restore_Database_dialog.png" alt="Restore Database dialog"></p></li><li><p>填写表格，如下所示：</p><ul><li><strong>Master Password</strong>：这是Odoo服务器的主密码。</li><li><strong>File</strong>：这是之前下载的Odoo备份。</li><li><strong>Database Name</strong>：提供将在其中还原备份的数据库的名称。 该数据库不得存在于服务器上。</li><li><strong>This database might have been moved or copied</strong>： 如果原始数据库位于另一台服务器上，或者已从当前服务器中删除，请选择“此数据库已移动”。否则，选择“此数据库是副本”，这是安全的默认选项。</li></ul></li><li><p>点击<strong>Continue</strong>按钮</p><blockquote><p>如果尝试执行此操作，收到一条错误消息（数据库还原错误：数据库已存在）。您需要先删除该数据库。</p></blockquote></li></ol><h3 id="怎么运行的…-1"><a href="#怎么运行的…-1" class="headerlink" title="怎么运行的…"></a>怎么运行的…</h3><p>以上功能除了<strong>设置和更改主密码</strong>外，另外的功能还可以在服务器上运行PostgreSQL管理命令来实现。</p><p>主密码是非常重要的一条信息，它仅存在于Odoo服务器配置文件中，并且永远不会存储在数据库中。过去曾经是默认值<strong>admin</strong>，但是使用此值是有风险的， 在Odoo v9及更高版本中，此密码被标识为未设置的主密码，并且在访问数据库管理界面时敦促您对其进行更改。即使将其存储在<strong>admin_passwd</strong>条目下的配置文件中，这与管理员用户的密码不同；这是两个独立的密码。主密码是为Odoo服务器进程设置的，该进程本身可以处理多个数据库实例，每个实例都有一个具有自己密码的独立管理员用户。</p><blockquote><p>安全注意事项</p><p>请记住，在本章中我们正在考虑开发环境。在生产服务器上工作时，必须保护Odoo数据库管理界面，因为它可以访问很多敏感信息，尤其是在服务器托管Odoo的情况下。 几个不同客户端的实例。</p></blockquote><p>要创建新数据库，Odoo使用PostgreSQL <strong>createdb</strong>实用程序并调用内部Odoo函数来初始化新数据库，其方式与在空数据库上启动Odoo时相同。</p><p>为了复制数据库，Odoo使用<strong>createdb</strong>的<strong>--template</strong>选项，将原始数据库作为参数传递，这实质上是使用内部和优化的PostgreSQL例程在新数据库中复制模板数据库的结构，这比创建一个 备份和还原（特别是在使用Web界面时，这需要下载备份文件并再次上传）。</p><p>备份和还原操作分别使用<strong>pg_dump</strong>和<strong>pg_restore</strong>实用程序。当使用<strong>zip</strong>格式时，备份还包括文件存储的副本，当您将Odoo配置为不将这些文件保留在数据库中时，备份还将包括文件存储的副本，其中包含文件的副本，这在14.0中是默认的选项。除非您进行更改，否则这些文件位于<strong>~&#x2F;.local&#x2F;share&#x2F;Odoo&#x2F;filestore</strong>中。</p><p>如果备份变大，则下载可能会失败。这是因为Odoo服务器本身无法处理内存中的大文件，或者是因为该服务器在反向代理之后运行，因为HTTP响应的大小受到限制。相反，出于相同的原因，您可能会遇到数据库还原操作方面的问题。当您开始遇到这些问题时，是时候投资购买更强大的外部备份解决方案了。</p><h3 id="还有更多…"><a href="#还有更多…" class="headerlink" title="还有更多…"></a>还有更多…</h3><p>经验丰富的Odoo开发人员通常不使用数据库管理界面管理数据库，而是从命令行执行操作。例如，要使用演示数据初始化新数据库，可以使用以下单行命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ createdb testdb &amp;&amp; odoo-bin -d testdb</span><br></pre></td></tr></table></figure><p>此命令行的额外用法是，您可以在使用时请求安装附加组件，例如，<code>-i sale,purchase,stock</code>。</p><p>要复制数据库，请停止服务器并运行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ createdb -T dbname newdbname</span><br><span class="line">$ <span class="built_in">cd</span> ~/.local/share/Odoo/filestore <span class="comment"># 修改为你的备份文件目录</span></span><br><span class="line">$ <span class="built_in">cp</span> -r dbname newdbname</span><br></pre></td></tr></table></figure><blockquote><p>仅当数据库上没有活动会话时才使用createdb -T，这意味着您必须在从命令行复制数据库之前关闭Odoo服务器。</p></blockquote><p>要删除实例，请运行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ dropdb dbname</span><br><span class="line">$ <span class="built_in">rm</span> -rf ~/.local/share/Odoo/filestore/dbname</span><br></pre></td></tr></table></figure><p>要创建备份（假设PostgreSQL服务器在本地运行），请使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pg_dump -Fc -f dbname.dump dbname</span><br><span class="line">$ tar cjf dbname.tgz dbname.dump ~/.local/share/Odoo/filestore/dbname</span><br></pre></td></tr></table></figure><p>要还原备份，请运行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tar xf dbname.tgz</span><br><span class="line">$ pg_restore -C -d dbname dbname.dump</span><br></pre></td></tr></table></figure><blockquote><p>警告！</p><p>如果您的Odoo实例使用其他用户连接到数据库，则需要传递-U用户名，以便正确的用户是还原的数据库的所有者。</p></blockquote><h2 id="将实例配置存储在文件中"><a href="#将实例配置存储在文件中" class="headerlink" title="将实例配置存储在文件中"></a>将实例配置存储在文件中</h2><p>odoo-bin脚本有很多选项，记住所有这些以及在启动服务器时记住正确设置它们是很乏味的，幸运的是，可以将它们全部存储在配置文件中并仅通过 递给您想要更改的内容，例如用于开发。</p><h3 id="怎么做…-2"><a href="#怎么做…-2" class="headerlink" title="怎么做…"></a>怎么做…</h3><p>对于此Recipe，请执行以下步骤：</p><ol><li><p>要为您的Odoo实例生成配置文件，请运行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./odoo-bin --save --config myodoo.cfg --stop-after-init</span><br></pre></td></tr></table></figure></li><li><p>您可以添加其他选项，它们的值将保存在生成的文件中。所有未设置的选项将以其默认值设置保存。要获取可能选项的列表，请使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./odoo-bin --<span class="built_in">help</span> | less</span><br></pre></td></tr></table></figure><p>这将为您提供有关各种选项执行效果的帮助。</p></li><li><p>要将命令行形式转换为配置形式，请使用选项名称，删除前导破折号，然后将中间的破折号转换为下划线。例如<code>--without-demo</code>更改为<strong>without_demo</strong>。这适用于大多数选项 ，但有一些例外情况，将在下一节中列出。</p></li><li><p>编辑<strong>myodoo.cfg</strong>文件（使用下一节中的表获取您可能要更改的一些参数），然后使用保存的选项启动服务器，运行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./odoo-bin -c myodoo.cfg</span><br></pre></td></tr></table></figure><blockquote><p><code>--config</code>选项通常缩写为<code>-c</code>。</p></blockquote></li></ol><h3 id="怎么运行的…-2"><a href="#怎么运行的…-2" class="headerlink" title="怎么运行的…"></a>怎么运行的…</h3><p>在启动时，Odoo会分三遍加载其配置；首先从源代码初始化所有选项的一组默认值，然后解析配置，如果文件中定义了相同的值都将覆盖默认值。</p><p>如前所述，选项的名称可以通过删除前导破折号并将中间的破折号转换为下划线来使用，但有一些例外情况，尤其是以下内容：</p><table><thead><tr><th>Comand line</th><th>Configuration file</th></tr></thead><tbody><tr><td>--db-filter</td><td>dbfilter</td></tr><tr><td>--no-http</td><td>http_enable&#x3D;True&#x2F;False</td></tr><tr><td>–database</td><td>db_name</td></tr><tr><td>--dev</td><td>dev_mode</td></tr><tr><td>--i18n-import &#x2F; --i18n-export</td><td>Unavailable</td></tr></tbody></table><p>这是通过配置文件通常设置的选项列表：</p><table><thead><tr><th>Options</th><th>Format</th><th>Usage</th></tr></thead><tbody><tr><td>without_demo</td><td>Comma-separated list of module names</td><td>This prevents module data from being loaded. Give the value <code>all</code> to disable demo data fro all modules, or <code>False</code> to enable demo data for all modules. To disable demo data for specific modules, provide module names, for example, <code>sale,purchase,crm</code>.</td></tr><tr><td>addons_path</td><td>Comma-separated list of paths</td><td>This is a list of directory name in which the server will look for add-ons.</td></tr><tr><td>admin_passwd</td><td>Text</td><td>This is the master password(take a look at the preceding recipe).</td></tr><tr><td>data_dir</td><td>Path to a directory</td><td>This is a directory in which the server will store session information, add-ons downloaded from the internet, and documents if you enable the file store.</td></tr><tr><td>http_portlongpolling_port</td><td>Port number</td><td>These are the ports on which the Odoo server will listen. You will need to specify booth to run multiple Odoo servers on the same host; <code>longpolling_port</code> is only used if <code>workers</code> is not 0. <code>http_port</code> defaults to <code>8069</code>, and <code>longpolling_port</code> defaults to 8072.</td></tr><tr><td>logfile</td><td>Path to a file</td><td>The file in which Odoo will write its logs.</td></tr><tr><td>log_level</td><td>Log verbosity level</td><td>Specifies the level of logging. Accepted values(in increasing order of verbosity) include <code>critecal,error,warn,debug_rpc_answer,debug_sql</code>.</td></tr><tr><td>workers</td><td>Integer</td><td>The number of worker processes. Refer to Chapter 3, Server Deployment, for more information.</td></tr><tr><td>proxy_mode</td><td>True&#x2F;False</td><td>Activate reverse proxy WSGI wrappers. Only enable this when running behind a trusted web proxy!</td></tr></tbody></table><p>以下是与数据库相关的配置选项的列表：</p><table><thead><tr><th>Options</th><th>Format</th><th>Usage</th></tr></thead><tbody><tr><td>db_host</td><td>Hostname</td><td>This is the name of the server running the PostgreSQL server. Use <code>False</code> to use local Unix domain sockets, and <code>localhost</code> to user TCP sockets locally.</td></tr><tr><td>db_user</td><td>Database user login</td><td>This is generally empty if <code>db_host</code> is <code>False</code>. This will be the name of the user used to connect to the database.</td></tr><tr><td>db_password</td><td>Database user password</td><td>This is generally empty if <code>db_host</code> is <code>False</code> and when<code>db_user</code> has the same name as the user running the server. Read the main page of <code>pg_hba.conf</code> for more information on this.</td></tr><tr><td>db_name</td><td>Database name</td><td>This is used to set the database name on which some commands operate by default. This does not limit the databases on which the server will act. Refer to the following <code>dbfilter</code> option for this.</td></tr><tr><td>db_sslmode</td><td>Database SSL mode</td><td>This is used to specify the database SSL connection mode.</td></tr><tr><td>dbfilter</td><td>A regular expression</td><td>The Expression should match the mane of the databases that are considered by the server. If you run the website, it should match a single database, so it will look like <code>^databasename$</code>. More information on this can be found in <em>Chapter 3, Server Deployment</em>.</td></tr><tr><td>list_db</td><td>True&#x2F;False</td><td>Set to <strong>True</strong> to disable the listing of databases. See <em>Chapter 3, Server Deployment</em>, for more information.</td></tr></tbody></table><p>Odoo现在使用Python <strong>ConfigParser</strong>模块来解析配置文件。但是，Odoo 11.0中的实现已更改，并且不再可以使用变量插值，因此，如果习惯于使用<code>%(section.variable)s</code>表示法从其他变量的值中定义变量的值，则将需要改变您的习惯并恢复为明确的价值观。</p><p>某些选项未在配置文件中使用，但在开发过程中被广泛使用：</p><table><thead><tr><th>Option</th><th>Format</th><th>Usage</th></tr></thead><tbody><tr><td>-i or --init</td><td>Comma-separated list of module name</td><td>It will install given modules by default while initializing the database.</td></tr><tr><td>-u or --update</td><td>Comma-separated list of module names</td><td>It will update given modules when you restart the server. It is mostly used when you modify source code or update the branch from git.</td></tr><tr><td>--dev</td><td>all, reload, qweb, werkzeug and xml</td><td>This enables developer mode and the auto-reload feature.</td></tr></tbody></table><h2 id="激活Odoo开发者模式工具"><a href="#激活Odoo开发者模式工具" class="headerlink" title="激活Odoo开发者模式工具"></a>激活Odoo开发者模式工具</h2><p>当使用Odoo开发时，您需要知道如何在Web界面中激活开发者模式，以便可以访问技术设置菜单和开发人员信息。启用调试模式将暴露一些高级配置选项和字段，这些选项和字段是 隐藏在Odoo中以提高可用性，因为它们不是常用的。</p><h3 id="怎么做…-3"><a href="#怎么做…-3" class="headerlink" title="怎么做…"></a>怎么做…</h3><p>要在Web界面激活开发者模式，请执行以下步骤：</p><ol><li><p>使用管理员账号登录你的Odoo实例。</p></li><li><p>进入<strong>设置</strong>菜单。</p></li><li><p>滚动到页面底部的<strong>Developer Tools</strong>部分：</p><p><img src="/images/Links_to_activate_different_developer_modes.png" alt="Links to activate different developer modes"></p></li><li><p>点击<strong>Activate the developer mode</strong>链接。</p></li><li><p>等待页面刷新。</p><blockquote><p>另外的方法</p><p>你也可以通过编辑URL激活开发人员模式。 在**#**号之前，插入<code>?debug=1</code>。例如，如果您当前的URL是<code>http://localhost:8069/web#menu_id=102&amp;action=94</code>，并且您要启用开发人员模式，则需要将该URL更改为<code>http://localhost:8069/web?debug=1#menu_id=102&amp;action=94</code>。此外，如果要使用资产调试模式，则将URL更改为<code>http://localhost:8069/web?debug=assets#menu_id=102&amp;action=94</code>。</p></blockquote></li></ol><p>要退出开发人员模式，您可以执行以下任一操作：</p><ul><li>编辑URL并在查询字符串中写入<code>?debug</code>&#x3D;0。</li><li>使用在<strong>设置</strong>菜单中的同一位置停用开发者模式。</li><li>单击顶部菜单中的错误图标，然后单击“离开开发者工具”选项。</li></ul><p>许多开发人员正在使用浏览器扩展来切换调试模式。通过此功能，您可以快速切换调试模式而无需访问设置菜单。这些扩展适用于Firefox和Chrome。请看以下屏幕截图，它将帮助您在Chrome商店中识别插件：</p><p><img src="/images/Browser_extension_for_debug_mode.png" alt="Browser extension for debug mode"></p><blockquote><p>自从Odoo v13版本后，调试模式的行为已发生更改。调试模式的状态存储在会话中，这意味着即使将<code>?debug</code>从URL中删除，调试模式仍会处于激活状态。</p></blockquote><h3 id="怎么运行的…-3"><a href="#怎么运行的…-3" class="headerlink" title="怎么运行的…"></a>怎么运行的…</h3><p>在开发者模式下，会发生两件事：</p><ul><li>将鼠标悬停在表单视图中的字段上或列表视图中的列上时，会有提示，提供有关该字段的技术信息（内部名称，类型等）</li><li>带有错误图标的下拉菜单会显示在右上角（用户菜单的旁边），通过这个菜单可访问有关正在显示的模型，各种相关视图定义，工作流，自定义过滤器管理等技术信息。</li></ul><p>开发者模式有一个变体**Developer mode (with assets)**。此模式的行为类似于普通开发者模式，但是，发送到浏览器的JavaScript和CSS代码并未缩小，这意味着您的网络开发工具 浏览器很容易用于调试JavaScript代码（有关详细信息，请参阅第15章，Web客户端开发）。</p><h2 id="更新附加模块列表"><a href="#更新附加模块列表" class="headerlink" title="更新附加模块列表"></a>更新附加模块列表</h2><p>当您添加新模块时，为了在Odoo中列出该模块，您需要更新模块列表。在此Recipe中，您将学习如何更新应用程序列表。</p><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>启动您的实例并使用管理员帐户连接到该实例。执行此操作后，激活开发者模式（如果您不知道如何激活开发者模式，请参上一小节）。</p><h3 id="怎么做…-4"><a href="#怎么做…-4" class="headerlink" title="怎么做…"></a>怎么做…</h3><p>要更新您实例中可用插件模块的列表，您需要执行以下步骤：</p><ol><li><p>打开应用菜单。</p></li><li><p>点击<strong>刷新本地模块列表</strong>。</p><p><img src="/images/Menu_item_to_update_the_apps_list.png" alt="Menu item to update the apps list"></p></li><li><p>在弹出的对话框中点解<strong>更新</strong>按键。</p><p><img src="/images/Dialog_to_update_the_apps_list.png" alt="Dialog to update the apps list"></p></li><li><p>更新结束时，您可以单击<strong>应用程序</strong>条目以查看可用附加模块的更新列表。您需要在搜索框中删除<strong>应用程序</strong>上的默认过滤器，以查看所有模块。</p></li></ol><h3 id="怎么运行的…-4"><a href="#怎么运行的…-4" class="headerlink" title="怎么运行的…"></a>怎么运行的…</h3><p>单击<strong>更新</strong>按钮时，Odoo将读取加载项路径配置变量，对于列表中的每个目录，它将查找包含加载项清单文件的直接子目录，该文件是名为<code>__manifest__.py</code>的文件，存储在附加模块目录。 Odoo会读取清单，希望找到Python字典。除非清单中包含<strong>installable</strong>设置为<strong>False</strong>的实例，否则附加模块元数据将记录在数据库中；如果模块已经存在，则信息将被更新；否则，将创建新记录。如果找不到以前可用的附加模块，则不会从列表中删除该记录。</p><blockquote><p>仅当在初始化数据库后添加了新的加载项路径时才需要更新的应用程序列表。如果在初始化数据库之前将新的加载项路径添加到配置文件中，则无需手动更新模块列表。</p></blockquote><p>总结到目前为止，我们已经学到的知识，安装后，您可以使用以下命令行启动Odoo服务器（如果使用的是虚拟环境，则需要先激活虚拟环境）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 odoo-bin -d odoo-test -i base --addons-path=addons --db-filter=odootest</span><br></pre></td></tr></table></figure><p>Once you run the module, you can access Odoo from <a href="http://localhost:8069/">http://localhost:8069</a>. You can also use a configuration file to run Odoo as follows:</p><p>运行模块后，您可以从<a href="http://localhost:8069/">http://localhost:8069</a>访问Odoo。还可以使用配置文件来运行Odoo，如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./odoo-bin -c myodoo.cfg</span><br></pre></td></tr></table></figure><p>启动Odoo服务器后，您可以从<strong>应用</strong>菜单<strong>安装&#x2F;更新</strong>模块。</p>]]></content>
    
    
    <summary type="html">有几种方法可以建立Odoo开发环境。 本章提出其中一个。您肯定会在网络上找到许多其他教程，这些教程介绍了其他方法。请记住，本章是关于与生产环境有不同要求的开发环境。</summary>
    
    
    
    
    <category term="Odoo开发者指南" scheme="https://www.junle.org/tags/Odoo%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>Odoo14开发者指南（Development Cookbook）第四版【翻译】</title>
    <link href="https://www.junle.org/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%EF%BC%88Development-Cookbook%EF%BC%89%E7%AC%AC%E5%9B%9B%E7%89%88%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/"/>
    <id>https://www.junle.org/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%EF%BC%88Development-Cookbook%EF%BC%89%E7%AC%AC%E5%9B%9B%E7%89%88%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/</id>
    <published>2021-03-17T09:44:29.000Z</published>
    <updated>2024-03-22T06:43:55.679Z</updated>
    
    <content type="html"><![CDATA[<p>由于个人需要最近在学习Odoo14，我参考的书籍是《Odoo 14 Development Cookbook Fourth Edition》，随便翻译一下作为学习笔记。</p><span id="more"></span><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Odoo 14开发者指南第四版提供了各种完整的开发方案，以帮助您使用Odoo框架构建复杂的业务应用程序。 无论您是要自定义现有模块，创建新模块还是自定义网站或后端Web客户端（JS），这本书都涵盖了Odoo开发的各个方面。</p><p>凭借其最新版本，强大的Odoo框架发布了用于快速应用程序开发的多种功能。此更新的Odoo开发指南将帮助您探索Odoo 14中的新功能，并学习如何使用它们从头开始开发Odoo应用程序。您将学习Odoo 14中的新网站概念，并了解Odoo的新Web客户端框架OWL（Odoo Web Library）。</p><p>完成安装后，您将开始通过实际示例探索Odoo框架。 然后，您将从头创建一个新的Odoo模块，并逐步发展到高级框架概念。您还将学习如何修改现有应用程序，包括销售点（PoS）。这本书不仅限于后端开发；您会发现用于创建新视图和小部件的高级JavaScript Recipes。随着您的学习进程，您将学习网站开发，并通过研究性能优化，调试和自动化测试来成为一名优质的Odoo开发人员。最后，您将深入研究高级概念，例如多网站，应用程序内购买（IAP），Odoo.sh，IoT Box和部署。</p><p>您将使用动态构组件构建漂亮的Odoo CMS网站；掌握高级概念，例如缓存，预取和调试；使用新的OWL框架修改后端JavaScript组件和POS；通过远程过程调用（RPC）连接并访问Odoo中的任何对象；使用Odoo.sh来管理、部署和测试Odoo实例；配置IoT Box以添加和升级POS硬件，并了解如何实施IAP服务。</p><p>到本书结尾，您将拥有构建令人印象深刻的Odoo应用程序所需的全部知识，并且您将精通开发最佳实践，这些最佳实践将在使用Odoo框架时变得非常有用。</p><h2 id="本书适用于"><a href="#本书适用于" class="headerlink" title="本书适用于"></a>本书适用于</h2><p>本书适合希望使用Odoo框架开发高效业务应用程序的新手和有经验的Odoo开发人员。要充分利用本书，必须具备Python和JavaScript的基本知识。</p><h2 id="本书涵盖的内容"><a href="#本书涵盖的内容" class="headerlink" title="本书涵盖的内容"></a>本书涵盖的内容</h2><ol><li>第一章：<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%AE%89%E8%A3%85Odoo%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">安装Odoo开发环境</a>，说明如何为Odoo创建开发环境，启动Odoo，创建配置文件以及激活Odoo的开发者工具。</li><li>第二章：<a href="/Odoo14%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E7%AE%A1%E7%90%86Odoo%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%9E%E4%BE%8B%E3%80%90%E7%BF%BB%E8%AF%91%E3%80%91/">管理Odoo服务器实例</a>，提供了一些有用的技巧，可用于处理从GitHub安装的附加组件以及组织实例的源代码。</li><li>第三章：创建Odoo附加模块，介绍了Odoo附加模块的结构，并提供了从头开始创建简单模块的分步指南。</li><li>第四章：应用程序模型，着重于Odoo模型结构，并解释所有类型的字段及其属性。它还涵盖了通过扩展模块扩展现有数据库结构的技术。</li><li>第五章：基本的服务器端开发，介绍了在Odoo中执行CRUD操作的各种框架方法。本章还包括继承和扩展现有方法的不同方法。</li><li>第六章：管理模块数据，显示如何将数据与模块代码一起运送。它还说明了在新发行版中修改了附件提供的数据模型时如何编写迁移脚本。</li><li>第七章：调试模块，提出了一些用于服务器端调试的策略，并介绍了Python调试器。它还介绍了在开发人员模式下运行Odoo的技术。</li><li>第八章：先进的服务器端开发技术，涵盖了ORM框架的更多高级主题。这对于开发向导，SQL视图，安装挂钩，更改方法等很有用。 本章还说明了如何在数据库中执行原始SQL查询。</li><li>第九章：后端视图，介绍了如何为数据模型编写业务视图以及如何从这些视图调用服务器端方法。它涵盖了常规视图（列表视图，表单视图和搜索视图），以及一些复杂的视图（看板，图形，日历，枢轴等）。</li><li>第十章：安全访问，介绍如何通过创建安全组，编写访问控制列表来定义给定模型上的每个组可以使用哪些操作，以及在必要时编写记录级规则来控制谁有权访问您的Odoo实例中的内容。 </li><li>第十一章：国际化，介绍了语言翻译在Odoo中的工作方式。它显示了如何安装多种语言以及如何导入&#x2F;导出翻译的术语。</li><li>第十二章：自动化，工作流，电子邮件和打印，介绍了Odoo中可用于实现记录业务流程的不同工具。它还显示了如何使用服务器操作和自动规则来支持业务规则。这也涵盖了生成动态PDF文档的QWeb报告。</li><li>第十三章：Web服务器开发，涵盖了Odoo Web服务器的核心。它显示了如何创建自定义URL路由以在给定URL上提供数据，还显示了如何控制对这些URL的访问。</li><li>第十四章：CMS网站开发，展示了如何使用Odoo管理网站。它还显示了如何创建和修改漂亮的网页和QWeb模板。本章还包括如何使用选项创建动态构件块。它包括一些用于管理SEO，用户表单，UTM跟踪，站点地图以及获取访问者位置信息的专用配方。本章还重点介绍了Odoo中多网站的最新概念。</li><li>第十五章：Web客户端开发，深入到Odoo的JavaScript部分。它介绍了如何创建新的字段窗口小部件以及如何对服务器进行RPC调用。这也包括如何从头开始创建全新的视图。您还将学习如何创建入职游览。</li><li>第十六章：Odoo Web库（OWL），介绍了称为OWL的新客户端框架。它涵盖了OWL组件的生命周期。它还涵盖了从零开始创建字段小部件的配方。</li><li>第十七章：Odoo的应用内购买，涵盖了与Odoo中IAP最新概念相关的所有内容。在本章中，您将学习如何为IAP创建客户端和服务模块。您还将学习如何创建IAP帐户以及如何从最终用户那里获得IAP信用。</li><li>第十八章：自动化测试用例，包括如何编写和执行自动化测试用例。这包括服务器端和客户端测试用例。本章还介绍了巡回测试用例，以及如何设置无头Chrome浏览器以获取失败的测试用例的视频。</li><li>第十九章：使用Odoo.sh进行管理，部署和测试，说明了如何使用PaaS平台Odoo.sh来管理，部署和测试Odoo实例。 它介绍了如何管理不同类型的实例，例如生产，登台和开发。本章还介绍了Odoo.sh的各种配置选项。</li><li>第二十章：Odoo中的远程过程调用涵盖了从外部应用程序连接Odoo实例的不同方法。本章教您如何通过XML-RPC，JSON-RPC和odoorpc库连接和访问Odoo实例中的数据。</li><li>第二十一章：性能优化，介绍了用于提高Odoo性能的不同概念和模式。本章包括预取，ORM高速缓存以及对代码进行性能分析以检测性能问题的概念。</li><li>第二十二章：销售点，涵盖PoS应用程序中的自定义。 这包括自定义用户界面，添加新的操作按钮，修改业务流程以及扩展客户配方。</li><li>第二十三章：在Odoo中管理电子邮件，介绍了如何在Odoo中管理电子邮件和聊天。 首先从配置邮件服务器开始，然后移至Odoo框架的邮件API。本章还介绍了Jinja2和QWeb邮件模板，表单视图上的聊天记录，字段日志和活动。</li><li>第二十四章：管理IoT Box，可让您重点了解IoT Box的最新硬件。本章介绍如何配置，访问和调试IoT Box。它还包括将IoT Box与您的自定义加载项集成的方法。</li></ol><p>本书包括Odoo的安装步骤，因此您唯一需要的就是Ubuntu 18.04或任何其他基于Linux的操作系统。 在其他操作系统上，您可以通过虚拟机使用它。 如果您使用的是Windows还可以将Ubuntu安装为子系统：</p><table><thead><tr><th>Odoo版本</th><th>OS需求</th></tr></thead><tbody><tr><td>Odoo v14</td><td>推荐使用Ubuntu（或者其他Linux发行版）</td></tr></tbody></table><p>由于Odoo后端在Python上运行，因此该书适用于具有Python编程语言基础知识的开发人员。在Odoo中，数据文件是使用XML创建的，因此需要XML的基本知识。</p><p>本书还介绍了后端JavaScript框架，PoS应用程序和网站构建器，它们需要JavaScript，jQuery和Bootstrap 4的基本知识。Odoo社区版是开源的，可免费获得，但其中包括一些功能，包括IoT， 队列和仪表板仅在企业版中可用，因此要遵循该食谱，您将需要企业版。</p><p>要遵循第24章，管理IoT Box，您将需要Raspberry Pi 3 B +模型，该模型可从<a href="https://www.raspberrypi.org/products/raspberrypi-3-model-b-plus/">https://www.raspberrypi.org/products/raspberrypi-3-model-b-plus/</a>获得。</p><p>如果您使用的是本书的数字版本，建议您自己键入代码或通过GitHub存储库（下一节中提供的链接）访问代码。 这样做将帮助您避免与代码复制和粘贴相关的任何潜在错误。</p><h2 id="下载示例代码文件"><a href="#下载示例代码文件" class="headerlink" title="下载示例代码文件"></a>下载示例代码文件</h2><p>您可以从GitHub上的<a href="https://github.com/PacktPublishing/Odoo-14-Development-Cookbook-Fourth-Edition">https://github.com/PacktPublishing/Odoo-14-Development-Cookbook-Fourth-Edition</a>下载此书的示例代码文件。 如果代码有更新，它将在现有的GitHub存储库中进行更新。</p><p>我们还提供了丰富的书籍和视频目录中的其他代码包，可从<a href="https://github.com/PacktPublishing/">https://github.com/PacktPublishing/</a>获得。 去看一下！</p><h2 id="下载彩色图像"><a href="#下载彩色图像" class="headerlink" title="下载彩色图像"></a>下载彩色图像</h2><p>我们还提供了一个PDF文件，其中包含本书中使用的屏幕截图&#x2F;图表的彩色图像。 您可以在这里下载：<a href="https://static.packt-cdn.com/downloads/9781800200319_ColorImages.pdf">https://static.packt-cdn.com/downloads/9781800200319_ColorImages.pdf</a></p>]]></content>
    
    
    <summary type="html">Odoo 14开发者指南第四版提供了各种完整的开发方案，以帮助您使用Odoo框架构建复杂的业务应用程序。 无论您是要自定义现有模块，创建新模块还是自定义网站或后端Web客户端（JS），这本书都涵盖了Odoo开发的各个方面。</summary>
    
    
    
    
    <category term="Odoo开发者指南" scheme="https://www.junle.org/tags/Odoo%E5%BC%80%E5%8F%91%E8%80%85%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>如何在Ubuntu 20.10上安装Odoo14</title>
    <link href="https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8Ubuntu-20-10%E4%B8%8A%E5%AE%89%E8%A3%85Odoo14/"/>
    <id>https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8Ubuntu-20-10%E4%B8%8A%E5%AE%89%E8%A3%85Odoo14/</id>
    <published>2021-03-10T02:06:19.000Z</published>
    <updated>2024-03-22T06:43:55.700Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><ul><li>git</li><li>Python3.6 or later</li><li>PostgreSQL10.0 or later</li></ul><span id="more"></span><h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python3-dev libxml2-dev libxslt1-dev libldap2-dev libsasl2-dev libtiff5-dev libjpeg8-dev libopenjp2-7-dev zlib1g-dev libfreetype6-dev liblcms2-dev libwebp-dev libharfbuzz-dev libfribidi-dev libxcb1-dev libpq-dev</span><br></pre></td></tr></table></figure><p>   安装wkhtmltox</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.5/wkhtmltox_0.12.5-1.focal_amd64.deb</span><br><span class="line">sudo dpkg -i wkhtmltox_0.12.5-1.focal_amd64.deb</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>   如果以上命令出现了报错，通过如下命令可强制安装依赖：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -f</span><br></pre></td></tr></table></figure><p>   安装PostgreSQL：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install postgresql postgresql-client -y</span><br></pre></td></tr></table></figure><p>   对于具有从右到左界面的语言（例如阿拉伯语或希伯来语），需要软件包rtlcss：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install nodejs npm -y</span><br><span class="line">sudo npm install -g rtlcss</span><br></pre></td></tr></table></figure><h3 id="下载Odoo源代码"><a href="#下载Odoo源代码" class="headerlink" title="下载Odoo源代码"></a>下载Odoo源代码</h3><p>   创建目录<code>~/odoo-dev/</code>用于存放Odoo源代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/odoo-dev</span><br><span class="line"><span class="built_in">cd</span> ~/odoo-dev</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/odoo/odoo -b 14.0 --depth=1</span><br></pre></td></tr></table></figure><h3 id="安装Odoo-Python依赖"><a href="#安装Odoo-Python依赖" class="headerlink" title="安装Odoo Python依赖"></a>安装Odoo Python依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install -r ~/odoo-dev/odoo/requirements.txt</span><br></pre></td></tr></table></figure><h3 id="创建Odoo应用数据库"><a href="#创建Odoo应用数据库" class="headerlink" title="创建Odoo应用数据库"></a>创建Odoo应用数据库</h3><p>   切换linux用户到postgres：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo su - postgres</span><br></pre></td></tr></table></figure><p>   使用<code>psql</code>命令进入PostgreSQL数据库：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql</span><br></pre></td></tr></table></figure><p>   使用以下命令创建Odoo数据库用户和数据库：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE odoodev;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> odoouser <span class="keyword">WITH</span> PASSWORD <span class="string">&#x27;password&#x27;</span>;</span><br><span class="line"><span class="keyword">ALTER</span> ROLE odoouser <span class="keyword">SET</span> client_encoding <span class="keyword">TO</span> <span class="string">&#x27;utf8&#x27;</span>;</span><br><span class="line"><span class="keyword">ALTER</span> ROLE odoouser <span class="keyword">SET</span> default_transaction_isolation <span class="keyword">to</span> <span class="string">&#x27;read committed&#x27;</span>;</span><br><span class="line"><span class="keyword">ALTER</span> ROLE odoouser <span class="keyword">SET</span> timezone <span class="keyword">to</span> <span class="string">&#x27;GTM+8&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> DATABASE odoodev <span class="keyword">to</span> odoouser;</span><br></pre></td></tr></table></figure><p>   完成后输入以下指令推出数据库后台：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\q</span><br></pre></td></tr></table></figure><h3 id="启动实例"><a href="#启动实例" class="headerlink" title="启动实例"></a>启动实例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 odoo-bin -d odoodev -i base --addons-path=addons --db-filter=odoodev$ –-db_host=localhost --db_user=odoouser --db_password=<span class="string">&#x27;password&#x27;</span></span><br></pre></td></tr></table></figure><p>   命令参数解释：</p><ul><li><p>-d database_name：默认使用这一数据库。</p></li><li><p>–db-filter&#x3D;database_name$：仅尝试连接匹配所提供正则表达式的数据库。一个Odoo安装可以为使用不同数据库的多个实例提供服务，通过这一参数限制可用的数据库。最后的那个$很重要，因为在匹配模式中使用了正则表达式，这会避免选择以相同的指定字符串开头的名称。</p></li><li><p>–addons-path&#x3D;directory1,directory2,…：Odoo通过这一逗号分隔列表中的目录来查找插件（add-on）。在实例创建的时候扫描该列表来添加实例中可用的插件模块列表。如果希望使用Odoo企业版，请在这一选项中添加其目录。</p></li><li><p>-i base: 用于安装base模块。通过命令行创建数据库时需要使用到。</p></li><li><p>–db_host&#x3D;localhost: 使用TCP连接数据库服务</p></li><li><p>–db_user&#x3D;odoouser: 使用指定的数据库登录用户</p></li><li><p>–db_password&#x3D;password: 这是用于认证PostgreSQL服务的密码</p></li></ul><p>   更多参数可使用<code>--help</code>查看。</p>]]></content>
    
    
    <summary type="html">如何在Ubuntu 20.10上安装Odoo14</summary>
    
    
    
    
    <category term="Linux" scheme="https://www.junle.org/tags/Linux/"/>
    
    <category term="Odoo" scheme="https://www.junle.org/tags/Odoo/"/>
    
  </entry>
  
  <entry>
    <title>ERP5统一业务模型</title>
    <link href="https://www.junle.org/ERP5%E7%BB%9F%E4%B8%80%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9E%8B/"/>
    <id>https://www.junle.org/ERP5%E7%BB%9F%E4%B8%80%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9E%8B/</id>
    <published>2020-10-28T01:30:11.000Z</published>
    <updated>2024-03-22T06:43:55.668Z</updated>
    
    <content type="html"><![CDATA[<h2 id="统一业务模型设计"><a href="#统一业务模型设计" class="headerlink" title="统一业务模型设计"></a>统一业务模型设计</h2><hr><p>ERP5统一业务模型用于ERP5中的会计，仓库管理，生产和人力资源管理。由于独立于特定业务流程的统一词汇表，为一个模块开发的所有功能都可以在其他模块中使用。ERP5的统一业务模型极大地缩短了学习曲线，并降低了多个模块上数据不一致的风险。</p><p><img src="/images/UnifiedBusinessModelDesign.png" alt="UnifiedBusinessModelDesign"></p><span id="more"></span><p>该模型基于五个抽象核心类：</p><ul><li>Resource：业务流程中的一种抽象资源，例如原材料，产品，货币或个人技能。</li><li>Node：可以接收和发送资源。它可以涉及诸如车间之类的实体，也可以涉及诸如银行账户之类的抽象实体。</li><li>Movement：描述了时间段内Resource在两个Node之间的移动。例如，一个Movement可能会将原材料从仓库发送到车间，或者将钱从一个帐户发送到另一个帐户。</li><li>Item：Resource的具体实物。一个Movement可以关联一系列可追溯的物件。比如Resource是人民币，Item则是流水号为xxx的纸币。</li><li>Path：定义了Node访问它可能需要的资源的方式。</li></ul><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><hr><h3 id="例子1"><a href="#例子1" class="headerlink" title="例子1"></a>例子1</h3><p>假设一家公司A要向另一家公司B出售照相机。一旦双方同意，公司A将向公司B发送10台摄像机，单价为$100。在这种情况下，公司A和B被视为Node。产品（相机）是一种Resource。销售本身（以$1000订购10台摄像机）就是Movement。如果这些条件在这些公司之间达成一致，例如单价，则该条件为Path。如果公司A要跟踪摄像机，则可以为每个摄像机附加条形码，这将生成10个Item。</p><h3 id="例子2"><a href="#例子2" class="headerlink" title="例子2"></a>例子2</h3><p>假设一家公司A希望保留有关另一家公司B的电汇信息。公司B向公司A发送了$1000作为应收款。在这种情况下，应收帐款和银行帐户实际上是Node。从逻辑上讲，公司A和B也是Node。Movement是付款，金钱是Resource。</p><p><em>本例子未使用到Item和Path。</em> </p><h3 id="例子3"><a href="#例子3" class="headerlink" title="例子3"></a>例子3</h3><p>假设公司A要用一家工厂的机械零件制造10台摄像机。在这种情况下，工厂是一个Node。摄像机和机械零件均可视为Resource。生产包括两个Movements，一个用于消耗零件，另一个用于生产相机。为了追溯，公司A可以在相机和零件上贴上标签，这些将成为Item。由原材料的消耗到成品的生产，这个过程称为Path。</p><h2 id="个人看法"><a href="#个人看法" class="headerlink" title="个人看法"></a>个人看法</h2><p>ERP5的UBM模型高度抽象了ERP系统中几乎所有单据的数据模型，这个模型值得借鉴。</p><p>ERP5是基于Zope开发类似于Plone，但是<a href="https://www.nexedi.com/">nexedi</a>把整个系统做得又长又臭（怀念5.4.6版本），其中还有不少的坑<del>（可能是要收顾问费）</del>，整体感觉系统性能和体验都做得很拉跨。同样是开源的ERP <a href="https://www.odoo.com/zh_CN">ODOO</a>能做得简单易用，作为一个开发者我更倾向于后者。</p><p>虽然ERP5系统做得很拉但是在系统设计方面还有很多很值得借鉴的地方，比如说ERP5的Simulation、Builder、Workflow等，我们会在以后的文章中再探讨。</p>]]></content>
    
    
    <summary type="html">ERP5统一业务模型用于ERP5中的会计，仓库管理，生产和人力资源管理。由于独立于特定业务流程的统一词汇表，为一个模块开发的所有功能都可以在其他模块中使用。ERP5的统一业务模型极大地缩短了学习曲线，并降低了多个模块上数据不一致的风险。</summary>
    
    
    
    
    <category term="ERP5" scheme="https://www.junle.org/tags/ERP5/"/>
    
  </entry>
  
  <entry>
    <title>如何在CentOS8上安装Mysql5.7</title>
    <link href="https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS8%E4%B8%8A%E5%AE%89%E8%A3%85Mysql5-7/"/>
    <id>https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS8%E4%B8%8A%E5%AE%89%E8%A3%85Mysql5-7/</id>
    <published>2020-08-21T06:51:38.000Z</published>
    <updated>2024-03-22T06:43:55.698Z</updated>
    
    <content type="html"><![CDATA[<p>在CentOS8上，默认情况下直接使用yum安装mysql，安装的是Mysql 8.0，在一些比较老的项目中，我们需要使用的mysql版本是5.7，下面我分享一个在CentOS8中安装Myslq5.7的方法。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">···</span><br><span class="line">Dependencies resolved.</span><br><span class="line">================================================================================</span><br><span class="line"> Package       Arch    Version                                 Repository  Size</span><br><span class="line">================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> mysql         x86_64  8.0.17-3.module_el8.0.0+181+899d6349    AppStream   11 M</span><br><span class="line">Installing dependencies:</span><br><span class="line"> mysql-common  x86_64  8.0.17-3.module_el8.0.0+181+899d6349    AppStream  143 k</span><br><span class="line">Enabling module streams:</span><br><span class="line"> mysql                 8.0</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">================================================================================</span><br><span class="line">Install  2 Packages</span><br><span class="line">···</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="下载Mysql5-7的RPM包"><a href="#下载Mysql5-7的RPM包" class="headerlink" title="下载Mysql5.7的RPM包"></a>下载Mysql5.7的RPM包</h2><p>进入<a href="https://downloads.mysql.com/archives/community/">https://downloads.mysql.com/archives/community/</a>，选择对应的mysql版本和操作系统版本，下载以下包：</p><ul><li>RPM Package, MySQL Server</li><li>RPM Package, Client Utilities</li><li>RPM Package, Shared Libraries</li><li>RPM Package, MySQL Configuration<br>安装Mysql Server需要这些包。</li></ul><h2 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h2><p>安装时需要按以下顺序安装，因为这些包存在依赖关系：<br><strong>MySQL Configuration -&gt; Shared Libraries -&gt; Client Utilities -&gt; MySQL Server</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall mysql-community-common-5.7.30-1.el7.x86_64.rpm</span><br><span class="line">yum localinstall mysql-community-libs-5.7.30-1.el7.x86_64.rpm</span><br><span class="line">yum localinstall mysql-community-client-5.7.30-1.el7.x86_64.rpm</span><br><span class="line">yum localinstall mysql-community-server-5.7.30-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure><h2 id="配置Mysql"><a href="#配置Mysql" class="headerlink" title="配置Mysql"></a>配置Mysql</h2><ul><li><p>系统启动时自启动：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> mysqld</span><br></pre></td></tr></table></figure></li><li><p>启动mysql服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure></li><li><p>查看mysqld服务运行状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status mysqld</span><br></pre></td></tr></table></figure></li></ul><p>输出内容：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">● mysqld.service - MySQL Server</span><br><span class="line"><span class="function">   Loaded: <span class="title">loaded</span> (/<span class="title">usr</span>/<span class="title">lib</span>/<span class="title">systemd</span>/<span class="title">system</span>/<span class="title">mysqld.service</span>; <span class="title">enabled</span>; <span class="title">vendor</span> <span class="title">preset</span>: <span class="title">disabled</span>)</span></span><br><span class="line"><span class="function">   <span class="title">Active</span>: <span class="title">active</span> (<span class="title">running</span>) <span class="title">since</span> <span class="title">Fri</span> 2020-08-21 02:07:18 <span class="title">EDT</span>; 41<span class="title">min</span> <span class="title">ago</span></span></span><br><span class="line"><span class="function">     <span class="title">Docs</span>: <span class="title">man:mysqld</span>(8)</span></span><br><span class="line"><span class="function">           <span class="title">http</span>://<span class="title">dev.mysql.com</span>/<span class="title">doc</span>/<span class="title">refman</span>/<span class="title">en</span>/<span class="title">using</span>-<span class="title">systemd.html</span></span></span><br><span class="line"><span class="function">  <span class="title">Process</span>: 55384 <span class="title">ExecStart</span>=/<span class="title">usr</span>/<span class="title">sbin</span>/<span class="title">mysqld</span> --<span class="title">daemonize</span> --<span class="title">pid</span>-<span class="title">file</span>=/<span class="title">var</span>/<span class="title">run</span>/<span class="title">mysqld</span>/<span class="title">mysqld.pid</span> $<span class="title">MYSQLD_OPTS</span> (<span class="title">code</span>=<span class="title">exited</span>, <span class="title">status</span>=0/<span class="title">SUCCESS</span>)</span></span><br><span class="line"><span class="function">  <span class="title">Process</span>: 55366 <span class="title">ExecStartPre</span>=/<span class="title">usr</span>/<span class="title">bin</span>/<span class="title">mysqld_pre_systemd</span> (<span class="title">code</span>=<span class="title">exited</span>, <span class="title">status</span>=0/<span class="title">SUCCESS</span>)</span></span><br><span class="line"><span class="function"> <span class="title">Main</span> <span class="title">PID</span>: 55386 (<span class="title">mysqld</span>)</span></span><br><span class="line"><span class="function">    <span class="title">Tasks</span>: 28 (<span class="title">limit</span>: 24984)</span></span><br><span class="line"><span class="function">   <span class="title">Memory</span>: 178.1<span class="title">M</span></span></span><br><span class="line"><span class="function">   <span class="title">CGroup</span>: /<span class="title">system.slice</span>/<span class="title">mysqld.service</span></span></span><br><span class="line"><span class="function">           └─55386 /<span class="title">usr</span>/<span class="title">sbin</span>/<span class="title">mysqld</span> --<span class="title">daemonize</span> --<span class="title">pid</span>-<span class="title">file</span>=/<span class="title">var</span>/<span class="title">run</span>/<span class="title">mysqld</span>/<span class="title">mysqld.pid</span></span></span><br></pre></td></tr></table></figure><p>如果忘记root密码需要重置root密码可参考<a href="/%E5%A6%82%E4%BD%95%E9%87%8D%E7%BD%AEMysql5-7-root%E5%AF%86%E7%A0%81/">《如何重置Mysql5.7 root密码》</a>。</p>]]></content>
    
    
    <summary type="html">如何在CentOS8上安装Mysql5.7</summary>
    
    
    
    
    <category term="Linux" scheme="https://www.junle.org/tags/Linux/"/>
    
    <category term="MySQL" scheme="https://www.junle.org/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>如何重置Mysql5.7 root密码</title>
    <link href="https://www.junle.org/%E5%A6%82%E4%BD%95%E9%87%8D%E7%BD%AEMysql5-7-root%E5%AF%86%E7%A0%81/"/>
    <id>https://www.junle.org/%E5%A6%82%E4%BD%95%E9%87%8D%E7%BD%AEMysql5-7-root%E5%AF%86%E7%A0%81/</id>
    <published>2020-08-21T06:09:08.000Z</published>
    <updated>2024-03-22T06:43:55.703Z</updated>
    
    <content type="html"><![CDATA[<p>分享一个mysql技巧，当你忘记mysql5.7的root密码时，需要重置root密码可以参考以下方法。</p><span id="more"></span><h2 id="修改mysql配置文件"><a href="#修改mysql配置文件" class="headerlink" title="修改mysql配置文件"></a>修改mysql配置文件</h2><p>以我的服务器为例，我的服务器linux版本为CentOS8，mysql的配置文件默认路径为<code>/etc/my.cnf</code>，修改文件；</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">## 在[mysqld]中加入下面一行</span><br><span class="line">skip-grant-tables</span><br></pre></td></tr></table></figure><p>完成后重启mysql的服务；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure><h2 id="登录mysql"><a href="#登录mysql" class="headerlink" title="登录mysql"></a>登录mysql</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot</span><br></pre></td></tr></table></figure><p>修改配置文件后，这里登录不需要密码；</p><h2 id="重置密码"><a href="#重置密码" class="headerlink" title="重置密码"></a>重置密码</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use mysql</span><br><span class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> authentication_string<span class="operator">=</span><span class="string">&#x27;&#x27;</span> <span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">flush privileges;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;你的新密码&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="后续工作"><a href="#后续工作" class="headerlink" title="后续工作"></a>后续工作</h2><p>退出mysql，修改配置文件<code>/etc/my.cnf</code>，删除<code>skip-grant-tables</code>行，重新启动mysqld服务；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure><p>至此修改完成。<br>good luck!!!</p><p>需要在CentOS8上安装MySQL5.7的可以参考<a href="/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS8%E4%B8%8A%E5%AE%89%E8%A3%85Mysql5-7/">《如何在CentOS8上安装Mysql5.7》</a>。</p>]]></content>
    
    
    <summary type="html">如何重置Mysql5.7 root密码</summary>
    
    
    
    
    <category term="MySQL" scheme="https://www.junle.org/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL explain学习笔记</title>
    <link href="https://www.junle.org/MySQL-explain%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>https://www.junle.org/MySQL-explain%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</id>
    <published>2020-08-06T01:52:54.000Z</published>
    <updated>2024-03-22T06:43:55.671Z</updated>
    
    <content type="html"><![CDATA[<h3 id="explain用法"><a href="#explain用法" class="headerlink" title="explain用法"></a>explain用法</h3><p>查询居民id为“004386f02b6511e8ad1300163e08fb5b”的居民所在的部门信息：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> department.<span class="operator">*</span> <span class="keyword">from</span> department,westation,citizen</span><br><span class="line"><span class="keyword">where</span> department.id <span class="operator">=</span> westation.department_id <span class="keyword">and</span> westation.id <span class="operator">=</span> citizen.westation_id</span><br><span class="line"><span class="keyword">and</span> citizen.id<span class="operator">=</span>&quot;004386f02b6511e8ad1300163e08fb5b&quot; </span><br></pre></td></tr></table></figure><table><thead><tr><th>id</th><th>select_type</th><th>table</th><th>type</th><th>possible_key</th><th>key</th><th>key_len</th><th>ref</th><th>rows</th><th>Extra</th></tr></thead><tbody><tr><td>1</td><td>SIMPLE</td><td>citizen</td><td>const</td><td>PRIMARY,FK_Citizen_Westation</td><td>PRIMARY</td><td>128</td><td>const</td><td>1</td><td></td></tr><tr><td>1</td><td>SIMPLE</td><td>westation</td><td>const</td><td>PRIMARY,department_id,FK_deparment_westation</td><td>PRIMARY</td><td>128</td><td>const</td><td>1</td><td></td></tr><tr><td>1</td><td>SIMPLE</td><td>department</td><td>const</td><td>PRIMARY</td><td>PRIMARY</td><td>128</td><td>const</td><td>1</td><td></td></tr></tbody></table><span id="more"></span><p>各列的含义：</p><ol><li><p>id：查询id，id相同的从上往下顺序执行；id不同的，值越大越先执行；id有相同和不相同的，综合前两种，值大的先执行，相同的顺序执行。</p></li><li><p>select_type：查询类型</p><ul><li>PRIMARY：包含子查询SQL中的主查询（最外层）</li><li>SUBQUERY：包含子查询SQL中的子查询（非最外层）</li><li>simple：简单查询（不包含子查询、union）</li><li>derived：衍生查询（使用到了临时表）<br>  a. 在from子查询中有一张表<br>  b. 在from子查询中如果有table1 union table2，则table1就是derived，table2就是union</li></ul></li><li><p>type：索引类型，常见索引类型从快到慢排序：system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; all</p><ul><li>system：只有一条数据的系统表或衍生表只有一条数据的主查询</li><li>const：仅仅能查到一条数据的SQL，用于Primary Key或unique索引（与索引类型有关）</li><li>eq_ref：唯一性索引，对于每个索引键的查询，返回匹配唯一行数据（有且只有一条，不能多，不能为0），常见于唯一索引和主键索引</li><li>ref：与eq_ref一样，对于每个索引键的查询，返回匹配的所有行数据（不唯一）</li><li>range：使用一个索引检索给定范围的行</li><li>index： 索引树遍历</li><li>all：全表遍历</li></ul></li><li><p>possible_key：可以使用的索引</p></li><li><p>key：实际使用的索引</p></li><li><p>key_len：索引中使用的字节数</p></li><li><p>ref：列与索引的比较，表示上述表的连接匹配条件，即哪些列或常量被用于查找索引列上的值</p></li><li><p>rows：估算出结果集行数</p></li><li><p>Extra：详细信息</p><ul><li><p>Using where：用读取表中所有信息，仅通过索引就可以获取所需数据，这发生在对表的全部的请求列都是同一个索引的部分的时候，表示mysql服务器将在存储引擎检索行后再进行过滤</p></li><li><p>ing temporary：示MySQL需要使用临时表来存储结果集，常见于排序和分组查询，常见 group by ; order by</p></li><li><p>ing filesort：Query中包含 order by 操作，而且无法利用索引完成的排序操作称为“文件排序”</p></li></ul></li></ol>]]></content>
    
    
    <summary type="html">MySQL explain学习笔记</summary>
    
    
    
    
    <category term="MySQL" scheme="https://www.junle.org/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>如何在Chart.js的图表顶部显示值</title>
    <link href="https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8Chart-js%E7%9A%84%E5%9B%BE%E8%A1%A8%E9%A1%B6%E9%83%A8%E6%98%BE%E7%A4%BA%E5%80%BC/"/>
    <id>https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8Chart-js%E7%9A%84%E5%9B%BE%E8%A1%A8%E9%A1%B6%E9%83%A8%E6%98%BE%E7%A4%BA%E5%80%BC/</id>
    <published>2020-06-18T04:14:09.000Z</published>
    <updated>2024-03-22T06:43:55.699Z</updated>
    
    <content type="html"><![CDATA[<p>本文介绍如何在Chart.js的图表顶部显示数值。</p><p>制作一个曲线图表，如下图所示。需要看具体数值时需要点击曲线上的点才能显示，用户在手机上操作时由于手机屏幕小很难点击到曲线上的点，需要将具体数值显示在曲线对应的点上。</p><p><img src="/images/202006181200.png"></p><span id="more"></span><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>通过查找我找到了一些解决方法：<a href="https://stackoverflow.com/questions/42556835/show-values-on-top-of-bars-in-chart-js/42562284">https://stackoverflow.com/questions/42556835/show-values-on-top-of-bars-in-chart-js/42562284</a>，但这个解决方法存在一些问题：</p><ul><li>当图表中存在两个以上的曲线时，显示的数值颜色跟曲线的颜色不匹配；</li><li>当点击图例隐藏曲线时，数值不能隐藏；</li></ul><p>根据这些问题我对option的animation进行修改如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;animation&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;duration&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;onComplete&quot;</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> chartInstance = <span class="variable language_">this</span>.<span class="property">chart</span>,</span><br><span class="line">      ctx = chartInstance.<span class="property">ctx</span>;</span><br><span class="line"></span><br><span class="line">      ctx.<span class="property">font</span> = <span class="title class_">Chart</span>.<span class="property">helpers</span>.<span class="title function_">fontString</span>(<span class="title class_">Chart</span>.<span class="property">defaults</span>.<span class="property">global</span>.<span class="property">defaultFontSize</span>, <span class="title class_">Chart</span>.<span class="property">defaults</span>.<span class="property">global</span>.<span class="property">defaultFontStyle</span>, <span class="title class_">Chart</span>.<span class="property">defaults</span>.<span class="property">global</span>.<span class="property">defaultFontFamily</span>);</span><br><span class="line">      ctx.<span class="property">textAlign</span> = <span class="string">&#x27;center&#x27;</span>;</span><br><span class="line">      ctx.<span class="property">textBaseline</span> = <span class="string">&#x27;bottom&#x27;</span>;</span><br><span class="line"></span><br><span class="line">      chartLegendItems = chartInstance.<span class="property">legend</span>.<span class="property">legendItems</span>;  <span class="comment">//获取图例</span></span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">datasets</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">dataset, i</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> meta = chartInstance.<span class="property">controller</span>.<span class="title function_">getDatasetMeta</span>(i);</span><br><span class="line"></span><br><span class="line">        meta.<span class="property">data</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">bar, index</span>) &#123;                            </span><br><span class="line">          <span class="keyword">if</span> (chartLegendItems[i].<span class="property">hidden</span> == <span class="literal">false</span>) &#123;    <span class="comment">//当图例隐藏时不显示数值</span></span><br><span class="line">            <span class="keyword">var</span> data = <span class="title class_">Number</span>(dataset.<span class="property">data</span>[index]).<span class="title function_">toFixed</span>(<span class="number">2</span>); <span class="comment">//保留两位小数</span></span><br><span class="line">            ctx.<span class="property">fillStyle</span> = dataset.<span class="property">backgroundColor</span>;    <span class="comment">//设置数值字体颜色为曲线颜色</span></span><br><span class="line">            ctx.<span class="title function_">fillText</span>(data, bar.<span class="property">_model</span>.<span class="property">x</span>, bar.<span class="property">_model</span>.<span class="property">y</span> - <span class="number">8</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果如下图：<br><img src="/images/202006181212.png"></p><h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>通过chartjs插件：<a href="https://github.com/chartjs/chartjs-plugin-datalabels">chartjs-plugin-datalabels</a></p><p>添加script：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>效果如下图：<br><img src="/images/202006220845.png"><br>你还可以自定义数值显示样式，详细内容可以参考<a href="https://chartjs-plugin-datalabels.netlify.app/guide/">chartjs-plugin-datalabels的文档</a>。</p>]]></content>
    
    
    <summary type="html">本文介绍如何在Chart.js的图表顶部显示数值</summary>
    
    
    
    
    <category term="Python" scheme="https://www.junle.org/tags/Python/"/>
    
    <category term="Chart.js" scheme="https://www.junle.org/tags/Chart-js/"/>
    
    <category term="数据可视化" scheme="https://www.junle.org/tags/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu安装psycopg2失败：error: command &#39;x86_64-linux-gnu-gcc&#39; failed with exit status 1</title>
    <link href="https://www.junle.org/Ubuntu%E5%AE%89%E8%A3%85psycopg2%E5%A4%B1%E8%B4%A5%EF%BC%9Aerror-command-x86-64-linux-gnu-gcc-failed-with-exit-status-1/"/>
    <id>https://www.junle.org/Ubuntu%E5%AE%89%E8%A3%85psycopg2%E5%A4%B1%E8%B4%A5%EF%BC%9Aerror-command-x86-64-linux-gnu-gcc-failed-with-exit-status-1/</id>
    <published>2020-06-03T01:24:30.000Z</published>
    <updated>2024-03-22T06:43:55.685Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题：Ubuntu安装psycopg2失败报错"><a href="#问题：Ubuntu安装psycopg2失败报错" class="headerlink" title="问题：Ubuntu安装psycopg2失败报错"></a>问题：Ubuntu安装psycopg2失败报错</h2><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">error: <span class="title">command</span> &#x27;<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>-<span class="title">gcc</span>&#x27; <span class="title">failed</span> <span class="title">with</span> <span class="title">exit</span> <span class="title">status</span> 1</span></span><br><span class="line"><span class="function">----------------------------------------</span></span><br><span class="line"><span class="function"><span class="title">ERROR</span>: <span class="title">Failed</span> <span class="title">building</span> <span class="title">wheel</span> <span class="title">for</span> <span class="title">psycopg2</span></span></span><br></pre></td></tr></table></figure><h2 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h2><p>安装 python-dev, python3-dev, libpq-dev ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python-dev  python3-dev  libpq-dev </span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Ubuntu安装psycopg2失败：error: command &#39;x86_64-linux-gnu-gcc&#39; failed with exit status 1</summary>
    
    
    
    
    <category term="Linux" scheme="https://www.junle.org/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu安装Pillow失败：The headers or library files could not be found for jpeg...</title>
    <link href="https://www.junle.org/Ubuntu%E5%AE%89%E8%A3%85Pillow%E5%A4%B1%E8%B4%A5%EF%BC%9AThe-headers-or-library-files-could-not-be-found-for-jpeg/"/>
    <id>https://www.junle.org/Ubuntu%E5%AE%89%E8%A3%85Pillow%E5%A4%B1%E8%B4%A5%EF%BC%9AThe-headers-or-library-files-could-not-be-found-for-jpeg/</id>
    <published>2020-06-03T01:17:58.000Z</published>
    <updated>2024-03-22T06:43:55.685Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题：Ubuntu安装Pillow失败报错"><a href="#问题：Ubuntu安装Pillow失败报错" class="headerlink" title="问题：Ubuntu安装Pillow失败报错"></a>问题：Ubuntu安装Pillow失败报错</h2><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">The headers or library files could <span class="keyword">not</span> be found <span class="keyword">for</span> jpeg,</span><br><span class="line">    a required dependency when compiling Pillow from source.</span><br><span class="line"></span><br><span class="line">    Please see the install instructions <span class="built_in">at</span>:</span><br><span class="line"><span class="function">       https://<span class="title">pillow.readthedocs.io</span>/<span class="title">en</span>/<span class="title">latest</span>/<span class="title">installation.html</span></span></span><br></pre></td></tr></table></figure><h2 id="解决方法：安装libjpeg-dev"><a href="#解决方法：安装libjpeg-dev" class="headerlink" title="解决方法：安装libjpeg-dev"></a>解决方法：安装libjpeg-dev</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libjpeg-dev</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Ubuntu安装Pillow失败：The headers or library files could not be found for jpeg...</summary>
    
    
    
    
    <category term="Linux" scheme="https://www.junle.org/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL数据库备份还原</title>
    <link href="https://www.junle.org/PostgreSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F/"/>
    <id>https://www.junle.org/PostgreSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F/</id>
    <published>2020-05-08T07:16:07.000Z</published>
    <updated>2024-03-22T06:43:55.681Z</updated>
    
    <content type="html"><![CDATA[<h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h2><hr><p>PostgreSQL数据库备份推荐使用自带的pg_dump，类似Mysql的mysqldump，以下命令为备份数据库并压缩：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_dump --username=postgres --host=localhost --dbname=DATABASE | xz -9 &gt; DATABASE.sql.xz</span><br></pre></td></tr></table></figure><p>也可以使用pg_dumpall命令把所有数据库都dump出来：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_dumpall --username=postgres --host=localhost | xz -9 &gt; DATABASE.sql.xz</span><br></pre></td></tr></table></figure><h2 id="还原"><a href="#还原" class="headerlink" title="还原"></a>还原</h2><hr><p>还原使用psql命令还原：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unxz -c DATABASE.sql.xz | psql -U 用户名 -h localhost DATABASE</span><br></pre></td></tr></table></figure><h2 id="备份脚本"><a href="#备份脚本" class="headerlink" title="备份脚本"></a>备份脚本</h2><hr><p>创建备份脚本dbbackup.sh，使用crontab来每日调用一次，实现自动备份数据库：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#备份文件存放路径</span></span><br><span class="line">backup_file_path=<span class="string">&quot;/your/dbbackup/path/&quot;</span></span><br><span class="line">cur_date=$(<span class="built_in">date</span> +<span class="string">&quot;%Y%m%d_%H%M&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[<span class="subst">$(date +&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span>]Start Backup.&quot;</span></span><br><span class="line">pg_dumpall --username=postgres --host=localhost | xz -9 &gt; <span class="variable">$&#123;backup_file_path&#125;</span><span class="variable">$&#123;cur_date&#125;</span>-DATABASE.sql.xz</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[<span class="subst">$(date +&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span>]Backup Done.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查找30天前的历史备份数据并删除，历史数据保留30天</span></span><br><span class="line">find <span class="string">&quot;<span class="variable">$&#123;backup_file_path&#125;</span>&quot;</span> -maxdepth 1 -name <span class="string">&quot;*.sql.xz&quot;</span> -daystart -mtime +30 -delete</span><br></pre></td></tr></table></figure><p>给dbbackup.sh添加可执行权限:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x dbbackup.sh</span><br></pre></td></tr></table></figure><p>最后在crontab中设置自动执行备份脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 * * * /your/dbbackup/path/dbbackup.sh</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">PostgreSQL数据库备份推荐使用自带的pg_dump，类似Mysql的mysqldump，以下命令为备份数据库并压缩</summary>
    
    
    
    
    <category term="PostgreSQL" scheme="https://www.junle.org/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>使用STM32F103C8T6驱动0.96寸RGB IPS显示屏</title>
    <link href="https://www.junle.org/%E4%BD%BF%E7%94%A8STM32F103C8T6%E9%A9%B1%E5%8A%A80-96%E5%AF%B8RGB-IPS%E6%98%BE%E7%A4%BA%E5%B1%8F/"/>
    <id>https://www.junle.org/%E4%BD%BF%E7%94%A8STM32F103C8T6%E9%A9%B1%E5%8A%A80-96%E5%AF%B8RGB-IPS%E6%98%BE%E7%A4%BA%E5%B1%8F/</id>
    <published>2020-05-03T13:51:31.000Z</published>
    <updated>2024-03-22T06:43:55.692Z</updated>
    
    <content type="html"><![CDATA[<p>笔者购买的是一款0.96寸的IPS显示屏，分辨率为160x80，驱动器IC为ST7735S，65k Colors, RGB 5,6,5-bit Input。 接口定义：</p><ul><li>GND： 接地；</li><li>VCC： 3.3~5V电源正；</li><li>SCL： SPI时钟线；</li><li>SDA： SPI数据线；</li><li>RES： 重启线；</li><li>DC： SPI数据&#x2F;命令选择线；</li><li>CS： 片选接口；</li><li>BLK： 被光控制，默认NC，低电平关闭背光。</li></ul><p>本文介绍实现SPI通信协议来驱动显示屏，先给出代码：<a href="https://github.com/elnujuw/stm32f103c8-st7735s-lcd">stm32f103c8-st7735s-lcd</a></p><h2 id="SPI通信时序"><a href="#SPI通信时序" class="headerlink" title="## SPI通信时序"></a><img src="/images/DSC00015.jpg" alt="0.96 RGB IPS Display"><br><span id="more"></span><br>## SPI通信时序</h2><p>参考ST7735S数据手册4线串行接口时序，SPI协议向ST7735S写数据流程是：</p><ol><li>把CS片选线从高电平拉到低电平，使能芯片；</li><li>操作SDA，DC引脚为要写入的数据</li><li>在SCL时钟的上升沿时刻写入数据到芯片中；</li><li>重复以上2、3步骤直到各个位的数据写入到芯片；</li><li>把CS片选冲低电平拉升到高电平，停止通信。</li></ol><p>时序如下图：<br><img src="/images/20200503162211.png"><br>实现代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief SPI协议写一个字节</span></span><br><span class="line"><span class="comment">  * @param  data 8位数据</span></span><br><span class="line"><span class="comment">  * @retval None</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeBus</span><span class="params">(<span class="type">uint8_t</span> data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> i;</span><br><span class="line">    LCD_CS_CLR();</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        LCD_SCL_CLR();</span><br><span class="line">        <span class="keyword">if</span>(data&amp;<span class="number">0x80</span>)</span><br><span class="line">            LCD_SDA_SET();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            LCD_SDA_CLR();</span><br><span class="line">        LCD_SCL_SET();</span><br><span class="line">        data&lt;&lt;=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    LCD_CS_SET();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h2><hr><p>lcd.c中已经实现了一个显示字符串的函数<code>void LCD_showString(uint16_t x, uint16_t y, char *p, uint16_t color);</code>,x, y是字符串显示的左上像素坐标，*p为字符串，color为显示函数。实现方法是使用PCtoLCD2002取模软件对ASCII字符进行取模取模，取模的结果放到font.h文件中。</p><p><img src="/images/DSC05852.jpg" alt="Junle&#39;s Blog"></p>]]></content>
    
    
    <summary type="html">使用STM32F103C8T6驱动0.96寸RGB IPS显示屏</summary>
    
    
    
    
    <category term="STM32" scheme="https://www.junle.org/tags/STM32/"/>
    
  </entry>
  
  <entry>
    <title>STM32延时函数的实现方法</title>
    <link href="https://www.junle.org/STM32%E5%BB%B6%E6%97%B6%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95/"/>
    <id>https://www.junle.org/STM32%E5%BB%B6%E6%97%B6%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95/</id>
    <published>2020-05-02T14:10:22.000Z</published>
    <updated>2024-03-22T06:43:55.683Z</updated>
    
    <content type="html"><![CDATA[<h2 id="我们在开发STM32工程时常常都需要使用到延时函数，比如控制LED的闪烁、IIC和SPI总线等都会用到延时函数，笔者刚开始接触STM32时查阅了不少的资料，本文将分享三种方法来实现延时函数。-软件延时"><a href="#我们在开发STM32工程时常常都需要使用到延时函数，比如控制LED的闪烁、IIC和SPI总线等都会用到延时函数，笔者刚开始接触STM32时查阅了不少的资料，本文将分享三种方法来实现延时函数。-软件延时" class="headerlink" title="我们在开发STM32工程时常常都需要使用到延时函数，比如控制LED的闪烁、IIC和SPI总线等都会用到延时函数，笔者刚开始接触STM32时查阅了不少的资料，本文将分享三种方法来实现延时函数。## 软件延时"></a>我们在开发STM32工程时常常都需要使用到延时函数，比如控制LED的闪烁、IIC和SPI总线等都会用到延时函数，笔者刚开始接触STM32时查阅了不少的资料，本文将分享三种方法来实现延时函数。<br><span id="more"></span><br>## 软件延时</h2><p>软件延时非常的简单粗暴，让单片机循环达到延时的目的：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Delay</span><span class="params">(__IO u32 nCount)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span>(; nCount != <span class="number">0</span>; nCount--);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>软件延时的优点是简单易懂，实现容易。缺点是不能精准地控制延时时间，在对延时时间要求较高的工程中，软件延时明显不能满足需求。</p><h2 id="硬件延时"><a href="#硬件延时" class="headerlink" title="硬件延时"></a>硬件延时</h2><hr><h3 id="定时器延时（非中断方式）"><a href="#定时器延时（非中断方式）" class="headerlink" title="定时器延时（非中断方式）"></a>定时器延时（非中断方式）</h3><hr><p>STM32内核中包含一个24位计数器SysTick，计数到0后又重新加载计数初始值到寄存器。下面介绍如何配置延时函数。<br>STM32外部8MHz时钟倍频到72MHz，然后SysTick计数器再8分频，所以SysTick计数器的工作频率是9MHz(一秒钟计数9M次)。SysTick在STM32的固件库core_cm3.h中是这样定义的：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  __IO <span class="type">uint32_t</span> CTRL;                         <span class="comment">/*!&lt; Offset: 0x00  SysTick Control and Status Register */</span></span><br><span class="line">  __IO <span class="type">uint32_t</span> LOAD;                         <span class="comment">/*!&lt; Offset: 0x04  SysTick Reload Value Register       */</span></span><br><span class="line">  __IO <span class="type">uint32_t</span> VAL;                          <span class="comment">/*!&lt; Offset: 0x08  SysTick Current Value Register      */</span></span><br><span class="line">  __I  <span class="type">uint32_t</span> CALIB;                        <span class="comment">/*!&lt; Offset: 0x0C  SysTick Calibration Register        */</span></span><br><span class="line">&#125; SysTick_Type;</span><br></pre></td></tr></table></figure><p>CTRL是SysTick控制和状态寄存器，LOAD是SysTick重载值寄存器，VAL是当前值寄存器，CALIB是SysTick校准寄存器（不常用）。实现代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;delay.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> fac_us=<span class="number">0</span>;<span class="comment">//us延时倍数</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> fac_ms=<span class="number">0</span>;<span class="comment">//ms延时倍数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  计数器初始化函数</span></span><br><span class="line"><span class="comment">  * @param  None</span></span><br><span class="line"><span class="comment">  * @retval None</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    SysTick_CLKSourceConfig(SysTick_CLKSource_HCLK_Div8);<span class="comment">//选择外部时钟HCLK/8</span></span><br><span class="line"></span><br><span class="line">    fac_us=SystemCoreClock/<span class="number">8000000</span>; <span class="comment">//72000000/8000000 = 9</span></span><br><span class="line"></span><br><span class="line">    fac_ms=(<span class="type">uint16_t</span>)fac_us*<span class="number">1000</span>; <span class="comment">//9000</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  us延时函数</span></span><br><span class="line"><span class="comment">  * @param  nus 延时us数</span></span><br><span class="line"><span class="comment">  * @retval None</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_us</span><span class="params">(<span class="type">uint32_t</span> nus)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> temp;</span><br><span class="line">    SysTick-&gt;LOAD = nus*fac_us; <span class="comment">//加载时间</span></span><br><span class="line">    SysTick-&gt;VAL = <span class="number">0x00</span>; <span class="comment">//清空计数器</span></span><br><span class="line">    SysTick-&gt;CTRL |= SysTick_CTRL_ENABLE_Msk; <span class="comment">//开始计数</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        temp = SysTick-&gt;CTRL;</span><br><span class="line">    &#125;<span class="keyword">while</span>(temp&amp;<span class="number">0x01</span>&amp;&amp;!(temp&amp;(<span class="number">1</span>&lt;&lt;<span class="number">16</span>))); <span class="comment">//等待时间到达</span></span><br><span class="line">    SysTick-&gt;CTRL &amp;= ~SysTick_CTRL_ENABLE_Msk; <span class="comment">//停止计数</span></span><br><span class="line">    SysTick-&gt;VAL = <span class="number">0x00</span>; <span class="comment">//清空计数器</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  ms延时函数</span></span><br><span class="line"><span class="comment">  * @param  mus 延时ms数</span></span><br><span class="line"><span class="comment">  * @retval None</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(<span class="type">uint16_t</span> nms)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> temp;</span><br><span class="line">    SysTick-&gt;LOAD = nms*fac_ms; <span class="comment">//加载时间</span></span><br><span class="line">    SysTick-&gt;VAL = <span class="number">0x00</span>; <span class="comment">//清空计数器</span></span><br><span class="line">    SysTick-&gt;CTRL |= SysTick_CTRL_ENABLE_Msk; <span class="comment">//开始计数</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        temp = SysTick-&gt;CTRL;</span><br><span class="line">    &#125;<span class="keyword">while</span>(temp&amp;<span class="number">0x01</span>&amp;&amp;!(temp&amp;(<span class="number">1</span>&lt;&lt;<span class="number">16</span>))); <span class="comment">//等待时间到达</span></span><br><span class="line">    SysTick-&gt;CTRL &amp;= ~SysTick_CTRL_ENABLE_Msk; <span class="comment">//停止计数</span></span><br><span class="line">    SysTick-&gt;VAL = <span class="number">0x00</span>; <span class="comment">//清空计数器</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="中断延时（中断方式）"><a href="#中断延时（中断方式）" class="headerlink" title="中断延时（中断方式）"></a>中断延时（中断方式）</h3><hr><p>使用SysTick计数器的中断方式实现延时，SysTick_Config()配置SysTick计数器，SystemCoreClock&#x2F;1000实现1ms产生一次中断，在中断函数SysTick_Handler中对time_delay变量减一处理，当time_delay为0时，到达延时时间。实现代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint32_t</span> time_delay;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  ms延时函数</span></span><br><span class="line"><span class="comment">  * @param  mus 延时ms数</span></span><br><span class="line"><span class="comment">  * @retval None</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(__IO <span class="type">uint32_t</span> nms)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(SysTick_Config(SystemCoreClock/<span class="number">1000</span>)) <span class="comment">//配置SysTick计数器</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    time_delay = nms;</span><br><span class="line">    <span class="keyword">while</span>(time_delay);  <span class="comment">//time_delay为0时，到达延时时间。</span></span><br><span class="line">    SysTick-&gt;CTRL = <span class="number">0x00</span>;  </span><br><span class="line">    SysTick-&gt;VAL = <span class="number">0x00</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  SysTick中断函数</span></span><br><span class="line"><span class="comment">  * @param  None</span></span><br><span class="line"><span class="comment">  * @retval None</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">SysTick_Handler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(time_delay)</span><br><span class="line">    &#123;</span><br><span class="line">        time_delay--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><hr><p>使用软件延时实现方便但不能精确延时。使用中断的方法实现的延时函数可以做到精确延时，但使用中断在中断嵌套中不利与其他中断调用此中断函数。使用非中断的方式可以很好的解决以上两种延时方法的缺点，所以比较推荐使用非中断的硬件延时方法实现延时函数。</p>]]></content>
    
    
    <summary type="html">我们在开发STM32工程时常常都需要使用到延时函数，比如控制LED的闪烁、IIC和SPI总线等都会用到延时函数，笔者刚开始接触STM32时查阅了不少的资料，本文将分享三种方法来实现延时函数。</summary>
    
    
    
    
    <category term="STM32" scheme="https://www.junle.org/tags/STM32/"/>
    
  </entry>
  
  <entry>
    <title>使用Keil5创建STM32工程</title>
    <link href="https://www.junle.org/%E4%BD%BF%E7%94%A8Keil5%E5%88%9B%E5%BB%BASTM32%E5%B7%A5%E7%A8%8B/"/>
    <id>https://www.junle.org/%E4%BD%BF%E7%94%A8Keil5%E5%88%9B%E5%BB%BASTM32%E5%B7%A5%E7%A8%8B/</id>
    <published>2020-04-27T09:26:09.000Z</published>
    <updated>2024-03-22T06:43:55.691Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://www.keil.com/">Keil</a>对于做单片机开发的人员来所再熟悉不过了。Keil成立与1982年，在2005年10月被ARM公司收购。<br>相信对于很多STM32的初学者来说从零开始创建一个STM32工程是比较困难的，很多人都是把之前的工程复制过来，再进行改编的，这样可以省掉很多烦恼。笔者最近也在学习STM32的开发，顺便整理一下自己的方法跟大家分享，下面来介绍如何使用Keil μVision5创建一个STM32的工程。</p><span id="more"></span><h2 id="下载ST官方库"><a href="#下载ST官方库" class="headerlink" title="下载ST官方库"></a>下载ST官方库</h2><hr><p>在ST官网:<a href="https://www.st.com/zh/microcontrollers-microprocessors.html">https://www.st.com/zh/microcontrollers-microprocessors.html</a>下载<strong>STM32 Standard Peripheral Libraries</strong>库文件，打开后进入<strong>工具与软件</strong> -&gt; <strong>嵌入式软件</strong> -&gt; <strong>MCU及MPU嵌入式软件</strong>：</p><p><img src="/images/202004271543.jpg" alt="STM32 Standard Peripheral Libraries"></p><p>笔者购买的开发板是使用STM32F103C8T6微控制器的开发板，所以选择<strong>STSW-STM32054</strong>:</p><p><img src="/images/202004271544.jpg" alt="STSW-STM32054"></p><p>下载完成后解压文件你会得到以下文件，这里主要用到的是<strong>Libraries</strong>和<strong>Project</strong>文件夹：</p><p><img src="/images/202004271557.jpg" alt="解压后文件夹"></p><h2 id="创建工程文件夹"><a href="#创建工程文件夹" class="headerlink" title="创建工程文件夹"></a>创建工程文件夹</h2><hr><ul><li><p>创建文件夹Template作为工程文件的根目录，然后在Template目录下再创建以下文件夹：CMSIS、USER、FWLIB、STARTUP。 CMSIS用于存放内核函数，USER存放用户自己的函数，FWLIB存放库函数，STARTUP存放启动引导文件。</p></li><li><p>将STM32F10x_StdPeriph_Lib_V3.5.0\Libraries\CMSIS\CM3\CoreSupport中的文件复制到工程目录的CMSIS文件夹中，<br>将STM32F10x_StdPeriph_Lib_V3.5.0\Libraries\CMSIS\CM3\DeviceSupport\ST\STM32F10x中的.c和.h文件复制到工程目录的CMSIS文件夹中，复制完成后的CMSIS文件夹应该是这样的：</p></li></ul><p><img src="/images/202004271605.jpg" alt="CMSIS"></p><ul><li>将STM32F10x_StdPeriph_Lib_V3.5.0\Project\STM32F10x_StdPeriph_Template目录下的.c和.h文件复制到工程目录的USER文件夹中，复制完成后的USER文件就是这样的：</li></ul><p><img src="/images/202004271619.jpg" alt="USER"></p><ul><li>将STM32F10x_StdPeriph_Lib_V3.5.0\Libraries\STM32F10x_StdPeriph_Driver目录下的inc文件夹和src文件夹复制到工程目录的FWLIB文件夹中，复制完成后的FWLIB文件夹应该是这样的：</li></ul><p><img src="/images/202004271614.jpg" alt="CMSIS"></p><ul><li>将STM32F10x_StdPeriph_Lib_V3.5.0\Libraries\CMSIS\CM3\DeviceSupport\ST\STM32F10x\startup\arm中的startup_stm32f10x_md.s文件复制到工程文件夹的STARTUP文件夹中，这里的是单片机的启动引导文件，可以根据芯片的FLASH容量来区分属于小容量、中容量和大容量从而决定使用哪个启动引导文件：</li></ul><table><thead><tr><th>FLASH容量</th><th align="center">分类</th><th align="left">对应的启动引导文件</th></tr></thead><tbody><tr><td>FLASH &lt;&#x3D; 32K</td><td align="center">小容量</td><td align="left">startup_stm32f10x_ld.s</td></tr><tr><td>64K &lt;&#x3D; FLASH &lt;&#x3D; 128K</td><td align="center">中容量</td><td align="left">startup_stm32f10x_md.s</td></tr><tr><td>256K &lt;&#x3D; FLASH &lt;&#x3D; 512K</td><td align="center">大容量</td><td align="left">startup_stm32f10x_hd.s</td></tr></tbody></table><p>笔者购买的开发板是使用STM32F103C8T6的微控制器，拥有64K的FLASH，属于中容量的微控制器，所以启动引导文件选择arm中的startup_stm32f10x_md.s，复制完成后的STARTUP文件夹应该是这样的：</p><p><img src="/images/202004271635.jpg" alt="STARTUP"></p><h2 id="新建μVision工程"><a href="#新建μVision工程" class="headerlink" title="新建μVision工程"></a>新建μVision工程</h2><hr><p>打开Keil，新建工程Template，工程文件保存在上一步的Template目录中，保存后选择芯片，这里我们用到的是STM32F103C8，在Search中输入STM32F103C8选中后点OK，在下一步弹出的Manager Run-Time Environment中我们点击Cancel，不需要让Keil来为我们添加库文件，我们使用之前下载好的库文件自己手工添加。</p><p><img src="/images/202004271640.jpg" alt="STM32F103C8 Device"></p><p>点击Manager Project Items按钮，将Project Targets更名为Template。 删除默认的Groups，并创建以下Groups：CMSIS、USER、FWLIB、STARTUP。</p><p><img src="/images/202004271646.jpg" alt="Manager Project Items"></p><p>在CMSIS Group中添加工程文件目录的CMSIS文件夹里的.c文件；在USER Group中添加工程文件目录的USER文件夹里的.c文件；在FWLIB Group中添加工程文件目录的FWLIB\src文件夹里的.c文件；在STARTUP Group中添加工程文件目录的STARTUP文件夹里的startup_stm32f10x_md.s文件；添加完成后点击OK。</p><p>点击Options for Target按钮（魔术棒）选择C&#x2F;C++设置页，在Preprocessor Symbots的Define中填写：<code>USE_STDPERIPH_DRIVER, STM32F10X_MD</code>这里的STM32F10X_MD是因为启动引导文件使用的是中容量的引导文件；Include Paths中填写：<code>.\CMSIS;.\FWLIB\inc;.\FWLIB\src;.\USER;.\CMSIS\startup\arm</code>，完成后点击OK。</p><p><img src="/images/202004271702.jpg" alt="OPtions for Target"></p><h2 id="编译调试"><a href="#编译调试" class="headerlink" title="编译调试"></a>编译调试</h2><hr><p>编译工程出现报错：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Rebuild started: Project: Template</span><br><span class="line">*** Using Compiler &#x27;V5.<span class="number">06</span> update <span class="number">6</span> (build <span class="number">750</span>)&#x27;, folder: &#x27;C:\Keil_v5\ARM\ARMCC\Bin&#x27;</span><br><span class="line">Rebuild target &#x27;Template&#x27;</span><br><span class="line">compiling core_cm3.c...</span><br><span class="line">compiling main.c...</span><br><span class="line">USER\main.c(<span class="number">24</span>): error:  #<span class="number">5</span>: cannot open source input file &quot;stm32_eval.h&quot;: No such file or directory</span><br><span class="line">  #include &quot;stm32_eval.h&quot;</span><br><span class="line">USER\main.c: <span class="number">0</span> warnings, <span class="number">1</span> error</span><br><span class="line">compiling system_stm32f10x.c...</span><br><span class="line">...</span><br><span class="line">compiling stm32f10x_tim.c...</span><br><span class="line">assembling startup_stm32f10x_md.s...</span><br><span class="line">compiling stm32f10x_wwdg.c...</span><br><span class="line">&quot;.\Objects\Template.axf&quot; - <span class="number">1</span> Error(s), <span class="number">0</span> Warning(s).</span><br><span class="line">Target <span class="keyword">not</span> created.</span><br><span class="line">Build <span class="built_in">Time</span> Elapsed:  <span class="number">00</span>:<span class="number">00</span>:<span class="number">08</span></span><br></pre></td></tr></table></figure><p>原因是没有找到文件stm32_eval.h，修改main.c文件，将不需要的内容删除，修改后的main.c文件如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Includes ------------------------------------------------------------------*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32f10x.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Private functions ---------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  Main program.</span></span><br><span class="line"><span class="comment">  * @param  None</span></span><br><span class="line"><span class="comment">  * @retval None</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Infinite loop */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重新编译工程，依然有错：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Rebuild started: Project: Template</span><br><span class="line">*** Using Compiler &#x27;V5.<span class="number">06</span> update <span class="number">6</span> (build <span class="number">750</span>)&#x27;, folder: &#x27;C:\Keil_v5\ARM\ARMCC\Bin&#x27;</span><br><span class="line">Rebuild target &#x27;Template&#x27;</span><br><span class="line">...</span><br><span class="line">compiling stm32f10x_wwdg.c...</span><br><span class="line">linking...</span><br><span class="line">.\Objects\Template.axf: Error: L6200E: Symbol SystemCoreClock multiply <span class="keyword">defined</span> (by system_stm32f10x_1.o and system_stm32f10x.o).</span><br><span class="line">.\Objects\Template.axf: Error: L6200E: Symbol AHBPrescTable multiply <span class="keyword">defined</span> (by system_stm32f10x_1.o and system_stm32f10x.o).</span><br><span class="line">.\Objects\Template.axf: Error: L6200E: Symbol SystemInit multiply <span class="keyword">defined</span> (by system_stm32f10x_1.o and system_stm32f10x.o).</span><br><span class="line">.\Objects\Template.axf: Error: L6200E: Symbol SystemCoreClockUpdate multiply <span class="keyword">defined</span> (by system_stm32f10x_1.o and system_stm32f10x.o).</span><br><span class="line"><span class="keyword">Not</span> enough information to list image symbols.</span><br><span class="line"><span class="keyword">Not</span> enough information to list load addresses <span class="keyword">in</span> the image map.</span><br><span class="line"><span class="function">Finished: 2 <span class="title">information</span>, 0 <span class="title">warning</span> <span class="title">and</span> 4 <span class="title">error</span> <span class="title">messages</span>.</span></span><br><span class="line"><span class="function">&quot;.\<span class="title">Objects</span>\<span class="title">Template.axf</span>&quot; - 4 <span class="title">Error</span>(<span class="title">s</span>), 0 <span class="title">Warning</span>(<span class="title">s</span>).</span></span><br><span class="line"><span class="function"><span class="title">Target</span> <span class="title">not</span> <span class="title">created</span>.</span></span><br><span class="line"><span class="function"><span class="title">Build</span> <span class="title">Time</span> <span class="title">Elapsed</span>:  00:00:07</span></span><br></pre></td></tr></table></figure><p>原因是system_stm32f10x.c文件重复，在CMSIS中和USER中都有一份，我们需要将USER中的system_stm32f10x.c文件移除出工程，点击Manager Project Items，选择USER Group，选择USER里的stm32f10x.c然后点击删除按钮。完成后点击OK。</p><p><img src="/images/202004271719.jpg" alt="remove stm32f10x.c from user group"></p><p>重新编译工程，此时没有报错了：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Rebuild started: Project: Template</span><br><span class="line">*** Using Compiler &#x27;V5.<span class="number">06</span> update <span class="number">6</span> (build <span class="number">750</span>)&#x27;, folder: &#x27;C:\Keil_v5\ARM\ARMCC\Bin&#x27;</span><br><span class="line">Rebuild target &#x27;Template&#x27;</span><br><span class="line">compiling core_cm3.c...</span><br><span class="line">...</span><br><span class="line">compiling stm32f10x_usart.c...</span><br><span class="line">assembling startup_stm32f10x_md.s...</span><br><span class="line">compiling stm32f10x_wwdg.c...</span><br><span class="line">linking...</span><br><span class="line">Program Size: Code=<span class="number">856</span> RO-data=<span class="number">268</span> RW-data=<span class="number">20</span> ZI-data=<span class="number">1636</span>  </span><br><span class="line">&quot;.\Objects\Template.axf&quot; - <span class="number">0</span> Error(s), <span class="number">0</span> Warning(s).</span><br><span class="line">Build <span class="built_in">Time</span> Elapsed:  <span class="number">00</span>:<span class="number">00</span>:<span class="number">07</span></span><br></pre></td></tr></table></figure><p>保存工程作为以后开发的模板工程，下次开发新项目时复制一份出来可以直接在这上面开发了。</p><h2 id="测试工程文件"><a href="#测试工程文件" class="headerlink" title="测试工程文件"></a>测试工程文件</h2><hr><p>编辑main.c文件：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  ******************************************************************************</span></span><br><span class="line"><span class="comment">  * @file    Project/STM32F10x_StdPeriph_Template/main.c </span></span><br><span class="line"><span class="comment">  * @author  Junle</span></span><br><span class="line"><span class="comment">  * @version V3.5.0</span></span><br><span class="line"><span class="comment">  * @date    27-April-2020</span></span><br><span class="line"><span class="comment">  * @brief   Main program body</span></span><br><span class="line"><span class="comment">  ******************************************************************************</span></span><br><span class="line"><span class="comment">  * @attention</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * THE PRESENT FIRMWARE WHICH IS FOR GUIDANCE ONLY AIMS AT PROVIDING CUSTOMERS</span></span><br><span class="line"><span class="comment">  * WITH CODING INFORMATION REGARDING THEIR PRODUCTS IN ORDER FOR THEM TO SAVE</span></span><br><span class="line"><span class="comment">  * TIME. AS A RESULT, STMICROELECTRONICS SHALL NOT BE HELD LIABLE FOR ANY</span></span><br><span class="line"><span class="comment">  * DIRECT, INDIRECT OR CONSEQUENTIAL DAMAGES WITH RESPECT TO ANY CLAIMS ARISING</span></span><br><span class="line"><span class="comment">  * FROM THE CONTENT OF SUCH FIRMWARE AND/OR THE USE MADE BY CUSTOMERS OF THE</span></span><br><span class="line"><span class="comment">  * CODING INFORMATION CONTAINED HEREIN IN CONNECTION WITH THEIR PRODUCTS.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * &lt;h2&gt;&amp;copy; COPYRIGHT 2011 STMicroelectronics&lt;/h2&gt;</span></span><br><span class="line"><span class="comment">  ******************************************************************************</span></span><br><span class="line"><span class="comment">  */</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">/* Includes ------------------------------------------------------------------*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32f10x.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Private functions ---------------------------------------------------------*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_GPIO_Config</span><span class="params">(<span class="type">void</span>)</span>; <span class="comment">//配置GPIO</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay</span><span class="params">(__IO u32 nCount)</span>;    <span class="comment">//延时函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  配置GPIO.</span></span><br><span class="line"><span class="comment">  * @param  None</span></span><br><span class="line"><span class="comment">  * @retval None</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_GPIO_Config</span><span class="params">(<span class="type">void</span>)</span>  </span><br><span class="line">&#123;</span><br><span class="line">  GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">  RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE); <span class="comment">// 开启GPIOB时钟</span></span><br><span class="line">  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;    <span class="comment">//定义要使用的pin</span></span><br><span class="line">  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;  <span class="comment">//复用功能的推挽输出</span></span><br><span class="line">  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">  GPIO_Init(GPIOB, &amp;GPIO_InitStructure);  <span class="comment">//初始化GPIO</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  延时函数.</span></span><br><span class="line"><span class="comment">  * @param  None</span></span><br><span class="line"><span class="comment">  * @retval None</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay</span><span class="params">(__IO u32 nCount)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span>(; nCount != <span class="number">0</span>; nCount--);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  Main program.</span></span><br><span class="line"><span class="comment">  * @param  None</span></span><br><span class="line"><span class="comment">  * @retval None</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  SystemInit(); </span><br><span class="line">    LED_GPIO_Config();</span><br><span class="line">  <span class="comment">/* Infinite loop */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">        GPIO_ResetBits(GPIOB, GPIO_Pin_10);</span><br><span class="line">        Delay(<span class="number">0x400000</span>);</span><br><span class="line">        GPIO_SetBits(GPIOB, GPIO_Pin_10);</span><br><span class="line">        Delay(<span class="number">0x400000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************* (C) COPYRIGHT 2011 STMicroelectronics *****END OF FILE****/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>点击Options for Target按钮（魔术棒）选择Output设置页，勾选Create HEX File然后点击OK，重新编译工程，完成后在工程文件夹下会生产Objects文件夹，HEX文件会存放在该文件夹中。</p><p><img src="/images/202004271742.jpg" alt="Create HEX File"></p><p>将LED和电阻串联连接到开发板的PB10引脚：</p><p><img src="/images/202004271808.jpg" alt="接线图"></p><p>下载HEX文件到STM32F103C8T6开发板，运行效果：</p><p><img src="/images/DSC05832.jpg" alt="运行效果"></p><p>LED灯闪烁，说明我们手动创建的工程文件可用。</p>]]></content>
    
    
    <summary type="html">Keil对于做单片机开发的人员来所再熟悉不过了。Keil成立与1982年，在2005年10月被ARM公司收购。</summary>
    
    
    
    
    <category term="STM32" scheme="https://www.junle.org/tags/STM32/"/>
    
  </entry>
  
  <entry>
    <title>ARM单片机STM32F103C8T6介绍</title>
    <link href="https://www.junle.org/ARM%E5%8D%95%E7%89%87%E6%9C%BASTM32F103C8T6%E4%BB%8B%E7%BB%8D/"/>
    <id>https://www.junle.org/ARM%E5%8D%95%E7%89%87%E6%9C%BASTM32F103C8T6%E4%BB%8B%E7%BB%8D/</id>
    <published>2020-04-27T07:27:33.000Z</published>
    <updated>2024-03-22T06:43:55.666Z</updated>
    
    <content type="html"><![CDATA[<h2 id="STM32"><a href="#STM32" class="headerlink" title="STM32"></a>STM32</h2><hr><p>STM32系列是STMicroelectronics半导体生产商生产的32位RISC ARM微控制器集成电路系列，下表总结了STM32微控制器系列。</p><span id="more"></span><table><thead><tr><th>STM32 Series</th><th align="center">ARM CPU Core</th></tr></thead><tbody><tr><td>L5</td><td align="center">Cortex-M33F</td></tr><tr><td>F7, H7</td><td align="center">Cortex-M7F</td></tr><tr><td>F3, F4, G4, L4, L4+, J</td><td align="center">Cortex-M4F</td></tr><tr><td>F1, F2, L1, W, J</td><td align="center">Cortex-M3</td></tr><tr><td>G0, L0, J</td><td align="center">Cortex-M0+</td></tr><tr><td>F0, J</td><td align="center">Cortex-M0</td></tr></tbody></table><h2 id="STM32F1系列"><a href="#STM32F1系列" class="headerlink" title="STM32F1系列"></a>STM32F1系列</h2><hr><p>STM32F1系列是第一批基于ARM Cortex-M3内核的STM32微控制器，被认为是它们的主流ARM微控制器。随着CPU速度，内部存储器大小和各种外围设备的发展，F1系列随着时间的推移而发展。<br>这里我们介绍的是STM32F1系列的微控制器：STM32F103C8T6。</p><p><img src="/images/DSC05836.jpg" alt="STM32F103C8T6开发板"><br>笔者购买的是STM32F103C8T6的核心板，使用CH340C实现USB转串口的调试接口，拥有64K FLASH和20K RAM，板载8M晶振&#x2F;RTC晶振，和GPIO全部引出，非常方便进行学习和开发。</p>]]></content>
    
    
    <summary type="html">STM32系列是STMicroelectronics半导体生产商生产的32位RISC ARM微控制器集成电路系列，下表总结了STM32微控制器系列。</summary>
    
    
    
    
    <category term="STM32" scheme="https://www.junle.org/tags/STM32/"/>
    
  </entry>
  
  <entry>
    <title>ESP8266开发板NodeMcu开发-DHT11温湿度Web服务器</title>
    <link href="https://www.junle.org/ESP8266%E5%BC%80%E5%8F%91%E6%9D%BFNodeMcu%E5%BC%80%E5%8F%91-DHT11%E6%B8%A9%E6%B9%BF%E5%BA%A6Web%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <id>https://www.junle.org/ESP8266%E5%BC%80%E5%8F%91%E6%9D%BFNodeMcu%E5%BC%80%E5%8F%91-DHT11%E6%B8%A9%E6%B9%BF%E5%BA%A6Web%E6%9C%8D%E5%8A%A1%E5%99%A8/</id>
    <published>2020-04-22T17:33:15.000Z</published>
    <updated>2024-03-22T06:43:55.669Z</updated>
    
    <content type="html"><![CDATA[<h2 id="本文介绍使用Arduino-IDE开发一个显示温湿度的Web服务器DHT11温湿传感器，供局域网内的任何设备访问。在本教程中，我将展示如何构建异步Web服务器，该服务器自动更新温度和湿度，而无需刷新网页并使用自定义CSS设置网页样式。-DHT11"><a href="#本文介绍使用Arduino-IDE开发一个显示温湿度的Web服务器DHT11温湿传感器，供局域网内的任何设备访问。在本教程中，我将展示如何构建异步Web服务器，该服务器自动更新温度和湿度，而无需刷新网页并使用自定义CSS设置网页样式。-DHT11" class="headerlink" title="本文介绍使用Arduino IDE开发一个显示温湿度的Web服务器DHT11温湿传感器，供局域网内的任何设备访问。在本教程中，我将展示如何构建异步Web服务器，该服务器自动更新温度和湿度，而无需刷新网页并使用自定义CSS设置网页样式。## DHT11"></a>本文介绍使用Arduino IDE开发一个显示温湿度的Web服务器DHT11温湿传感器，供局域网内的任何设备访问。<br><img src="/images/DSC05817.jpg" alt="效果显示"><br>在本教程中，我将展示如何构建异步Web服务器，该服务器自动更新温度和湿度，而无需刷新网页并使用自定义CSS设置网页样式。<br><span id="more"></span><br>## DHT11</h2><p>DHT11是温湿传感器，产品参数如下：</p><table><thead><tr><th>内容</th><th align="center">参数</th></tr></thead><tbody><tr><td>湿度测量范围</td><td align="center">20%~95%测量误差：±5%</td></tr><tr><td>温度测量范围</td><td align="center">0~50℃测量误差：±2%</td></tr><tr><td>解析度</td><td align="center">湿度0.1%，温度0.1℃</td></tr><tr><td>工作电压</td><td align="center">3V~5.5V DC</td></tr><tr><td>采样周期</td><td align="center">1秒</td></tr></tbody></table><p><img src="/images/DSC05815.jpg" alt="DHT11温湿传感器"></p><h2 id="连接DHT11"><a href="#连接DHT11" class="headerlink" title="连接DHT11"></a>连接DHT11</h2><hr><p>VCC接3V3，GND连地，DATA接GPIO5（D1）。</p><p><img src="/images/202004231923.png" alt="接线图"></p><h2 id="安装DHT库"><a href="#安装DHT库" class="headerlink" title="安装DHT库"></a>安装DHT库</h2><hr><ol><li>打开Arduino IDE，<strong>项目</strong> -&gt; <strong>加载库</strong> -&gt; <strong>管理库</strong>；</li><li>搜索<strong>DHT</strong>，找到<strong>DHT sensor library by Adafruit</strong>并安装；</li><li>搜索<strong>Adafruit Unified Sensor</strong>，找到<strong>Adafruit Unified Sensor by Adafruit</strong>并安装；</li></ol><p>安装完成后重启Arduino IDE。</p><h2 id="安装异步Web服务库"><a href="#安装异步Web服务库" class="headerlink" title="安装异步Web服务库"></a>安装异步Web服务库</h2><hr><p>要构建异步Web服务需要安装这两个库：<a href="https://github.com/me-no-dev/ESPAsyncWebServer">ESPAsyncWebServer</a>和<a href="https://github.com/me-no-dev/ESPAsyncTCP">ESPAsync TCP</a>。</p><h3 id="安装ESPAsyncWebServer库"><a href="#安装ESPAsyncWebServer库" class="headerlink" title="安装ESPAsyncWebServer库"></a>安装ESPAsyncWebServer库</h3><ol><li>下载<a href="https://github.com/me-no-dev/ESPAsyncWebServer/archive/master.zip">安装ESPAsyncWebServer</a>压缩文件；</li><li>解压后得到文件夹<em>ESPAsyncWebServer-master</em>；</li><li>重命名文件夹<em>ESPAsyncWebServer-master</em>为<em>ESPAsyncWebServer</em>；</li><li>复制文件夹到你的Arduino IDE的库文件夹，笔者的Arduino IDE的库文件夹为<code>C:\Users\junle\Documents\Arduino\libraries</code>。</li></ol><h3 id="ESPAsync-TCP库"><a href="#ESPAsync-TCP库" class="headerlink" title="ESPAsync TCP库"></a>ESPAsync TCP库</h3><ol><li>下载<a href="https://github.com/me-no-dev/ESPAsyncTCP/archive/master.zip">安装ESPAsyncWebServer</a>压缩文件；</li><li>解压后得到文件夹<em>ESPAsyncTCP-master</em>；</li><li>重命名文件夹<em>ESPAsyncTCP-master</em>为<em>ESPAsyncTCP</em>；</li><li>复制文件夹到你的Arduino IDE的库文件夹，笔者的Arduino IDE的库文件夹为<code>C:\Users\junle\Documents\Arduino\libraries</code>。<br>安装完成后重启Arduino IDE。</li></ol><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><hr><p>打开您的Arduino IDE并复制以下代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Arduino.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Hash.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESPAsyncTCP.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESPAsyncWebServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Adafruit_Sensor.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;DHT.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DHTPIN 5     <span class="comment">//DHT数据Pin连接GPIO5</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DHTTYPE    DHT11     <span class="comment">//DHT 11</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid = <span class="string">&quot;REPLACE_WITH_YOUR_SSID&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;REPLACE_WITH_YOUR_PASSWORD&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">DHT <span class="title">dht</span><span class="params">(DHTPIN, DHTTYPE)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> temperature = <span class="number">0.0</span>;</span><br><span class="line"><span class="type">float</span> humidity = <span class="number">0.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">AsyncWebServer <span class="title">server</span><span class="params">(<span class="number">80</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> previousMillis = <span class="number">0</span>;    <span class="comment">// 记录DHT上次的采样时间</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">long</span> interval = <span class="number">10000</span>;  <span class="comment">//每10秒读取一次DHT数据</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> index_html[] PROGMEM = <span class="string">R&quot;rawliteral(</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE HTML&gt;&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</span></span><br><span class="line"><span class="string">  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://use.fontawesome.com/releases/v5.7.2/css/all.css&quot; integrity=&quot;sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr&quot; crossorigin=&quot;anonymous&quot;&gt;</span></span><br><span class="line"><span class="string">  &lt;style&gt;</span></span><br><span class="line"><span class="string">    html &#123;</span></span><br><span class="line"><span class="string">     font-family: Arial;</span></span><br><span class="line"><span class="string">     display: inline-block;</span></span><br><span class="line"><span class="string">     margin: 0px auto;</span></span><br><span class="line"><span class="string">     text-align: center;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    h2 &#123; font-size: 3.0rem; &#125;</span></span><br><span class="line"><span class="string">    p &#123; font-size: 3.0rem; &#125;</span></span><br><span class="line"><span class="string">    .units &#123; font-size: 1.2rem; &#125;</span></span><br><span class="line"><span class="string">    .dht-labels&#123;</span></span><br><span class="line"><span class="string">      font-size: 1.5rem;</span></span><br><span class="line"><span class="string">      vertical-align:middle;</span></span><br><span class="line"><span class="string">      padding-bottom: 15px;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">  &lt;h2&gt;ESP8266 DHT Server&lt;/h2&gt;</span></span><br><span class="line"><span class="string">  &lt;p&gt;</span></span><br><span class="line"><span class="string">    &lt;i class=&quot;fas fa-thermometer-half&quot; style=&quot;color:#059e8a;&quot;&gt;&lt;/i&gt; </span></span><br><span class="line"><span class="string">    &lt;span class=&quot;dht-labels&quot;&gt;Temperature&lt;/span&gt; </span></span><br><span class="line"><span class="string">    &lt;span id=&quot;temperature&quot;&gt;%TEMPERATURE%&lt;/span&gt;</span></span><br><span class="line"><span class="string">    &lt;sup class=&quot;units&quot;&gt;&amp;deg;C&lt;/sup&gt;</span></span><br><span class="line"><span class="string">  &lt;/p&gt;</span></span><br><span class="line"><span class="string">  &lt;p&gt;</span></span><br><span class="line"><span class="string">    &lt;i class=&quot;fas fa-tint&quot; style=&quot;color:#00add6;&quot;&gt;&lt;/i&gt; </span></span><br><span class="line"><span class="string">    &lt;span class=&quot;dht-labels&quot;&gt;Humidity&lt;/span&gt;</span></span><br><span class="line"><span class="string">    &lt;span id=&quot;humidity&quot;&gt;%HUMIDITY%&lt;/span&gt;</span></span><br><span class="line"><span class="string">    &lt;sup class=&quot;units&quot;&gt;%&lt;/sup&gt;</span></span><br><span class="line"><span class="string">  &lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">setInterval(function ( ) &#123;</span></span><br><span class="line"><span class="string">  var xhttp = new XMLHttpRequest();</span></span><br><span class="line"><span class="string">  xhttp.onreadystatechange = function() &#123;</span></span><br><span class="line"><span class="string">    if (this.readyState == 4 &amp;&amp; this.status == 200) &#123;</span></span><br><span class="line"><span class="string">      document.getElementById(&quot;temperature&quot;).innerHTML = this.responseText;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;;</span></span><br><span class="line"><span class="string">  xhttp.open(&quot;GET&quot;, &quot;/temperature&quot;, true);</span></span><br><span class="line"><span class="string">  xhttp.send();</span></span><br><span class="line"><span class="string">&#125;, 10000 ) ;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">setInterval(function ( ) &#123;</span></span><br><span class="line"><span class="string">  var xhttp = new XMLHttpRequest();</span></span><br><span class="line"><span class="string">  xhttp.onreadystatechange = function() &#123;</span></span><br><span class="line"><span class="string">    if (this.readyState == 4 &amp;&amp; this.status == 200) &#123;</span></span><br><span class="line"><span class="string">      document.getElementById(&quot;humidity&quot;).innerHTML = this.responseText;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;;</span></span><br><span class="line"><span class="string">  xhttp.open(&quot;GET&quot;, &quot;/humidity&quot;, true);</span></span><br><span class="line"><span class="string">  xhttp.send();</span></span><br><span class="line"><span class="string">&#125;, 10000 ) ;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;)rawliteral&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Replaces placeholder with DHT values</span></span><br><span class="line"><span class="function">String <span class="title">processor</span><span class="params">(<span class="type">const</span> String&amp; var)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(var == <span class="string">&quot;TEMPERATURE&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">String</span>(temperature);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(var == <span class="string">&quot;HUMIDITY&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">String</span>(humidity);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">String</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup</span><span class="params">()</span></span>&#123;</span><br><span class="line">  Serial.<span class="built_in">begin</span>(<span class="number">115200</span>);</span><br><span class="line">  dht.<span class="built_in">begin</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//链接Wifi</span></span><br><span class="line">  WiFi.<span class="built_in">begin</span>(ssid, password);</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;Connecting to WiFi&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> (WiFi.<span class="built_in">status</span>() != WL_CONNECTED) &#123;</span><br><span class="line">    <span class="built_in">delay</span>(<span class="number">1000</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//打印IP</span></span><br><span class="line">  Serial.<span class="built_in">println</span>(WiFi.<span class="built_in">localIP</span>());</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  server.<span class="built_in">on</span>(<span class="string">&quot;/&quot;</span>, HTTP_GET, [](AsyncWebServerRequest *request)&#123;</span><br><span class="line">    request-&gt;<span class="built_in">send_P</span>(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, index_html, processor);</span><br><span class="line">  &#125;);</span><br><span class="line">  server.<span class="built_in">on</span>(<span class="string">&quot;/temperature&quot;</span>, HTTP_GET, [](AsyncWebServerRequest *request)&#123;</span><br><span class="line">    request-&gt;<span class="built_in">send_P</span>(<span class="number">200</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="built_in">String</span>(temperature).<span class="built_in">c_str</span>());</span><br><span class="line">  &#125;);</span><br><span class="line">  server.<span class="built_in">on</span>(<span class="string">&quot;/humidity&quot;</span>, HTTP_GET, [](AsyncWebServerRequest *request)&#123;</span><br><span class="line">    request-&gt;<span class="built_in">send_P</span>(<span class="number">200</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="built_in">String</span>(humidity).<span class="built_in">c_str</span>());</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//开启服务</span></span><br><span class="line">  server.<span class="built_in">begin</span>();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loop</span><span class="params">()</span></span>&#123;  </span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> currentMillis = <span class="built_in">millis</span>();</span><br><span class="line">  <span class="keyword">if</span> (currentMillis - previousMillis &gt;= interval) &#123;</span><br><span class="line">    previousMillis = currentMillis;</span><br><span class="line">    <span class="comment">//读取温度</span></span><br><span class="line">    <span class="type">float</span> newTemperature = dht.<span class="built_in">readTemperature</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isnan</span>(newTemperature)) &#123;</span><br><span class="line">      Serial.<span class="built_in">println</span>(<span class="string">&quot;Failed to read from DHT sensor!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      temperature = newTemperature;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//读取湿度</span></span><br><span class="line">    <span class="type">float</span> newHumidity = dht.<span class="built_in">readHumidity</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isnan</span>(newHumidity)) &#123;</span><br><span class="line">      Serial.<span class="built_in">println</span>(<span class="string">&quot;Failed to read from DHT sensor!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      humidity = newHumidity;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>你还需要使用你所在的局域网的Wifi的ssid和密码代替以下内容：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid = <span class="string">&quot;REPLACE_WITH_YOUR_SSID&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;REPLACE_WITH_YOUR_PASSWORD&quot;</span>;</span><br></pre></td></tr></table></figure><h2 id="编译代码并下载到ESP8266"><a href="#编译代码并下载到ESP8266" class="headerlink" title="编译代码并下载到ESP8266"></a>编译代码并下载到ESP8266</h2><hr><p>编译你的代码并下载到ESP8266开发板，打开串口监视器，程序启动并连接你的Wifi后将IP地址打印到监视器中；在浏览器中访问该IP即可。</p>]]></content>
    
    
    <summary type="html">本文介绍使用Arduino IDE开发一个显示温湿度的Web服务器DHT11温湿传感器，供局域网内的任何设备访问。</summary>
    
    
    
    
    <category term="ESP8266" scheme="https://www.junle.org/tags/ESP8266/"/>
    
    <category term="Arduino" scheme="https://www.junle.org/tags/Arduino/"/>
    
  </entry>
  
  <entry>
    <title>ESP8266开发板NodeMcu开发-搭建Arduino IDE开发环境</title>
    <link href="https://www.junle.org/ESP8266%E5%BC%80%E5%8F%91%E6%9D%BFNodeMcu%E5%BC%80%E5%8F%91-%E6%90%AD%E5%BB%BAArduino-IDE%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"/>
    <id>https://www.junle.org/ESP8266%E5%BC%80%E5%8F%91%E6%9D%BFNodeMcu%E5%BC%80%E5%8F%91-%E6%90%AD%E5%BB%BAArduino-IDE%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/</id>
    <published>2020-04-22T12:14:10.000Z</published>
    <updated>2024-03-22T06:43:55.670Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.arduino.cc/en/Main/Software">Arduino IDE</a>是<a href="https://www.arduino.cc/">Arduino公司</a>提供的集成开发软件，Arduino是一家制作开源硬件和开源软件的公司。Arduino是一套以Java编写的跨平台应用软件，使用与C语言和C++语言相仿的编程语言开发，主要针对Arduino系列的开发板编程。</p><p>本文介绍通过简单的配置可以在Arduino IDE中添加对ESP8266开发板的支持。</p><span id="more"></span><h2 id="安装Arduino-IDE"><a href="#安装Arduino-IDE" class="headerlink" title="安装Arduino IDE"></a>安装Arduino IDE</h2><ol><li>到官方网站下载页面下载<a href="https://www.arduino.cc/en/Main/Software">Arduino IDE</a>(建议下载最新版本)，选择<code>Windows Installer, for Windows 7 and up</code> (建议下载Installer版本);</li><li>Installer版本请开启安装档，依照步骤安装；ZIP版本直接解压缩即可使用;</li></ol><h2 id="添加ESP8266支持"><a href="#添加ESP8266支持" class="headerlink" title="添加ESP8266支持"></a>添加ESP8266支持</h2><p>Arduino IDE安装完成后，打开软件 <strong>文件</strong> -&gt; <strong>首选项</strong>  的设置页面，在附加开发板管理器网站中添加以下URL：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">https://<span class="title">arduino.esp8266.com</span>/<span class="title">stable</span>/<span class="title">package_esp8266com_index.json</span></span></span><br></pre></td></tr></table></figure><p><img src="/images/202004221949.png" alt="添加ESP8266 URL"><br>打开 <strong>工具</strong> -&gt; <strong>开发板: “xxxx”</strong> -&gt; <strong>开发板管理器…</strong>  等待下载平台索引，搜索中输入 <strong>ESP8266</strong>  找到ESP8266并安装。<br><img src="/images/202004221958.png" alt="安装ESP8266支持"><br>安装完成后重启Arduino IDE软件，在  <strong>工具</strong> -&gt;  <strong>开发板</strong> 选项中即可看到ESP8266开发板选项：<br><img src="/images/202004222008.png" alt="安装完成"><br>对于笔者购买的开发板这里选择的是 <strong>NodeMCU 1.0 (ESP-12E Module)</strong> 。<br>至此ESP8266开发板的Arduino IDE开发环境搭建完成。</p>]]></content>
    
    
    <summary type="html">Arduino IDE是Arduino公司提供的集成开发软件，Arduino是一家制作开源硬件和开源软件的公司。Arduino是一套以Java编写的跨平台应用软件，使用与C语言和C++语言相仿的编程语言开发，主要针对Arduino系列的开发板编程。</summary>
    
    
    
    
    <category term="ESP8266" scheme="https://www.junle.org/tags/ESP8266/"/>
    
    <category term="Arduino" scheme="https://www.junle.org/tags/Arduino/"/>
    
  </entry>
  
  <entry>
    <title>ESP8266开发板NodeMcu开发-NodeMcu介绍</title>
    <link href="https://www.junle.org/ESP8266%E5%BC%80%E5%8F%91%E6%9D%BFNodeMcu%E5%BC%80%E5%8F%91-NodeMcu%E4%BB%8B%E7%BB%8D/"/>
    <id>https://www.junle.org/ESP8266%E5%BC%80%E5%8F%91%E6%9D%BFNodeMcu%E5%BC%80%E5%8F%91-NodeMcu%E4%BB%8B%E7%BB%8D/</id>
    <published>2020-04-22T09:07:56.000Z</published>
    <updated>2024-03-22T06:43:55.669Z</updated>
    
    <content type="html"><![CDATA[<h2 id="NodeMcu简介"><a href="#NodeMcu简介" class="headerlink" title="NodeMcu简介"></a>NodeMcu简介</h2><p><a href="https://www.nodemcu.com/index_en.html">NodeMcu</a>是一款运行于乐鑫ESP8266芯片之中的可编程固件，是超简单的物联网开发平台。他以lua语言为基础，同时提供了封装ESP8266硬件操作的高级API，可以让开发者以类似于arduino的方式与底层硬件打交道，使软件开发人员轻松地操作设备；同时NodeMcu还提供了时间驱动型网络API， Nodejs风格的编程方式更是让互联网开发人员如鱼得水。</p><span id="more"></span><h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><p>ESP8266对封装模块ESP12进行了扩展，包括了：</p><ul><li><p>D1~D10：均可服用位GPIO， PWM， I2C, 1-Wire</p></li><li><p>A0：1路ADC</p></li><li><p>USB供电</p></li><li><p>USB转串口调试接口</p></li></ul><p>可用RAM位20Kbyte：目前采用4M Flash，用户可用存储空间150Kbyte。</p><p>NodeMcu开发板的价格非常便宜，某宝上一搜就能找到，笔者购买的是CP20102芯片USB转串口的开发板。</p><p><img src="/images/DSC00013.jpg" alt="NodeMcu"></p>]]></content>
    
    
    <summary type="html">NodeMcu是一款运行于乐鑫ESP8266芯片之中的可编程固件，是超简单的物联网开发平台。</summary>
    
    
    
    
    <category term="ESP8266" scheme="https://www.junle.org/tags/ESP8266/"/>
    
  </entry>
  
  <entry>
    <title>树莓派4b GPIO引脚图</title>
    <link href="https://www.junle.org/%E6%A0%91%E8%8E%93%E6%B4%BE4b-GPIO%E5%BC%95%E8%84%9A%E5%9B%BE/"/>
    <id>https://www.junle.org/%E6%A0%91%E8%8E%93%E6%B4%BE4b-GPIO%E5%BC%95%E8%84%9A%E5%9B%BE/</id>
    <published>2020-04-20T09:07:56.000Z</published>
    <updated>2024-03-22T06:43:55.705Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/GPIO-Pinout-Diagram-2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img src=&quot;/images/GPIO-Pinout-Diagram-2.png&quot;&gt;&lt;/p&gt;
</summary>
      
    
    
    
    
    <category term="RaspberryPI" scheme="https://www.junle.org/tags/RaspberryPI/"/>
    
  </entry>
  
  <entry>
    <title>物联网ESP8266开发板NodeMcu引脚图</title>
    <link href="https://www.junle.org/%E7%89%A9%E8%81%94%E7%BD%91ESP8266%E5%BC%80%E5%8F%91%E6%9D%BFNodeMcu%E5%BC%95%E8%84%9A%E5%9B%BE/"/>
    <id>https://www.junle.org/%E7%89%A9%E8%81%94%E7%BD%91ESP8266%E5%BC%80%E5%8F%91%E6%9D%BFNodeMcu%E5%BC%95%E8%84%9A%E5%9B%BE/</id>
    <published>2020-04-20T08:14:03.000Z</published>
    <updated>2024-03-22T06:43:55.708Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/node_mcu_lua_pin.png"></p><p><img src="/images/esp8266_devkit_horizontal-001.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img src=&quot;/images/node_mcu_lua_pin.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/esp8266_devkit_horizontal-001.png&quot;&gt;&lt;/p&gt;
</summary>
      
    
    
    
    
    <category term="ESP8266" scheme="https://www.junle.org/tags/ESP8266/"/>
    
  </entry>
  
  <entry>
    <title>树莓派4b VNC链接提示Cannot currently show the Desktop</title>
    <link href="https://www.junle.org/%E6%A0%91%E8%8E%93%E6%B4%BE4b-VNC%E9%93%BE%E6%8E%A5%E6%8F%90%E7%A4%BACannot-currently-show-the-Desktop/"/>
    <id>https://www.junle.org/%E6%A0%91%E8%8E%93%E6%B4%BE4b-VNC%E9%93%BE%E6%8E%A5%E6%8F%90%E7%A4%BACannot-currently-show-the-Desktop/</id>
    <published>2020-04-15T07:47:24.000Z</published>
    <updated>2024-03-22T06:43:55.706Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>树莓派4b在设置VNC后使用VNC Viewer链接后提示：<strong>Cannot currently show the Desktop</strong>，无法显示桌面。</p><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>开启VNC功能后还需要设置桌面的分辨率，方法如下：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo raspi-config</span><br></pre></td></tr></table></figure><p>在菜单选择<strong>advanced</strong> -&gt; <strong>Resolution</strong>：</p><p><img src="/images/raspi_advanced.png"></p><p>选择要设置的分辨率：</p><p><img src="/images/raspi_resolution.png"></p><p>设置完成后选择<strong>Finish</strong>并重启树莓派，重启后重新连接VNC Viewer即可。</p>]]></content>
    
    
    <summary type="html">树莓派4b VNC链接提示Cannot currently show the Desktop</summary>
    
    
    
    
    <category term="RaspberryPI" scheme="https://www.junle.org/tags/RaspberryPI/"/>
    
  </entry>
  
  <entry>
    <title>树莓派4b Oops - unable to determine board type... model: 17</title>
    <link href="https://www.junle.org/%E6%A0%91%E8%8E%93%E6%B4%BE4b-Oops-unable-to-determine-board-type-model-17/"/>
    <id>https://www.junle.org/%E6%A0%91%E8%8E%93%E6%B4%BE4b-Oops-unable-to-determine-board-type-model-17/</id>
    <published>2020-04-12T08:20:38.000Z</published>
    <updated>2024-03-22T06:43:55.706Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>树莓派4b在执行<strong>gpio readall</strong>出错</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">pi@raspberrypi:~ $ <span class="title">gpio</span> <span class="title">readall</span></span></span><br><span class="line"><span class="function"><span class="title">Oops</span> - <span class="title">unable</span> <span class="title">to</span> <span class="title">determine</span> <span class="title">board</span> <span class="title">type</span>... <span class="title">model</span>: 17</span></span><br></pre></td></tr></table></figure><span id="more"></span><p>当前wiringPi版本：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">pi@raspberrypi:~ $ <span class="title">gpio</span> -<span class="title">v</span></span></span><br><span class="line"><span class="function"><span class="title">gpio</span> <span class="title">version</span>: 2.50</span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">c</span>) 2012-2018 <span class="title">Gordon</span> <span class="title">Henderson</span></span></span><br><span class="line"><span class="function"><span class="title">This</span> <span class="title">is</span> <span class="title">free</span> <span class="title">software</span> <span class="title">with</span> <span class="title">ABSOLUTELY</span> <span class="title">NO</span> <span class="title">WARRANTY</span>.</span></span><br><span class="line"><span class="function"><span class="title">For</span> <span class="title">details</span> <span class="title">type</span>: <span class="title">gpio</span> -<span class="title">warranty</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Raspberry</span> <span class="title">Pi</span> <span class="title">Details</span>:</span></span><br><span class="line"><span class="function">  <span class="title">Type</span>: <span class="title">Unknown17</span>, <span class="title">Revision</span>: 01, <span class="title">Memory</span>: 0<span class="title">MB</span>, <span class="title">Maker</span>: <span class="title">Sony</span></span></span><br><span class="line"><span class="function">  * <span class="title">Device</span> <span class="title">tree</span> <span class="title">is</span> <span class="title">enabled</span>.</span></span><br><span class="line"><span class="function">  *--&gt; <span class="title">Raspberry</span> <span class="title">Pi</span> 4 <span class="title">Model</span> <span class="title">B</span> <span class="title">Rev</span> 1.1</span></span><br><span class="line"><span class="function">  * <span class="title">This</span> <span class="title">Raspberry</span> <span class="title">Pi</span> <span class="title">supports</span> <span class="title">user</span>-<span class="title">level</span> <span class="title">GPIO</span> <span class="title">access</span>.</span></span><br></pre></td></tr></table></figure><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>按以下方法更新wiringPi：<br><a href="http://wiringpi.com/wiringpi-updated-to-2-52-for-the-raspberry-pi-4b/">http://wiringpi.com/wiringpi-updated-to-2-52-for-the-raspberry-pi-4b/</a><br>更新后wiringPi版本:</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">pi@raspberrypi:/<span class="title">tmp</span> $ <span class="title">gpio</span> -<span class="title">v</span></span></span><br><span class="line"><span class="function"><span class="title">gpio</span> <span class="title">version</span>: 2.52</span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">c</span>) 2012-2018 <span class="title">Gordon</span> <span class="title">Henderson</span></span></span><br><span class="line"><span class="function"><span class="title">This</span> <span class="title">is</span> <span class="title">free</span> <span class="title">software</span> <span class="title">with</span> <span class="title">ABSOLUTELY</span> <span class="title">NO</span> <span class="title">WARRANTY</span>.</span></span><br><span class="line"><span class="function"><span class="title">For</span> <span class="title">details</span> <span class="title">type</span>: <span class="title">gpio</span> -<span class="title">warranty</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Raspberry</span> <span class="title">Pi</span> <span class="title">Details</span>:</span></span><br><span class="line"><span class="function">  <span class="title">Type</span>: <span class="title">Pi</span> 4<span class="title">B</span>, <span class="title">Revision</span>: 01, <span class="title">Memory</span>: 2048<span class="title">MB</span>, <span class="title">Maker</span>: <span class="title">Sony</span></span></span><br><span class="line"><span class="function">  * <span class="title">Device</span> <span class="title">tree</span> <span class="title">is</span> <span class="title">enabled</span>.</span></span><br><span class="line"><span class="function">  *--&gt; <span class="title">Raspberry</span> <span class="title">Pi</span> 4 <span class="title">Model</span> <span class="title">B</span> <span class="title">Rev</span> 1.1</span></span><br><span class="line"><span class="function">  * <span class="title">This</span> <span class="title">Raspberry</span> <span class="title">Pi</span> <span class="title">supports</span> <span class="title">user</span>-<span class="title">level</span> <span class="title">GPIO</span> <span class="title">access</span>.</span></span><br></pre></td></tr></table></figure><p>执行<strong>gpio readall</strong>命令：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">pi@raspberrypi:/<span class="title">tmp</span> $ <span class="title">gpio</span> <span class="title">readall</span></span></span><br><span class="line"><span class="function"> +-----+-----+---------+------+---+---<span class="title">Pi</span> 4<span class="title">B</span>--+---+------+---------+-----+-----+</span></span><br><span class="line"><span class="function"> | <span class="title">BCM</span> | <span class="title">wPi</span> |   <span class="title">Name</span>  | <span class="title">Mode</span> | <span class="title">V</span> | <span class="title">Physical</span> | <span class="title">V</span> | <span class="title">Mode</span> | <span class="title">Name</span>    | <span class="title">wPi</span> | <span class="title">BCM</span> |</span></span><br><span class="line"><span class="function"> +-----+-----+---------+------+---+----++----+---+------+---------+-----+-----+</span></span><br><span class="line"><span class="function"> |     |     |    3.3<span class="title">v</span> |      |   |  1 || 2  |   |      | 5<span class="title">v</span>      |     |     |</span></span><br><span class="line"><span class="function"> |   2 |   8 |   <span class="title">SDA</span>.1 |   <span class="title">IN</span> | 1 |  3 || 4  |   |      | 5<span class="title">v</span>      |     |     |</span></span><br><span class="line"><span class="function"> |   3 |   9 |   <span class="title">SCL</span>.1 |   <span class="title">IN</span> | 1 |  5 || 6  |   |      | 0<span class="title">v</span>      |     |     |</span></span><br><span class="line"><span class="function"> |   4 |   7 | <span class="title">GPIO</span>. 7 |   <span class="title">IN</span> | 1 |  7 || 8  | 1 | <span class="title">IN</span>   | <span class="title">TxD</span>     | 15  | 14  |</span></span><br><span class="line"><span class="function"> |     |     |      0<span class="title">v</span> |      |   |  9 || 10 | 1 | <span class="title">IN</span>   | <span class="title">RxD</span>     | 16  | 15  |</span></span><br><span class="line"><span class="function"> |  17 |   0 | <span class="title">GPIO</span>. 0 |   <span class="title">IN</span> | 0 | 11 || 12 | 0 | <span class="title">IN</span>   | <span class="title">GPIO</span>. 1 | 1   | 18  |</span></span><br><span class="line"><span class="function"> |  27 |   2 | <span class="title">GPIO</span>. 2 |   <span class="title">IN</span> | 0 | 13 || 14 |   |      | 0<span class="title">v</span>      |     |     |</span></span><br><span class="line"><span class="function"> |  22 |   3 | <span class="title">GPIO</span>. 3 |   <span class="title">IN</span> | 0 | 15 || 16 | 0 | <span class="title">IN</span>   | <span class="title">GPIO</span>. 4 | 4   | 23  |</span></span><br><span class="line"><span class="function"> |     |     |    3.3<span class="title">v</span> |      |   | 17 || 18 | 0 | <span class="title">IN</span>   | <span class="title">GPIO</span>. 5 | 5   | 24  |</span></span><br><span class="line"><span class="function"> |  10 |  12 |    <span class="title">MOSI</span> |   <span class="title">IN</span> | 0 | 19 || 20 |   |      | 0<span class="title">v</span>      |     |     |</span></span><br><span class="line"><span class="function"> |   9 |  13 |    <span class="title">MISO</span> |   <span class="title">IN</span> | 0 | 21 || 22 | 0 | <span class="title">IN</span>   | <span class="title">GPIO</span>. 6 | 6   | 25  |</span></span><br><span class="line"><span class="function"> |  11 |  14 |    <span class="title">SCLK</span> |   <span class="title">IN</span> | 0 | 23 || 24 | 1 | <span class="title">IN</span>   | <span class="title">CE0</span>     | 10  | 8   |</span></span><br><span class="line"><span class="function"> |     |     |      0<span class="title">v</span> |      |   | 25 || 26 | 1 | <span class="title">IN</span>   | <span class="title">CE1</span>     | 11  | 7   |</span></span><br><span class="line"><span class="function"> |   0 |  30 |   <span class="title">SDA</span>.0 |   <span class="title">IN</span> | 1 | 27 || 28 | 1 | <span class="title">IN</span>   | <span class="title">SCL</span>.0   | 31  | 1   |</span></span><br><span class="line"><span class="function"> |   5 |  21 | <span class="title">GPIO</span>.21 |   <span class="title">IN</span> | 1 | 29 || 30 |   |      | 0<span class="title">v</span>      |     |     |</span></span><br><span class="line"><span class="function"> |   6 |  22 | <span class="title">GPIO</span>.22 |   <span class="title">IN</span> | 1 | 31 || 32 | 0 | <span class="title">IN</span>   | <span class="title">GPIO</span>.26 | 26  | 12  |</span></span><br><span class="line"><span class="function"> |  13 |  23 | <span class="title">GPIO</span>.23 |   <span class="title">IN</span> | 0 | 33 || 34 |   |      | 0<span class="title">v</span>      |     |     |</span></span><br><span class="line"><span class="function"> |  19 |  24 | <span class="title">GPIO</span>.24 |   <span class="title">IN</span> | 0 | 35 || 36 | 0 | <span class="title">IN</span>   | <span class="title">GPIO</span>.27 | 27  | 16  |</span></span><br><span class="line"><span class="function"> |  26 |  25 | <span class="title">GPIO</span>.25 |   <span class="title">IN</span> | 0 | 37 || 38 | 0 | <span class="title">IN</span>   | <span class="title">GPIO</span>.28 | 28  | 20  |</span></span><br><span class="line"><span class="function"> |     |     |      0<span class="title">v</span> |      |   | 39 || 40 | 0 | <span class="title">IN</span>   | <span class="title">GPIO</span>.29 | 29  | 21  |</span></span><br><span class="line"><span class="function"> +-----+-----+---------+------+---+----++----+---+------+---------+-----+-----+</span></span><br><span class="line"><span class="function"> | <span class="title">BCM</span> | <span class="title">wPi</span> |   <span class="title">Name</span>  | <span class="title">Mode</span> | <span class="title">V</span> | <span class="title">Physical</span> | <span class="title">V</span> | <span class="title">Mode</span> | <span class="title">Name</span>    | <span class="title">wPi</span> | <span class="title">BCM</span> |</span></span><br><span class="line"><span class="function"> +-----+-----+---------+------+---+---<span class="title">Pi</span> 4<span class="title">B</span>--+---+------+---------+-----+-----+</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">树莓派4b Oops - unable to determine board type... model: 17...</summary>
    
    
    
    
    <category term="RaspberryPI" scheme="https://www.junle.org/tags/RaspberryPI/"/>
    
  </entry>
  
  <entry>
    <title>树莓派4b安装官方系统Raspbian</title>
    <link href="https://www.junle.org/%E6%A0%91%E8%8E%93%E6%B4%BE4b%E5%AE%89%E8%A3%85%E5%AE%98%E6%96%B9%E7%B3%BB%E7%BB%9FRaspbian/"/>
    <id>https://www.junle.org/%E6%A0%91%E8%8E%93%E6%B4%BE4b%E5%AE%89%E8%A3%85%E5%AE%98%E6%96%B9%E7%B3%BB%E7%BB%9FRaspbian/</id>
    <published>2020-04-12T04:42:40.000Z</published>
    <updated>2024-03-22T06:43:55.707Z</updated>
    
    <content type="html"><![CDATA[<p>本文介绍通过NOOBS安装Raspbin系统，New Out Of Box Software (NOOBS)是Raspberry Pi操作系统安装管理器。</p><h2 id="准备内容"><a href="#准备内容" class="headerlink" title="准备内容"></a>准备内容</h2><ul><li>树莓派4b</li><li>树莓派电源</li><li>鼠标键盘</li><li>Micro HDMI转HDMI线</li><li>带HDMI接口的显示器</li><li>tf卡</li><li>NOOBS（带系统镜像）</li></ul><h2 id="安装NOOBS"><a href="#安装NOOBS" class="headerlink" title="安装NOOBS"></a>安装NOOBS</h2><ol><li><p>格式化SD卡，文件系统为FAT，安装完全版的Raspbian至少需要16GB的SD卡空间。</p></li><li><p>下载NOOBS压缩包。<br>可以在Raspberry Pi网站上下载NOOBS：<a href="https://www.raspberrypi.org/downloads/noobs/">https://www.raspberrypi.org/downloads/noobs/</a><br>官方提供两个版本的：NOOBS和NOOBS Lite</p></li></ol><ul><li>NOOBS包含Raspbian系统镜像，可离线安装系统；</li><li>NOOBS Lite不包含Raspbian系统镜像，安装时需要在线下载系统镜像。<br>本文使用NOOBS安装。</li></ul><ol start="3"><li>下载完成后解压缩文件到SD卡根目录。</li></ol><h2 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h2><ol><li>将SD卡插入树莓派背面的SD卡插槽，链接硬件，最后接通电源。</li></ol>]]></content>
    
    
    <summary type="html">本文介绍通过NOOBS安装Raspbin系统，New Out Of Box Software (NOOBS)是Raspberry Pi操作系统安装管理器。</summary>
    
    
    
    
    <category term="RaspberryPI" scheme="https://www.junle.org/tags/RaspberryPI/"/>
    
  </entry>
  
  <entry>
    <title>如何还原SQLServer master数据库</title>
    <link href="https://www.junle.org/%E5%A6%82%E4%BD%95%E8%BF%98%E5%8E%9FSQLServer-master%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    <id>https://www.junle.org/%E5%A6%82%E4%BD%95%E8%BF%98%E5%8E%9FSQLServer-master%E6%95%B0%E6%8D%AE%E5%BA%93/</id>
    <published>2019-08-14T02:38:47.000Z</published>
    <updated>2024-03-22T06:43:55.702Z</updated>
    
    <content type="html"><![CDATA[<p><strong>注意：SQLServer的master数据库只能还原到版本号相同的SQLServer实例</strong></p><p>执行命令<code>select @@version;</code>查询当前SQLServer实例的版本号：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Microsoft SQL Server <span class="number">2005</span> - <span class="number">9</span>.<span class="number">00</span>.<span class="number">5324</span>.<span class="number">00</span></span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="备份master数据库"><a href="#备份master数据库" class="headerlink" title="备份master数据库"></a>备份master数据库</h2><p>执行以下SQL语句，备份master数据库到<code>D:\master.bak</code>目录：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BACKUP DATABASE master <span class="keyword">TO</span> DISK <span class="operator">=</span> <span class="string">&#x27;D:\master.bak&#x27;</span> <span class="keyword">WITH</span> REPLACE;</span><br></pre></td></tr></table></figure><h2 id="备份Service-Master-Key"><a href="#备份Service-Master-Key" class="headerlink" title="备份Service Master Key"></a>备份Service Master Key</h2><p>执行以下SQL语句，备份master数据库到<code>D:\smk.bak</code>目录：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BACKUP SERVICE MASTER KEY <span class="keyword">TO</span> FILE<span class="operator">=</span>N<span class="string">&#x27;D:\smk.bak&#x27;</span> ENCRYPTION <span class="keyword">BY</span> PASSWORD <span class="operator">=</span>  <span class="string">&#x27;password&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="进入单用户模式"><a href="#进入单用户模式" class="headerlink" title="进入单用户模式"></a>进入单用户模式</h2><p>在server中找到SQL Server(MSSQLSERVER)的服务，停止后，在参数项中加入“-m”：<br><img src="/images/20190814084601.png" alt="SQL Server(MSSQLSERVER)"><br>如果进入单用户模式之后，却一个用户都不可以登录，可以在服务器上运行“netstat -ano | findstr 1433”查看SQLSERVER的端口，查看是否已经有用户在登录；</p><h2 id="还原master数据库"><a href="#还原master数据库" class="headerlink" title="还原master数据库"></a>还原master数据库</h2><p>打开命令提示符工具输入以下代码还原master数据库</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sqlcmd</span></span></span><br><span class="line"><span class="function">  1&gt; <span class="title">RESTORE</span> <span class="title">DATABASE</span> <span class="title">master</span> <span class="title">FROM</span> <span class="title">DISK</span>=&#x27;<span class="title">D</span>:\<span class="title">master.bak</span>&#x27; <span class="title">WITH</span> <span class="title">REPLACE</span>;</span></span><br><span class="line"><span class="function">  2&gt; <span class="title">GO</span></span></span><br></pre></td></tr></table></figure><h2 id="重新启动SQLServer"><a href="#重新启动SQLServer" class="headerlink" title="重新启动SQLServer"></a>重新启动SQLServer</h2><p>如果还原master数据库后，SQLSERVER的服务无法开启，请注意是否因为备份的实例的master数据库路径与还原的实例的master数据库路径不一致导致的，可查看windows应用程序日志查看报错原因。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">日志名称:          Application</span><br><span class="line">来源:            MSSQLSERVER</span><br><span class="line">日期:            2019/8/13 16:38:22</span><br><span class="line">事件 ID:         17207</span><br><span class="line">任务类别:          (2)</span><br><span class="line">级别:            错误</span><br><span class="line">关键字:           经典</span><br><span class="line">用户:            暂缺</span><br><span class="line">计算机:           test</span><br><span class="line">描述:</span><br><span class="line">FileMgr::StartLogFiles: Operating system error 2(系统找不到指定的文件。) occurred while creating or opening file &#x27;C:\Program Files (x86)\Microsoft SQL Server\MSSQL.1\MSSQL\DATA\mssqlsystemresource.ldf&#x27;. Diagnose and correct the operating system error, and retry the operation.</span><br><span class="line">事件 Xml:</span><br><span class="line"><span class="tag">&lt;<span class="name">Event</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">System</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Provider</span> <span class="attr">Name</span>=<span class="string">&quot;MSSQLSERVER&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">EventID</span> <span class="attr">Qualifiers</span>=<span class="string">&quot;49152&quot;</span>&gt;</span>17207<span class="tag">&lt;/<span class="name">EventID</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Level</span>&gt;</span>2<span class="tag">&lt;/<span class="name">Level</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Task</span>&gt;</span>2<span class="tag">&lt;/<span class="name">Task</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Keywords</span>&gt;</span>0x80000000000000<span class="tag">&lt;/<span class="name">Keywords</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TimeCreated</span> <span class="attr">SystemTime</span>=<span class="string">&quot;2019-08-13T08:38:22.403131400Z&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">EventRecordID</span>&gt;</span>4811<span class="tag">&lt;/<span class="name">EventRecordID</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Channel</span>&gt;</span>Application<span class="tag">&lt;/<span class="name">Channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Computer</span>&gt;</span>test<span class="tag">&lt;/<span class="name">Computer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Security</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">System</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">EventData</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Data</span>&gt;</span>FileMgr::StartLogFiles<span class="tag">&lt;/<span class="name">Data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Data</span>&gt;</span>2(系统找不到指定的文件。)<span class="tag">&lt;/<span class="name">Data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Data</span>&gt;</span>C:\Program Files (x86)\Microsoft SQL Server\MSSQL.1\MSSQL\DATA\mssqlsystemresource.ldf<span class="tag">&lt;/<span class="name">Data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Binary</span>&gt;</span>37430000100000000A0000005000440045002D004A005<span class="tag">&lt;/<span class="name">Binary</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">EventData</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Event</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果是，可以在命令提示符工具中执行命令</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NET</span> <span class="built_in">START</span> MSSQLSERVER /f /T3608</span><br></pre></td></tr></table></figure><p>把SQLSERVER实例启动到master-only恢复模式，再执行如下列的SQL语句，修改Master数据库中记录的其他的系统数据库的路径记录:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">USE master;</span><br><span class="line">GO</span><br><span class="line"><span class="keyword">ALTER</span> DATABASE mssqlsystemresource MODIFY FILE (NAME<span class="operator">=</span>data,FILENAME<span class="operator">=</span><span class="string">&#x27;C:\Program Files\Microsoft SQL Server\MSSQL.1\MSSQL\Data\mssqlsystemresource.mdf&#x27;</span> ); </span><br><span class="line"><span class="keyword">ALTER</span> DATABASE mssqlsystemresource MODIFY FILE </span><br><span class="line">(NAME<span class="operator">=</span>log,FILENAME<span class="operator">=</span><span class="string">&#x27;C:\Program Files\Microsoft SQL Server\MSSQL.1\MSSQL\Data\mssqlsystemresource.ldf&#x27;</span> ); </span><br><span class="line"><span class="keyword">ALTER</span> DATABASE mssqlsystemresource <span class="keyword">SET</span> READ_ONLY; </span><br><span class="line"></span><br><span class="line">USE master;</span><br><span class="line">GO</span><br><span class="line"><span class="keyword">ALTER</span> DATABASE model MODIFY FILE (NAME<span class="operator">=</span>modeldev,FILENAME<span class="operator">=</span><span class="string">&#x27;C:\Program Files\Microsoft SQL Server\MSSQL.1\MSSQL\Data\model.mdf&#x27;</span> ); </span><br><span class="line"><span class="keyword">ALTER</span> DATABASE model MODIFY FILE (NAME<span class="operator">=</span>modellog,FILENAME<span class="operator">=</span><span class="string">&#x27;C:\Program Files\Microsoft SQL Server\MSSQL.1\MSSQL\Data\modellog.ldf&#x27;</span> );</span><br><span class="line">GO</span><br><span class="line">USE master;</span><br><span class="line">GO</span><br><span class="line"><span class="keyword">ALTER</span> DATABASE msdb MODIFY FILE (NAME<span class="operator">=</span>MSDBData,FILENAME<span class="operator">=</span><span class="string">&#x27;C:\Program Files\Microsoft SQL Server\MSSQL.1\MSSQL\Data\msdbdata.mdf&#x27;</span> ); </span><br><span class="line"><span class="keyword">ALTER</span> DATABASE msdb MODIFY FILE (NAME<span class="operator">=</span>MSDBLog,FILENAME<span class="operator">=</span><span class="string">&#x27;C:\Program Files\Microsoft SQL Server\MSSQL.1\MSSQL\Data\msdblog.ldf&#x27;</span> );</span><br><span class="line">GO</span><br><span class="line">USE master;</span><br><span class="line">GO</span><br><span class="line"><span class="keyword">ALTER</span> DATABASE tempdb MODIFY FILE (NAME<span class="operator">=</span>tempdev,FILENAME<span class="operator">=</span><span class="string">&#x27;C:\Program Files\Microsoft SQL Server\MSSQL.1\MSSQL\Data\tempdb.mdf&#x27;</span> ); </span><br><span class="line"><span class="keyword">ALTER</span> DATABASE tempdb MODIFY FILE (NAME<span class="operator">=</span>templog,FILENAME<span class="operator">=</span><span class="string">&#x27;C:\Program Files\Microsoft SQL Server\MSSQL.1\MSSQL\Data\templog.ldf&#x27;</span> );</span><br><span class="line">GO</span><br></pre></td></tr></table></figure><p><strong>注意“C:\Program Files\Microsoft SQL Server\MSSQL.1\MSSQL\Data\”路径为还原的实例的路径。</strong></p><p>执行以上SQL语句后重启服务。</p><h3 id="还原Service-Master-Key"><a href="#还原Service-Master-Key" class="headerlink" title="还原Service Master Key"></a>还原Service Master Key</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RESTORE SERVICE MASTER KEY <span class="keyword">FROM</span> FILE<span class="operator">=</span>N<span class="string">&#x27;D:\smk.bak&#x27;</span> DECRYPTION <span class="keyword">BY</span> PASSWORD <span class="operator">=</span> <span class="string">&#x27;password&#x27;</span> FORCE;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">如何还原SQLServer master数据库</summary>
    
    
    
    
    <category term="SQLServer" scheme="https://www.junle.org/tags/SQLServer/"/>
    
  </entry>
  
  <entry>
    <title>Windows 10 安装SQLServer 2005</title>
    <link href="https://www.junle.org/Windows-10-%E5%AE%89%E8%A3%85SQLServer-2005/"/>
    <id>https://www.junle.org/Windows-10-%E5%AE%89%E8%A3%85SQLServer-2005/</id>
    <published>2019-08-02T08:03:53.000Z</published>
    <updated>2024-03-22T06:43:55.687Z</updated>
    
    <content type="html"><![CDATA[<h2 id="报错"><a href="#报错" class="headerlink" title="报错"></a>报错</h2><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The SQL Server service failed to <span class="built_in">start</span>. <span class="keyword">For</span> <span class="built_in">more</span> information, see the SQL Server Books Online topics, “How to: View SQL Server <span class="number">2005</span> Setup Log Files” and “Starting SQL Server Manually.” </span><br></pre></td></tr></table></figure><p><img src="/images/sql_server_2005_error_windows_10.png" alt="图片来源https://eddiejackson.net/wp/?p=16941"></p><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><ol><li><p>重新运行安装程序到图一报错的地方。</p></li><li><p>下载文件<a href="http://eddiejackson.net/apps/Fix_Error_SQL2005.zip">http://eddiejackson.net/apps/Fix_Error_SQL2005.zip</a></p></li><li><p>复制对应版本的文件到安装目录<code>Program Files (x86) -&gt; Microsoft SQL Server &gt; MSSQL.2 &gt; MSSQL &gt; Binn</code>替换原文件。</p></li><li><p>返回图一点击<strong>Retry</strong>。</p></li></ol><p>安装完成。</p><p>参考：<a href="https://eddiejackson.net/wp/?p=16941">https://eddiejackson.net/wp/?p=16941</a></p>]]></content>
    
    
    <summary type="html">The SQL Server service failed to start. For more information, see the SQL Server Books Online topics, How to View SQL Server 2005 Setup Log Files and Starting SQL Server Manually.</summary>
    
    
    
    
    <category term="SQLServer" scheme="https://www.junle.org/tags/SQLServer/"/>
    
  </entry>
  
  <entry>
    <title>如何在CentOS 7上安装和配置VNC Server</title>
    <link href="https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS-7%E4%B8%8A%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AEVNC-Server/"/>
    <id>https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS-7%E4%B8%8A%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AEVNC-Server/</id>
    <published>2019-07-23T07:53:36.000Z</published>
    <updated>2024-03-22T06:43:55.696Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装GNOME-Desktop-Packages"><a href="#安装GNOME-Desktop-Packages" class="headerlink" title="安装GNOME Desktop Packages"></a>安装GNOME Desktop Packages</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum groupinstall <span class="string">&quot;GNOME Desktop&quot;</span></span><br></pre></td></tr></table></figure><h2 id="安装Tigervnc和依赖包"><a href="#安装Tigervnc和依赖包" class="headerlink" title="安装Tigervnc和依赖包"></a>安装Tigervnc和依赖包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install tigervnc-server xorg-x11-fonts-Type1</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="创建VNC-Server配置文件"><a href="#创建VNC-Server配置文件" class="headerlink" title="创建VNC Server配置文件"></a>创建VNC Server配置文件</h2><p>复制VNC配置文件模板<code>/lib/systemd/system/vncserver@.service</code>到<code>/etc/systemd/system/vncserver@:&lt;Port_Number&gt;.service</code>。<br>我们希望VNC Server监听<strong>5903</strong>端口<code>&lt;Port_Number&gt;</code>为3，如果监听VNC Server监听5904端口<code>&lt;Port_Number&gt;</code>则为4，以此类推：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /lib/systemd/system/vncserver@.service /etc/systemd/system/vncserver@:3.service</span><br></pre></td></tr></table></figure><h2 id="修改VNC-Server配置文件"><a href="#修改VNC-Server配置文件" class="headerlink" title="修改VNC Server配置文件"></a>修改VNC Server配置文件</h2><p>修改配置文件<code>/etc/systemd/system/vncserver@:3.service</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Remote desktop service (VNC)</span><br><span class="line">After=syslog.target network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line"></span><br><span class="line">ExecStartPre=/bin/sh -c <span class="string">&#x27;/usr/bin/vncserver -kill %i &gt; /dev/null 2&gt;&amp;1 || :&#x27;</span></span><br><span class="line">ExecStart=/usr/sbin/runuser -l &lt;USER&gt; -c <span class="string">&quot;/usr/bin/vncserver %i&quot;</span></span><br><span class="line">PIDFile=/home/&lt;USER&gt;/.vnc/%H%i.pid</span><br><span class="line">ExecStop=/bin/sh -c <span class="string">&#x27;/usr/bin/vncserver -kill %i &gt; /dev/null 2&gt;&amp;1 || :&#x27;</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>替换文本中的**&lt;USER&gt;**为你的VNC用户。</p><h2 id="firewall添加端口"><a href="#firewall添加端口" class="headerlink" title="firewall添加端口"></a>firewall添加端口</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --zone=public --add-port=5903/tcp</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><h2 id="设置VNC密码"><a href="#设置VNC密码" class="headerlink" title="设置VNC密码"></a>设置VNC密码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]<span class="comment"># su - test</span></span><br><span class="line">Last login: Tue Jul 23 08:47:39 CST 2019 on pts/0</span><br><span class="line">[<span class="built_in">test</span>@vm ~]$ vncserver</span><br><span class="line"></span><br><span class="line">You will require a password to access your desktops.</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">Verify:</span><br><span class="line">Would you like to enter a view-only password (y/n)? n</span><br><span class="line">A view-only password is not used</span><br><span class="line">xauth:  file /home/test/.Xauthority does not exist</span><br><span class="line"></span><br><span class="line">New <span class="string">&#x27;vm:3 (test)&#x27;</span> desktop is vm:3</span><br><span class="line"></span><br><span class="line">Creating default startup script /home/test/.vnc/xstartup</span><br><span class="line">Creating default config /home/test/.vnc/config</span><br><span class="line">Starting applications specified <span class="keyword">in</span> /home/test/.vnc/xstartup</span><br><span class="line">Log file is /home/test/.vnc/vm:3.<span class="built_in">log</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="启动VNC-Server和设置开机启动"><a href="#启动VNC-Server和设置开机启动" class="headerlink" title="启动VNC Server和设置开机启动"></a>启动VNC Server和设置开机启动</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start vncserver@:3.service</span><br><span class="line">systemctl <span class="built_in">enable</span> vncserver@:3.service</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">如何在CentOS 7上安装和配置VNC Server</summary>
    
    
    
    
    <category term="Linux" scheme="https://www.junle.org/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>如何在CentOS 7上添加SSH端口</title>
    <link href="https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS-7%E4%B8%8A%E6%B7%BB%E5%8A%A0SSH%E7%AB%AF%E5%8F%A3/"/>
    <id>https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS-7%E4%B8%8A%E6%B7%BB%E5%8A%A0SSH%E7%AB%AF%E5%8F%A3/</id>
    <published>2019-07-23T07:11:31.000Z</published>
    <updated>2024-03-22T06:43:55.697Z</updated>
    
    <content type="html"><![CDATA[<h2 id="修改文件-etc-ssh-sshd-config"><a href="#修改文件-etc-ssh-sshd-config" class="headerlink" title="修改文件/etc/ssh/sshd_config"></a>修改文件<code>/etc/ssh/sshd_config</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Port 22  <span class="comment">#去掉这行开头的#号</span></span><br><span class="line">Port 22222  <span class="comment">#添加一行</span></span><br></pre></td></tr></table></figure><h2 id="firewall添加端口"><a href="#firewall添加端口" class="headerlink" title="firewall添加端口"></a>firewall添加端口</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=22222/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="修改selinux"><a href="#修改selinux" class="headerlink" title="修改selinux"></a>修改selinux</h2><p>如果没有安装policycoreutils-python需要先安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install policycoreutils-python</span><br></pre></td></tr></table></figure><p>安装完成后添加22222端口：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">semanage port -a -t ssh_port_t -p tcp 22222</span><br></pre></td></tr></table></figure><p>查看是否添加成功：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]<span class="comment"># semanage port -l | grep ssh</span></span><br><span class="line">ssh_port_t                     tcp      22222, 22</span><br></pre></td></tr></table></figure><h2 id="重启ssh服务"><a href="#重启ssh服务" class="headerlink" title="重启ssh服务"></a>重启ssh服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure><p>检查ssh服务是否监听22222端口：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]<span class="comment"># systemctl status sshd</span></span><br><span class="line">● sshd.service - OpenSSH server daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/sshd.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Tue 2019-07-23 15:26:10 CST; 24s ago</span><br><span class="line">     Docs: man:sshd(8)</span><br><span class="line">           man:sshd_config(5)</span><br><span class="line"> Main PID: 17854 (sshd)</span><br><span class="line">    Tasks: 1</span><br><span class="line">   CGroup: /system.slice/sshd.service</span><br><span class="line">           └─17854 /usr/sbin/sshd -D</span><br><span class="line"></span><br><span class="line">Jul 23 15:26:10 vm systemd[1]: Starting OpenSSH server daemon...</span><br><span class="line">Jul 23 15:26:10 vm sshd[17854]: Server listening on 0.0.0.0 port 22222.</span><br><span class="line">Jul 23 15:26:10 vm sshd[17854]: Server listening on :: port 22222.</span><br><span class="line">Jul 23 15:26:10 vm sshd[17854]: Server listening on 0.0.0.0 port 22.</span><br><span class="line">Jul 23 15:26:10 vm sshd[17854]: Server listening on :: port 22.</span><br><span class="line">Jul 23 15:26:10 vm systemd[1]: Started OpenSSH server daemon.</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show <span class="keyword">in</span> full.</span><br></pre></td></tr></table></figure><p><strong>可见看到ssh服务监听22222和22端口。</strong></p>]]></content>
    
    
    <summary type="html">如何在CentOS 7上添加SSH端口</summary>
    
    
    
    
    <category term="Linux" scheme="https://www.junle.org/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>VNCViewer No matching security types错误解决方法</title>
    <link href="https://www.junle.org/VNCViewer-No-matching-security-types%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"/>
    <id>https://www.junle.org/VNCViewer-No-matching-security-types%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</id>
    <published>2019-07-23T06:55:31.000Z</published>
    <updated>2024-03-22T06:43:55.686Z</updated>
    
    <content type="html"><![CDATA[<p>当用VNCViewer连接服务器时出现<strong>No matching security types</strong>错误。</p><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>禁用Vino的加密要求。<br>使用屏幕共享的用户身份运行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gsettings <span class="built_in">set</span> org.gnome.Vino require-encryption <span class="literal">false</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">当用VNCViewer连接服务器时出现No matching security types错误...</summary>
    
    
    
    
    <category term="Linux" scheme="https://www.junle.org/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>重新初始化SQL Server错误日志</title>
    <link href="https://www.junle.org/%E9%87%8D%E6%96%B0%E5%88%9D%E5%A7%8B%E5%8C%96SQL-Server%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97/"/>
    <id>https://www.junle.org/%E9%87%8D%E6%96%B0%E5%88%9D%E5%A7%8B%E5%8C%96SQL-Server%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97/</id>
    <published>2019-07-17T00:47:49.000Z</published>
    <updated>2024-03-22T06:43:55.709Z</updated>
    
    <content type="html"><![CDATA[<p>您可以使用sp_cycle_errorlog存储过程定期重新初始化错误日志：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXEC</span> sp_cycle_errorlog ;  </span><br><span class="line">GO </span><br></pre></td></tr></table></figure><p>重新初始化前：<br><img src="/images/20190717085147.png" alt="初始化前"><br>重新初始化后：<br><img src="/images/20190717085249.png" alt="初始化后"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;您可以使用sp_cycle_errorlog存储过程定期重新初始化错误日志：&lt;/p&gt;
&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;b</summary>
      
    
    
    
    
    <category term="SQLServer" scheme="https://www.junle.org/tags/SQLServer/"/>
    
  </entry>
  
  <entry>
    <title>搭建属于自己的SlapOS云平台（一） 安装 SlapOS Master</title>
    <link href="https://www.junle.org/%E6%90%AD%E5%BB%BA%E5%B1%9E%E4%BA%8E%E8%87%AA%E5%B7%B1%E7%9A%84SlapOS%E4%BA%91%E5%B9%B3%E5%8F%B0%EF%BC%88%E4%B8%80%EF%BC%89%20%E5%AE%89%E8%A3%85-SlapOS-Master/"/>
    <id>https://www.junle.org/%E6%90%AD%E5%BB%BA%E5%B1%9E%E4%BA%8E%E8%87%AA%E5%B7%B1%E7%9A%84SlapOS%E4%BA%91%E5%B9%B3%E5%8F%B0%EF%BC%88%E4%B8%80%EF%BC%89%20%E5%AE%89%E8%A3%85-SlapOS-Master/</id>
    <published>2018-01-15T03:03:58.000Z</published>
    <updated>2024-03-22T06:43:55.704Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://slapos.vifib.com/">SlapOS</a>是一种分散的云计算技术，使用<a href="http://www.buildout.org/en/latest/">Buildout</a>在异构环境中自动部署和配置应用程序。SlapOS支持IaaS，PaaS和SaaS应用程序。</p><p><a href="https://lab.nexedi.com/nexedi/slapos/raw/master/software/slapos-master/software.cfg">SlapOS Master</a>用于管理SlapOS云平台，提供软件管理，服务实例管理，使用记帐和计费模块等功能，通过SlapOS能很方便地创建想要的服务。关于SlapOS的更多信息可阅览SlapOS的<a href="http://community.slapos.org/">官网</a>。</p><span id="more"></span><h2 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h2><p>安装SlapOS Master过程类似ERP5安装（ERP5安装过程可以参考<a href="/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS-7%E4%B8%8A%E5%AE%89%E8%A3%85ERP5/">这里</a>），不同的地方是Buildout配置文件和创建实例的参数。确保在操作以下步骤之前完成SlapOS Node的安装（SlapOS Node的安装可参考<a href="/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS-7%E4%B8%8A%E5%AE%89%E8%A3%85SlapOS-Node/">这里</a>）。</p><h3 id="配置SlapOS"><a href="#配置SlapOS" class="headerlink" title="配置SlapOS"></a>配置SlapOS</h3><p>在终端输入以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]<span class="comment"># slapos configure local \</span></span><br><span class="line">    --interface-name eth0 \</span><br><span class="line">    --partition-number 16 \</span><br><span class="line">    --ipv4-local-network 10.0.0.0/24 \</span><br><span class="line">    --daemon-listen-ip 127.0.0.1 \</span><br><span class="line">    --daemon-listen-port 50000</span><br></pre></td></tr></table></figure><p><strong>interface-name</strong>： Computer Partition使用的网卡， 请根据自己实际的网卡填写， 该网卡需要有ipv6地址。<br><strong>partition-number</strong>： SlapOS创建的Computer Partition数量，对于ERP5需要10个左右，这里我们配置16个。<br><strong>ipv4-local-network</strong>：  Computer Partition使用的网络。<br><strong>daemon-listen-ip</strong>： slapos-proxy绑定的地址。<br><strong>daemon-listen-port</strong>： slapos-proxy绑定的端口。</p><p>完成后输入以下命令格式化Computer Partition：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]<span class="comment"># slapos node format --now</span></span><br></pre></td></tr></table></figure><p>输出如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]<span class="comment"># slapos node format --now</span></span><br><span class="line">2018-10-19 14:18:11 slapos[1464] INFO Updating computer</span><br><span class="line">2018-10-19 14:18:32 slapos[1464] INFO Posting information to <span class="string">&#x27;http://127.0.0.1:50000&#x27;</span></span><br><span class="line">2018-10-19 14:18:32 slapos[1464] INFO slapos successfully prepared the computer.</span><br></pre></td></tr></table></figure><h3 id="安装SlapOS"><a href="#安装SlapOS" class="headerlink" title="安装SlapOS"></a>安装SlapOS</h3><p>获取SlapOS buildout配置文件到本地目录*&#x2F;opt&#x2F;buildout*</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]# mkdir -p /opt/buildout &amp;&amp; cd /opt/buildout</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]# git clone https://github.com/SlapOS/slapos.git</span><br></pre></td></tr></table></figure><p>构建和安装ERP5软件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]# slapos supply /opt/buildout/slapos/software/slapos-master/software.cfg local_computer</span><br></pre></td></tr></table></figure><p>通过以下命令可以查看buildout日志：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]# tail -f /opt/slapos/log/slapos-node-software.log</span><br></pre></td></tr></table></figure><p>输入以下命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]# slapos node software</span><br></pre></td></tr></table></figure><p>输出内容如下，则说明软件构建完成：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vm opt]# slapos node software</span><br><span class="line">2018-10-19 14:35:14 slapos[7190] INFO Processing software releases...</span><br><span class="line">2018-10-19 14:35:14 slapos[7190] INFO Finished software releases.</span><br></pre></td></tr></table></figure><h3 id="创建SlapOS-Master实例"><a href="#创建SlapOS-Master实例" class="headerlink" title="创建SlapOS Master实例"></a>创建SlapOS Master实例</h3><h4 id="创建证书颁发机构文件夹"><a href="#创建证书颁发机构文件夹" class="headerlink" title="创建证书颁发机构文件夹"></a>创建证书颁发机构文件夹</h4><p>输入以下命令，在*&#x2F;etc&#x2F;*目录下创建文件夹<strong>slapos-ssl</strong>文件夹:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]<span class="comment"># mkdir -pv /etc/slapos-ssl</span></span><br></pre></td></tr></table></figure><p>修改文件夹用户权限：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]<span class="comment"># chmod 770 -R /etc/slapos-ssl </span></span><br><span class="line">[root@vm ~]<span class="comment"># chown -R slapsoft:slapsoft /etc/slapos-ssl</span></span><br></pre></td></tr></table></figure><h3 id="创建SlapOS-Master实例参数配置脚本"><a href="#创建SlapOS-Master实例参数配置脚本" class="headerlink" title="创建SlapOS Master实例参数配置脚本"></a>创建SlapOS Master实例参数配置脚本</h3><p>输入以下命令创建脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]<span class="comment"># touch slapos-master-config.py</span></span><br><span class="line">[root@vm ~]<span class="comment"># chmod +x slapos-master-config.py</span></span><br></pre></td></tr></table></figure><p>修改脚本内容为以下内容：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/slapos/bin/py</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> slapos.slap.slap</span><br><span class="line"></span><br><span class="line">slapos_master_url = <span class="string">&#x27;http://127.0.0.1:50000/&#x27;</span></span><br><span class="line"></span><br><span class="line">slap = slapos.slap.slap()</span><br><span class="line">slap.initializeConnection(slapos_master_url)</span><br><span class="line"></span><br><span class="line">software_url = <span class="string">&#x27;/opt/buildout/slapos/software/slapos-master/software.cfg&#x27;</span></span><br><span class="line"></span><br><span class="line">computer_id = <span class="string">&#x27;local_computer&#x27;</span></span><br><span class="line"></span><br><span class="line">parameter_dict = &#123;</span><br><span class="line">    <span class="string">&quot;zope-partition-dict&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;activities-node&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;family&quot;</span>: <span class="string">&quot;activities&quot;</span>,</span><br><span class="line">            <span class="string">&quot;thread-amount&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">&quot;instance-count&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;timerserver-interval&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;port-base&quot;</span>: <span class="number">2200</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;distribution-node&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;family&quot;</span>: <span class="string">&quot;distribution&quot;</span>,</span><br><span class="line">            <span class="string">&quot;thread-amount&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;instance-count&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;port-base&quot;</span>: <span class="number">2210</span>,</span><br><span class="line">            <span class="string">&quot;timerserver-interval&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;web-node&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;family&quot;</span>: <span class="string">&quot;web&quot;</span>,</span><br><span class="line">            <span class="string">&quot;thread-amount&quot;</span>: <span class="number">4</span>,</span><br><span class="line">            <span class="string">&quot;instance-count&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;port-base&quot;</span>: <span class="number">2230</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;service-slapos&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;family&quot;</span>: <span class="string">&quot;service&quot;</span>,</span><br><span class="line">            <span class="string">&quot;thread-amount&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">&quot;instance-count&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;port-base&quot;</span>: <span class="number">2240</span>,</span><br><span class="line">            <span class="string">&quot;ssl-authentication&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;backend-path&quot;</span>: <span class="string">&quot;/%(site-id)s/portal_slap&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ca_path = <span class="string">&#x27;/etc/slapos-ssl&#x27;</span></span><br><span class="line">parameter_dict[<span class="string">&quot;shared-certificate-authority-path&quot;</span>] = ca_path</span><br><span class="line"></span><br><span class="line">partition = slap.registerOpenOrder().request(</span><br><span class="line">    software_url,</span><br><span class="line">    <span class="string">&quot;slapos_master&quot;</span>,</span><br><span class="line">    software_type=<span class="string">&#x27;default&#x27;</span>,</span><br><span class="line">    partition_parameter_kw=&#123; <span class="string">&#x27;_&#x27;</span>: json.dumps(parameter_dict, sort_keys=<span class="literal">True</span>, indent=<span class="number">2</span>), &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;SlapOS Master Instance: &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(partition.getConnectionParameterDict())</span><br></pre></td></tr></table></figure><p>执行脚本创建SlapOS Master实例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]<span class="comment"># ./slapos-master-config.py</span></span><br></pre></td></tr></table></figure><p>等待SlapOS Master实例Buildout完成，可通过以下命令查看Buildout日志：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]<span class="comment"># tail -f /opt/slapos/log/slapos-node-instance.log</span></span><br></pre></td></tr></table></figure><p>等待10-15分钟后重新执行脚本如果输出内容如下表示实例Buildout完成：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2018-10-19 16:47:39 slapos[13925] INFO Instance requested.</span><br><span class="line">State is : started.</span><br><span class="line">2018-10-19 16:47:39 slapos[13925] INFO Connection parameters of instance are:</span><br><span class="line">2018-10-19 16:47:39 slapos[13925] INFO &#123;<span class="string">&#x27;_&#x27;</span>: <span class="string">&#x27;&#123;&quot;hosts-dict&quot;: &#123;&quot;erp5-cloudooo&quot;: &quot;10.0.0.221&quot;, &quot;erp5-smtp&quot;: &quot;127.0.0.2&quot;, &quot;erp5-catalog-0&quot;: &quot;10.0.0.218&quot;, &quot;erp5-memcached-volatile&quot;: &quot;10.0.0.215&quot;, &quot;erp5-memcached-persistent&quot;: &quot;10.0.0.214&quot;&#125;, &quot;site-id&quot;: &quot;erp5&quot;, &quot;monitor-setup-url&quot;: &quot;&quot;, &quot;family-default-v6&quot;: &quot;https://[xxxx:xxx::xxxx]:2151&quot;, &quot;deadlock-debugger-password&quot;: &quot;yzhmrcqk&quot;, &quot;inituser-login&quot;: &quot;zope&quot;, &quot;inituser-password&quot;: &quot;uslxwikz&quot;, &quot;monitor-base-url&quot;: &quot;&quot;, &quot;mariadb-test-database-list&quot;: [&quot;mysql://testuser_0:testpassword0@10.0.0.218:2099/erp5_test_0&quot;], &quot;mariadb-database-list&quot;: [&quot;mysql://user:insecure@10.0.0.218:2099/erp5&quot;], &quot;memcached-volatile-url&quot;: &quot;memcached://10.0.0.215:2013/&quot;, &quot;memcached-persistent-url&quot;: &quot;memcached://10.0.0.214:2003/&quot;, &quot;caucase-http-url&quot;: &quot;http://[xxxx:xxx::xxxx]:8890&quot;, &quot;cloudooo-url&quot;: &quot;http://10.0.0.221:2020/&quot;, &quot;family-default&quot;: &quot;https://10.0.0.211:2151&quot;&#125;&#x27;</span>&#125;</span><br><span class="line">2018-10-19 16:47:39 slapos[13925] INFO You can rerun the <span class="built_in">command</span> to get up-to-date information.</span><br></pre></td></tr></table></figure><h3 id="修改证书颁发机构文件夹用户权限"><a href="#修改证书颁发机构文件夹用户权限" class="headerlink" title="修改证书颁发机构文件夹用户权限"></a>修改证书颁发机构文件夹用户权限</h3><p>执行以下命令修改权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]# cd /etc/slapos-ssl </span><br><span class="line">[root@vm ~]# chmod -R 770 cacert.pem crl requests certs crlnumber index.txt newcerts private serial  </span><br><span class="line">[root@vm ~]# chown -R slapsoft:slapsoft cacert.pem crl requests certs crlnumber index.txt newcerts private serial</span><br></pre></td></tr></table></figure><h3 id="重启SlapOS-Master实例"><a href="#重启SlapOS-Master实例" class="headerlink" title="重启SlapOS Master实例"></a>重启SlapOS Master实例</h3><p>执行以下命令重启SlapOS Master实例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]# slapos node restart all</span><br></pre></td></tr></table></figure><p><strong>至此SlapOS Master安装完成</strong></p>]]></content>
    
    
    <summary type="html">搭建属于自己的SlapOS云平台</summary>
    
    
    
    
    <category term="SlapOS" scheme="https://www.junle.org/tags/SlapOS/"/>
    
  </entry>
  
  <entry>
    <title>CentOS7编译安装shadowsocks-libev + simple-obfs混淆</title>
    <link href="https://www.junle.org/CentOS7%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85shadowsocks-libev-simple-obfs%E6%B7%B7%E6%B7%86/"/>
    <id>https://www.junle.org/CentOS7%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85shadowsocks-libev-simple-obfs%E6%B7%B7%E6%B7%86/</id>
    <published>2017-06-30T03:08:07.000Z</published>
    <updated>2024-03-22T06:43:55.667Z</updated>
    
    <content type="html"><![CDATA[<p>安装前推荐系统先完成BBR的配置，配置方法可参考<a href="/%E5%9C%A8CentOS7%E4%B8%8A%E5%90%AF%E7%94%A8BBR%E6%8F%90%E9%80%9F/">《如何在CentOS7上启用BBR提速》</a></p><span id="more"></span><h2 id="安装shadowsocks-libev"><a href="#安装shadowsocks-libev" class="headerlink" title="安装shadowsocks-libev"></a>安装shadowsocks-libev</h2><p>获取shadowsocks-libev源码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/shadowsocks/shadowsocks-libev.git</span><br><span class="line"><span class="built_in">cd</span> shadowsocks-libev</span><br><span class="line">git submodule update --init --recursive</span><br></pre></td></tr></table></figure><p>安装基本构建依赖</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gettext gcc autoconf libtool automake make asciidoc xmlto c-ares-devel libev-devel pcre-devel</span><br></pre></td></tr></table></figure><p>安装libsodium</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LIBSODIUM_VER=1.0.16</span><br><span class="line">wget https://download.libsodium.org/libsodium/releases/old/libsodium-<span class="variable">$LIBSODIUM_VER</span>.tar.gz</span><br><span class="line">tar xvf libsodium-<span class="variable">$LIBSODIUM_VER</span>.tar.gz</span><br><span class="line"><span class="built_in">pushd</span> libsodium-<span class="variable">$LIBSODIUM_VER</span></span><br><span class="line">./configure --prefix=/usr &amp;&amp; make</span><br><span class="line">sudo make install</span><br><span class="line"><span class="built_in">popd</span></span><br><span class="line">sudo ldconfig</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>安装MbedTLS</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> MBEDTLS_VER=2.6.0</span><br><span class="line">wget https://tls.mbed.org/download/mbedtls-<span class="variable">$MBEDTLS_VER</span>-gpl.tgz</span><br><span class="line">tar xvf mbedtls-<span class="variable">$MBEDTLS_VER</span>-gpl.tgz</span><br><span class="line"><span class="built_in">pushd</span> mbedtls-<span class="variable">$MBEDTLS_VER</span></span><br><span class="line">make SHARED=1 CFLAGS=-fPIC</span><br><span class="line">sudo make DESTDIR=/usr install</span><br><span class="line"><span class="built_in">popd</span></span><br><span class="line">sudo ldconfig</span><br></pre></td></tr></table></figure><p>安装shadowsocks-libev</p><p>按照Shadowsocks-libev的README，在<code>make</code>时失败，解决方法<a href="https://github.com/shadowsocks/shadowsocks-libev/issues/1164#issuecomment-319578410">https://github.com/shadowsocks/shadowsocks-libev/issues/1164#issuecomment-319578410</a><br>安装过程如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./autogen.sh</span><br><span class="line">./configure --with-sodium-include=/usr/include --with-sodium-lib=/usr/local/lib --with-mbedtls-include=/usr/include --with-mbedtls-lib=/usr/lib</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h2 id="安装simple-obfs"><a href="#安装simple-obfs" class="headerlink" title="安装simple-obfs"></a>安装simple-obfs</h2><p>获取simple-obfs源码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/shadowsocks/simple-obfs.git</span><br><span class="line"><span class="built_in">cd</span> simple-obfs</span><br><span class="line">git submodule update --init --recursive</span><br></pre></td></tr></table></figure><p>安装simple-obfs</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h2 id="配置shadowsocks-libev服务"><a href="#配置shadowsocks-libev服务" class="headerlink" title="配置shadowsocks-libev服务"></a>配置shadowsocks-libev服务</h2><p>创建shadowsocks配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /etc/shadowsocks/</span><br><span class="line"><span class="built_in">touch</span> /etc/shadowsocks/config.json</span><br></pre></td></tr></table></figure><p>修改配置文件内容如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span><span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;server_port&quot;</span><span class="punctuation">:</span><span class="number">8388</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;local_port&quot;</span><span class="punctuation">:</span><span class="number">1080</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;password&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span><span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;chacha20-ietf-poly1305&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span><span class="string">&quot;daemon&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugin&quot;</span><span class="punctuation">:</span><span class="string">&quot;obfs-server&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugin_opts&quot;</span><span class="punctuation">:</span><span class="string">&quot;obfs=http;failover=example.com&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><span style="color:red"><strong>注意：</strong></span>需要修改<em>password</em>的内容。</p><p>创建shadowsocks启动脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> /etc/init.d/shadowsocks</span><br><span class="line"><span class="built_in">chmod</span> +x /etc/init.d/shadowsocks</span><br></pre></td></tr></table></figure><p>修改脚本内容如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment"># chkconfig: 2345 90 10</span></span><br><span class="line"><span class="comment"># description: A secure socks5 proxy, designed to protect your Internet traffic.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### BEGIN INIT INFO</span></span><br><span class="line"><span class="comment"># Provides:          Shadowsocks-libev</span></span><br><span class="line"><span class="comment"># Required-Start:    $network $syslog</span></span><br><span class="line"><span class="comment"># Required-Stop:     $network</span></span><br><span class="line"><span class="comment"># Default-Start:     2 3 4 5</span></span><br><span class="line"><span class="comment"># Default-Stop:      0 1 6</span></span><br><span class="line"><span class="comment"># Short-Description: Fast tunnel proxy that helps you bypass firewalls</span></span><br><span class="line"><span class="comment"># Description:       Start or stop the Shadowsocks-libev server</span></span><br><span class="line"><span class="comment">### END INIT INFO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author: Teddysun &lt;i@teddysun.com&gt;</span></span><br><span class="line"><span class="keyword">if</span> [ -f /usr/local/bin/ss-server ]; <span class="keyword">then</span></span><br><span class="line">    DAEMON=/usr/local/bin/ss-server</span><br><span class="line"><span class="keyword">elif</span> [ -f /usr/bin/ss-server ]; <span class="keyword">then</span></span><br><span class="line">    DAEMON=/usr/bin/ss-server</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">NAME=Shadowsocks-libev</span><br><span class="line">CONF=/etc/shadowsocks/config.json</span><br><span class="line">PID_DIR=/var/run</span><br><span class="line">PID_FILE=<span class="variable">$PID_DIR</span>/shadowsocks.pid</span><br><span class="line">RET_VAL=0</span><br><span class="line"></span><br><span class="line">[ -x <span class="variable">$DAEMON</span> ] || <span class="built_in">exit</span> 0</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$PID_DIR</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="variable">$PID_DIR</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Creating PID directory <span class="variable">$PID_DIR</span> failed&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="variable">$CONF</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NAME</span> config file <span class="variable">$CONF</span> not found&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_running</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ -r <span class="variable">$PID_FILE</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">read</span> PID &lt; <span class="variable">$PID_FILE</span></span><br><span class="line">        <span class="keyword">if</span> [ -d <span class="string">&quot;/proc/<span class="variable">$PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">return</span> 0</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">rm</span> -f <span class="variable">$PID_FILE</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">return</span> 2</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">do_status</span></span>() &#123;</span><br><span class="line">    check_running</span><br><span class="line">    <span class="keyword">case</span> $? <span class="keyword">in</span></span><br><span class="line">        0)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NAME</span> (pid <span class="variable">$PID</span>) is running...&quot;</span></span><br><span class="line">        ;;</span><br><span class="line">        1|2)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NAME</span> is stopped&quot;</span></span><br><span class="line">        RET_VAL=1</span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">do_start</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> check_running; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NAME</span> (pid <span class="variable">$PID</span>) is already running...&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="variable">$DAEMON</span> -uv -c <span class="variable">$CONF</span> -f <span class="variable">$PID_FILE</span></span><br><span class="line">    <span class="keyword">if</span> check_running; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Starting <span class="variable">$NAME</span> success&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Starting <span class="variable">$NAME</span> failed&quot;</span></span><br><span class="line">        RET_VAL=1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">do_stop</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> check_running; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">kill</span> -9 <span class="variable">$PID</span></span><br><span class="line">        <span class="built_in">rm</span> -f <span class="variable">$PID_FILE</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Stopping <span class="variable">$NAME</span> success&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NAME</span> is stopped&quot;</span></span><br><span class="line">        RET_VAL=1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">do_restart</span></span>() &#123;</span><br><span class="line">    do_stop</span><br><span class="line">    do_start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">    start|stop|restart|status)</span><br><span class="line">    do_<span class="variable">$1</span></span><br><span class="line">    ;;</span><br><span class="line">    *)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> &#123; start | stop | restart | status &#125;&quot;</span></span><br><span class="line">    RET_VAL=1</span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> <span class="variable">$RET_VAL</span></span><br></pre></td></tr></table></figure><p>配置shadowsocks开机启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --add shadowsocks</span><br></pre></td></tr></table></figure><p>启动shadowsocks</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/shadowsocks start</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">CentOS7编译安装shadowsocks-libev + simple-obfs混淆</summary>
    
    
    
    
    <category term="Linux" scheme="https://www.junle.org/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>在CentOS7上启用BBR提速</title>
    <link href="https://www.junle.org/%E5%9C%A8CentOS7%E4%B8%8A%E5%90%AF%E7%94%A8BBR%E6%8F%90%E9%80%9F/"/>
    <id>https://www.junle.org/%E5%9C%A8CentOS7%E4%B8%8A%E5%90%AF%E7%94%A8BBR%E6%8F%90%E9%80%9F/</id>
    <published>2017-06-25T03:58:27.000Z</published>
    <updated>2024-03-22T06:43:55.694Z</updated>
    
    <content type="html"><![CDATA[<p>BBR (Bottleneck Bandwidth and RTT)是由Google提供给Linux内核TCP堆栈的一种新的拥塞控制算法。有了BBR，Linux服务器可以显着提高吞吐量并减少连接延迟。</p><span id="more"></span><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><ul><li>CentOS7 x64服务器</li><li>root用户</li></ul><h2 id="更新Linux内核"><a href="#更新Linux内核" class="headerlink" title="更新Linux内核"></a>更新Linux内核</h2><p>安装elrepo repo:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</span><br></pre></td></tr></table></figure><p>从安装elrepo安装内核</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum --enablerepo=elrepo-kernel install kernel-ml -y</span><br></pre></td></tr></table></figure><p>确定内核安装完成</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep kernel</span><br></pre></td></tr></table></figure><p>内核安装完成输出内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kernel-ml-4.10.4-1.el7.elrepo.x86_64</span><br><span class="line">kernel-ml-headers-4.19.5-1.el7.elrepo.x86_64</span><br><span class="line">kernel-tools-libs-3.10.0-862.14.4.el7.x86_64</span><br><span class="line">kernel-ml-4.19.0-1.el7.elrepo.x86_64</span><br><span class="line">kernel-tools-3.10.0-862.14.4.el7.x86_64</span><br><span class="line">kernel-ml-4.19.5-1.el7.elrepo.x86_64</span><br><span class="line">kernel-3.10.0-514.el7.x86_64</span><br></pre></td></tr></table></figure><p>修改grub2设置启用新内核，输入以下命令显示grub2菜单中的所有条目：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">egrep ^menuentry /etc/grub2.cfg | <span class="built_in">cut</span> -f 2 -d \&#x27;</span><br></pre></td></tr></table></figure><p>输出结果如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CentOS Linux (4.19.5-1.el7.elrepo.x86_64) 7 (Core)</span><br><span class="line">CentOS Linux 7 Rescue b38eea25ce6937aa19f219f91608f833 (4.19.0-1.el7.elrepo.x86_64)</span><br><span class="line">CentOS Linux (4.19.0-1.el7.elrepo.x86_64) 7 (Core)</span><br><span class="line">CentOS Linux (4.10.4-1.el7.elrepo.x86_64) 7 (Core)</span><br><span class="line">CentOS Linux (3.10.0-514.el7.x86_64) 7 (Core)</span><br><span class="line">CentOS Linux (0-rescue-bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb) 7 (Core)</span><br></pre></td></tr></table></figure><p>输出结果从上到下编号为0-5，我们需要将grub2的默认启动项设置为*CentOS Linux (4.19.5-1.el7.elrepo.x86_64) 7 (Core)*（第一项编号为0）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub2-set-default 0</span><br></pre></td></tr></table></figure><p>设置完成后重启服务器：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure><p>重启完成后输入以下命令确定新内核引导成功：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">uname</span> -r</span><br></pre></td></tr></table></figure><p>输出结果如下则说明成功：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4.19.5-1.el7.elrepo.x86_64</span><br></pre></td></tr></table></figure><h2 id="启用BBR"><a href="#启用BBR" class="headerlink" title="启用BBR"></a>启用BBR</h2><p>输入以下命令修改sysctl配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;net.core.default_qdisc=fq&quot;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;net.ipv4.tcp_congestion_control=bbr&quot;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><p>完成后依次输入以下命令确定系统是否启用了BBR：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sysctl net.ipv4.tcp_available_congestion_control</span><br><span class="line">sysctl net.ipv4.tcp_congestion_control</span><br></pre></td></tr></table></figure><p>如果输出结果中都含有<strong>BBR</strong>字样，则表示BBR已经启用。</p>]]></content>
    
    
    <summary type="html">BBR (Bottleneck Bandwidth and RTT)是由Google提供给Linux内核TCP堆栈的一种新的拥塞控制算法。有了BBR，Linux服务器可以显着提高吞吐量并减少连接延迟。</summary>
    
    
    
    
    <category term="Linux" scheme="https://www.junle.org/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>如何更新ERP5的业务模板</title>
    <link href="https://www.junle.org/%E5%A6%82%E4%BD%95%E6%9B%B4%E6%96%B0ERP5%E7%9A%84%E4%B8%9A%E5%8A%A1%E6%A8%A1%E6%9D%BF/"/>
    <id>https://www.junle.org/%E5%A6%82%E4%BD%95%E6%9B%B4%E6%96%B0ERP5%E7%9A%84%E4%B8%9A%E5%8A%A1%E6%A8%A1%E6%9D%BF/</id>
    <published>2016-11-04T08:11:12.000Z</published>
    <updated>2024-03-22T06:43:55.701Z</updated>
    
    <content type="html"><![CDATA[<p>安装ERP5可参考文档<a href="/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS-7%E4%B8%8A%E5%AE%89%E8%A3%85ERP5/">《如何在CentOS 7上安装ERP5》</a>完成安装，安装完成后进入ERP5业务模板目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@erp5 ~] <span class="built_in">cd</span> /opt/slapgrid/9acaca863b17989c02d809a4de0295dd/parts/erp5/</span><br></pre></td></tr></table></figure><p>切换到slapsoft用户：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@erp5 erp5] su slapsoft</span><br></pre></td></tr></table></figure><p>从远程<a href="https://lab.nexedi.com/nexedi/erp5.git">仓库</a>更新ERP5代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh-4.2$ git pull --rebase</span><br></pre></td></tr></table></figure><p>更新完成后重建ERP5业务模板：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh-4.2$ product/ERP5/bin/genbt5list bt5/ product/ERP5/bootstrap</span><br></pre></td></tr></table></figure><span id="more"></span><p>重建完成后用开发者用户（zope）登录到ERP5，打开下面路径*&#x2F;erp5&#x2F;portal_templates&#x2F;view*，点击右上角<strong>Import &#x2F; Export</strong>按钮；<br><img src="/images/20181204163617.png" alt="1"><br>点击<strong>Update Repository Information</strong>更新ERP5业务模板路径；<br><img src="/images/20181204164549.png" alt="2"><br>点击选择列表选择<strong>Upgrade Business Templates from Repositories</strong>，在左边的checkbox上勾选需要更新的业务模板，并点击按钮<strong>Upgrade Business Templates from Repositories</strong>；<br><img src="/images/20181204164625.png" alt="3"><br><img src="/images/20181204164834.png" alt="4"><br>等待页面刷新，完成后拉到最底下，点击按钮<strong>Validate Installation</strong>确定更新。<br><img src="/images/20181204170338.png" alt="5"></p>]]></content>
    
    
    <summary type="html">如何更新ERP5的业务模板</summary>
    
    
    
    
    <category term="ERP5" scheme="https://www.junle.org/tags/ERP5/"/>
    
  </entry>
  
  <entry>
    <title>Zope REQUEST 和 RESPONSE的常用方法</title>
    <link href="https://www.junle.org/Zope-REQUEST-%E5%92%8C-RESPONSE%E7%9A%84%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95/"/>
    <id>https://www.junle.org/Zope-REQUEST-%E5%92%8C-RESPONSE%E7%9A%84%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95/</id>
    <published>2016-07-10T05:51:11.000Z</published>
    <updated>2024-03-22T06:43:55.688Z</updated>
    
    <content type="html"><![CDATA[<p>##REQUEST</p><ul><li>environ<blockquote><p>CGI编程规范所要求的环境变量，包括用户请求头信息，<br>服务器信息和其它用户请求相关的信息</p></blockquote></li><li>form<blockquote><p>从用户请求上提交的表单变量</p></blockquote></li><li>cookies<blockquote><p>cookie数据</p></blockquote></li><li>other<blockquote><p>其它可以设置的数据</p></blockquote><span id="more"></span></li><li>PARENTS<blockquote><p>漫游访问对象时所经历的对象列表，<br>从PARENTS[0]开始是所访问对象的父对象</p></blockquote></li><li>RESPONSE<blockquote><p>获取RESPONSE对象</p></blockquote></li><li>URL<blockquote><p>用户所访问的URL，但不包含参数字符串</p></blockquote></li><li>URLn<blockquote><p>其中的n分别是0, 1一直往上数。<br>URL0就是URL，URL1是URL0去掉最后一级路径，URL2是URL1再去掉一级路径，<br>直到网站根为止</p></blockquote></li><li>URLPATHn<blockquote><p>URLPATHn分别对应着URLn的路径部分，如URLPATH0就是URL0的路径部分，依此类推</p></blockquote></li><li>BASEn<blockquote><p>BASEn以一种与URLn相反的方式计数：<br>BASE0就是网站根，BASE1是所访问的URL的网站根加上一级路径，<br>BASE2就是加上二级路径，依此类推</p></blockquote></li><li>BASEPATHn<blockquote><p>BASEPATHn就是BASEn的路径部分</p></blockquote></li><li>get_header(name, default&#x3D;None)<blockquote><p>返回命名的HTTP头，或者可选的default参数，如果没有这个HTTP头则返回空。<br>注意，有没有 <code>HTTP_</code> 都可以识别，如 Content-Type,<br>CONTENT_TYPE, HTTP_CONTENT_TYPE 都会返回 Content-Type 头，如果有的话。</p></blockquote></li><li>getClientAddr()<blockquote><p>以字符串形式返回客户端IP，不能找到时返回空字符串</p></blockquote></li><li>has_key(key)<blockquote><p>如果REQUEST对象上有这个key则返回真，否则返回假</p></blockquote></li><li>items()<blockquote><p>以(key, value)的形式返回对象的元组的一个序列</p></blockquote></li><li>keys()<blockquote><p>返回REQUEST所保存的所有对象的key的已排序的序列</p></blockquote></li><li>set(name, value)<blockquote><p>在REQUEST上设置属性，如在Plone模板开发中常用的设置无边框操作是<br><code>request.set(&#39;disable_border&#39;, 1)</code></p></blockquote></li><li>set_lazy(key, callable)<blockquote><p>设置延迟计算的数据，callable是一个可调用的对象<br>当这个数据被访问时才调用callable计算出，计算后就保存在other数据中</p></blockquote></li><li>setServerURL(protocol&#x3D;None, hostname&#x3D;None, port&#x3D;None)<blockquote><p>设置服务器相关的URL，同时会影响到URL,URLn,BASEn,还有absolute_url的计算值</p></blockquote></li><li>values()<blockquote><p>返回REQUEST中所保存的所有值的序列</p></blockquote></li></ul><p>##RESPONSE</p><ul><li>addHeader(name, value)<blockquote><p>添加一项HTTP响应头</p></blockquote></li><li>expireCookie(name, **kw)<blockquote><p>发送一个cookie过期的消息，通知浏览器删除这个cookie</p></blockquote></li><li>redirect(location, status&#x3D;302, lock&#x3D;0)<blockquote><p>给浏览器回应重定向，如： <code>RESPONSE.redirect(&#39;http://czug.org&#39;)</code></p></blockquote></li><li>setBase(base)<blockquote><p>设置响应的基准URL，如果base为None或这个输出已经有base，则没有效果</p></blockquote></li><li>setBody(body, title&#x3D;””, is_error&#x3D;0)<blockquote><p>设置返回的响应体为body字符串的内容。并更新返回的Content-Length字段。</p></blockquote></li><li>setCookie(name, value, **kw)<blockquote><p>设置cookie信息，如：<code>RESPONSE.setCookie(&#39;__cp&#39;, cp, path=&#39;%s&#39; % cookie_path(REQUEST))</code></p></blockquote></li><li>setHeader(name, value, literal&#x3D;0)<blockquote><p>设置一个返回的HTTP头</p></blockquote></li><li>setStatus(status, reason&#x3D;None)<blockquote><p>设置返回状态，reason参数是用于描述这个状态的字符串。</p></blockquote></li></ul>]]></content>
    
    
    <summary type="html">Zope REQUEST 和 RESPONSE的常用方法</summary>
    
    
    
    
    <category term="Zope" scheme="https://www.junle.org/tags/Zope/"/>
    
  </entry>
  
  <entry>
    <title>Zope DateTime类型的常用操作</title>
    <link href="https://www.junle.org/Zope-DateTime%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/"/>
    <id>https://www.junle.org/Zope-DateTime%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/</id>
    <published>2016-03-22T02:03:53.000Z</published>
    <updated>2024-03-22T06:43:55.687Z</updated>
    
    <content type="html"><![CDATA[<ul><li>strftime(format)<blockquote><p>返回按照format格式提供的日期时间字符串。 参见 Python中的 time.strftime 函数。</p></blockquote></li><li>dow()<blockquote><p>返回用整数表示的星期中的天数，星期日是0。</p></blockquote></li><li>aCommon()<blockquote><p>返回按照“Mar 1, 1997 1:45 pm”格式表示的日期时间字符串。</p></blockquote></li><li>h_12()<blockquote><p>返回12小时制的小时数。</p></blockquote></li><li>Mon_()<span id="more"></span><blockquote><p>兼容：见pMonth。</p></blockquote></li><li>HTML4()<blockquote><p>按照符合HTML 4.0规范的格式返回对象，这个规范是ISO8601标准之一。<br>参见 HTML 4.0 规范，日期输出格式为：YYYY-MM-DDTHH:MM:SSZ T，其中Z是文本字符。时间为UTC（通用协调时间）时间。</p></blockquote></li><li>greaterThanEqualTo(t)<blockquote><p>和其它DateTime对象或浮点数比较DateTime对象，比如由Python 的time 模块返回的数值。<br>如果对象表示一个大于或等于指定的DateTime或time 模块风格的时间的日期或时间对象，则返回真。<br>通过比较长整数型的毫秒，它可以给出更为精确的结果。</p></blockquote></li><li>dayOfYear()<blockquote><p>返回按照对象所在时区表示的年的天数。</p></blockquote></li><li>lessThan(t)<blockquote><p>与其它的DateTime对象或一个浮点数比较DateTime对象，比如由Pythontime 模块返回的数字。<br>如果对象表示一个小于指定的DateTime或time 模块风格的时间的日期或时间对象，则返回真。<br>通过比较长整数型毫秒，它可以给出更为精确的结果。</p></blockquote></li><li>AMPM()<blockquote><p>返回一个对象的最接近秒的时间字符串。</p></blockquote></li><li>isCurrentHour()<blockquote><p>如果这个对象在所在时区中表示一个属于当前小时范围里的日期或时间对象，则返回真。</p></blockquote></li><li>Month()<blockquote><p>返回完整的月份的名称。</p></blockquote></li><li>mm()<blockquote><p>以两位数字符形式返回月份。</p></blockquote></li><li>ampm()<blockquote><p>返回适当的时间修饰语（am或pm）。</p></blockquote></li><li>hour()<blockquote><p>返回以24小时制表示的小时。</p></blockquote></li><li>aCommonZ()<blockquote><p>返回以”Mar 1, 1997 1:45 pm US&#x2F;Eastern”格式表示对象值的字符串。</p></blockquote></li><li>Day_()<blockquote><p>兼容：见pDay。</p></blockquote></li><li>pCommon()<blockquote><p>返回以”Mar. 1, 1997 1:45 pm”格式表示的对象值的字符串。</p></blockquote></li><li>minute()<blockquote><p>返回分钟。</p></blockquote></li><li>day()<blockquote><p>返回以整数表示的天。</p></blockquote></li><li>earliestTime()<blockquote><p>返回一个新的表示最早时间（全部按秒计算）的DateTime对象，它仍然属于对象所在时区中的当前天。</p></blockquote></li><li>Date()<blockquote><p>返回对象的日期字符串。</p></blockquote></li><li>Time()<blockquote><p>返回对象的最接近秒的时间字符串。</p></blockquote></li><li>isFuture()<blockquote><p>如果这个对象表示一个晚于调用时间的时间日期对象，则返回真。</p></blockquote></li><li>greaterThan(t)<blockquote><p>和其它的DateTime对象或一个浮点数比较DateTime对象，比如和由Pythontime 模块返回的数字比较。<br>如果对象表示一个大于指定的DateTime或符合time 模块风格的时间的date&#x2F;time对象，则返回真。<br>通过比较长整数型毫秒，它可以给出更为精确的结果。</p></blockquote></li><li>TimeMinutes()<blockquote><p>返回对象的时间字符串，不显示秒。</p></blockquote></li><li>yy()<blockquote><p>返回以两位数字符表示的日历年。</p></blockquote></li><li>isCurrentDay()<blockquote><p>如果对象在所在时区中表示一个属于当前天范围内的日期时间对象，则返回真。</p></blockquote></li><li>dd()<blockquote><p>返回以两位数字符形式表示的天。</p></blockquote></li><li>rfc822()<blockquote><p>返回以RFC 822格式显示的日期。</p></blockquote></li><li>isLeapYear()<blockquote><p>如果当前年（在对象所属时区中）是闰年则返回真</p></blockquote></li><li>fCommon()<blockquote><p>返回一个以”March 1, 1997 1:45 pm”格式表示的对象值的字符串。</p></blockquote></li><li>isPast()<blockquote><p>如果对象表示一个早于调用时间的日期时间对象，则返回真。</p></blockquote></li><li>fCommonZ()<blockquote><p>返回一个以”March 1, 1997 1:45 pm”格式表示的对象值的字符串。</p></blockquote></li><li>timeTime()<blockquote><p>返回UTC中按照Python time模块所使用的格式以浮点数形式表示的日期时间。<br>注意，采用那些拥有对于time模块来说没有含义的值的DateTime来创建日期或时间是可能的。</p></blockquote></li><li>toZone(z)<blockquote><p>返回当前对象在指定的z时区中的DateTime 。</p></blockquote></li><li>lessThanEqualTo(t)<blockquote><p>和另外一个DateTime对象或一个浮点数比较DateTime对象，比如和由Python time模块返回的数字进行比较。<br>如果对象表示一个小于或等于指定的DateTime或time模块风格的时间的日期时间，则返回真。<br>通过比较长整数型毫秒，它可以给出更为精确的结果。</p></blockquote></li><li>Mon()<blockquote><p>兼容：参见aMonth。</p></blockquote></li><li>parts()<blockquote><p>返回包含对象的日历年、月、日、小时、分钟、秒和时区值的元组。</p></blockquote></li><li>isCurrentYear()<blockquote><p>如果这个对象在所属时区中表示一个属于当前年范围以内的日期时间对象，则返回真。</p></blockquote></li><li>PreciseAMPM()<blockquote><p>返回对象的时间字符串。</p></blockquote></li><li>AMPMMinutes()<blockquote><p>返回对象的时间字符串，不显示秒。</p></blockquote></li><li>equalTo(t)<blockquote><p>和另外一个DateTime对象或一个浮点数比较DateTime对象，比如和由Python time模块返回的数字进行比较。<br>如果对象表示一个等于指定的DateTime或time模块风格时间的日期时间，则返回真。通过比较长整数型毫秒，它可以给出更为精确的结果。</p></blockquote></li><li>pDay()<blockquote><p>返回星期的简短名称（带有句点）。</p></blockquote></li><li>notEqualTo(t)<blockquote><p>和另外一个DateTime对象或一个浮点数比较DateTime对象，比如和由Python time模块返回的数字进行比较。<br>如果对象表示一个不等于指定的DateTime或time模块风格时间的日期时间，则返回真。<br>通过比较长整数型毫秒，它可以给出更为精确的结果。</p></blockquote></li><li>h_24()<blockquote><p>返回24小时制的小时。</p></blockquote></li><li>pCommonZ()<blockquote><p>返回以”Mar. 1, 1997 1:45 pm US&#x2F;Eastern”格式表示的对象值的字符串。</p></blockquote></li><li>isCurrentMonth()<blockquote><p>如果对象在所属的时区中表示一个属于当前月范围以内的日期时间对象，则返回真。</p></blockquote></li><li>DayOfWeek()<blockquote><p>兼容：参见aDay。</p></blockquote></li><li>latestTime()<blockquote><p>返回一个新的表示最迟时间（全部按秒计算）的DateTime对象，它仍然属于对象所在时区中的当前天。</p></blockquote></li><li>dow_1()<blockquote><p>返回以整数表示的星期的天数，星期日为1。</p></blockquote></li><li>timezone()<blockquote><p>返回对象的所属时区。</p></blockquote></li><li>year()<blockquote><p>返回对象的日历年。</p></blockquote></li><li>PreciseTime()<blockquote><p>返回对象的时间字符串。</p></blockquote></li><li>ISO()<blockquote><p>按照ISO标准格式返回对象。<br>输出格式为：YYYY-MM-DD HH:MM:SS</p></blockquote></li><li>millis()<blockquote><p>返回自从GMT新纪元以来的毫秒数。</p></blockquote></li><li>second()<blockquote><p>返回秒</p></blockquote></li><li>month()<blockquote><p>返回以整数表示的对象的月份。</p></blockquote></li><li>pMonth()<blockquote><p>返回简写（带有句点）的月份名称。</p></blockquote></li><li>aMonth()<blockquote><p>返回简写的月份名称。</p></blockquote></li><li>isCurrentMinute()<blockquote><p>如果对象在所属时区中表示一个属于当前分钟范围以内的日期时间对象，则返回真。</p></blockquote></li><li>Day()<blockquote><p>返回星期中天的完整名称。</p></blockquote></li><li>aDay()<blockquote><p>返回星期中天的简写名称。</p></blockquote></li></ul><p><strong>此外，DateTime对象还支持数值计算：</strong></p><ul><li>两个DateTime对象可以相减，从而获得两者间的时间差，单位为天。</li><li>一个DateTime对象和一个正的或负的数字可以相加，从而获得一个新DateTime对象。</li><li>一个正的或负的数字和一个DateTime对象可以相加，从而获得一个新DateTime对象。</li><li>一个正的或负的数字可以从一个DateTime对象中减去，从而获得一个新DateTime对象。</li></ul>]]></content>
    
    
    <summary type="html">Zope DateTime类型的常用操作</summary>
    
    
    
    
    <category term="Zope" scheme="https://www.junle.org/tags/Zope/"/>
    
  </entry>
  
  <entry>
    <title>Zope对象的漫游方法</title>
    <link href="https://www.junle.org/Zope%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%BC%AB%E6%B8%B8%E6%96%B9%E6%B3%95/"/>
    <id>https://www.junle.org/Zope%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%BC%AB%E6%B8%B8%E6%96%B9%E6%B3%95/</id>
    <published>2016-03-20T04:11:55.000Z</published>
    <updated>2024-03-22T06:43:55.689Z</updated>
    
    <content type="html"><![CDATA[<ul><li>absolute_url<blockquote><p>返回当前对象的绝对路径，调用它如 <code>context.absolute_url()</code></p></blockquote></li><li>absolute_url_path<blockquote><p>返回当前对象的绝对路径中的path部分，调用它如 <code>context.absolute_url_path()</code></p></blockquote></li><li>getPhysicalPath<blockquote><p>返回对象的物理路径的列表，这个地址和是否使用虚拟主机在访问无关。<br>调用它如 <code>context.getPhysicalPath()</code></p></blockquote></li><li>unrestrictedTraverse<blockquote><p>不检查访问权限的漫游, 此方法不能在ZMI脚本中使用，<br>在扩展开发中的调用如 <code>context.unrestrictedTraverse(&#39;path/to/object&#39;)</code></p></blockquote></li><li>restrictedTraverse<blockquote><p>需要检查权限的漫游，与unrestrictedTraverse区别是多了每一级上的权限检查，<br>如 <code>context.restrictedTraverse(&#39;path/to/object&#39;)</code></p></blockquote></li></ul>]]></content>
    
    
    <summary type="html">Zope对象的漫游方法</summary>
    
    
    
    
    <category term="Zope" scheme="https://www.junle.org/tags/Zope/"/>
    
  </entry>
  
  <entry>
    <title>Zope文件夹操作</title>
    <link href="https://www.junle.org/Zope%E6%96%87%E4%BB%B6%E5%A4%B9%E6%93%8D%E4%BD%9C/"/>
    <id>https://www.junle.org/Zope%E6%96%87%E4%BB%B6%E5%A4%B9%E6%93%8D%E4%BD%9C/</id>
    <published>2016-01-10T03:23:54.000Z</published>
    <updated>2024-03-22T06:43:55.689Z</updated>
    
    <content type="html"><![CDATA[<p>文件夹操作包括检查子对象的操作，还有剪切、拷贝、粘贴等：</p><span id="more"></span><ul><li>hasObject<blockquote><p>检查文件夹中是否存在某个对象：<code>folder.hasObject(id)</code></p></blockquote></li><li>objectIds<blockquote><p>返回文件夹中的对象id字符串的列表，可以指定某些类型则只返回该类型：<code>folder.objectIds()</code></p></blockquote></li><li>objectValues<blockquote><p>返回文件夹中对象的列表，可以指定某些类型则只返回该类型：<code>folder.objectValues()</code></p></blockquote></li><li>manage_delObjects<blockquote><p>删除文件夹中的一些对象，参数是所要删除的id字符串列表：<code>folder.manage_delObjects([&#39;id&#39;])</code></p></blockquote></li><li>_setObject<blockquote><p>因为以下划线开头的函数是不会发布的，这个常用在文件系统上的开发中，用于给文件夹中添加对象：<code>folder._setObject(&#39;id&#39;, someObject)</code></p></blockquote></li><li>manage_renameObject<blockquote><p>修改文件夹中的子对象的id：<code>folder.renameObject(id, new_id)</code></p></blockquote></li><li>manage_renameObjects<blockquote><p>这个函数接受两个id的列表作为参数以同时对多个子对象进行改名：<code>folder.renameObjects([id], [new_id])</code></p></blockquote></li><li>manage_copyObjects<blockquote><p>复制文件夹中的一组对象：<code>cb_copy_data = folder.manage_copyObjects([&#39;my_document&#39;])</code></p></blockquote></li><li>manage_cutObjects<blockquote><p>剪切文件夹中的一组对象：<code>cb_copy_data = folder.manage_cutObjects([&#39;my_document&#39;])</code></p></blockquote></li><li>manage_pasteObjects<blockquote><p>剪贴一组对象，它使用manage_copyObjects或manage_cutObjects的返回值作为参数：<code>another_folder.manage_pasteObjects(cb_copy_data)</code></p></blockquote></li><li>objectItems<blockquote><p>返回文件夹中对象的(id, value)形式的元组的列表。</p></blockquote></li></ul><p>现在介绍一个剪切、复制和粘贴的实例。下面的脚本，其功能是把刚才创建的my_document文档复制到新文件夹my_folder里：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Products.CMFCore.utils <span class="keyword">import</span> getToolByName</span><br><span class="line"></span><br><span class="line">urltool = getToolByName(context, <span class="string">&quot;portal_url&quot;</span>)</span><br><span class="line">portal = urltool.getPortalObject()</span><br><span class="line">cb_copy_data = portal.manage_copyObjects([<span class="string">&quot;my_document&quot;</span>])</span><br><span class="line">folder = <span class="built_in">getattr</span>(portal, <span class="string">&quot;my_folder&quot;</span>)</span><br><span class="line">folder.manage_pasteObjects(cb_copy_data)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Zope文件夹操作</summary>
    
    
    
    
    <category term="Zope" scheme="https://www.junle.org/tags/Zope/"/>
    
  </entry>
  
  <entry>
    <title>如何在CentOS 7上安装ERP5</title>
    <link href="https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS-7%E4%B8%8A%E5%AE%89%E8%A3%85ERP5/"/>
    <id>https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS-7%E4%B8%8A%E5%AE%89%E8%A3%85ERP5/</id>
    <published>2015-07-15T03:42:18.000Z</published>
    <updated>2024-03-22T06:43:55.695Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><ul><li>CentOS 7服务器</li><li>ipv6地址</li><li>root用户权限</li></ul><h2 id="安装SlapOS-Node"><a href="#安装SlapOS-Node" class="headerlink" title="安装SlapOS Node"></a>安装SlapOS Node</h2><p>可以参考文档<a href="/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS-7%E4%B8%8A%E5%AE%89%E8%A3%85SlapOS-Node/">《如何在CentOS 7上安装SlapOS》</a>完成SlapOS Node安装。</p><span id="more"></span> <h2 id="配置SlapOS"><a href="#配置SlapOS" class="headerlink" title="配置SlapOS"></a>配置SlapOS</h2><p>在终端输入以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">slapos configure <span class="built_in">local</span> \</span><br><span class="line">    --interface-name eth0 \</span><br><span class="line">    --partition-number 16 \</span><br><span class="line">    --ipv4-local-network 10.0.0.0/24 \</span><br><span class="line">    --daemon-listen-ip 127.0.0.1 \</span><br><span class="line">    --daemon-listen-port 50000</span><br></pre></td></tr></table></figure><p><strong>interface-name</strong>: Computer Partition使用的网卡， 请根据自己实际的网卡填写， 该网卡需要有ipv6地址。<br><strong>partition-number</strong>: SlapOS创建的Computer Partition数量，对于ERP5需要10个左右，这里我们配置16个。<br><strong>ipv4-local-network</strong>:  Computer Partition使用的网络。<br><strong>daemon-listen-ip</strong>: slapos-proxy绑定的地址。<br><strong>daemon-listen-port</strong>: slapos-proxy绑定的端口。</p><p>完成后输入以下命令格式化Computer Partition：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slapos node format --now</span><br></pre></td></tr></table></figure><p>输出如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]<span class="comment"># slapos node format --now</span></span><br><span class="line">2018-10-19 14:18:11 slapos[1464] INFO Updating computer</span><br><span class="line">2018-10-19 14:18:32 slapos[1464] INFO Posting information to <span class="string">&#x27;http://127.0.0.1:50000&#x27;</span></span><br><span class="line">2018-10-19 14:18:32 slapos[1464] INFO slapos successfully prepared the computer.</span><br></pre></td></tr></table></figure><h2 id="安装ERP5"><a href="#安装ERP5" class="headerlink" title="安装ERP5"></a>安装ERP5</h2><p>获取SlapOS buildout配置文件到本地目录*&#x2F;opt&#x2F;buildout*</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/buildout &amp;&amp; <span class="built_in">cd</span> /opt/buildout</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/SlapOS/slapos.git</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> slapos &amp;&amp; git checkout 1.0.67</span><br></pre></td></tr></table></figure><p>构建和安装ERP5软件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slapos supply /opt/buildout/slapos/software/erp5/software.cfg local_computer</span><br></pre></td></tr></table></figure><p>SlapOS会根据buildout配置去构建和安装ERP5所需的各个软件，ERP5构建过程可能需要较长时间，建议丢在那里让它跑一晚上，通过以下命令可以查看buildout日志：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tail</span> -f /opt/slapos/log/slapos-node-software.log</span><br></pre></td></tr></table></figure><p>输入以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slapos node software</span><br></pre></td></tr></table></figure><p>输出内容如下，则说明软件构建完成：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@vm opt]<span class="comment"># slapos node software</span></span><br><span class="line">2018-10-19 14:35:14 slapos[7190] INFO Processing software releases...</span><br><span class="line">2018-10-19 14:35:14 slapos[7190] INFO Finished software releases.</span><br></pre></td></tr></table></figure><h2 id="创建ERP5实例"><a href="#创建ERP5实例" class="headerlink" title="创建ERP5实例"></a>创建ERP5实例</h2><p>输入以下命令创建ERP5实例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slapos request erp5 /opt/buildout/slapos/software/erp5/software.cfg</span><br></pre></td></tr></table></figure><p>SlapOS会自动创建ERP5实例，实例化过程大约需要5-10分钟，通过以下命令查看实例化日志：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tail</span> -f /opt/slapos/log/slapos-node-instance.log</span><br></pre></td></tr></table></figure><p>输入以下命令查看实例化结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slapos request erp5 /opt/buildout/slapos/software/erp5/software.cfg</span><br></pre></td></tr></table></figure><p>输出结果如下，则说明实例化完成。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2018-10-19 16:47:39 slapos[13925] INFO Instance requested.</span><br><span class="line">State is : started.</span><br><span class="line">2018-10-19 16:47:39 slapos[13925] INFO Connection parameters of instance are:</span><br><span class="line">2018-10-19 16:47:39 slapos[13925] INFO &#123;<span class="string">&#x27;_&#x27;</span>: <span class="string">&#x27;&#123;&quot;hosts-dict&quot;: &#123;&quot;erp5-cloudooo&quot;: &quot;10.0.0.221&quot;, &quot;erp5-smtp&quot;: &quot;127.0.0.2&quot;, &quot;erp5-catalog-0&quot;: &quot;10.0.0.218&quot;, &quot;erp5-memcached-volatile&quot;: &quot;10.0.0.215&quot;, &quot;erp5-memcached-persistent&quot;: &quot;10.0.0.214&quot;&#125;, &quot;site-id&quot;: &quot;erp5&quot;, &quot;monitor-setup-url&quot;: &quot;&quot;, &quot;family-default-v6&quot;: &quot;https://[xxxx:xxx::xxxx]:2151&quot;, &quot;deadlock-debugger-password&quot;: &quot;yzhmrcqk&quot;, &quot;inituser-login&quot;: &quot;zope&quot;, &quot;inituser-password&quot;: &quot;uslxwikz&quot;, &quot;monitor-base-url&quot;: &quot;&quot;, &quot;mariadb-test-database-list&quot;: [&quot;mysql://testuser_0:testpassword0@10.0.0.218:2099/erp5_test_0&quot;], &quot;mariadb-database-list&quot;: [&quot;mysql://user:insecure@10.0.0.218:2099/erp5&quot;], &quot;memcached-volatile-url&quot;: &quot;memcached://10.0.0.215:2013/&quot;, &quot;memcached-persistent-url&quot;: &quot;memcached://10.0.0.214:2003/&quot;, &quot;caucase-http-url&quot;: &quot;http://[xxxx:xxx::xxxx]:8890&quot;, &quot;cloudooo-url&quot;: &quot;http://10.0.0.221:2020/&quot;, &quot;family-default&quot;: &quot;https://10.0.0.211:2151&quot;&#125;&#x27;</span>&#125;</span><br><span class="line">2018-10-19 16:47:39 slapos[13925] INFO You can rerun the <span class="built_in">command</span> to get up-to-date information.</span><br></pre></td></tr></table></figure><p>ERP5的实例化结果输出的是一个字典，** family-default-v6 <strong>是ERP5实例连接url，</strong> inituser-login <strong>是用户名，</strong> inituser-password **是密码。</p>]]></content>
    
    
    <summary type="html">如何在CentOS 7上安装ERP5</summary>
    
    
    
    
    <category term="ERP5" scheme="https://www.junle.org/tags/ERP5/"/>
    
    <category term="SlapOS" scheme="https://www.junle.org/tags/SlapOS/"/>
    
  </entry>
  
  <entry>
    <title>如何在CentOS 7上安装SlapOS Node</title>
    <link href="https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS-7%E4%B8%8A%E5%AE%89%E8%A3%85SlapOS-Node/"/>
    <id>https://www.junle.org/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS-7%E4%B8%8A%E5%AE%89%E8%A3%85SlapOS-Node/</id>
    <published>2014-11-12T04:08:20.000Z</published>
    <updated>2024-03-22T06:43:55.696Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><ul><li>CentOS 7服务器</li><li>root用户权限</li></ul><h2 id="添加SlapOS源"><a href="#添加SlapOS源" class="headerlink" title="添加SlapOS源"></a>添加SlapOS源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo wget https://download.opensuse.org/repositories/home:/VIFIBnexedi/CentOS_7/home:VIFIBnexedi.repo -O /etc/yum.repos.d/slapos.repo</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="导入RPM-GPG-KEY"><a href="#导入RPM-GPG-KEY" class="headerlink" title="导入RPM-GPG-KEY"></a>导入RPM-GPG-KEY</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rpm --import http://download.opensuse.org/repositories/home:/VIFIBnexedi/CentOS_7/repodata/repomd.xml.key</span><br></pre></td></tr></table></figure><h2 id="安装SlapOS"><a href="#安装SlapOS" class="headerlink" title="安装SlapOS"></a>安装SlapOS</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install slapos.node -y</span><br></pre></td></tr></table></figure><br><br>]]></content>
    
    
    <summary type="html">如何在CentOS 7上安装SlapOS Node</summary>
    
    
    
    
    <category term="ERP5" scheme="https://www.junle.org/tags/ERP5/"/>
    
    <category term="SlapOS" scheme="https://www.junle.org/tags/SlapOS/"/>
    
  </entry>
  
  <entry>
    <title>一行命令统计Nginx访问日志各个ip的访问次数</title>
    <link href="https://www.junle.org/%E4%B8%80%E8%A1%8C%E5%91%BD%E4%BB%A4%E7%BB%9F%E8%AE%A1Nginx%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97%E5%90%84%E4%B8%AAip%E7%9A%84%E8%AE%BF%E9%97%AE%E6%AC%A1%E6%95%B0/"/>
    <id>https://www.junle.org/%E4%B8%80%E8%A1%8C%E5%91%BD%E4%BB%A4%E7%BB%9F%E8%AE%A1Nginx%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97%E5%90%84%E4%B8%AAip%E7%9A%84%E8%AE%BF%E9%97%AE%E6%AC%A1%E6%95%B0/</id>
    <published>2014-08-07T03:40:41.000Z</published>
    <updated>2024-03-22T06:43:55.690Z</updated>
    
    <content type="html"><![CDATA[<p>查看访问各个ip及访问次数按访问次数排序</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]<span class="comment"># awk &#x27;&#123;print $1&#125;&#x27; /var/log/nginx/access.log | sort | uniq -c | sort -rn</span></span><br></pre></td></tr></table></figure><p>查看访问最多的10个ip及访问次数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@vm ~]<span class="comment"># awk &#x27;&#123;print $1&#125;&#x27; /var/log/nginx/access.log | sort | uniq -c | sort -rn | head -10</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;查看访问各个ip及访问次数按访问次数排序&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td </summary>
      
    
    
    
    
    <category term="Linux" scheme="https://www.junle.org/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>清理SQL Server数据库日志的方法</title>
    <link href="https://www.junle.org/%E6%B8%85%E7%90%86SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%A5%E5%BF%97%E7%9A%84%E6%96%B9%E6%B3%95/"/>
    <id>https://www.junle.org/%E6%B8%85%E7%90%86SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%A5%E5%BF%97%E7%9A%84%E6%96%B9%E6%B3%95/</id>
    <published>2014-06-22T12:14:12.000Z</published>
    <updated>2024-03-22T06:43:55.708Z</updated>
    
    <content type="html"><![CDATA[<p>清理sql server数据库日志方法：</p><ol><li><p>打开查询分析器，输入命令<code>DUMP TRANSACTION 数据库名 WITH NO_LOG</code></p></li><li><p>再打开企业管理器–右键你要压缩的数据库–所有任务–收缩数据库–收缩文件–选择日志文件–在收缩方式里选择收缩至: ,这里会给出一个允许收缩到的最小M数,直接输入这个数,确定就可以了。</p></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;清理sql server数据库日志方法：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;打开查询分析器，输入命令&lt;code&gt;DUMP TRANSACTION 数据库名 WITH NO_LOG&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;再打开企业管理器–右键你要压缩的数据库–所有任务</summary>
      
    
    
    
    
    <category term="SQLServer" scheme="https://www.junle.org/tags/SQLServer/"/>
    
  </entry>
  
  <entry>
    <title>使用BCP命令导出SQL Server表数据</title>
    <link href="https://www.junle.org/%E4%BD%BF%E7%94%A8BCP%E5%91%BD%E4%BB%A4%E5%AF%BC%E5%87%BASQL-Server%E8%A1%A8%E6%95%B0%E6%8D%AE/"/>
    <id>https://www.junle.org/%E4%BD%BF%E7%94%A8BCP%E5%91%BD%E4%BB%A4%E5%AF%BC%E5%87%BASQL-Server%E8%A1%A8%E6%95%B0%E6%8D%AE/</id>
    <published>2014-06-08T09:02:08.000Z</published>
    <updated>2024-03-22T06:43:55.691Z</updated>
    
    <content type="html"><![CDATA[<p>使用BCP命令导出表数据到电子表格文件：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--EXEC master..xp_cmdshell &#x27;BCP test..person out f:\backup\person.xls -c -T&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="variable">@tblname</span> <span class="type">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">declare</span> <span class="variable">@dbname</span> <span class="type">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">declare</span> <span class="variable">@dir</span> <span class="type">varchar</span>(<span class="number">200</span>)</span><br><span class="line"><span class="keyword">declare</span> <span class="variable">@str</span> <span class="type">varchar</span>(<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> <span class="variable">@dir</span> <span class="operator">=</span> <span class="string">&#x27;f:\backup\&#x27;</span></span><br><span class="line"><span class="keyword">set</span> <span class="variable">@dbname</span> <span class="operator">=</span> <span class="string">&#x27;test&#x27;</span></span><br><span class="line"><span class="keyword">set</span> <span class="variable">@tblname</span> <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">while <span class="keyword">exists</span>(<span class="keyword">select</span> name <span class="keyword">from</span> sys.tables <span class="keyword">where</span> SCHEMA_NAME(schema_id)<span class="operator">=</span>N<span class="string">&#x27;dbo&#x27;</span> <span class="keyword">and</span> <span class="variable">@tblname</span> <span class="operator">&lt;</span> name)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="variable">@tblname</span> <span class="operator">=</span> <span class="built_in">min</span>(name) <span class="keyword">from</span> sys.tables <span class="keyword">where</span> SCHEMA_NAME(schema_id)<span class="operator">=</span>N<span class="string">&#x27;dbo&#x27;</span> <span class="keyword">and</span> <span class="variable">@tblname</span> <span class="operator">&lt;</span> name</span><br><span class="line">    <span class="keyword">set</span> <span class="variable">@str</span> <span class="operator">=</span> <span class="string">&#x27;BCP &#x27;</span><span class="operator">+</span><span class="variable">@dbname</span><span class="operator">+</span><span class="string">&#x27;..&#x27;</span><span class="operator">+</span><span class="variable">@tblname</span><span class="operator">+</span><span class="string">&#x27; out &#x27;</span><span class="operator">+</span><span class="variable">@dir</span><span class="operator">+</span><span class="variable">@tblname</span><span class="operator">+</span><span class="string">&#x27;.xls -c -T&#x27;</span></span><br><span class="line">    <span class="keyword">exec</span> master..xp_cmdshell <span class="variable">@str</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">使用BCP命令导出SQL Server表数据</summary>
    
    
    
    
    <category term="SQLServer" scheme="https://www.junle.org/tags/SQLServer/"/>
    
  </entry>
  
</feed>
